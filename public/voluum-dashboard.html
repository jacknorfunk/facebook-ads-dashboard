<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voluum Performance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg p-6 mb-8 text-white">
            <h1 class="text-3xl font-bold mb-2">Voluum Performance Tracker</h1>
            <p class="text-purple-100">Real-time campaign monitoring and trend analysis</p>
            
            <div class="mt-4 flex items-center space-x-4">
                <div class="flex items-center">
                    <div id="status-dot" class="w-3 h-3 rounded-full bg-yellow-400 mr-2"></div>
                    <span id="status-text" class="text-sm">Initializing...</span>
                </div>
                <button 
                    onclick="loadData()" 
                    class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded text-sm transition-colors">
                    üîÑ Refresh Data
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Live Campaigns</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-campaigns">--</p>
                    </div>
                    <div class="text-2xl">üìä</div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Total Revenue</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-revenue">--</p>
                    </div>
                    <div class="text-2xl">üí∞</div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Average ROAS</p>
                        <p class="text-2xl font-bold text-gray-900" id="avg-roas">--</p>
                    </div>
                    <div class="text-2xl">üìà</div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Trending Up</p>
                        <p class="text-2xl font-bold text-green-600" id="trending-up">--</p>
                    </div>
                    <div class="text-2xl">‚¨ÜÔ∏è</div>
                </div>
            </div>
        </div>

        <!-- Debug Section -->
        <div class="bg-white rounded-lg p-6 shadow-sm mb-8">
            <h2 class="text-lg font-semibold mb-4">Connection Status</h2>
            <div id="debug-info" class="bg-gray-50 p-4 rounded text-sm font-mono whitespace-pre-wrap">
                Ready to connect...
            </div>
        </div>

        <!-- Campaign Table -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="p-6 border-b">
                <h2 class="text-xl font-semibold">Campaign Performance</h2>
                <p class="text-gray-600 mt-1">Live campaign data from Voluum</p>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-500">Campaign</th>
                            <th class="px-6 py-3 text-center text-sm font-medium text-gray-500">Status</th>
                            <th class="px-6 py-3 text-right text-sm font-medium text-gray-500">Clicks</th>
                            <th class="px-6 py-3 text-right text-sm font-medium text-gray-500">Conversions</th>
                            <th class="px-6 py-3 text-right text-sm font-medium text-gray-500">Revenue</th>
                            <th class="px-6 py-3 text-right text-sm font-medium text-gray-500">Cost</th>
                            <th class="px-6 py-3 text-right text-sm font-medium text-gray-500">ROAS</th>
                            <th class="px-6 py-3 text-center text-sm font-medium text-gray-500">24h Change</th>
                        </tr>
                    </thead>
                    <tbody id="campaign-table-body">
                        <tr>
                            <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                                <div class="flex items-center justify-center">
                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-2"></div>
                                    Click "Refresh Data" to load campaigns
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Raw API Response -->
        <div class="bg-white rounded-lg p-6 shadow-sm mt-8">
            <h2 class="text-lg font-semibold mb-4">API Response (Debug)</h2>
            <pre id="api-response" class="bg-gray-50 p-4 rounded text-sm overflow-auto max-h-64">
No data loaded yet...
            </pre>
        </div>
    </div>

    <script>
        let campaigns = [];
        
        function updateStatus(type, message) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            
            const colors = {
                loading: 'bg-yellow-400',
                success: 'bg-green-400',
                error: 'bg-red-400'
            };
            
            dot.className = `w-3 h-3 rounded-full ${colors[type]} mr-2`;
            text.textContent = message;
        }
        
        function addDebugLog(message) {
            const debugDiv = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            const currentLog = debugDiv.textContent;
            debugDiv.textContent = currentLog + `\n[${timestamp}] ${message}`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }
        
        async function loadData() {
            updateStatus('loading', 'Loading campaigns...');
            addDebugLog('Starting data load...');
            
            try {
                addDebugLog('Fetching from /api/voluum/campaigns');
                
                const response = await fetch('/api/voluum/campaigns');
                
                addDebugLog(`Response status: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    addDebugLog(`Error: ${errorText}`);
                    updateStatus('error', `Error ${response.status}`);
                    document.getElementById('api-response').textContent = `Error ${response.status}: ${errorText}`;
                    return;
                }
                
                const data = await response.json();
                addDebugLog(`Received ${data.length} campaigns`);
                
                campaigns = data;
                updateStats();
                renderTable();
                updateStatus('success', 'Data loaded successfully');
                
                document.getElementById('api-response').textContent = JSON.stringify(data, null, 2);
                
            } catch (error) {
                addDebugLog(`Error: ${error.message}`);
                updateStatus('error', 'Connection failed');
                document.getElementById('api-response').textContent = `Error: ${error.message}`;
            }
        }
        
        function updateStats() {
            const totalCampaigns = campaigns.length;
            const totalRevenue = campaigns.reduce((sum, c) => sum + (c.revenue || 0), 0);
            const avgRoas = totalCampaigns > 0 ? 
                campaigns.reduce((sum, c) => sum + (c.roas || 0), 0) / totalCampaigns : 0;
            const trendingUp = campaigns.filter(c => c.trendStatus === 'UP').length;
            
            document.getElementById('total-campaigns').textContent = totalCampaigns;
            document.getElementById('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('avg-roas').textContent = `${avgRoas.toFixed(2)}x`;
            document.getElementById('trending-up').textContent = trendingUp;
        }
        
        function renderTable() {
            const tbody = document.getElementById('campaign-table-body');
            
            if (campaigns.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                            No campaigns found
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = campaigns.map(campaign => {
                const statusColors = {
                    'UP': 'bg-green-100 text-green-800',
                    'DOWN': 'bg-red-100 text-red-800',
                    'STABLE': 'bg-gray-100 text-gray-800',
                    'NEW': 'bg-blue-100 text-blue-800'
                };
                
                const statusIcons = {
                    'UP': '‚¨ÜÔ∏è',
                    'DOWN': '‚¨áÔ∏è',
                    'STABLE': '‚û°Ô∏è',
                    'NEW': 'üÜï'
                };
                
                const status = campaign.trendStatus || 'STABLE';
                const change = campaign.primaryChange || 0;
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div>
                                <p class="font-medium text-gray-900">${campaign.name}</p>
                                ${campaign.offerName ? `<p class="text-sm text-gray-500">${campaign.offerName}</p>` : ''}
                            </div>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusColors[status]}">
                                ${statusIcons[status]} ${status}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right font-medium">${(campaign.clicks || 0).toLocaleString()}</td>
                        <td class="px-6 py-4 text-right font-medium">${campaign.conversions || 0}</td>
                        <td class="px-6 py-4 text-right font-medium">$${(campaign.revenue || 0).toFixed(2)}</td>
                        <td class="px-6 py-4 text-right font-medium">$${(campaign.cost || 0).toFixed(2)}</td>
                        <td class="px-6 py-4 text-right">
                            <span class="font-medium ${(campaign.roas || 0) >= 1 ? 'text-green-600' : 'text-red-600'}">
                                ${(campaign.roas || 0).toFixed(2)}x
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="text-sm ${change >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${change >= 0 ? '+' : ''}${change.toFixed(1)}%
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Auto-load on page ready
        document.addEventListener('DOMContentLoaded', function() {
            addDebugLog('Page loaded');
            updateStatus('loading', 'Ready to load data');
            loadData();
        });
    </script>
</body>
</html>
