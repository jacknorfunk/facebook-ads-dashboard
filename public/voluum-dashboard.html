<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voluum Performance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .status-up { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .status-down { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .status-stable { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); }
        .status-paused { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .loading-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .trend-positive { color: #10b981; }
        .trend-negative { color: #ef4444; }
        .campaign-row { 
            cursor: pointer; 
            transition: all 0.2s ease; 
        }
        .campaign-row:hover { 
            background-color: #f1f5f9; 
            transform: translateY(-1px); 
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .roas-card {
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .offer-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        .offer-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-white">Voluum Performance Tracker</h1>
                    <p class="text-blue-100">Real-time campaign monitoring and trend analysis</p>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="exportBtn" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-all">
                        <i class="fas fa-download mr-2"></i>Export CSV
                    </button>
                    <button id="refreshBtn" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-all">
                        <i class="fas fa-sync mr-2"></i>Refresh
                    </button>
                </div>
            </div>
            
            <!-- Simple Filters Row -->
            <div class="bg-white bg-opacity-10 rounded-lg p-4">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <!-- Date Range -->
                    <div>
                        <label class="block text-xs font-medium text-blue-100 mb-1">Date Range</label>
                        <select id="dateRange" class="w-full px-3 py-2 rounded-md bg-white bg-opacity-90 text-gray-800 text-sm">
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="14d">Last 14 Days</option>
                            <option value="30d">Last 30 Days</option>
                        </select>
                    </div>
                    
                    <!-- Status Filter - Default to Active -->
                    <div>
                        <label class="block text-xs font-medium text-blue-100 mb-1">Status</label>
                        <select id="statusFilter" class="w-full px-3 py-2 rounded-md bg-white bg-opacity-90 text-gray-800 text-sm">
                            <option value="all">All Campaigns</option>
                            <option value="active" selected>Active Only</option>
                            <option value="paused">Paused Only</option>
                            <option value="profitable">Profitable (ROAS > 1.0)</option>
                        </select>
                    </div>
                    
                    <!-- Spend Level -->
                    <div>
                        <label class="block text-xs font-medium text-blue-100 mb-1">Spend Level</label>
                        <select id="spendFilter" class="w-full px-3 py-2 rounded-md bg-white bg-opacity-90 text-gray-800 text-sm">
                            <option value="all">All Spend</option>
                            <option value="high">High (>$1K)</option>
                            <option value="medium">Medium ($100-$1K)</option>
                            <option value="low">Low (<$100)</option>
                            <option value="zero">Zero Spend</option>
                        </select>
                    </div>
                    
                    <!-- Performance -->
                    <div>
                        <label class="block text-xs font-medium text-blue-100 mb-1">Performance</label>
                        <select id="performanceFilter" class="w-full px-3 py-2 rounded-md bg-white bg-opacity-90 text-gray-800 text-sm">
                            <option value="all">All Performance</option>
                            <option value="excellent">Excellent (>1.5x ROAS)</option>
                            <option value="good">Good (1.0-1.5x)</option>
                            <option value="poor">Poor (<1.0x)</option>
                        </select>
                    </div>
                    
                    <!-- Sort By -->
                    <div>
                        <label class="block text-xs font-medium text-blue-100 mb-1">Sort By</label>
                        <select id="sortBy" class="w-full px-3 py-2 rounded-md bg-white bg-opacity-90 text-gray-800 text-sm">
                            <option value="revenue">Revenue (High to Low)</option>
                            <option value="spend">Spend (High to Low)</option>
                            <option value="roas">ROAS (High to Low)</option>
                            <option value="conversions">Conversions (High to Low)</option>
                            <option value="name">Campaign Name (A-Z)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Active Campaigns</p>
                        <p id="activeCampaigns" class="text-2xl font-bold text-green-600">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-play text-green-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Revenue</p>
                        <p id="totalRevenue" class="text-2xl font-bold text-gray-900">$0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-dollar-sign text-green-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Spend</p>
                        <p id="totalSpend" class="text-2xl font-bold text-red-600">$0</p>
                    </div>
                    <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-credit-card text-red-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Average ROAS</p>
                        <p id="averageRoas" class="text-2xl font-bold text-purple-600">0.0x</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-purple-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Conversions</p>
                        <p id="totalConversions" class="text-2xl font-bold text-indigo-600">0</p>
                    </div>
                    <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-bullseye text-indigo-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Connection Status -->
        <div class="bg-white rounded-xl shadow-sm border p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Connection Status</h3>
                <div id="connectionIndicator" class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                    <span class="text-sm text-gray-600">Connecting...</span>
                </div>
            </div>
            <div id="debugInfo" class="text-sm text-gray-600 space-y-1">
                <div>Ready to connect...</div>
            </div>
        </div>

        <!-- Campaign Performance Table -->
        <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">Campaign Performance</h3>
                    <div class="flex items-center gap-4">
                        <span id="filteredCount" class="text-sm text-gray-600">Showing 0 campaigns</span>
                        <div class="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded">
                            💡 Click on any campaign to view offers
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Campaign</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visits</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conversions</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenue</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Spend</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ROAS</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CPA</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">24h Change</th>
                        </tr>
                    </thead>
                    <tbody id="campaignsTable" class="bg-white divide-y divide-gray-200">
                        <!-- Campaigns will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="loading-pulse">
                <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600">Loading campaign data...</p>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-12 hidden">
            <i class="fas fa-filter text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">No Campaigns Found</h3>
            <p class="text-gray-600 mb-4">Try adjusting your filters or refresh the data</p>
            <button onclick="resetAllFilters()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                Reset Filters
            </button>
        </div>
    </div>

    <!-- Offers Modal -->
    <div id="offersModal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 max-w-6xl">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 id="modalCampaignName" class="text-2xl font-bold text-gray-900">Campaign Offers</h2>
                        <p id="modalCampaignId" class="text-sm text-gray-500"></p>
                    </div>
                    <button onclick="closeOffersModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <!-- ROAS Overview Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="roas-card p-6 text-center">
                        <div class="text-sm opacity-80 mb-1">7 Day ROAS</div>
                        <div id="roas7d" class="text-3xl font-bold">0.0x</div>
                        <div id="roasChange7d" class="text-sm opacity-80 mt-1">vs previous 7 days</div>
                    </div>
                    
                    <div class="roas-card p-6 text-center">
                        <div class="text-sm opacity-80 mb-1">14 Day ROAS</div>
                        <div id="roas14d" class="text-3xl font-bold">0.0x</div>
                        <div id="roasChange14d" class="text-sm opacity-80 mt-1">vs previous 14 days</div>
                    </div>
                    
                    <div class="roas-card p-6 text-center">
                        <div class="text-sm opacity-80 mb-1">30 Day ROAS</div>
                        <div id="roas30d" class="text-3xl font-bold">0.0x</div>
                        <div id="roasChange30d" class="text-sm opacity-80 mt-1">vs previous 30 days</div>
                    </div>
                </div>

                <!-- Performance Chart -->
                <div class="bg-gray-50 rounded-lg p-6 mb-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">ROAS Trend</h3>
                    <div class="h-64">
                        <canvas id="roasChart"></canvas>
                    </div>
                </div>

                <!-- Offers Table -->
                <div class="bg-white rounded-lg border overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Offers Performance</h3>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Offer Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">7D ROAS</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">14D ROAS</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">30D ROAS</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conversions</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenue</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="offersTable" class="bg-white divide-y divide-gray-200">
                                <!-- Offers will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allCampaigns = [];
        let filteredCampaigns = [];
        let currentSortColumn = '';
        let currentSortDirection = 'desc';
        let roasChart = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('Dashboard initialized');
            setupEventListeners();
            loadCampaigns();
        });

        function setupEventListeners() {
            // Filter and sort event listeners - reload data when date changes
            document.getElementById('dateRange').addEventListener('change', function() {
                debugLog(`Date range changed to: ${this.value}`);
                loadCampaigns(); // Reload data for new date range
            });
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('spendFilter').addEventListener('change', applyFilters);
            document.getElementById('performanceFilter').addEventListener('change', applyFilters);
            document.getElementById('sortBy').addEventListener('change', applySorting);
            
            // Button event listeners
            document.getElementById('refreshBtn').addEventListener('click', loadCampaigns);
            document.getElementById('exportBtn').addEventListener('click', exportCSV);
        }

        function getDateRangeParams(dateRange) {
            const today = new Date();
            const formatDate = (date) => date.toISOString().split('T')[0]; // YYYY-MM-DD format
            
            switch (dateRange) {
                case 'today':
                    return {
                        from: formatDate(today),
                        to: formatDate(today)
                    };
                    
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    return {
                        from: formatDate(yesterday),
                        to: formatDate(yesterday)
                    };
                    
                case '7d':
                    const week = new Date(today);
                    week.setDate(week.getDate() - 7);
                    return {
                        from: formatDate(week),
                        to: formatDate(today)
                    };
                    
                case '14d':
                    const twoWeeks = new Date(today);
                    twoWeeks.setDate(twoWeeks.getDate() - 14);
                    return {
                        from: formatDate(twoWeeks),
                        to: formatDate(today)
                    };
                    
                case '30d':
                    const month = new Date(today);
                    month.setDate(month.getDate() - 30);
                    return {
                        from: formatDate(month),
                        to: formatDate(today)
                    };
                    
                default:
                    return {
                        from: formatDate(today),
                        to: formatDate(today)
                    };
            }
        }

        async function loadCampaigns() {
            try {
                showLoadingState();
                debugLog('Loading campaigns from Voluum API...');
                
                // Get current date range selection and convert to API format
                const dateRange = document.getElementById('dateRange').value;
                const apiDateRange = convertDateRangeForAPI(dateRange);
                
                debugLog(`Fetching data for date range: ${dateRange} (API format: ${apiDateRange})`);
                
                const url = `/api/voluum/campaigns?date_range=${apiDateRange}`;
                const response = await fetch(url);
                const data = await response.json();
                
                debugLog(`API Response: ${JSON.stringify(data.debug_info || {})}`);
                
                // Log the first few campaigns to see the actual data structure
                if (data.data && data.data.campaigns && data.data.campaigns.length > 0) {
                    debugLog(`Sample campaign data: ${JSON.stringify(data.data.campaigns[0], null, 2)}`);
                }
                
                // Handle the correct API response structure
                if (data.data && data.data.campaigns) {
                    allCampaigns = data.data.campaigns;
                    const dataSource = data.debug_info?.data_source || 'unknown';
                    debugLog(`✅ Loaded ${allCampaigns.length} campaigns from ${dataSource} for ${dateRange}`);
                    
                    if (data.success) {
                        updateConnectionStatus('connected', `✅ Real Voluum data - ${allCampaigns.length} campaigns (${dateRange})`);
                    } else {
                        updateConnectionStatus('warning', `⚠️ Using mock data - ${allCampaigns.length} campaigns (${dateRange})`);
                    }
                } else {
                    throw new Error(data.error || 'Invalid API response structure');
                }
                
                applyFilters();
                updateOverviewCards();
                hideLoadingState();
                
            } catch (error) {
                debugLog(`❌ Error loading campaigns: ${error.message}`);
                updateConnectionStatus('error', `❌ Connection failed: ${error.message}`);
                
                // Use local fallback mock data
                allCampaigns = generateMockCampaigns();
                applyFilters();
                updateOverviewCards();
                hideLoadingState();
            }
        }

        function convertDateRangeForAPI(dateRange) {
            // Convert dashboard date range to API format
            switch (dateRange) {
                case 'today': return 'today';
                case 'yesterday': return 'yesterday';
                case '7d': return 'last_7_days';
                case '14d': return 'last_14_days';
                case '30d': return 'last_30_days';
                default: return 'last_7_days';
            }
        }

        function applyFilters() {
            const dateRange = document.getElementById('dateRange').value;
            const status = document.getElementById('statusFilter').value;
            const spend = document.getElementById('spendFilter').value;
            const performance = document.getElementById('performanceFilter').value;
            
            debugLog(`Applying filters - Status: ${status}, Spend: ${spend}, Performance: ${performance}`);
            debugLog(`Total campaigns before filtering: ${allCampaigns.length}`);
            
            filteredCampaigns = allCampaigns.filter(campaign => {
                // More flexible traffic detection - check for visits, clicks, or any cost
                const hasTraffic = (campaign.visits || 0) > 0 || 
                                  (campaign.clicks || 0) > 0 || 
                                  (campaign.cost || 0) > 0 ||
                                  (campaign.conversions || 0) > 0;
                
                const campaignSpend = parseFloat(campaign.cost || 0);
                const campaignRevenue = parseFloat(campaign.revenue || 0);
                const roas = campaignRevenue > 0 && campaignSpend > 0 ? campaignRevenue / campaignSpend : 0;
                
                debugLog(`Campaign: ${campaign.name}, HasTraffic: ${hasTraffic}, Visits: ${campaign.visits}, Cost: ${campaign.cost}, Revenue: ${campaign.revenue}`);
                
                // Status filter - be more inclusive for "active"
                if (status === 'active' && !hasTraffic) {
                    debugLog(`Filtered out ${campaign.name} - no traffic`);
                    return false;
                }
                if (status === 'paused' && hasTraffic) return false;
                if (status === 'profitable' && roas <= 1.0) return false;
                
                // Spend filter
                if (spend === 'high' && campaignSpend <= 1000) return false;
                if (spend === 'medium' && (campaignSpend <= 100 || campaignSpend > 1000)) return false;
                if (spend === 'low' && (campaignSpend <= 0 || campaignSpend >= 100)) return false;
                if (spend === 'zero' && campaignSpend > 0) return false;
                
                // Performance filter
                if (performance === 'excellent' && roas <= 1.5) return false;
                if (performance === 'good' && (roas < 1.0 || roas > 1.5)) return false;
                if (performance === 'poor' && roas >= 1.0) return false;
                
                return true;
            });
            
            debugLog(`Campaigns after filtering: ${filteredCampaigns.length}`);
            
            applySorting();
            updateCampaignsTable();
            updateFilteredCount();
        }

        function applySorting() {
            const sortBy = document.getElementById('sortBy').value;
            
            filteredCampaigns.sort((a, b) => {
                let aVal, bVal;
                
                switch (sortBy) {
                    case 'revenue':
                        aVal = parseFloat(a.revenue || 0);
                        bVal = parseFloat(b.revenue || 0);
                        return bVal - aVal; // High to low
                    case 'spend':
                        aVal = parseFloat(a.cost || 0);
                        bVal = parseFloat(b.cost || 0);
                        return bVal - aVal; // High to low
                    case 'roas':
                        const aRoas = (parseFloat(a.revenue || 0) > 0 && parseFloat(a.cost || 0) > 0) ? 
                                     parseFloat(a.revenue) / parseFloat(a.cost) : 0;
                        const bRoas = (parseFloat(b.revenue || 0) > 0 && parseFloat(b.cost || 0) > 0) ? 
                                     parseFloat(b.revenue) / parseFloat(b.cost) : 0;
                        return bRoas - aRoas; // High to low
                    case 'conversions':
                        aVal = parseInt(a.conversions || 0);
                        bVal = parseInt(b.conversions || 0);
                        return bVal - aVal; // High to low
                    case 'name':
                        return (a.campaignName || a.name || '').localeCompare(b.campaignName || b.name || '');
                    default:
                        return 0;
                }
            });
        }

        function updateCampaignsTable() {
            const tbody = document.getElementById('campaignsTable');
            
            if (filteredCampaigns.length === 0) {
                showEmptyState();
                return;
            }
            
            hideEmptyState();
            
            tbody.innerHTML = filteredCampaigns.map((campaign, index) => {
                const hasTraffic = (campaign.visits || 0) > 0 || (campaign.cost || 0) > 0;
                const statusClass = hasTraffic ? getStatusClass(campaign.status) : 'status-paused';
                const statusLabel = hasTraffic ? campaign.status || 'ACTIVE' : 'PAUSED';
                const changeClass = (campaign.change24h || 0) >= 0 ? 'trend-positive' : 'trend-negative';
                const changeIcon = (campaign.change24h || 0) >= 0 ? '↗' : '↘';
                
                const visits = formatNumber(campaign.visits || 0);
                const conversions = formatNumber(campaign.conversions || 0);
                const revenue = formatCurrency(campaign.revenue || 0);
                const spend = formatCurrency(campaign.cost || 0);
                const roas = calculateRoas(campaign.revenue || 0, campaign.cost || 0);
                const cpa = calculateCpa(campaign.cost || 0, campaign.conversions || 0);
                const change24h = formatPercentage(campaign.change24h || 0);
                
                return `
                    <tr class="campaign-row hover:bg-gray-50" onclick="openOffersModal('${campaign.id || campaign.campaignId}', '${escapeHtml(campaign.name || campaign.campaignName || 'Unknown')}')">
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-900 max-w-xs truncate">${campaign.name || campaign.campaignName || 'Unknown Campaign'}</div>
                            <div class="text-sm text-gray-500">ID: ${campaign.id || campaign.campaignId || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium text-white ${statusClass}">
                                ${statusLabel}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">${visits}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${conversions}</td>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${revenue}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${spend}</td>
                        <td class="px-6 py-4 text-sm font-medium ${getRoasColorClass(parseFloat(roas))}">${roas}x</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${cpa}</td>
                        <td class="px-6 py-4 text-sm ${changeClass}">${changeIcon} ${change24h}</td>
                    </tr>
                `;
            }).join('');
        }

        async function openOffersModal(campaignId, campaignName) {
            try {
                // Show modal
                document.getElementById('modalCampaignName').textContent = campaignName;
                document.getElementById('modalCampaignId').textContent = `Campaign ID: ${campaignId}`;
                document.getElementById('offersModal').classList.remove('hidden');
                
                // Load offers data for different time periods
                await loadOffersData(campaignId);
                
            } catch (error) {
                debugLog(`Error opening offers modal: ${error.message}`);
            }
        }

        async function loadOffersData(campaignId) {
            try {
                // Simulate API calls for different time periods
                const [offers7d, offers14d, offers30d] = await Promise.all([
                    fetchOffers(campaignId, 7),
                    fetchOffers(campaignId, 14),
                    fetchOffers(campaignId, 30)
                ]);
                
                // Update ROAS cards
                updateRoasCards(offers7d, offers14d, offers30d);
                
                // Update offers table
                updateOffersTable(offers7d, offers14d, offers30d);
                
                // Update chart
                updateRoasChart(offers7d, offers14d, offers30d);
                
            } catch (error) {
                debugLog(`Error loading offers data: ${error.message}`);
            }
        }

        async function fetchOffers(campaignId, days) {
            // For now, simulate API call with mock data
            // In real implementation, this would call the Voluum offers endpoint
            const mockOffers = generateMockOffers(campaignId, days);
            return mockOffers;
        }

        function generateMockOffers(campaignId, days) {
            const offers = [];
            const offerCount = Math.floor(Math.random() * 5) + 1; // 1-5 offers
            
            for (let i = 0; i < offerCount; i++) {
                const baseRevenue = Math.random() * 10000;
                const baseSpend = baseRevenue * (0.7 + Math.random() * 0.6); // 0.7-1.3 ratio
                const daysFactor = days / 7; // Scale by days
                
                offers.push({
                    offerId: `offer_${campaignId}_${i + 1}`,
                    offerName: `Offer ${i + 1} - ${['Health', 'Finance', 'Insurance', 'Travel', 'Education'][i % 5]}`,
                    revenue: baseRevenue * daysFactor,
                    spend: baseSpend * daysFactor,
                    conversions: Math.floor(Math.random() * 50 * daysFactor) + 1,
                    visits: Math.floor(Math.random() * 1000 * daysFactor) + 100,
                    roas: (baseRevenue * daysFactor) / (baseSpend * daysFactor),
                    status: Math.random() > 0.2 ? 'ACTIVE' : 'PAUSED'
                });
            }
            
            return offers;
        }

        function updateRoasCards(offers7d, offers14d, offers30d) {
            const roas7d = calculateAverageRoas(offers7d);
            const roas14d = calculateAverageRoas(offers14d);
            const roas30d = calculateAverageRoas(offers30d);
            
            document.getElementById('roas7d').textContent = roas7d.toFixed(2) + 'x';
            document.getElementById('roas14d').textContent = roas14d.toFixed(2) + 'x';
            document.getElementById('roas30d').textContent = roas30d.toFixed(2) + 'x';
            
            // Calculate changes (simulated)
            const change7d = ((roas7d - roas14d) / roas14d * 100).toFixed(1);
            const change14d = ((roas14d - roas30d) / roas30d * 100).toFixed(1);
            const change30d = (Math.random() * 20 - 10).toFixed(1); // Simulated
            
            document.getElementById('roasChange7d').textContent = `${change7d > 0 ? '+' : ''}${change7d}%`;
            document.getElementById('roasChange14d').textContent = `${change14d > 0 ? '+' : ''}${change14d}%`;
            document.getElementById('roasChange30d').textContent = `${change30d > 0 ? '+' : ''}${change30d}%`;
        }

        function updateOffersTable(offers7d, offers14d, offers30d) {
            const tbody = document.getElementById('offersTable');
            
            // Combine offers data
            const combinedOffers = offers7d.map((offer7d, index) => ({
                ...offer7d,
                roas14d: offers14d[index]?.roas || 0,
                roas30d: offers30d[index]?.roas || 0
            }));
            
            tbody.innerHTML = combinedOffers.map(offer => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <div class="font-medium text-gray-900">${offer.offerName}</div>
                        <div class="text-sm text-gray-500">ID: ${offer.offerId}</div>
                    </td>
                    <td class="px-6 py-4 text-sm font-medium ${getRoasColorClass(offer.roas)}">${offer.roas.toFixed(2)}x</td>
                    <td class="px-6 py-4 text-sm font-medium ${getRoasColorClass(offer.roas14d)}">${offer.roas14d.toFixed(2)}x</td>
                    <td class="px-6 py-4 text-sm font-medium ${getRoasColorClass(offer.roas30d)}">${offer.roas30d.toFixed(2)}x</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${formatNumber(offer.conversions)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${formatCurrency(offer.revenue)}</td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium text-white ${offer.status === 'ACTIVE' ? 'status-up' : 'status-paused'}">
                            ${offer.status}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function updateRoasChart(offers7d, offers14d, offers30d) {
            const ctx = document.getElementById('roasChart').getContext('2d');
            
            if (roasChart) {
                roasChart.destroy();
            }
            
            const data = {
                labels: ['7 Days', '14 Days', '30 Days'],
                datasets: [{
                    label: 'ROAS Trend',
                    data: [
                        calculateAverageRoas(offers7d),
                        calculateAverageRoas(offers14d),
                        calculateAverageRoas(offers30d)
                    ],
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            };
            
            roasChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ROAS'
                            }
                        }
                    }
                }
            });
        }

        function closeOffersModal() {
            document.getElementById('offersModal').classList.add('hidden');
            if (roasChart) {
                roasChart.destroy();
                roasChart = null;
            }
        }

        // Utility Functions
        function calculateAverageRoas(offers) {
            if (!offers || offers.length === 0) return 0;
            const totalRoas = offers.reduce((sum, offer) => sum + (offer.roas || 0), 0);
            return totalRoas / offers.length;
        }

        function calculateRoas(revenue, cost) {
            const rev = parseFloat(revenue) || 0;
            const spend = parseFloat(cost) || 0;
            return spend > 0 ? (rev / spend).toFixed(2) : '0.00';
        }

        function calculateCpa(cost, conversions) {
            const spend = parseFloat(cost) || 0;
            const conv = parseInt(conversions) || 0;
            return conv > 0 ? formatCurrency(spend / conv) : formatCurrency(0);
        }

        function getStatusClass(status) {
            const statusUpper = (status || '').toUpperCase();
            if (statusUpper.includes('UP') || statusUpper === 'ACTIVE') return 'status-up';
            if (statusUpper.includes('DOWN')) return 'status-down';
            if (statusUpper.includes('STABLE')) return 'status-stable';
            return 'status-paused';
        }

        function getRoasColorClass(roas) {
            const roasValue = parseFloat(roas) || 0;
            if (roasValue >= 1.5) return 'text-green-600';
            if (roasValue >= 1.0) return 'text-yellow-600';
            return 'text-red-600';
        }

        function formatNumber(num) {
            return new Intl.NumberFormat().format(parseInt(num) || 0);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(parseFloat(amount) || 0);
        }

        function formatPercentage(value) {
            const num = parseFloat(value) || 0;
            return (num >= 0 ? '+' : '') + num.toFixed(1) + '%';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateOverviewCards() {
            const activeCampaigns = filteredCampaigns.filter(c => 
                (c.visits || 0) > 0 || (c.cost || 0) > 0
            ).length;
            
            const totalRevenue = allCampaigns.reduce((sum, c) => sum + (parseFloat(c.revenue) || 0), 0);
            const totalSpend = allCampaigns.reduce((sum, c) => sum + (parseFloat(c.cost) || 0), 0);
            const totalConversions = allCampaigns.reduce((sum, c) => sum + (parseInt(c.conversions) || 0), 0);
            const averageRoas = totalSpend > 0 ? totalRevenue / totalSpend : 0;
            
            document.getElementById('activeCampaigns').textContent = formatNumber(activeCampaigns);
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('totalSpend').textContent = formatCurrency(totalSpend);
            document.getElementById('totalConversions').textContent = formatNumber(totalConversions);
            document.getElementById('averageRoas').textContent = averageRoas.toFixed(2) + 'x';
        }

        function updateFilteredCount() {
            document.getElementById('filteredCount').textContent = 
                `Showing ${filteredCampaigns.length} of ${allCampaigns.length} campaigns`;
        }

        function updateConnectionStatus(status, message) {
            const indicator = document.getElementById('connectionIndicator');
            const text = indicator.querySelector('span');
            const dot = indicator.querySelector('div');
            
            text.textContent = message;
            
            if (status === 'connected') {
                dot.className = 'w-3 h-3 bg-green-400 rounded-full';
            } else if (status === 'warning') {
                dot.className = 'w-3 h-3 bg-yellow-400 rounded-full';
            } else if (status === 'error') {
                dot.className = 'w-3 h-3 bg-red-400 rounded-full';
            } else {
                dot.className = 'w-3 h-3 bg-yellow-400 rounded-full';
            }
        }

        function exportCSV() {
            const csvContent = generateCSVContent(filteredCampaigns);
            downloadCSV(csvContent, 'voluum_campaigns_export.csv');
        }

        function generateCSVContent(campaigns) {
            const headers = ['Campaign Name', 'Campaign ID', 'Status', 'Visits', 'Conversions', 'Revenue', 'Spend', 'ROAS', 'CPA', '24h Change'];
            
            const rows = campaigns.map(campaign => [
                campaign.campaignName || campaign.name || '',
                campaign.campaignId || campaign.id || '',
                (campaign.visits || 0) > 0 || (campaign.cost || 0) > 0 ? 'ACTIVE' : 'PAUSED',
                campaign.visits || 0,
                campaign.conversions || 0,
                campaign.revenue || 0,
                campaign.cost || 0,
                calculateRoas(campaign.revenue || 0, campaign.cost || 0),
                calculateCpa(campaign.cost || 0, campaign.conversions || 0).replace('$', ''),
                (campaign.change24h || 0) + '%'
            ]);
            
            return [headers, ...rows].map(row => 
                row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
            ).join('\n');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function resetAllFilters() {
            document.getElementById('dateRange').value = 'today';
            document.getElementById('statusFilter').value = 'active'; // Keep default to active
            document.getElementById('spendFilter').value = 'all';
            document.getElementById('performanceFilter').value = 'all';
            document.getElementById('sortBy').value = 'revenue';
            applyFilters();
        }

        function generateMockCampaigns() {
            // Get current date range for realistic mock data
            const dateRange = document.getElementById('dateRange').value;
            const multiplier = getDateMultiplier(dateRange);
            
            debugLog(`Generating mock data for ${dateRange} (multiplier: ${multiplier})`);
            
            const campaigns = [];
            const campaignNames = [
                'NewsBreak ROAS - SENIORS - MOBILE',
                'NewsBreak ROAS - Tariffs V2',
                'NewsBreak Revenue - Home Insurance',
                'Facebook - B1A1 - Global - test',
                'Lander - Global - 836-PERFORM-DISCOVER',
                'Outbrain - Health & Wellness',
                'Taboola - Finance Offers - Desktop',
                'Native - Insurance Leads - Mobile'
            ];

            for (let i = 0; i < 20; i++) {
                const hasTraffic = Math.random() > 0.3; // 70% chance of traffic
                const baseRevenue = hasTraffic ? (Math.random() * 8000 + 1000) * multiplier : 0;
                const baseSpend = hasTraffic ? baseRevenue * (0.8 + Math.random() * 0.4) : 0; // 0.8-1.2 ratio
                
                campaigns.push({
                    campaignId: `camp_${1000 + i}`,
                    campaignName: campaignNames[i % campaignNames.length] + ` ${i + 1}`,
                    visits: hasTraffic ? Math.floor((Math.random() * 30000 + 1000) * multiplier) : 0,
                    conversions: hasTraffic ? Math.floor((Math.random() * 500 + 10) * multiplier) : 0,
                    revenue: baseRevenue,
                    cost: baseSpend,
                    status: hasTraffic ? (Math.random() > 0.5 ? 'UP' : 'STABLE') : 'PAUSED',
                    change24h: (Math.random() * 40 - 20) // -20% to +20%
                });
            }

            return campaigns;
        }

        function getDateMultiplier(dateRange) {
            // Adjust data volume based on date range
            switch (dateRange) {
                case 'today': return 0.3;
                case 'yesterday': return 0.3;
                case '7d': return 1.0;
                case '14d': return 1.8;
                case '30d': return 3.5;
                default: return 1.0;
            }
        }

        function debugLog(message) {
            const debugInfo = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            debugInfo.appendChild(logEntry);
            
            // Keep only last 10 messages
            while (debugInfo.children.length > 10) {
                debugInfo.removeChild(debugInfo.firstChild);
            }
            
            console.log(message);
        }

        function showLoadingState() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.querySelector('.bg-white.rounded-xl.shadow-sm.border.overflow-hidden').classList.add('hidden');
        }

        function hideLoadingState() {
            document.getElementById('loadingState').classList.add('hidden');
            document.querySelector('.bg-white.rounded-xl.shadow-sm.border.overflow-hidden').classList.remove('hidden');
        }

        function showEmptyState() {
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('campaignsTable').innerHTML = '';
        }

        function hideEmptyState() {
            document.getElementById('emptyState').classList.add('hidden');
        }

        // Close modal when clicking outside
        document.getElementById('offersModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeOffersModal();
            }
        });
    </script>
</body>
</html>
