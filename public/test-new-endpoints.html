<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Voluum API Diagnostics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .console {
            background: #1a202c;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            padding: 1rem;
            border-radius: 0.5rem;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        .warning { border-left: 4px solid #f59e0b; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-4">Comprehensive Voluum API Diagnostics</h1>
        <p class="text-gray-600 mb-6">Deep testing of your Voluum API setup to find exactly what's wrong</p>
        
        <!-- Quick Action Buttons -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <h2 class="text-lg font-semibold mb-3">Quick Actions</h2>
            <div class="flex flex-wrap gap-3">
                <button onclick="runAllTests()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    Run All Tests
                </button>
                <button onclick="testDirectVoluum()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                    Test Direct Voluum
                </button>
                <button onclick="debugParameters()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700">
                    Debug Parameters
                </button>
                <button onclick="clearAllLogs()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                    Clear All
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Test 1: Environment Validation -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">1. Environment Validation</h2>
                <button onclick="validateEnvironment()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mb-4">
                    Validate Setup
                </button>
                <div id="envConsole" class="console">Click to validate your environment setup...</div>
            </div>

            <!-- Test 2: Authentication Deep Test -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">2. Authentication Deep Test</h2>
                <button onclick="deepAuthTest()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 mb-4">
                    Deep Auth Test
                </button>
                <div id="authConsole" class="console">Click to test authentication thoroughly...</div>
            </div>

            <!-- Test 3: Voluum Profile Access -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">3. Voluum Profile Access</h2>
                <button onclick="testProfile()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 mb-4">
                    Test Profile API
                </button>
                <div id="profileConsole" class="console">Click to test profile access...</div>
            </div>

            <!-- Test 4: Campaign Endpoints -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">4. Campaign Endpoints</h2>
                <button onclick="testCampaignEndpoints()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 mb-4">
                    Test All Campaign APIs
                </button>
                <div id="campaignConsole" class="console">Click to test campaign endpoints...</div>
            </div>

            <!-- Test 5: Report Endpoint Analysis -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">5. Report Endpoint Analysis</h2>
                <button onclick="analyzeReportEndpoint()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 mb-4">
                    Analyze Report API
                </button>
                <div id="reportConsole" class="console">Click to analyze report endpoints...</div>
            </div>

            <!-- Test 6: Parameter Testing -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">6. Parameter Testing</h2>
                <button onclick="testParameters()" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 mb-4">
                    Test Parameters
                </button>
                <div id="paramConsole" class="console">Click to test different parameter combinations...</div>
            </div>
        </div>

        <!-- Summary Panel -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">ðŸŽ¯ Diagnostic Summary</h2>
            <div id="summary" class="text-gray-600">
                Run tests above to get a comprehensive analysis of your Voluum API setup.
            </div>
        </div>

        <!-- Debug Raw Data -->
        <div class="mt-6 bg-gray-900 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-white font-medium">ðŸ”¬ Raw Debug Data</h3>
                <button onclick="clearDebug()" class="text-gray-400 hover:text-white text-sm">Clear</button>
            </div>
            <div id="rawDebug" class="text-green-400 font-mono text-xs max-h-48 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        function log(consoleId, message) {
            const console = document.getElementById(consoleId);
            const timestamp = new Date().toLocaleTimeString();
            console.textContent += `[${timestamp}] ${message}\n`;
            console.scrollTop = console.scrollHeight;
        }

        function clear(consoleId) {
            document.getElementById(consoleId).textContent = '';
        }

        async function testNewEnvironment() {
            clear('envConsole');
            log('envConsole', 'ðŸ§ª Testing NEW /api/test-env endpoint...');
            
            try {
                const response = await fetch('/api/test-env');
                log('envConsole', `ðŸ“¡ Response status: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log('envConsole', `âŒ HTTP Error: ${response.status} - ${response.statusText}`);
                    log('envConsole', `âŒ Response: ${errorText.substring(0, 200)}...`);
                    return;
                }
                
                const data = await response.json();
                log('envConsole', `ðŸ“Š Environment Check:`);
                log('envConsole', `   VOLUME_KEY_ID: ${data.environment_check?.volume_key_id_present ? 'âœ…' : 'âŒ'}`);
                log('envConsole', `   VOLUME_KEY: ${data.environment_check?.volume_key_present ? 'âœ…' : 'âŒ'}`);
                
                if (data.api_test) {
                    log('envConsole', `ðŸ” Voluum API Test:`);
                    log('envConsole', `   Auth Status: ${data.api_test.auth_status || 'N/A'}`);
                    log('envConsole', `   Auth Success: ${data.api_test.auth_success ? 'âœ…' : 'âŒ'}`);
                    log('envConsole', `   Has Token: ${data.api_test.has_token ? 'âœ…' : 'âŒ'}`);
                }
                
                if (data.success) {
                    log('envConsole', 'ðŸŽ‰ SUCCESS! Environment and API test passed!');
                } else {
                    log('envConsole', `âŒ FAILED: ${data.error}`);
                }
                
            } catch (error) {
                log('envConsole', `âŒ Network Error: ${error.message}`);
                log('envConsole', 'ðŸ’¡ Check: Is /api/test-env.js uploaded correctly?');
            }
        }

        async function testNewAuth() {
            clear('authConsole');
            log('authConsole', 'ðŸ” Testing NEW /api/voluum/auth endpoint...');
            
            try {
                const response = await fetch('/api/voluum/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                log('authConsole', `ðŸ“¡ Response status: ${response.status}`);
                
                const data = await response.json();
                
                if (data.success && data.token) {
                    log('authConsole', 'ðŸŽ‰ SUCCESS! Authentication working!');
                    log('authConsole', `ðŸŽ« Token: ${data.token.substring(0, 20)}...`);
                    log('authConsole', `â° Expires: ${data.expiresAt || 'N/A'}`);
                } else {
                    log('authConsole', 'âŒ Authentication FAILED');
                    log('authConsole', `âŒ Error: ${data.error}`);
                    if (data.response) {
                        log('authConsole', `âŒ Voluum Response: ${data.response.substring(0, 100)}...`);
                    }
                }
                
            } catch (error) {
                log('authConsole', `âŒ Network Error: ${error.message}`);
                log('authConsole', 'ðŸ’¡ Check: Is /api/voluum/auth.js uploaded correctly?');
            }
        }

        async function testNewCampaigns() {
            clear('campaignsConsole');
            log('campaignsConsole', 'ðŸ“Š Testing NEW /api/voluum/campaigns endpoint...');
            
            try {
                const response = await fetch('/api/voluum/campaigns?range=yesterday');
                log('campaignsConsole', `ðŸ“¡ Response status: ${response.status}`);
                
                const data = await response.json();
                
                if (data.success) {
                    log('campaignsConsole', 'ðŸŽ‰ SUCCESS! Campaigns API working!');
                    log('campaignsConsole', `ðŸ“ˆ Found: ${data.campaigns?.length || 0} campaigns`);
                    log('campaignsConsole', `ðŸ“… Date Range: ${data.dateRange?.from} to ${data.dateRange?.to}`);
                    
                    if (data.campaigns && data.campaigns.length > 0) {
                        const first = data.campaigns[0];
                        log('campaignsConsole', `ðŸ† First Campaign: ${first.name}`);
                        log('campaignsConsole', `   Visits: ${first.visits}, Revenue: $${first.revenue}`);
                    }
                } else {
                    log('campaignsConsole', 'âŒ Campaigns FAILED');
                    log('campaignsConsole', `âŒ Error: ${data.error}`);
                    if (data.response) {
                        log('campaignsConsole', `âŒ Voluum Response: ${data.response.substring(0, 100)}...`);
                    }
                }
                
            } catch (error) {
                log('campaignsConsole', `âŒ Network Error: ${error.message}`);
                log('campaignsConsole', 'ðŸ’¡ Check: Is /api/voluum/campaigns.js uploaded correctly?');
            }
        }

        async function testNewReports() {
            clear('reportsConsole');
            log('reportsConsole', 'ðŸ“Š Testing NEW /api/voluum/reports endpoint...');
            
            try {
                const response = await fetch('/api/voluum/reports?range=yesterday&groupBy=campaign');
                log('reportsConsole', `ðŸ“¡ Response status: ${response.status}`);
                
                const data = await response.json();
                
                if (data.success) {
                    log('reportsConsole', 'ðŸŽ‰ SUCCESS! Reports API working!');
                    log('reportsConsole', `ðŸ“Š Found: ${data.rows?.length || 0} rows`);
                    log('reportsConsole', `ðŸ“… Date Range: ${data.dateRange?.from} to ${data.dateRange?.to}`);
                    
                    if (data.columns) {
                        log('reportsConsole', `ðŸ“‹ Columns: ${data.columns.map(c => c.name).join(', ')}`);
                    }
                } else {
                    log('reportsConsole', 'âŒ Reports FAILED');
                    log('reportsConsole', `âŒ Error: ${data.error}`);
                    if (data.response) {
                        log('reportsConsole', `âŒ Voluum Response: ${data.response.substring(0, 100)}...`);
                    }
                }
                
            } catch (error) {
                log('reportsConsole', `âŒ Network Error: ${error.message}`);
                log('reportsConsole', 'ðŸ’¡ Check: Is /api/voluum/reports.js uploaded correctly?');
            }
        }

        // Auto-run environment test
        window.addEventListener('load', () => {
            setTimeout(testNewEnvironment, 1000);
        });
    </script>
</body>
</html>
