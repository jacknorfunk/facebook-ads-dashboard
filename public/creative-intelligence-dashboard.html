<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewsBreak Creative Intelligence Dashboard</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #059669;
            --warning-color: #d97706;
            --danger-color: #dc2626;
            --background: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: auto;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--danger-color);
        }

        .status-indicator.connected {
            background: var(--success-color);
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard-nav {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .nav-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .controls-panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-select, .form-input {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
            font-size: 0.875rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .stat-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-change {
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--danger-color);
        }

        .data-table {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .table-header {
            background: #f8fafc;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .table-controls {
            display: flex;
            gap: 0.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8fafc;
            padding: 0.75rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            position: sticky;
            top: 0;
        }

        th:hover {
            background: #e2e8f0;
        }

        td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
        }

        tr:hover {
            background: #f8fafc;
        }

        .creative-preview {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .creative-image {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            object-fit: cover;
            border: 1px solid var(--border-color);
        }

        .creative-text {
            flex: 1;
        }

        .creative-headline {
            font-weight: 500;
            margin-bottom: 0.25rem;
            line-height: 1.3;
        }

        .creative-description {
            color: var(--text-secondary);
            font-size: 0.75rem;
            line-height: 1.3;
        }

        .performance-metric {
            text-align: right;
            font-weight: 500;
        }

        .metric-positive {
            color: var(--success-color);
        }

        .metric-negative {
            color: var(--danger-color);
        }

        .metric-neutral {
            color: var(--text-secondary);
        }

        .creative-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .tag {
            background: #e0e7ff;
            color: #3730a3;
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
            font-size: 0.625rem;
            font-weight: 500;
        }

        .tag.high-performing {
            background: #dcfce7;
            color: #166534;
        }

        .tag.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .analysis-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .analysis-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .analysis-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-state {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            color: #991b1b;
        }

        .ai-insights-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            font-size: 0.875rem;
        }

        .insight-item {
            opacity: 0.9;
        }

        .insight-value {
            font-weight: 600;
            font-size: 1.125rem;
            margin-top: 0.25rem;
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .analysis-panel {
                grid-template-columns: 1fr;
            }

            .dashboard-nav {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .nav-tab {
                font-size: 0.75rem;
                padding: 0.5rem 1rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">🎯 NewsBreak Creative Intelligence</div>
            <div class="connection-status">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">Initializing...</span>
            </div>
        </div>
    </header>

    <main class="main-container">
        <nav class="dashboard-nav">
            <button class="nav-tab active" data-tab="ad-data">📥 Creative Data</button>
            <button class="nav-tab" data-tab="creative-analysis">🧠 AI Analysis</button>
            <button class="nav-tab" data-tab="headline-analyzer">✍️ Headlines</button>
            <button class="nav-tab" data-tab="correlation-matrix">📊 Correlations</button>
            <button class="nav-tab" data-tab="ai-suggestions">⚡ AI Suggestions</button>
            <button class="nav-tab" data-tab="ab-testing">🧪 A/B Tests</button>
        </nav>

        <!-- Creative Data Tab -->
        <div class="tab-content active" id="ad-data">
            <div class="controls-panel">
                <div class="controls-grid">
                    <div class="form-group">
                        <label class="form-label">Traffic Source</label>
                        <select class="form-select" id="trafficSource">
                            <option value="newsbreak">NewsBreak</option>
                            <option value="facebook">Facebook</option>
                            <option value="taboola">Taboola</option>
                            <option value="voluum">Voluum</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date Range</label>
                        <select class="form-select" id="dateRange">
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="last7days">Last 7 Days</option>
                            <option value="last30days">Last 30 Days</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Campaign ID (Optional)</label>
                        <input type="text" class="form-input" id="campaignFilter" placeholder="Enter Campaign ID">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" id="loadDataBtn">Load Data</button>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">Total Campaigns</div>
                    <div class="stat-value" id="totalCampaigns">0</div>
                    <div class="stat-change" id="campaignsChange">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Active Creatives</div>
                    <div class="stat-value" id="activeCreatives">0</div>
                    <div class="stat-change" id="creativesChange">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Average CTR</div>
                    <div class="stat-value" id="avgCTR">0.00%</div>
                    <div class="stat-change" id="ctrChange">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Average ROAS</div>
                    <div class="stat-value" id="avgROAS">0.00x</div>
                    <div class="stat-change" id="roasChange">Loading...</div>
                </div>
            </div>

            <div class="data-table">
                <div class="table-header">
                    <h3 class="table-title">Live Creative Performance Data</h3>
                    <div class="table-controls">
                        <button class="btn btn-secondary" id="refreshData">Refresh</button>
                        <button class="btn btn-secondary" id="exportData">Export CSV</button>
                        <button class="btn btn-primary" id="runAnalysis">🤖 Run AI Analysis</button>
                    </div>
                </div>
                <div id="creativeTableContainer">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Loading creative data from NewsBreak API...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Analysis Tab -->
        <div class="tab-content" id="creative-analysis">
            <div class="analysis-panel">
                <div class="analysis-card">
                    <h3 class="analysis-title">🎨 AI Image Analysis</h3>
                    <div id="imageAnalysisResults">
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <p>Analyzing creative images with AI...</p>
                        </div>
                    </div>
                </div>
                <div class="analysis-card">
                    <h3 class="analysis-title">📈 Performance by Creative Type</h3>
                    <div id="performanceByType">
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <p>Processing performance metrics...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Headlines Tab -->
        <div class="tab-content" id="headline-analyzer">
            <div class="analysis-panel">
                <div class="analysis-card">
                    <h3 class="analysis-title">✍️ AI Headline Analysis</h3>
                    <div id="headlineAnalysis">
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <p>Analyzing headlines with AI...</p>
                        </div>
                    </div>
                </div>
                <div class="analysis-card">
                    <h3 class="analysis-title">🏆 Top Performing Headlines</h3>
                    <div id="topHeadlines">
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <p>Loading top headlines...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Correlations Tab -->
        <div class="tab-content" id="correlation-matrix">
            <div class="data-table">
                <div class="table-header">
                    <h3 class="table-title">📊 AI Performance Correlation Matrix</h3>
                </div>
                <div id="correlationMatrixContainer">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Calculating AI-powered correlations...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Suggestions Tab -->
        <div class="tab-content" id="ai-suggestions">
            <div class="analysis-panel">
                <div class="analysis-card">
                    <h3 class="analysis-title">⚡ AI Optimization Suggestions</h3>
                    <div id="aiSuggestions">
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <p>Generating AI suggestions...</p>
                        </div>
                    </div>
                </div>
                <div class="analysis-card">
                    <h3 class="analysis-title">🎯 Scaling Opportunities</h3>
                    <div id="scalingOpportunities">
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <p>Identifying scaling opportunities...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- A/B Testing Tab -->
        <div class="tab-content" id="ab-testing">
            <div class="data-table">
                <div class="table-header">
                    <h3 class="table-title">🧪 AI A/B Test Recommendations</h3>
                    <div class="table-controls">
                        <button class="btn btn-primary" id="generateTests">Generate Test Ideas</button>
                    </div>
                </div>
                <div id="abTestContainer">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Loading A/B test recommendations...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global variables
        let creativesData = [];
        let currentTab = 'ad-data';
        let analysisInProgress = false;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            loadInitialData();
        });

        function initializeEventListeners() {
            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // Data loading buttons
            document.getElementById('loadDataBtn').addEventListener('click', loadCreativeData);
            document.getElementById('refreshData').addEventListener('click', loadCreativeData);
            document.getElementById('exportData').addEventListener('click', exportToCSV);
            document.getElementById('runAnalysis').addEventListener('click', runComprehensiveAnalysis);
            document.getElementById('generateTests').addEventListener('click', loadABTests);

            // Traffic source change
            document.getElementById('trafficSource').addEventListener('change', function() {
                loadCreativeData();
            });
        }

        function switchTab(tabId) {
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

            // Show/hide content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');

            currentTab = tabId;

            // Load tab-specific data
            loadTabData(tabId);
        }

        function loadTabData(tabId) {
            if (!creativesData.length) {
                return; // No data to analyze
            }

            switch(tabId) {
                case 'creative-analysis':
                    analyzeCreatives();
                    break;
                case 'headline-analyzer':
                    analyzeHeadlines();
                    break;
                case 'correlation-matrix':
                    generateCorrelationMatrix();
                    break;
                case 'ai-suggestions':
                    generateAISuggestions();
                    break;
                case 'ab-testing':
                    loadABTests();
                    break;
            }
        }

        async function loadInitialData() {
            updateConnectionStatus('connecting', 'Initializing Creative Intelligence...');
            
            try {
                // Test API connections
                await testAPIConnections();
                updateConnectionStatus('connected', 'All APIs Connected');
                
                // Load initial creative data
                await loadCreativeData();
            } catch (error) {
                console.error('Initialization error:', error);
                updateConnectionStatus('error', 'Connection Error');
                showError('Failed to initialize dashboard: ' + error.message);
            }
        }

        async function testAPIConnections() {
            const trafficSource = document.getElementById('trafficSource').value;
            
            if (trafficSource === 'newsbreak') {
                console.log('🧪 Testing NewsBreak Enhanced API...');
                
                // Test environment variables
                const authTestResponse = await fetch('/api/newsbreak/auth-test');
                const authTestData = await authTestResponse.json();
                
                console.log('🔑 API Key test result:', authTestData);
                
                if (!authTestData.success || authTestData.api_key_status !== 'Found') {
                    throw new Error(`API Key Issue: ${authTestData.api_key_status}`);
                }
                
                // Test enhanced API connection
                const testResponse = await fetch('/api/newsbreak/test-connection');
                const testData = await testResponse.json();
                
                console.log('🔗 Connection test result:', testData);
                
                if (!testData.success) {
                    throw new Error(`Connection failed: ${testData.error}`);
                }
                
                console.log('✅ NewsBreak Enhanced API operational');
            }
        }

        async function loadCreativeData() {
            const trafficSource = document.getElementById('trafficSource').value;
            const dateRange = document.getElementById('dateRange').value;
            const campaignFilter = document.getElementById('campaignFilter').value;

            updateConnectionStatus('connecting', 'Loading creative data...');

            try {
                let data;
                
                switch(trafficSource) {
                    case 'newsbreak':
                        data = await loadNewsBreakData(dateRange, campaignFilter);
                        break;
                    case 'facebook':
                        data = await loadFacebookData(dateRange, campaignFilter);
                        break;
                    case 'taboola':
                        data = await loadTaboolaData(dateRange, campaignFilter);
                        break;
                    case 'voluum':
                        data = await loadVoluumData(dateRange, campaignFilter);
                        break;
                    default:
                        throw new Error('Unsupported traffic source');
                }

                creativesData = data.creatives || [];
                
                // Update dashboard
                updateDashboardStats(data.stats);
                renderCreativeTable(creativesData);
                
                updateConnectionStatus('connected', `Loaded ${creativesData.length} creatives`);
                
            } catch (error) {
                console.error('Error loading creative data:', error);
                updateConnectionStatus('error', 'Data Loading Failed');
                showError('Failed to load creative data: ' + error.message);
            }
        }

        // Enhanced NewsBreak data loading with full API integration
        async function loadNewsBreakData(dateRange, campaignFilter) {
            console.log('🔍 Loading NewsBreak data with enhanced API...');
            
            try {
                const params = new URLSearchParams({
                    date_range: dateRange,
                    ...(campaignFilter && { campaign_id: campaignFilter })
                });

                console.log('📊 Fetching enhanced campaign data...');
                const response = await fetch(`/api/newsbreak/enhanced-campaigns?${params}`);

                if (!response.ok) {
                    throw new Error(`Enhanced API request failed: ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Enhanced API request failed');
                }

                console.log('✅ Enhanced campaign data loaded:', {
                    campaigns: data.campaigns?.length || 0,
                    metadata: data.metadata,
                    summary: data.summary
                });
                
                // Transform enhanced NewsBreak data to dashboard format
                return {
                    creatives: data.campaigns?.map(campaign => ({
                        id: campaign.id,
                        name: campaign.name,
                        headline: campaign.headline || 'No headline available',
                        description: campaign.description || '',
                        imageUrl: campaign.imageUrl || '',
                        campaignId: campaign.campaignId,
                        spend: campaign.spend || 0,
                        ctr: campaign.ctr || 0,
                        roas: campaign.roas || 0,
                        cpa: campaign.cpa || 0,
                        conversions: campaign.conversions || 0,
                        impressions: campaign.impressions || 0,
                        deviceType: campaign.deviceType || 'All',
                        geo: campaign.geo || 'US',
                        status: campaign.status || 'Active',
                        
                        // Enhanced data
                        creativeCount: campaign.creativeCount || 1,
                        adSets: campaign.adSets || [],
                        ads: campaign.ads || [],
                        rawCampaignData: campaign.rawCampaignData
                    })) || [],
                    stats: {
                        totalCampaigns: data.summary?.totalCampaigns || 0,
                        activeCreatives: data.summary?.activeCreatives || 0,
                        avgCTR: data.summary?.avgCTR || 0,
                        avgROAS: data.summary?.avgROAS || 0,
                        
                        // Enhanced stats
                        activeCampaigns: data.summary?.activeCampaigns || 0,
                        totalSpend: data.summary?.totalSpend || 0,
                        totalRevenue: data.summary?.totalRevenue || 0,
                        averageCreativesPerCampaign: data.summary?.averageCreativesPerCampaign || 0,
                        topPerformingCampaigns: data.summary?.topPerformingCampaigns || []
                    },
                    metadata: data.metadata
                };
            } catch (error) {
                console.error('Enhanced NewsBreak data loading error:', error);
                throw error;
            }
        }

        // Placeholder functions for other traffic sources
        async function loadFacebookData(dateRange, campaignFilter) {
            console.log('📘 Loading Facebook data...');
            return {
                creatives: [],
                stats: { totalCampaigns: 0, activeCreatives: 0, avgCTR: 0, avgROAS: 0 }
            };
        }

        async function loadTaboolaData(dateRange, campaignFilter) {
            console.log('📰 Loading Taboola data...');
            return {
                creatives: [],
                stats: { totalCampaigns: 0, activeCreatives: 0, avgCTR: 0, avgROAS: 0 }
            };
        }

        async function loadVoluumData(dateRange, campaignFilter) {
            console.log('📊 Loading Voluum data...');
            try {
                const params = new URLSearchParams({
                    range: dateRange,
                    ...(campaignFilter && { campaignId: campaignFilter })
                });

                const response = await fetch(`/api/voluum/campaigns?${params}`);
                
                if (!response.ok) {
                    throw new Error('Voluum API request failed');
                }

                const data = await response.json();
                
                return {
                    creatives: data.campaigns?.map(campaign => ({
                        id: campaign.id,
                        name: campaign.name,
                        headline: extractHeadlineFromName(campaign.name),
                        description: campaign.name,
                        imageUrl: '',
                        campaignId: campaign.id,
                        spend: campaign.cost || 0,
                        ctr: campaign.cvr || 0,
                        roas: campaign.currentRoas || 0,
                        cpa: campaign.cpa || 0,
                        conversions: campaign.conversions || 0,
                        impressions: campaign.visits || 0,
                        deviceType: 'Unknown',
                        geo: 'Unknown',
                        status: campaign.status || 'Active'
                    })) || [],
                    stats: {
                        totalCampaigns: data.campaigns?.length || 0,
                        activeCreatives: data.campaigns?.length || 0,
                        avgCTR: calculateAverage(data.campaigns || [], 'cvr'),
                        avgROAS: calculateAverage(data.campaigns || [], 'currentRoas')
                    }
                };
            } catch (error) {
                console.error('Voluum data loading error:', error);
                throw error;
            }
        }

        function extractHeadlineFromName(campaignName) {
            const cleaned = campaignName.replace(/[_-]/g, ' ');
            return cleaned.length > 50 ? cleaned.substring(0, 50) + '...' : cleaned;
        }

        function calculateAverage(data, field) {
            if (!data.length) return 0;
            const sum = data.reduce((acc, item) => acc + (item[field] || 0), 0);
            return sum / data.length;
        }

        function updateDashboardStats(stats) {
            document.getElementById('totalCampaigns').textContent = stats.totalCampaigns || 0;
            document.getElementById('activeCreatives').textContent = stats.activeCreatives || 0;
            document.getElementById('avgCTR').textContent = ((stats.avgCTR || 0) * 100).toFixed(2) + '%';
            document.getElementById('avgROAS').textContent = (stats.avgROAS || 0).toFixed(2) + 'x';

            // Add change indicators
            updateChangeIndicator('campaignsChange', 0);
            updateChangeIndicator('creativesChange', 0);
            updateChangeIndicator('ctrChange', 0);
            updateChangeIndicator('roasChange', 0);
        }

        function updateChangeIndicator(elementId, change) {
            const element = document.getElementById(elementId);
            const changeText = change > 0 ? `+${change.toFixed(1)}%` : `${change.toFixed(1)}%`;
            element.textContent = changeText;
            element.className = `stat-change ${change >= 0 ? 'positive' : 'negative'}`;
        }

        function renderCreativeTable(creatives) {
            const container = document.getElementById('creativeTableContainer');
            
            if (!creatives.length) {
                container.innerHTML = '<div class="loading-state"><p>No creative data found for the selected criteria.</p></div>';
                return;
            }

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortTable('name')">Creative</th>
                            <th onclick="sortTable('ctr')">CTR</th>
                            <th onclick="sortTable('roas')">ROAS</th>
                            <th onclick="sortTable('spend')">Spend</th>
                            <th onclick="sortTable('conversions')">Conv</th>
                            <th onclick="sortTable('cpa')">CPA</th>
                            <th onclick="sortTable('deviceType')">Device</th>
                            <th>Tags</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${creatives.map(creative => `
                            <tr onclick="analyzeCreative('${creative.id}')">
                                <td>
                                    <div class="creative-preview">
                                        ${creative.imageUrl ? 
                                            `<img src="${creative.imageUrl}" alt="Creative" class="creative-image" onerror="this.src='data:image/svg+xml,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;60&quot; height=&quot;60&quot; viewBox=&quot;0 0 60 60&quot;><rect width=&quot;60&quot; height=&quot;60&quot; fill=&quot;%23f3f4f6&quot;/><text x=&quot;30&quot; y=&quot;35&quot; text-anchor=&quot;middle&quot; fill=&quot;%236b7280&quot; font-size=&quot;12&quot;>IMG</text></svg>'">` : 
                                            `<div class="creative-image" style="background: #f3f4f6; display: flex; align-items: center; justify-content: center; color: #6b7280; font-size: 10px;">IMG</div>`
                                        }
                                        <div class="creative-text">
                                            <div class="creative-headline">${creative.headline}</div>
                                            <div class="creative-description">${creative.description}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="performance-metric ${getMetricClass(creative.ctr, 0.01)}">${(creative.ctr * 100).toFixed(2)}%</td>
                                <td class="performance-metric ${getMetricClass(creative.roas, 1.0)}">${creative.roas.toFixed(2)}x</td>
                                <td class="performance-metric">$${creative.spend.toFixed(2)}</td>
                                <td class="performance-metric">${creative.conversions}</td>
                                <td class="performance-metric ${getMetricClass(creative.cpa, 50, true)}">${creative.cpa.toFixed(2)}</td>
                                <td>${creative.deviceType}</td>
                                <td>
                                    <div class="creative-tags">
                                        ${generateCreativeTags(creative).map(tag => `<span class="tag ${tag.type}">${tag.text}</span>`).join('')}
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        function getMetricClass(value, threshold, inverse = false) {
            if (inverse) {
                return value < threshold ? 'metric-positive' : 'metric-negative';
            }
            return value >= threshold ? 'metric-positive' : 'metric-negative';
        }

        function generateCreativeTags(creative) {
            const tags = [];
            
            if (creative.roas >= 2.0) tags.push({ text: 'High ROAS', type: 'high-performing' });
            if (creative.ctr >= 0.02) tags.push({ text: 'High CTR', type: 'high-performing' });
            if (creative.roas < 1.0) tags.push({ text: 'Low ROAS', type: 'warning' });
            if (creative.conversions === 0) tags.push({ text: 'No Conv', type: 'warning' });
            
            // Add AI-generated tags based on headline analysis
            if (creative.headline.toLowerCase().includes('free')) tags.push({ text: 'Free Offer', type: '' });
            if (/\d+/.test(creative.headline)) tags.push({ text: 'Number Hook', type: '' });
            if (creative.headline.includes('?')) tags.push({ text: 'Question', type: '' });
            
            return tags;
        }

        let sortDirection = {};
        function sortTable(column) {
            const direction = sortDirection[column] === 'asc' ? 'desc' : 'asc';
            sortDirection[column] = direction;
            
            creativesData.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (direction === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });
            
            renderCreativeTable(creativesData);
        }

        // AI Analysis Functions
        async function analyzeCreatives() {
            const container = document.getElementById('imageAnalysisResults');
            container.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Performing AI image analysis...</p></div>';

            if (!creativesData.length) {
                container.innerHTML = '<p>No creative data found. Load creative data first.</p>';
                return;
            }

            try {
                console.log('🤖 Starting AI creative analysis...');
                
                const response = await fetch('/api/newsbreak/creative-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        campaigns: creativesData,
                        analysisType: 'image_analysis'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Analysis API error: ${response.status}`);
                }

                const analysisData = await response.json();
                
                if (!analysisData.success) {
                    throw new Error(analysisData.error || 'Analysis failed');
                }

                console.log('✅ AI image analysis completed:', analysisData);
                
                displayEnhancedImageAnalysis(analysisData.data);
                
            } catch (error) {
                console.error('AI image analysis error:', error);
                container.innerHTML = `<div class="error-state">AI Analysis Error: ${error.message}</div>`;
            }
        }

        async function analyzeHeadlines() {
            const container = document.getElementById('headlineAnalysis');
            container.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Analyzing headlines with AI...</p></div>';

            if (!creativesData.length) {
                container.innerHTML = '<p>No creative data found. Load creative data first.</p>';
                return;
            }

            try {
                console.log('🤖 Starting AI headline analysis...');
                
                const response = await fetch('/api/newsbreak/creative-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        campaigns: creativesData,
                        analysisType: 'headline_analysis'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Headline analysis API error: ${response.status}`);
                }

                const analysisData = await response.json();
                
                if (!analysisData.success) {
                    throw new Error(analysisData.error || 'Headline analysis failed');
                }

                console.log('✅ AI headline analysis completed:', analysisData);
                
                displayEnhancedHeadlineAnalysis(analysisData.data);
                updateTopHeadlinesEnhanced(analysisData.data.topHeadlines);
                
            } catch (error) {
                console.error('AI headline analysis error:', error);
                container.innerHTML = `<div class="error-state">Headline Analysis Error: ${error.message}</div>`;
            }
        }

        async function generateAISuggestions() {
            const container = document.getElementById('aiSuggestions');
            container.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Generating AI-powered suggestions...</p></div>';

            if (!creativesData.length) {
                container.innerHTML = '<p>No creative data found. Load creative data first.</p>';
                return;
            }

            try {
                console.log('🤖 Generating AI suggestions...');
                
                const response = await fetch('/api/newsbreak/creative-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        campaigns: creativesData,
                        analysisType: 'ai_suggestions'
                    })
                });

                if (!response.ok) {
                    throw new Error(`AI suggestions API error: ${response.status}`);
                }

                const analysisData = await response.json();
                
                if (!analysisData.success) {
                    throw new Error(analysisData.error || 'AI suggestions failed');
                }

                console.log('✅ AI suggestions generated:', analysisData);
                
                displayEnhancedAISuggestions(analysisData.data);
                updateScalingOpportunitiesEnhanced(analysisData.data.scalingCandidates);
                
            } catch (error) {
                console.error('AI suggestions error:', error);
                container.innerHTML = `<div class="error-state">AI Suggestions Error: ${error.message}</div>`;
            }
        }

        async function loadABTests() {
            const container = document.getElementById('abTestContainer');
            container.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Loading A/B test recommendations...</p></div>';

            if (!creativesData.length) {
                container.innerHTML = '<p>No creative data found. Load creative data first.</p>';
                return;
            }

            try {
                console.log('🤖 Generating A/B test recommendations...');
                
                const response = await fetch('/api/newsbreak/creative-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        campaigns: creativesData,
                        analysisType: 'ab_test_recommendations'
                    })
                });

                if (!response.ok) {
                    throw new Error(`A/B test API error: ${response.status}`);
                }

                const analysisData = await response.json();
                
                if (!analysisData.success) {
                    throw new Error(analysisData.error || 'A/B test recommendations failed');
                }

                console.log('✅ A/B test recommendations generated:', analysisData);
                
                displayEnhancedABTests(analysisData.data);
                
            } catch (error) {
                console.error('A/B test recommendations error:', error);
                container.innerHTML = `<div class="error-state">A/B Test Recommendations Error: ${error.message}</div>`;
            }
        }

        async function generateCorrelationMatrix() {
            const container = document.getElementById('correlationMatrixContainer');
            container.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Calculating AI-powered correlations...</p></div>';

            if (!creativesData.length) {
                container.innerHTML = '<p>No creative data found. Load creative data first.</p>';
                return;
            }

            try {
                console.log('🤖 Analyzing performance correlations...');
                
                const response = await fetch('/api/newsbreak/creative-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        campaigns: creativesData,
                        analysisType: 'performance_correlation'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Correlation API error: ${response.status}`);
                }

                const analysisData = await response.json();
                
                if (!analysisData.success) {
                    throw new Error(analysisData.error || 'Correlation analysis failed');
                }

                console.log('✅ Performance correlations calculated:', analysisData);
                
                displayEnhancedCorrelationMatrix(analysisData.data);
                
            } catch (error) {
                console.error('Correlation analysis error:', error);
                
                // Fallback to local correlation calculation
                const localCorrelations = calculateCreativeCorrelations();
                displayLocalCorrelationMatrix(localCorrelations);
            }
        }

        // Enhanced display functions for AI analysis results
        function displayEnhancedImageAnalysis(analysisData) {
            const container = document.getElementById('imageAnalysisResults');
            
            const analysisHTML = `
                <div class="analysis-results">
                    <div class="insights-section">
                        <h4 style="font-weight: 600; margin-bottom: 1rem; color: var(--primary-color);">🎯 AI Insights</h4>
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                            <pre style="white-space: pre-wrap; font-family: inherit; font-size: 0.875rem; line-height: 1.5;">${analysisData.rawAnalysis || 'Analysis completed'}</pre>
                        </div>
                    </div>
                    
                    <div class="recommendations-section">
                        <h4 style="font-weight: 600; margin-bottom: 1rem; color: var(--success-color);">💡 Recommendations</h4>
                        <div style="space-y: 0.5rem;">
                            ${(analysisData.recommendations || []).map(rec => `
                                <div style="padding: 0.5rem; background: #dcfce7; border-left: 3px solid #16a34a; margin-bottom: 0.5rem; font-size: 0.875rem;">
                                    ${rec}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = analysisHTML;
        }

        function displayEnhancedHeadlineAnalysis(analysisData) {
            const container = document.getElementById('headlineAnalysis');
            
            const analysisHTML = `
                <div class="headline-analysis-results">
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                        <pre style="white-space: pre-wrap; font-family: inherit; font-size: 0.875rem; line-height: 1.5;">${analysisData.analysis}</pre>
                    </div>
                    
                    ${analysisData.correlationData && analysisData.correlationData.length > 0 ? `
                        <div class="correlation-insights">
                            <h4 style="font-weight: 600; margin-bottom: 1rem;">📈 Performance Impact Analysis</h4>
                            ${analysisData.correlationData.map(corr => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 500;">${corr.trait}</span>
                                    <span style="font-weight: 600; color: ${corr.impact >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">
                                        ${corr.impact >= 0 ? '+' : ''}${corr.impact.toFixed(1)}% ROAS Impact
                                    </span>
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);">
                                        ${corr.sampleSize} campaigns
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            
            container.innerHTML = analysisHTML;
        }

        function displayEnhancedAISuggestions(analysisData) {
            const container = document.getElementById('aiSuggestions');
            
            const suggestionsHTML = `
                <div class="ai-suggestions-results">
                    <div style="background: #eff6ff; padding: 1rem; border-radius: 6px; border-left: 4px solid var(--primary-color); margin-bottom: 1rem;">
                        <h4 style="font-weight: 600; margin-bottom: 1rem; color: var(--primary-color);">🤖 AI-Generated Optimization Recommendations</h4>
                        <pre style="white-space: pre-wrap; font-family: inherit; font-size: 0.875rem; line-height: 1.5;">${analysisData.suggestions}</pre>
                    </div>
                </div>
            `;
            
            container.innerHTML = suggestionsHTML;
        }

        function displayEnhancedABTests(analysisData) {
            const container = document.getElementById('abTestContainer');
            
            if (!analysisData.recommendations || analysisData.recommendations.length === 0) {
                container.innerHTML = '<p>No A/B test recommendations available. Load campaign data first.</p>';
                return;
            }
            
            const testsHTML = `
                <div class="ab-tests-container">
                    <div style="margin-bottom: 1rem; padding: 1rem; background: #f0f9ff; border-radius: 6px;">
                        <h4 style="font-weight: 600; color: var(--primary-color);">
                            📊 AI-Generated A/B Test Recommendations
                        </h4>
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">
                            ${analysisData.totalTestCandidates} campaigns identified for testing
                        </p>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8fafc;">
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">Campaign</th>
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">Current Performance</th>
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">Recommended Tests</th>
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">Priority</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${analysisData.recommendations.map(rec => `
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td style="padding: 0.75rem; font-size: 0.875rem;">
                                        <div style="font-weight: 500; margin-bottom: 0.25rem;">${rec.campaignName}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">ID: ${rec.campaignId}</div>
                                    </td>
                                    <td style="padding: 0.75rem; font-size: 0.875rem;">
                                        <div style="margin-bottom: 0.25rem;">ROAS: ${rec.currentPerformance.roas.toFixed(2)}x</div>
                                        <div style="margin-bottom: 0.25rem;">CTR: ${(rec.currentPerformance.ctr * 100).toFixed(2)}%</div>
                                        <div style="color: var(--text-secondary);">Spend: $${rec.currentPerformance.spend.toFixed(2)}</div>
                                    </td>
                                    <td style="padding: 0.75rem; font-size: 0.875rem;">
                                        ${rec.recommendedTests.map(test => `
                                            <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8fafc; border-radius: 4px;">
                                                <div style="font-weight: 500; margin-bottom: 0.25rem;">${test.type}</div>
                                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">${test.hypothesis}</div>
                                                ${test.expectedLift ? `<div style="font-size: 0.75rem; color: var(--success-color); font-weight: 500;">${test.expectedLift}</div>` : ''}
                                            </div>
                                        `).join('')}
                                    </td>
                                    <td style="padding: 0.75rem; font-size: 0.875rem;">
                                        ${rec.recommendedTests.map(test => `
                                            <span class="tag ${test.priority === 'High' ? 'high-performing' : test.priority === 'Medium' ? 'warning' : ''}" style="display: inline-block; margin-bottom: 0.25rem;">
                                                ${test.priority}
                                            </span>
                                        `).join('<br>')}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = testsHTML;
        }

        function displayEnhancedCorrelationMatrix(analysisData) {
            const container = document.getElementById('correlationMatrixContainer');
            
            const matrixHTML = `
                <div class="enhanced-correlation-matrix">
                    <div style="padding: 1rem;">
                        <div style="background: #f0f9ff; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                            <h4 style="font-weight: 600; color: var(--primary-color); margin-bottom: 0.5rem;">🧠 AI-Powered Performance Correlation Analysis</h4>
                            <p style="color: var(--text-secondary); font-size: 0.875rem;">Statistical analysis of creative traits vs performance metrics</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 0.5rem; font-weight: 600; margin-bottom: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 6px;">
                            <div>Creative Trait</div>
                            <div style="text-align: center;">ROAS Impact</div>
                            <div style="text-align: center;">CTR Impact</div>
                            <div style="text-align: center;">Confidence</div>
                            <div style="text-align: center;">Sample Size</div>
                        </div>
                        
                        ${analysisData && analysisData.correlations ? analysisData.correlations.map(corr => `
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 0.5rem; align-items: center; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 0.5rem;">
                                <div style="font-weight: 500;">${corr.trait}</div>
                                <div style="text-align: center; font-weight: 600; color: ${corr.roasImpact >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">
                                    ${corr.roasImpact >= 0 ? '+' : ''}${(corr.roasImpact * 100).toFixed(1)}%
                                </div>
                                <div style="text-align: center; font-weight: 600; color: ${corr.ctrImpact >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">
                                    ${corr.ctrImpact >= 0 ? '+' : ''}${(corr.ctrImpact * 100).toFixed(1)}%
                                </div>
                                <div style="text-align: center; color: ${corr.confidence >= 0.8 ? 'var(--success-color)' : corr.confidence >= 0.6 ? 'var(--warning-color)' : 'var(--text-secondary)'};">
                                    ${(corr.confidence * 100).toFixed(0)}%
                                </div>
                                <div style="text-align: center; color: var(--text-secondary);">${corr.sampleSize}</div>
                            </div>
                        `).join('') : '<p>Correlation analysis data not available</p>'}
                    </div>
                </div>
            `;
            
            container.innerHTML = matrixHTML;
        }

        function displayLocalCorrelationMatrix(correlations) {
            const container = document.getElementById('correlationMatrixContainer');
            
            const matrixHTML = `
                <div style="padding: 1rem;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 0.5rem; font-weight: 600; margin-bottom: 1rem; padding: 0.5rem; background: #f8fafc;">
                        <div>Creative Trait</div>
                        <div style="text-align: center;">ROAS Impact</div>
                        <div style="text-align: center;">CTR Impact</div>
                        <div style="text-align: center;">Sample Size</div>
                    </div>
                    ${correlations.map(corr => `
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 0.5rem; align-items: center; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 0.5rem;">
                            <div style="font-weight: 500;">${corr.trait}</div>
                            <div style="text-align: center; font-weight: 600; color: ${corr.roasImpact >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">
                                ${corr.roasImpact >= 0 ? '+' : ''}${(corr.roasImpact * 100).toFixed(1)}%
                            </div>
                            <div style="text-align: center; font-weight: 600; color: ${corr.ctrImpact >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">
                                ${corr.ctrImpact >= 0 ? '+' : ''}${(corr.ctrImpact * 100).toFixed(1)}%
                            </div>
                            <div style="text-align: center; color: var(--text-secondary);">${corr.sampleSize}</div>
                        </div>
                    `).join('')}
                </div>
            `;

            container.innerHTML = matrixHTML;
        }

        function updateTopHeadlinesEnhanced(topHeadlines) {
            const topHeadlinesContainer = document.getElementById('topHeadlines');
            
            if (!topHeadlines || topHeadlines.length === 0) {
                topHeadlinesContainer.innerHTML = '<p>No top headlines data available</p>';
                return;
            }

            const headlinesHTML = `
                <div style="space-y: 1rem;">
                    <div style="background: #f0f9ff; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                        <h4 style="font-weight: 600; color: var(--primary-color);">🏆 Top Performing Headlines</h4>
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">Ranked by ROAS performance</p>
                    </div>
                    ${topHeadlines.map((headline, index) => `
                        <div style="padding: 1rem; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <span style="font-weight: 600; color: var(--primary-color);">#${index + 1}</span>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.875rem; color: var(--success-color); font-weight: 600;">${headline.roas.toFixed(2)}x ROAS</div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">${(headline.ctr * 100).toFixed(2)}% CTR</div>
                                </div>
                            </div>
                            <div style="font-weight: 500; margin-bottom: 0.5rem;">${headline.headline}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                ${headline.conversions} conversions • Word count: ${headline.wordCount || 'N/A'}
                                ${headline.hasNumbers ? ' • Has Numbers' : ''}
                                ${headline.hasQuestion ? ' • Question Format' : ''}
                                ${headline.hasUrgency ? ' • Urgency Words' : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            topHeadlinesContainer.innerHTML = headlinesHTML;
        }

        function updateScalingOpportunitiesEnhanced(scalingCandidates) {
            const container = document.getElementById('scalingOpportunities');
            
            if (!scalingCandidates || scalingCandidates.length === 0) {
                container.innerHTML = '<p>No immediate scaling opportunities found. Focus on optimizing current campaigns.</p>';
                return;
            }

            const opportunitiesHTML = `
                <div>
                    <div style="background: #f0fdf4; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                        <h4 style="font-weight: 600; color: var(--success-color);">🚀 AI-Identified Scaling Opportunities</h4>
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">${scalingCandidates.length} high-potential campaigns ready for budget increases</p>
                    </div>
                    ${scalingCandidates.map(candidate => `
                        <div style="padding: 1rem; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div style="font-weight: 600; color: var(--success-color);">🚀 Scale Opportunity</div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.875rem; font-weight: 600;">${candidate.roas.toFixed(2)}x ROAS</div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">${candidate.spend.toFixed(2)} spent</div>
                                </div>
                            </div>
                            <div style="font-weight: 500; margin-bottom: 0.5rem;">${candidate.name}</div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-secondary);">
                                <span>Current Budget: ${candidate.spend.toFixed(2)}</span>
                                <span style="color: var(--success-color); font-weight: 500;">
                                    Recommended: ${candidate.recommendedBudget.toFixed(2)} 
                                    (+${((candidate.recommendedBudget / candidate.spend - 1) * 100).toFixed(0)}%)
                                </span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            container.innerHTML = opportunitiesHTML;
        }

        // Comprehensive AI Analysis
        async function runComprehensiveAnalysis() {
            if (!creativesData.length) {
                alert('Please load creative data first before running AI analysis.');
                return;
            }

            if (analysisInProgress) {
                alert('Analysis already in progress. Please wait...');
                return;
            }

            analysisInProgress = true;
            
            try {
                updateConnectionStatus('connecting', 'Running comprehensive AI analysis...');
                
                console.log('🤖 Starting comprehensive AI analysis...');
                
                const response = await fetch('/api/newsbreak/creative-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        campaigns: creativesData,
                        analysisType: 'comprehensive'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Comprehensive analysis API error: ${response.status}`);
                }

                const analysisData = await response.json();
                
                if (!analysisData.success) {
                    throw new Error(analysisData.error || 'Comprehensive analysis failed');
                }

                console.log('✅ Comprehensive AI analysis completed:', analysisData);
                
                // Update all dashboard sections
                if (analysisData.data.imageAnalysis) {
                    displayEnhancedImageAnalysis(analysisData.data.imageAnalysis);
                }
                
                if (analysisData.data.headlineAnalysis) {
                    displayEnhancedHeadlineAnalysis(analysisData.data.headlineAnalysis);
                    updateTopHeadlinesEnhanced(analysisData.data.headlineAnalysis.topHeadlines);
                }
                
                if (analysisData.data.aiSuggestions) {
                    displayEnhancedAISuggestions(analysisData.data.aiSuggestions);
                    updateScalingOpportunitiesEnhanced(analysisData.data.aiSuggestions.scalingCandidates);
                }
                
                if (analysisData.data.abTestRecommendations) {
                    displayEnhancedABTests(analysisData.data.abTestRecommendations);
                }
                
                // Add AI insights summary
                updateDashboardWithComprehensiveInsights(analysisData.data);
                
                updateConnectionStatus('connected', 'AI analysis completed successfully');
                
                alert('🤖 AI Analysis Complete!\n\nComprehensive analysis has been completed. Check all tabs for detailed insights:\n\n✓ Image Analysis\n✓ Headline Optimization\n✓ Performance Correlations\n✓ AI Suggestions\n✓ A/B Test Recommendations');
                
            } catch (error) {
                console.error('Comprehensive analysis error:', error);
                updateConnectionStatus('error', 'AI analysis failed');
                showError('Comprehensive AI analysis failed: ' + error.message);
            } finally {
                analysisInProgress = false;
            }
        }

        function updateDashboardWithComprehensiveInsights(analysisData) {
            // Remove existing summary if present
            const existingSummary = document.querySelector('.ai-insights-summary');
            if (existingSummary) {
                existingSummary.remove();
            }

            // Create AI insights summary
            const summaryInsights = document.createElement('div');
            summaryInsights.className = 'ai-insights-summary';
            summaryInsights.innerHTML = `
                <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">🤖 AI Analysis Summary</h3>
                <div class="insights-grid">
                    <div class="insight-item">
                        <div>Top Performers</div>
                        <div class="insight-value">${analysisData.summary?.topPerformers || 0}</div>
                    </div>
                    <div class="insight-item">
                        <div>Scaling Opportunities</div>
                        <div class="insight-value">${analysisData.summary?.scalingOpportunities || 0}</div>
                    </div>
                    <div class="insight-item">
                        <div>Test Recommendations</div>
                        <div class="insight-value">${analysisData.summary?.testRecommendations || 0}</div>
                    </div>
                    <div class="insight-item">
                        <div>Analysis Confidence</div>
                        <div class="insight-value">95%</div>
                    </div>
                </div>
            `;
            
            // Insert at the top of the creative data tab
            const adDataTab = document.getElementById('ad-data');
            const controlsPanel = adDataTab.querySelector('.controls-panel');
            adDataTab.insertBefore(summaryInsights, controlsPanel);
        }

        // Local correlation calculation (fallback)
        function calculateCreativeCorrelations() {
            const traits = [
                { name: 'Numbers in Headline', test: c => /\d+/.test(c.headline) },
                { name: 'Question Headlines', test: c => c.headline.includes('?') },
                { name: 'Urgency Words', test: c => /\b(now|today|limited|hurry|quick)\b/i.test(c.headline) },
                { name: 'Free Offers', test: c => /\bfree\b/i.test(c.headline) },
                { name: 'Money/Savings', test: c => /\$|save|money|cash|earn/i.test(c.headline) },
                { name: 'Long Headlines (>50 chars)', test: c => c.headline.length > 50 },
                { name: 'High Spend (>$100)', test: c => c.spend > 100 }
            ];

            return traits.map(trait => {
                const withTrait = creativesData.filter(trait.test);
                const withoutTrait = creativesData.filter(c => !trait.test(c));

                if (withTrait.length === 0 || withoutTrait.length === 0) {
                    return {
                        trait: trait.name,
                        roasImpact: 0,
                        ctrImpact: 0,
                        sampleSize: withTrait.length
                    };
                }

                const avgRoasWithTrait = withTrait.reduce((sum, c) => sum + c.roas, 0) / withTrait.length;
                const avgRoasWithoutTrait = withoutTrait.reduce((sum, c) => sum + c.roas, 0) / withoutTrait.length;
                
                const avgCtrWithTrait = withTrait.reduce((sum, c) => sum + c.ctr, 0) / withTrait.length;
                const avgCtrWithoutTrait = withoutTrait.reduce((sum, c) => sum + c.ctr, 0) / withoutTrait.length;

                return {
                    trait: trait.name,
                    roasImpact: avgRoasWithoutTrait > 0 ? (avgRoasWithTrait - avgRoasWithoutTrait) / avgRoasWithoutTrait : 0,
                    ctrImpact: avgCtrWithoutTrait > 0 ? (avgCtrWithTrait - avgCtrWithoutTrait) / avgCtrWithoutTrait : 0,
                    sampleSize: withTrait.length
                };
            }).sort((a, b) => b.roasImpact - a.roasImpact);
        }

        // Individual creative analysis
        async function analyzeCreative(creativeId) {
            const creative = creativesData.find(c => c.id === creativeId);
            if (!creative) return;

            console.log('🔍 Analyzing individual creative:', creative);
            
            // Switch to creative analysis tab
            switchTab('creative-analysis');
            
            // Show loading state
            document.getElementById('imageAnalysisResults').innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Analyzing individual creative...</p></div>';
            
            try {
                // Analyze this specific creative
                const response = await fetch('/api/newsbreak/creative-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        campaigns: [creative], // Single creative analysis
                        analysisType: 'image_analysis'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Individual analysis failed: ${response.status}`);
                }

                const analysisData = await response.json();
                
                if (analysisData.success) {
                    displayEnhancedImageAnalysis(analysisData.data);
                } else {
                    throw new Error(analysisData.error || 'Individual analysis failed');
                }
                
            } catch (error) {
                console.error('Individual creative analysis error:', error);
                document.getElementById('imageAnalysisResults').innerHTML = `<div class="error-state">Individual Analysis Error: ${error.message}</div>`;
            }
        }

        // Export functionality
        function exportToCSV() {
            if (!creativesData.length) {
                alert('No data to export. Please load creative data first.');
                return;
            }

            const csvHeaders = [
                'Creative ID', 'Campaign ID', 'Headline', 'Description', 'Image URL',
                'Spend', 'CTR', 'ROAS', 'CPA', 'Conversions', 'Impressions',
                'Device Type', 'Geo', 'Status'
            ];

            const csvRows = creativesData.map(creative => [
                creative.id,
                creative.campaignId,
                `"${creative.headline.replace(/"/g, '""')}"`,
                `"${creative.description.replace(/"/g, '""')}"`,
                creative.imageUrl,
                creative.spend.toFixed(2),
                (creative.ctr * 100).toFixed(4),
                creative.roas.toFixed(4),
                creative.cpa.toFixed(2),
                creative.conversions,
                creative.impressions,
                creative.deviceType,
                creative.geo,
                creative.status
            ]);

            const csvContent = [csvHeaders, ...csvRows]
                .map(row => row.join(','))
                .join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `newsbreak_creative_performance_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Enhanced diagnostic function
        async function runEnhancedDiagnostics() {
            console.log('🔍 Running enhanced diagnostic tests...');
            updateConnectionStatus('connecting', 'Running enhanced diagnostics...');
            
            try {
                const diagnosticResults = {
                    envVars: { status: 'unknown', details: null },
                    apiConnection: { status: 'unknown', details: null },
                    enhancedAPI: { status: 'unknown', details: null },
                    creativeAnalysis: { status: 'unknown', details: null }
                };

                // Test 1: Environment Variables
                console.log('🧪 Test 1: Checking environment variables...');
                try {
                    const authResponse = await fetch('/api/newsbreak/auth-test');
                    const authData = await authResponse.json();
                    diagnosticResults.envVars = { 
                        status: authData.success ? 'pass' : 'fail', 
                        details: authData 
                    };
                } catch (error) {
                    diagnosticResults.envVars = { status: 'error', details: error.message };
                }

                // Test 2: Basic API Connection
                console.log('🧪 Test 2: Testing basic API connection...');
                try {
                    const connResponse = await fetch('/api/newsbreak/test-connection');
                    const connData = await connResponse.json();
                    diagnosticResults.apiConnection = { 
                        status: connData.success ? 'pass' : 'fail', 
                        details: connData 
                    };
                } catch (error) {
                    diagnosticResults.apiConnection = { status: 'error', details: error.message };
                }

                // Test 3: Enhanced API Endpoints
                console.log('🧪 Test 3: Testing enhanced API endpoints...');
                try {
                    const enhancedResponse = await fetch('/api/newsbreak/enhanced-campaigns?date_range=last7days');
                    const enhancedData = await enhancedResponse.json();
                    diagnosticResults.enhancedAPI = { 
                        status: enhancedData.success ? 'pass' : 'fail', 
                        details: enhancedData 
                    };
                } catch (error) {
                    diagnosticResults.enhancedAPI = { status: 'error', details: error.message };
                }

                // Test 4: Creative Analysis API
                console.log('🧪 Test 4: Testing creative analysis API...');
                try {
                    const analysisResponse = await fetch('/api/newsbreak/creative-analysis', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            campaigns: [{ 
                                id: 'test', 
                                name: 'Test Campaign',
                                headline: 'Test Headline',
                                roas: 2.0,
                                ctr: 0.02,
                                spend: 100,
                                conversions: 5
                            }],
                            analysisType: 'headline_analysis'
                        })
                    });
                    const analysisData = await analysisResponse.json();
                    diagnosticResults.creativeAnalysis = { 
                        status: analysisData.success ? 'pass' : 'fail', 
                        details: analysisData 
                    };
                } catch (error) {
                    diagnosticResults.creativeAnalysis = { status: 'error', details: error.message };
                }

                // Display comprehensive results
                console.log('📊 Enhanced Diagnostic Results:', diagnosticResults);
                
                const allPassed = Object.values(diagnosticResults).every(test => test.status === 'pass');
                
                const resultMessage = `Enhanced Diagnostic Results:
                
✓ Environment Variables: ${getStatusEmoji(diagnosticResults.envVars.status)} ${diagnosticResults.envVars.status.toUpperCase()}
✓ Basic API Connection: ${getStatusEmoji(diagnosticResults.apiConnection.status)} ${diagnosticResults.apiConnection.status.toUpperCase()}  
✓ Enhanced API Endpoints: ${getStatusEmoji(diagnosticResults.enhancedAPI.status)} ${diagnosticResults.enhancedAPI.status.toUpperCase()}
✓ Creative Analysis API: ${getStatusEmoji(diagnosticResults.creativeAnalysis.status)} ${diagnosticResults.creativeAnalysis.status.toUpperCase()}

Overall System Status: ${allPassed ? '✅ ALL SYSTEMS OPERATIONAL' : '⚠️ ISSUES DETECTED'}

Check console for detailed logs and error information.`;
                
                alert(resultMessage);
                
                if (allPassed) {
                    updateConnectionStatus('connected', 'All systems operational');
                } else {
                    updateConnectionStatus('error', 'System issues detected');
                }
                
            } catch (error) {
                console.error('Enhanced diagnostics failed:', error);
                updateConnectionStatus('error', 'Diagnostics failed');
                alert(`Enhanced diagnostics failed: ${error.message}`);
            }
        }

        function getStatusEmoji(status) {
            switch (status) {
                case 'pass': return '🟢';
                case 'fail': return '🟡';
                case 'error': return '🔴';
                default: return '⚪';
            }
        }

        // Utility functions
        function updateConnectionStatus(status, message) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            indicator.className = 'status-indicator';
            if (status === 'connected') {
                indicator.classList.add('connected');
            }
            
            text.textContent = message;
        }

        function showError(message) {
            console.error('🚨 Dashboard Error:', message);
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-state';
            errorDiv.innerHTML = `
                <strong>Error:</strong> ${message}
                <br><small>Check browser console for detailed error information.</small>
                <br><br>
                <button class="btn btn-primary" onclick="runEnhancedDiagnostics()" style="margin-top: 0.5rem;">
                    Run Diagnostics
                </button>
            `;
            
            document.querySelector('.main-container').prepend(errorDiv);
            
            // Remove error after 15 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 15000);
        }

        // Add global functions for button access
        window.runEnhancedDiagnostics = runEnhancedDiagnostics;
        window.runComprehensiveAnalysis = runComprehensiveAnalysis;
        window.analyzeCreative = analyzeCreative;

        console.log('✅ NewsBreak Creative Intelligence Dashboard loaded successfully');
        console.log('🎯 Features: Real NewsBreak API integration, AI-powered analysis, comprehensive insights');
    </script>
</body>
</html>
