<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewsBreak Creative Intelligence Dashboard</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #059669;
            --warning-color: #d97706;
            --danger-color: #dc2626;
            --background: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: auto;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--danger-color);
        }

        .status-indicator.connected {
            background: var(--success-color);
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard-nav {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .nav-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .controls-panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-select, .form-input {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
            font-size: 0.875rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .stat-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-change {
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--danger-color);
        }

        .data-table {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .table-header {
            background: #f8fafc;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .table-controls {
            display: flex;
            gap: 0.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8fafc;
            padding: 0.75rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            position: sticky;
            top: 0;
        }

        th:hover {
            background: #e2e8f0;
        }

        td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
        }

        tr:hover {
            background: #f8fafc;
        }

        .creative-preview {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .creative-image {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            object-fit: cover;
            border: 1px solid var(--border-color);
        }

        .creative-text {
            flex: 1;
        }

        .creative-headline {
            font-weight: 500;
            margin-bottom: 0.25rem;
            line-height: 1.3;
        }

        .creative-description {
            color: var(--text-secondary);
            font-size: 0.75rem;
            line-height: 1.3;
        }

        .performance-metric {
            text-align: right;
            font-weight: 500;
        }

        .metric-positive {
            color: var(--success-color);
        }

        .metric-negative {
            color: var(--danger-color);
        }

        .metric-neutral {
            color: var(--text-secondary);
        }

        .creative-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .tag {
            background: #e0e7ff;
            color: #3730a3;
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
            font-size: 0.625rem;
            font-weight: 500;
        }

        .tag.high-performing {
            background: #dcfce7;
            color: #166534;
        }

        .tag.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .analysis-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .analysis-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .analysis-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-state {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            color: #991b1b;
            white-space: pre-line;
        }

        .warning-state {
            background: #fffbeb;
            border: 1px solid #fed7aa;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            color: #92400e;
            white-space: pre-line;
        }

        .ai-insights-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            font-size: 0.875rem;
        }

        .insight-item {
            opacity: 0.9;
        }

        .insight-value {
            font-weight: 600;
            font-size: 1.125rem;
            margin-top: 0.25rem;
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .analysis-panel {
                grid-template-columns: 1fr;
            }

            .dashboard-nav {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .nav-tab {
                font-size: 0.75rem;
                padding: 0.5rem 1rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">🎯 NewsBreak Creative Intelligence</div>
            <div class="connection-status">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">Initializing...</span>
            </div>
        </div>
    </header>

    <main class="main-container">
        <nav class="dashboard-nav">
            <button class="nav-tab active" data-tab="ad-data">📥 Creative Data</button>
            <button class="nav-tab" data-tab="creative-analysis">🧠 AI Analysis</button>
            <button class="nav-tab" data-tab="headline-analyzer">✍️ Headlines</button>
            <button class="nav-tab" data-tab="correlation-matrix">📊 Correlations</button>
            <button class="nav-tab" data-tab="ai-suggestions">⚡ AI Suggestions</button>
            <button class="nav-tab" data-tab="ab-testing">🧪 A/B Tests</button>
        </nav>

        <!-- Creative Data Tab -->
        <div class="tab-content active" id="ad-data">
            <div class="controls-panel">
                <div class="controls-grid">
                    <div class="form-group">
                        <label class="form-label">Traffic Source</label>
                        <select class="form-select" id="trafficSource">
                            <option value="newsbreak">NewsBreak</option>
                            <option value="facebook">Facebook</option>
                            <option value="taboola">Taboola</option>
                            <option value="voluum">Voluum</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date Range</label>
                        <select class="form-select" id="dateRange">
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="last7days">Last 7 Days</option>
                            <option value="last30days">Last 30 Days</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Campaign ID (Optional)</label>
                        <input type="text" class="form-input" id="campaignFilter" placeholder="Enter Campaign ID">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" id="loadDataBtn">Load Data</button>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">Total Campaigns</div>
                    <div class="stat-value" id="totalCampaigns">0</div>
                    <div class="stat-change" id="campaignsChange">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Active Creatives</div>
                    <div class="stat-value" id="activeCreatives">0</div>
                    <div class="stat-change" id="creativesChange">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Average CTR</div>
                    <div class="stat-value" id="avgCTR">0.00%</div>
                    <div class="stat-change" id="ctrChange">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Average ROAS</div>
                    <div class="stat-value" id="avgROAS">0.00x</div>
                    <div class="stat-change" id="roasChange">Loading...</div>
                </div>
            </div>

            <div class="data-table">
                <div class="table-header">
                    <h3 class="table-title">Live Creative Performance Data</h3>
                    <div class="table-controls">
                        <button class="btn btn-secondary" id="refreshData">Refresh</button>
                        <button class="btn btn-secondary" id="exportData">Export CSV</button>
                        <button class="btn btn-primary" id="runAnalysis">🤖 Run AI Analysis</button>
                    </div>
                </div>
                <div id="creativeTableContainer">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Loading REAL creative data from NewsBreak API...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Analysis Tab -->
        <div class="tab-content" id="creative-analysis">
            <div class="analysis-panel">
                <div class="analysis-card">
                    <h3 class="analysis-title">🎨 AI Image Analysis</h3>
                    <div id="imageAnalysisResults">
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <p>Click "Run AI Analysis" to analyze creatives...</p>
                        </div>
                    </div>
                </div>
                <div class="analysis-card">
                    <h3 class="analysis-title">📈 Performance by Creative Type</h3>
                    <div id="performanceByType">
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <p>Load creative data to see performance breakdown...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Headlines Tab -->
        <div class="tab-content" id="headline-analyzer">
            <div class="analysis-panel">
                <div class="analysis-card">
                    <h3 class="analysis-title">✍️ AI Headline Analysis</h3>
                    <div id="headlineAnalysis">
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <p>Click "Run AI Analysis" to analyze headlines...</p>
                        </div>
                    </div>
                </div>
                <div class="analysis-card">
                    <h3 class="analysis-title">🏆 Top Performing Headlines</h3>
                    <div id="topHeadlines">
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <p>Load creative data to see top headlines...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Correlations Tab -->
        <div class="tab-content" id="correlation-matrix">
            <div class="data-table">
                <div class="table-header">
                    <h3 class="table-title">📊 Performance Correlation Matrix</h3>
                </div>
                <div id="correlationMatrixContainer">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Load creative data to calculate correlations...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Suggestions Tab -->
        <div class="tab-content" id="ai-suggestions">
            <div class="analysis-panel">
                <div class="analysis-card">
                    <h3 class="analysis-title">⚡ AI Optimization Suggestions</h3>
                    <div id="aiSuggestions">
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <p>Click "Run AI Analysis" for optimization suggestions...</p>
                        </div>
                    </div>
                </div>
                <div class="analysis-card">
                    <h3 class="analysis-title">🎯 Scaling Opportunities</h3>
                    <div id="scalingOpportunities">
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <p>Load creative data to identify scaling opportunities...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- A/B Testing Tab -->
        <div class="tab-content" id="ab-testing">
            <div class="data-table">
                <div class="table-header">
                    <h3 class="table-title">🧪 A/B Test Recommendations</h3>
                    <div class="table-controls">
                        <button class="btn btn-primary" id="generateTests">Generate Test Ideas</button>
                    </div>
                </div>
                <div id="abTestContainer">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Click "Generate Test Ideas" for A/B test recommendations...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global variables
        let creativesData = [];
        let currentTab = 'ad-data';
        let analysisInProgress = false;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            loadInitialData();
        });

        function initializeEventListeners() {
            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // Data loading buttons
            document.getElementById('loadDataBtn').addEventListener('click', loadCreativeData);
            document.getElementById('refreshData').addEventListener('click', loadCreativeData);
            document.getElementById('exportData').addEventListener('click', exportToCSV);
            document.getElementById('runAnalysis').addEventListener('click', runComprehensiveAnalysis);
            document.getElementById('generateTests').addEventListener('click', loadABTests);

            // Traffic source change
            document.getElementById('trafficSource').addEventListener('change', function() {
                loadCreativeData();
            });
        }

        function switchTab(tabId) {
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

            // Show/hide content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');

            currentTab = tabId;

            // Load tab-specific data
            loadTabData(tabId);
        }

        function loadTabData(tabId) {
            if (!creativesData.length) {
                return; // No data to analyze
            }

            switch(tabId) {
                case 'creative-analysis':
                    // Will be handled by comprehensive analysis
                    break;
                case 'headline-analyzer':
                    updateTopHeadlines();
                    break;
                case 'correlation-matrix':
                    generateCorrelationMatrix();
                    break;
                case 'ai-suggestions':
                    updateScalingOpportunities();
                    break;
                case 'ab-testing':
                    // Will be handled by generate test ideas button
                    break;
            }
        }

        async function loadInitialData() {
            updateConnectionStatus('connecting', 'Initializing Creative Intelligence...');
            
            try {
                // Test API connections
                await testAPIConnections();
                updateConnectionStatus('connected', 'APIs Connected');
                
                // Load initial creative data
                await loadCreativeData();
            } catch (error) {
                console.error('Initialization error:', error);
                updateConnectionStatus('error', 'Connection Error');
                showError('Failed to initialize dashboard: ' + error.message);
            }
        }

        async function testAPIConnections() {
            const trafficSource = document.getElementById('trafficSource').value;
            
            if (trafficSource === 'newsbreak') {
                console.log('🧪 Testing NewsBreak API...');
                
                // Test environment variables
                const authTestResponse = await fetch('/api/newsbreak/auth-test');
                const authTestData = await authTestResponse.json();
                
                console.log('🔑 API Key test result:', authTestData);
                
                if (!authTestData.success || authTestData.api_key_status !== 'Found') {
                    throw new Error(`API Key Issue: ${authTestData.api_key_status}`);
                }
                
                // Test API connection
                const testResponse = await fetch('/api/newsbreak/test-connection');
                const testData = await testResponse.json();
                
                console.log('🔗 Connection test result:', testData);
                
                if (!testData.success) {
                    throw new Error(`Connection failed: ${testData.error}`);
                }
                
                console.log('✅ NewsBreak API operational');
            }
        }

        async function loadCreativeData() {
            const trafficSource = document.getElementById('trafficSource').value;
            const dateRange = document.getElementById('dateRange').value;
            const campaignFilter = document.getElementById('campaignFilter').value;

            updateConnectionStatus('connecting', 'Loading creative data...');

            try {
                let data;
                
                switch(trafficSource) {
                    case 'newsbreak':
                        data = await loadNewsBreakData(dateRange, campaignFilter);
                        break;
                    case 'facebook':
                        data = await loadFacebookData(dateRange, campaignFilter);
                        break;
                    case 'taboola':
                        data = await loadTaboolaData(dateRange, campaignFilter);
                        break;
                    case 'voluum':
                        data = await loadVoluumData(dateRange, campaignFilter);
                        break;
                    default:
                        throw new Error('Unsupported traffic source');
                }

                creativesData = data.creatives || [];
                
                // Update dashboard
                updateDashboardStats(data.stats);
                renderCreativeTable(creativesData);
                
                // Show source information
                if (data.source) {
                    console.log(`📊 Data source: ${data.source}`);
                    if (data.source === 'no_data_available') {
                        showWarning('No campaign data available for the selected criteria. Try:\n• Different date range\n• Check if campaigns are running\n• Contact your NewsBreak account manager');
                    }
                }
                
                updateConnectionStatus('connected', `Loaded ${creativesData.length} campaigns`);
                
            } catch (error) {
                console.error('Error loading creative data:', error);
                updateConnectionStatus('error', 'Data Loading Failed');
                showError('Failed to load creative data: ' + error.message);
            }
        }

        // UPDATED NewsBreak data loading - NO MOCK DATA
        async function loadNewsBreakData(dateRange, campaignFilter) {
            console.log('🔍 Loading NewsBreak data with enhanced API (NO MOCK DATA)...');
            
            try {
                const params = new URLSearchParams({
                    date_range: dateRange,
                    ...(campaignFilter && { campaign_id: campaignFilter })
                });

                console.log('📊 Fetching REAL campaign data from enhanced API...');
                
                // Try enhanced API first
                let response = await fetch(`/api/newsbreak/enhanced-campaigns?${params}`);
                let data;

                if (response.ok) {
                    data = await response.json();
                    console.log('✅ Enhanced API response:', data);
                } else {
                    console.log('⚠️ Enhanced API not available, trying campaigns-fixed...');
                    // Fallback to existing API
                    response = await fetch(`/api/newsbreak/campaigns-fixed?${params}`);
                    data = await response.json();
                }

                // CHECK FOR MOCK DATA AND ALERT USER
                if (!data.success && data.debug?.note === "Using mock data - API returned 400") {
                    console.error('❌ API is returning mock data due to API errors');
                    
                    const errorMessage = `⚠️ MOCK DATA DETECTED

Your NewsBreak API is returning errors, so mock data is being shown.

API Error Details:
• Error: "${data.debug.api_error?.errMsg}"
• This means your NewsBreak API access may be limited
• Contact your NewsBreak Account Manager for assistance

IMPORTANT: The data you see is NOT REAL campaign data.`;

                    showError(errorMessage);
                    
                    // Don't proceed with mock data - return empty instead
                    return {
                        creatives: [],
                        stats: {
                            totalCampaigns: 0,
                            activeCreatives: 0,
                            avgCTR: 0,
                            avgROAS: 0
                        },
                        source: 'mock_data_rejected'
                    };
                }

                console.log(`✅ Data loaded - Source: ${data.source || 'unknown'}`);
                console.log(`📊 Campaigns found: ${data.campaigns?.length || 0}`);

                // If no real data available, show a clear message
                if (!data.campaigns || data.campaigns.length === 0) {
                    if (data.message) {
                        showWarning(data.message);
                    } else {
                        showWarning('No campaign data available. This may indicate:\n• No active campaigns in the selected date range\n• API access limitations\n• Contact your NewsBreak account manager for assistance');
                    }
                }

                // Transform data to dashboard format
                return {
                    creatives: data.campaigns?.map(campaign => ({
                        id: campaign.id,
                        name: campaign.name,
                        headline: campaign.headline || 'No headline available',
                        description: campaign.description || '',
                        imageUrl: campaign.imageUrl || '',
                        campaignId: campaign.campaignId,
                        spend: campaign.spend || 0,
                        ctr: campaign.ctr || 0,
                        roas: campaign.roas || 0,
                        cpa: campaign.cpa || 0,
                        conversions: campaign.conversions || 0,
                        impressions: campaign.impressions || 0,
                        deviceType: campaign.deviceType || 'All',
                        geo: campaign.geo || 'US',
                        status: campaign.status || 'Active',
                        
                        // Enhanced data if available
                        creativeCount: campaign.creativeCount || 1,
                        adSets: campaign.adSets || [],
                        ads: campaign.ads || [],
                        rawCampaignData: campaign.rawCampaignData
                    })) || [],
                    stats: {
                        totalCampaigns: data.summary?.totalCampaigns || 0,
                        activeCreatives: data.summary?.activeCreatives || 0,
                        avgCTR: data.summary?.avgCTR || 0,
                        avgROAS: data.summary?.avgROAS || 0,
                        
                        // Enhanced stats if available
                        activeCampaigns: data.summary?.activeCampaigns || 0,
                        totalSpend: data.summary?.totalSpend || 0,
                        totalRevenue: data.summary?.totalRevenue || 0,
                        averageCreativesPerCampaign: data.summary?.averageCreativesPerCampaign || 0,
                        topPerformingCampaigns: data.summary?.topPerformingCampaigns || []
                    },
                    metadata: data.metadata,
                    source: data.source
                };
            } catch (error) {
                console.error('❌ NewsBreak data loading error:', error);
                throw error;
            }
        }

        // Placeholder functions for other traffic sources
        async function loadFacebookData(dateRange, campaignFilter) {
            console.log('📘 Loading Facebook data...');
            return {
                creatives: [],
                stats: { totalCampaigns: 0, activeCreatives: 0, avgCTR: 0, avgROAS: 0 }
            };
        }

        async function loadTaboolaData(dateRange, campaignFilter) {
            console.log('📰 Loading Taboola data...');
            return {
                creatives: [],
                stats: { totalCampaigns: 0, activeCreatives: 0, avgCTR: 0, avgROAS: 0 }
            };
        }

        async function loadVoluumData(dateRange, campaignFilter) {
            console.log('📊 Loading Voluum data...');
            try {
                const params = new URLSearchParams({
                    range: dateRange,
                    ...(campaignFilter && { campaignId: campaignFilter })
                });

                const response = await fetch(`/api/voluum/campaigns?${params}`);
                
                if (!response.ok) {
                    throw new Error('Voluum API request failed');
                }

                const data = await response.json();
                
                return {
                    creatives: data.campaigns?.map(campaign => ({
                        id: campaign.id,
                        name: campaign.name,
                        headline: extractHeadlineFromName(campaign.name),
                        description: campaign.name,
                        imageUrl: '',
                        campaignId: campaign.id,
                        spend: campaign.cost || 0,
                        ctr: campaign.cvr || 0,
                        roas: campaign.currentRoas || 0,
                        cpa: campaign.cpa || 0,
                        conversions: campaign.conversions || 0,
                        impressions: campaign.visits || 0,
                        deviceType: 'Unknown',
                        geo: 'Unknown',
                        status: campaign.status || 'Active'
                    })) || [],
                    stats: {
                        totalCampaigns: data.campaigns?.length || 0,
                        activeCreatives: data.campaigns?.length || 0,
                        avgCTR: calculateAverage(data.campaigns || [], 'cvr'),
                        avgROAS: calculateAverage(data.campaigns || [], 'currentRoas')
                    }
                };
            } catch (error) {
                console.error('Voluum data loading error:', error);
                throw error;
            }
        }

        function extractHeadlineFromName(campaignName) {
            const cleaned = campaignName.replace(/[_-]/g, ' ');
            return cleaned.length > 50 ? cleaned.substring(0, 50) + '...' : cleaned;
        }

        function calculateAverage(data, field) {
            if (!data.length) return 0;
            const sum = data.reduce((acc, item) => acc + (item[field] || 0), 0);
            return sum / data.length;
        }

        function updateDashboardStats(stats) {
            document.getElementById('totalCampaigns').textContent = stats.totalCampaigns || 0;
            document.getElementById('activeCreatives').textContent = stats.activeCreatives || 0;
            document.getElementById('avgCTR').textContent = ((stats.avgCTR || 0) * 100).toFixed(2) + '%';
            document.getElementById('avgROAS').textContent = (stats.avgROAS || 0).toFixed(2) + 'x';

            // Add change indicators
            updateChangeIndicator('campaignsChange', 0);
            updateChangeIndicator('creativesChange', 0);
            updateChangeIndicator('ctrChange', 0);
            updateChangeIndicator('roasChange', 0);
        }

        function updateChangeIndicator(elementId, change) {
            const element = document.getElementById(elementId);
            const changeText = change > 0 ? `+${change.toFixed(1)}%` : `${change.toFixed(1)}%`;
            element.textContent = changeText;
            element.className = `stat-change ${change >= 0 ? 'positive' : 'negative'}`;
        }

        function renderCreativeTable(creatives) {
            const container = document.getElementById('creativeTableContainer');
            
            if (!creatives.length) {
                container.innerHTML = '<div class="loading-state"><p>No creative data found for the selected criteria.</p></div>';
                return;
            }

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortTable('name')">Creative</th>
                            <th onclick="sortTable('ctr')">CTR</th>
                            <th onclick="sortTable('roas')">ROAS</th>
                            <th onclick="sortTable('spend')">Spend</th>
                            <th onclick="sortTable('conversions')">Conv</th>
                            <th onclick="sortTable('cpa')">CPA</th>
                            <th onclick="sortTable('deviceType')">Device</th>
                            <th>Tags</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${creatives.map(creative => `
                            <tr onclick="analyzeCreative('${creative.id}')">
                                <td>
                                    <div class="creative-preview">
                                        ${creative.imageUrl ? 
                                            `<img src="${creative.imageUrl}" alt="Creative" class="creative-image" onerror="this.src='data:image/svg+xml,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;60&quot; height=&quot;60&quot; viewBox=&quot;0 0 60 60&quot;><rect width=&quot;60&quot; height=&quot;60&quot; fill=&quot;%23f3f4f6&quot;/><text x=&quot;30&quot; y=&quot;35&quot; text-anchor=&quot;middle&quot; fill=&quot;%236b7280&quot; font-size=&quot;12&quot;>IMG</text></svg>'">` : 
                                            `<div class="creative-image" style="background: #f3f4f6; display: flex; align-items: center; justify-content: center; color: #6b7280; font-size: 10px;">IMG</div>`
                                        }
                                        <div class="creative-text">
                                            <div class="creative-headline">${creative.headline}</div>
                                            <div class="creative-description">${creative.description}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="performance-metric ${getMetricClass(creative.ctr, 0.01)}">${(creative.ctr * 100).toFixed(2)}%</td>
                                <td class="performance-metric ${getMetricClass(creative.roas, 1.0)}">${creative.roas.toFixed(2)}x</td>
                                <td class="performance-metric">$${creative.spend.toFixed(2)}</td>
                                <td class="performance-metric">${creative.conversions}</td>
                                <td class="performance-metric ${getMetricClass(creative.cpa, 50, true)}">${creative.cpa.toFixed(2)}</td>
                                <td>${creative.deviceType}</td>
                                <td>
                                    <div class="creative-tags">
                                        ${generateCreativeTags(creative).map(tag => `<span class="tag ${tag.type}">${tag.text}</span>`).join('')}
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        function getMetricClass(value, threshold, inverse = false) {
            if (inverse) {
                return value < threshold ? 'metric-positive' : 'metric-negative';
            }
            return value >= threshold ? 'metric-positive' : 'metric-negative';
        }

        function generateCreativeTags(creative) {
            const tags = [];
            
            if (creative.roas >= 2.0) tags.push({ text: 'High ROAS', type: 'high-performing' });
            if (creative.ctr >= 0.02) tags.push({ text: 'High CTR', type: 'high-performing' });
            if (creative.roas < 1.0) tags.push({ text: 'Low ROAS', type: 'warning' });
            if (creative.conversions === 0) tags.push({ text: 'No Conv', type: 'warning' });
            
            // Add tags based on headline analysis
            if (creative.headline.toLowerCase().includes('free')) tags.push({ text: 'Free Offer', type: '' });
            if (/\d+/.test(creative.headline)) tags.push({ text: 'Number Hook', type: '' });
            if (creative.headline.includes('?')) tags.push({ text: 'Question', type: '' });
            
            return tags;
        }

        let sortDirection = {};
        function sortTable(column) {
            const direction = sortDirection[column] === 'asc' ? 'desc' : 'asc';
            sortDirection[column] = direction;
            
            creativesData.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (direction === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });
            
            renderCreativeTable(creativesData);
        }

        // AI Analysis Functions
        async function runComprehensiveAnalysis() {
            if (!creativesData.length) {
                alert('Please load creative data first before running AI analysis.');
                return;
            }

            if (analysisInProgress) {
                alert('Analysis already in progress. Please wait...');
                return;
            }

            analysisInProgress = true;
            
            try {
                updateConnectionStatus('connecting', 'Running AI analysis...');
                
                // Check if creative analysis API exists
                const response = await fetch('/api/newsbreak/creative-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        campaigns: creativesData.slice(0, 10), // Limit for testing
                        analysisType: 'comprehensive'
                    })
                });

                if (response.ok) {
                    const analysisData = await response.json();
                    
                    if (analysisData.success) {
                        // Update analysis tabs with AI results
                        updateAnalysisResults(analysisData.data);
                        updateConnectionStatus('connected', 'AI analysis completed');
                        alert('🤖 AI Analysis Complete!\n\nCheck the other tabs for detailed insights.');
                    } else {
                        throw new Error(analysisData.error || 'AI analysis failed');
                    }
                } else {
                    // Fallback to local analysis if AI API not available
                    console.log('AI API not available, running local analysis...');
                    runLocalAnalysis();
                    updateConnectionStatus('connected', 'Local analysis completed');
                    alert('📊 Analysis Complete!\n\nUsing local analysis methods. Check other tabs for insights.');
                }
                
            } catch (error) {
                console.error('Analysis error:', error);
                // Fallback to local analysis
                runLocalAnalysis();
                updateConnectionStatus('connected', 'Local analysis completed');
                alert('📊 Analysis Complete!\n\nUsing local analysis methods due to API limitations.');
            } finally {
                analysisInProgress = false;
            }
        }

        function runLocalAnalysis() {
            // Run local analysis methods
            updateTopHeadlines();
            generateCorrelationMatrix();
            updateScalingOpportunities();
            updateImageAnalysis();
        }

        function updateAnalysisResults(analysisData) {
            // Update image analysis if available
            if (analysisData.imageAnalysis) {
                const container = document.getElementById('imageAnalysisResults');
                container.innerHTML = `
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 6px;">
                        <h4 style="font-weight: 600; margin-bottom: 1rem; color: var(--primary-color);">🎯 AI Analysis Results</h4>
                        <pre style="white-space: pre-wrap; font-family: inherit; font-size: 0.875rem; line-height: 1.5;">${analysisData.imageAnalysis.analysis || 'Analysis completed'}</pre>
                    </div>
                `;
            }

            // Update other analysis sections
            if (analysisData.headlineAnalysis) {
                updateTopHeadlines(analysisData.headlineAnalysis.topHeadlines);
            }

            if (analysisData.aiSuggestions) {
                const container = document.getElementById('aiSuggestions');
                container.innerHTML = `
                    <div style="background: #eff6ff; padding: 1rem; border-radius: 6px; border-left: 4px solid var(--primary-color);">
                        <h4 style="font-weight: 600; margin-bottom: 1rem; color: var(--primary-color);">🤖 AI Optimization Suggestions</h4>
                        <pre style="white-space: pre-wrap; font-family: inherit; font-size: 0.875rem; line-height: 1.5;">${analysisData.aiSuggestions.suggestions}</pre>
                    </div>
                `;
            }
        }

        function updateImageAnalysis() {
            const container = document.getElementById('imageAnalysisResults');
            
            if (!creativesData.length) {
                container.innerHTML = '<p>No creative data available for analysis.</p>';
                return;
            }

            const creativesWithImages = creativesData.filter(c => c.imageUrl);
            const highPerformers = creativesData.filter(c => c.roas >= 2.0);
            const lowPerformers = creativesData.filter(c => c.roas < 1.0);

            const analysisHTML = `
                <div style="background: #f8fafc; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                    <h4 style="font-weight: 600; margin-bottom: 1rem; color: var(--primary-color);">📊 Creative Analysis Summary</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div style="padding: 1rem; background: white; border-radius: 6px; border: 1px solid var(--border-color);">
                            <div style="font-weight: 600; color: var(--success-color);">High Performers</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${highPerformers.length}</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">ROAS ≥ 2.0x</div>
                        </div>
                        
                        <div style="padding: 1rem; background: white; border-radius: 6px; border: 1px solid var(--border-color);">
                            <div style="font-weight: 600; color: var(--primary-color);">With Images</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${creativesWithImages.length}</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">Have image URLs</div>
                        </div>
                        
                        <div style="padding: 1rem; background: white; border-radius: 6px; border: 1px solid var(--border-color);">
                            <div style="font-weight: 600; color: var(--warning-color);">Low Performers</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${lowPerformers.length}</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">ROAS < 1.0x</div>
                        </div>
                    </div>

                    <div style="margin-top: 1rem;">
                        <h5 style="font-weight: 600; margin-bottom: 0.5rem;">💡 Key Insights:</h5>
                        <ul style="margin-left: 1rem; space-y: 0.25rem; font-size: 0.875rem;">
                            <li>Performance ratio: ${highPerformers.length}:${lowPerformers.length} (high:low performers)</li>
                            <li>Image coverage: ${Math.round((creativesWithImages.length / creativesData.length) * 100)}% of campaigns have images</li>
                            <li>Average ROAS: ${(creativesData.reduce((sum, c) => sum + c.roas, 0) / creativesData.length).toFixed(2)}x</li>
                            ${highPerformers.length > 0 ? `<li>Top performer ROAS: ${Math.max(...highPerformers.map(c => c.roas)).toFixed(2)}x</li>` : ''}
                        </ul>
                    </div>
                </div>
            `;
            
            container.innerHTML = analysisHTML;

            // Update performance by type
            const typeContainer = document.getElementById('performanceByType');
            const creativeTypes = analyzeCreativeTypes();
            
            const typeHTML = `
                <div style="background: #f8fafc; padding: 1rem; border-radius: 6px;">
                    <h4 style="font-weight: 600; margin-bottom: 1rem; color: var(--primary-color);">📈 Performance by Creative Type</h4>
                    ${creativeTypes.map(type => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 0.5rem;">
                            <span style="font-weight: 500;">${type.name}</span>
                            <div style="text-align: right;">
                                <div style="font-weight: 600; color: var(--success-color);">🚀 Scale Opportunity</div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.875rem; font-weight: 600;">${candidate.roas.toFixed(2)}x ROAS</div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">${candidate.spend.toFixed(2)} spent</div>
                                </div>
                            </div>
                            <div style="font-weight: 500; margin-bottom: 0.5rem;">${candidate.name}</div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-secondary);">
                                <span>Current Budget: ${candidate.spend.toFixed(2)}</span>
                                <span style="color: var(--success-color); font-weight: 500;">
                                    Recommended: ${(candidate.spend * 2).toFixed(2)} 
                                    (+100%)
                                </span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            container.innerHTML = opportunitiesHTML;
        }

        async function loadABTests() {
            const container = document.getElementById('abTestContainer');
            
            if (!creativesData.length) {
                container.innerHTML = '<p>No creative data available for A/B test recommendations.</p>';
                return;
            }

            container.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Generating A/B test recommendations...</p></div>';

            // Generate local A/B test recommendations
            const testCandidates = creativesData.filter(c => 
                c.spend > 50 && 
                c.conversions >= 2 && 
                c.roas > 1.0
            ).sort((a, b) => b.spend - a.spend);

            const testRecommendations = testCandidates.slice(0, 10).map(campaign => {
                const tests = [];
                
                // Headline tests
                if (campaign.headline.length > 50) {
                    tests.push({
                        type: 'Headline Length',
                        hypothesis: 'Shorter headlines will improve CTR',
                        expectedLift: '+15% CTR',
                        priority: 'High'
                    });
                }
                
                if (!/\d/.test(campaign.headline)) {
                    tests.push({
                        type: 'Number Addition',
                        hypothesis: 'Adding specific numbers improves performance',
                        expectedLift: '+12% ROAS',
                        priority: 'Medium'
                    });
                }
                
                if (campaign.ctr < 0.02) {
                    tests.push({
                        type: 'CTR Optimization',
                        hypothesis: 'More compelling hook will improve CTR',
                        expectedLift: '+25% CTR',
                        priority: 'High'
                    });
                }
                
                return {
                    campaignId: campaign.id,
                    campaignName: campaign.name,
                    currentPerformance: {
                        roas: campaign.roas,
                        ctr: campaign.ctr,
                        spend: campaign.spend
                    },
                    recommendedTests: tests
                };
            });

            const testsHTML = `
                <div class="ab-tests-container">
                    <div style="margin-bottom: 1rem; padding: 1rem; background: #f0f9ff; border-radius: 6px;">
                        <h4 style="font-weight: 600; color: var(--primary-color);">
                            📊 A/B Test Recommendations
                        </h4>
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">
                            ${testCandidates.length} campaigns identified for testing
                        </p>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8fafc;">
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">Campaign</th>
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">Current Performance</th>
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">Recommended Tests</th>
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">Priority</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${testRecommendations.map(rec => `
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td style="padding: 0.75rem; font-size: 0.875rem;">
                                        <div style="font-weight: 500; margin-bottom: 0.25rem;">${rec.campaignName}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">ID: ${rec.campaignId}</div>
                                    </td>
                                    <td style="padding: 0.75rem; font-size: 0.875rem;">
                                        <div style="margin-bottom: 0.25rem;">ROAS: ${rec.currentPerformance.roas.toFixed(2)}x</div>
                                        <div style="margin-bottom: 0.25rem;">CTR: ${(rec.currentPerformance.ctr * 100).toFixed(2)}%</div>
                                        <div style="color: var(--text-secondary);">Spend: ${rec.currentPerformance.spend.toFixed(2)}</div>
                                    </td>
                                    <td style="padding: 0.75rem; font-size: 0.875rem;">
                                        ${rec.recommendedTests.map(test => `
                                            <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8fafc; border-radius: 4px;">
                                                <div style="font-weight: 500; margin-bottom: 0.25rem;">${test.type}</div>
                                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">${test.hypothesis}</div>
                                                <div style="font-size: 0.75rem; color: var(--success-color); font-weight: 500;">${test.expectedLift}</div>
                                            </div>
                                        `).join('')}
                                    </td>
                                    <td style="padding: 0.75rem; font-size: 0.875rem;">
                                        ${rec.recommendedTests.map(test => `
                                            <span class="tag ${test.priority === 'High' ? 'high-performing' : test.priority === 'Medium' ? 'warning' : ''}" style="display: inline-block; margin-bottom: 0.25rem;">
                                                ${test.priority}
                                            </span>
                                        `).join('<br>')}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = testsHTML;
        }

        // Individual creative analysis
        function analyzeCreative(creativeId) {
            const creative = creativesData.find(c => c.id === creativeId);
            if (!creative) return;

            console.log('🔍 Analyzing individual creative:', creative);
            
            // Switch to creative analysis tab
            switchTab('creative-analysis');
            
            // Show individual creative analysis
            const container = document.getElementById('imageAnalysisResults');
            container.innerHTML = `
                <div style="background: #f8fafc; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                    <h4 style="font-weight: 600; margin-bottom: 1rem; color: var(--primary-color);">🔍 Individual Creative Analysis</h4>
                    
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        ${creative.imageUrl ? 
                            `<img src="${creative.imageUrl}" alt="Creative" style="width: 120px; height: 120px; object-fit: cover; border-radius: 6px; border: 1px solid var(--border-color);">` : 
                            `<div style="width: 120px; height: 120px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; color: #6b7280; border-radius: 6px; border: 1px solid var(--border-color);">No Image</div>`
                        }
                        <div style="flex: 1;">
                            <h5 style="font-weight: 600; margin-bottom: 0.5rem;">${creative.headline}</h5>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">${creative.description}</p>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">ROAS</div>
                                    <div style="font-weight: 600; color: ${creative.roas >= 2 ? 'var(--success-color)' : creative.roas >= 1 ? 'var(--warning-color)' : 'var(--danger-color)'};">${creative.roas.toFixed(2)}x</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">CTR</div>
                                    <div style="font-weight: 600;">${(creative.ctr * 100).toFixed(2)}%</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Spend</div>
                                    <div style="font-weight: 600;">${creative.spend.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Conversions</div>
                                    <div style="font-weight: 600;">${creative.conversions}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 1rem;">
                        <h5 style="font-weight: 600; margin-bottom: 0.5rem;">📊 Performance Analysis:</h5>
                        <ul style="margin-left: 1rem; space-y: 0.25rem; font-size: 0.875rem;">
                            ${creative.roas >= 2 ? '<li style="color: var(--success-color);">✅ High ROAS - Consider scaling budget</li>' : ''}
                            ${creative.roas < 1 ? '<li style="color: var(--danger-color);">⚠️ Low ROAS - Needs optimization or pause</li>' : ''}
                            ${creative.ctr >= 0.02 ? '<li style="color: var(--success-color);">✅ High CTR - Strong creative appeal</li>' : ''}
                            ${creative.ctr < 0.01 ? '<li style="color: var(--warning-color);">⚠️ Low CTR - Consider headline/image optimization</li>' : ''}
                            ${creative.conversions === 0 ? '<li style="color: var(--danger-color);">⚠️ No conversions - Check targeting or landing page</li>' : ''}
                            ${/\d+/.test(creative.headline) ? '<li>✅ Uses numbers in headline</li>' : '<li>💡 Consider adding specific numbers to headline</li>'}
                            ${creative.headline.includes('?') ? '<li>✅ Uses question format</li>' : '<li>💡 Consider testing question-based headlines</li>'}
                            ${creative.headline.length > 60 ? '<li>💡 Headline is long - test shorter versions for mobile</li>' : ''}
                        </ul>
                    </div>

                    <div style="margin-top: 1rem;">
                        <h5 style="font-weight: 600; margin-bottom: 0.5rem;">💡 Optimization Recommendations:</h5>
                        <div style="background: #eff6ff; padding: 1rem; border-radius: 6px; border-left: 4px solid var(--primary-color);">
                            ${generateOptimizationRecommendations(creative)}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateOptimizationRecommendations(creative) {
            const recommendations = [];
            
            if (creative.roas >= 2 && creative.conversions >= 5) {
                recommendations.push('🚀 <strong>Scale Budget:</strong> This creative is performing well. Consider increasing budget by 50-100%.');
            }
            
            if (creative.ctr < 0.015) {
                recommendations.push('📝 <strong>Optimize Headline:</strong> CTR is below average. Test more compelling hooks or emotional triggers.');
            }
            
            if (creative.roas < 1.0) {
                recommendations.push('⚠️ <strong>Pause or Optimize:</strong> This creative is unprofitable. Consider pausing or major optimization.');
            }
            
            if (!creative.imageUrl) {
                recommendations.push('🖼️ <strong>Add Image:</strong> Creatives with images typically perform better. Add a relevant visual.');
            }
            
            if (creative.headline.length > 60) {
                recommendations.push('✂️ <strong>Shorten Headline:</strong> Long headlines may perform poorly on mobile. Test shorter versions.');
            }
            
            if (!/\d+/.test(creative.headline)) {
                recommendations.push('🔢 <strong>Add Numbers:</strong> Headlines with specific numbers often perform better. Test "7 tips" instead of "tips".');
            }
            
            if (creative.conversions > 0 && creative.cpa > 50) {
                recommendations.push('💰 <strong>Lower CPA:</strong> Cost per acquisition is high. Optimize targeting or improve conversion rate.');
            }
            
            if (recommendations.length === 0) {
                recommendations.push('✅ <strong>Good Performance:</strong> This creative is performing well. Monitor for creative fatigue over time.');
            }
            
            return recommendations.join('<br><br>');
        }

        // Export functionality
        function exportToCSV() {
            if (!creativesData.length) {
                alert('No data to export. Please load creative data first.');
                return;
            }

            const csvHeaders = [
                'Creative ID', 'Campaign ID', 'Headline', 'Description', 'Image URL',
                'Spend', 'CTR', 'ROAS', 'CPA', 'Conversions', 'Impressions',
                'Device Type', 'Geo', 'Status'
            ];

            const csvRows = creativesData.map(creative => [
                creative.id,
                creative.campaignId,
                `"${creative.headline.replace(/"/g, '""')}"`,
                `"${creative.description.replace(/"/g, '""')}"`,
                creative.imageUrl,
                creative.spend.toFixed(2),
                (creative.ctr * 100).toFixed(4),
                creative.roas.toFixed(4),
                creative.cpa.toFixed(2),
                creative.conversions,
                creative.impressions,
                creative.deviceType,
                creative.geo,
                creative.status
            ]);

            const csvContent = [csvHeaders, ...csvRows]
                .map(row => row.join(','))
                .join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `newsbreak_creative_performance_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Enhanced diagnostic function - Updated to work with new APIs
        async function runEnhancedDiagnostics() {
            console.log('🔍 Running enhanced diagnostic tests...');
            updateConnectionStatus('connecting', 'Running enhanced diagnostics...');
            
            try {
                const diagnosticResults = {
                    envVars: { status: 'unknown', details: null },
                    apiConnection: { status: 'unknown', details: null },
                    enhancedAPI: { status: 'unknown', details: null },
                    workingAPI: { status: 'unknown', details: null }
                };

                // Test 1: Environment Variables
                console.log('🧪 Test 1: Checking environment variables...');
                try {
                    const authResponse = await fetch('/api/newsbreak/auth-test');
                    const authData = await authResponse.json();
                    diagnosticResults.envVars = { 
                        status: authData.success ? 'pass' : 'fail', 
                        details: authData 
                    };
                } catch (error) {
                    diagnosticResults.envVars = { status: 'error', details: error.message };
                }

                // Test 2: Basic API Connection
                console.log('🧪 Test 2: Testing basic API connection...');
                try {
                    const connResponse = await fetch('/api/newsbreak/test-connection');
                    const connData = await connResponse.json();
                    diagnosticResults.apiConnection = { 
                        status: connData.success ? 'pass' : 'fail', 
                        details: connData 
                    };
                } catch (error) {
                    diagnosticResults.apiConnection = { status: 'error', details: error.message };
                }

                // Test 3: Enhanced API Endpoints
                console.log('🧪 Test 3: Testing enhanced API endpoints...');
                try {
                    const enhancedResponse = await fetch('/api/newsbreak/enhanced-campaigns?date_range=last7days');
                    const enhancedData = await enhancedResponse.json();
                    diagnosticResults.enhancedAPI = { 
                        status: enhancedData.success ? 'pass' : 'fail', 
                        details: enhancedData 
                    };
                } catch (error) {
                    diagnosticResults.enhancedAPI = { status: 'error', details: error.message };
                }

                // Test 4: Working API Endpoints (campaigns-fixed) 
                console.log('🧪 Test 4: Testing fallback API endpoints...');
                try {
                    const workingResponse = await fetch('/api/newsbreak/campaigns-fixed?date_range=last7days');
                    const workingData = await workingResponse.json();
                    diagnosticResults.workingAPI = { 
                        status: workingData.success ? 'pass' : 'fail', 
                        details: workingData 
                    };
                } catch (error) {
                    diagnosticResults.workingAPI = { status: 'error', details: error.message };
                }

                // Display comprehensive results
                console.log('📊 Enhanced Diagnostic Results:', diagnosticResults);
                
                const criticalPassed = diagnosticResults.envVars.status === 'pass' && 
                                     diagnosticResults.apiConnection.status === 'pass' && 
                                     (diagnosticResults.enhancedAPI.status === 'pass' ||
                                      diagnosticResults.workingAPI.status === 'pass');
                
                const resultMessage = `Enhanced Diagnostic Results:
                
✓ Environment Variables: ${getStatusEmoji(diagnosticResults.envVars.status)} ${diagnosticResults.envVars.status.toUpperCase()}
✓ Basic API Connection: ${getStatusEmoji(diagnosticResults.apiConnection.status)} ${diagnosticResults.apiConnection.status.toUpperCase()}  
✓ Enhanced API Endpoints: ${getStatusEmoji(diagnosticResults.enhancedAPI.status)} ${diagnosticResults.enhancedAPI.status.toUpperCase()}
✓ Fallback API Endpoints: ${getStatusEmoji(diagnosticResults.workingAPI.status)} ${diagnosticResults.workingAPI.status.toUpperCase()}

Overall System Status: ${criticalPassed ? '✅ READY FOR PRODUCTION' : '⚠️ ISSUES DETECTED'}

${diagnosticResults.workingAPI.details?.debug?.note === "Using mock data - API returned 400" ? 
  '⚠️ WARNING: System is falling back to mock data due to API errors.\nContact your NewsBreak Account Manager to resolve API access issues.' : 
  'Dashboard will show real campaign data when available.'}

Check console for detailed logs and error information.`;
                
                alert(resultMessage);
                
                if (criticalPassed) {
                    updateConnectionStatus('connected', 'System ready - loading data...');
                    await loadCreativeData();
                } else {
                    updateConnectionStatus('error', 'Critical system issues detected');
                }
                
            } catch (error) {
                console.error('Enhanced diagnostics failed:', error);
                updateConnectionStatus('error', 'Diagnostics failed');
                alert(`Enhanced diagnostics failed: ${error.message}`);
            }
        }

        function getStatusEmoji(status) {
            switch (status) {
                case 'pass': return '🟢';
                case 'fail': return '🟡';
                case 'error': return '🔴';
                default: return '⚪';
            }
        }

        // Utility functions
        function updateConnectionStatus(status, message) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            indicator.className = 'status-indicator';
            if (status === 'connected') {
                indicator.classList.add('connected');
            }
            
            text.textContent = message;
        }

        function showError(message) {
            console.error('🚨 Dashboard Error:', message);
            
            // Remove existing error messages
            const existingErrors = document.querySelectorAll('.error-state');
            existingErrors.forEach(error => error.remove());
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-state';
            errorDiv.innerHTML = `
                <strong>⚠️ IMPORTANT:</strong> ${message}
                <br><br>
                <button class="btn btn-primary" onclick="runEnhancedDiagnostics()" style="margin-top: 0.5rem;">
                    Run Diagnostics
                </button>
            `;
            
            document.querySelector('.main-container').prepend(errorDiv);
            
            // Remove error after 30 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 30000);
        }

        function showWarning(message) {
            console.warn('⚠️ Dashboard Warning:', message);
            
            // Remove existing warning messages
            const existingWarnings = document.querySelectorAll('.warning-state');
            existingWarnings.forEach(warning => warning.remove());
            
            const warningDiv = document.createElement('div');
            warningDiv.className = 'warning-state';
            warningDiv.innerHTML = `
                <strong>ℹ️ Information:</strong> ${message}
            `;
            
            document.querySelector('.main-container').prepend(warningDiv);
            
            // Remove warning after 20 seconds
            setTimeout(() => {
                if (warningDiv.parentNode) {
                    warningDiv.parentNode.removeChild(warningDiv);
                }
            }, 20000);
        }

        // Add global functions for button access
        window.runEnhancedDiagnostics = runEnhancedDiagnostics;
        window.runComprehensiveAnalysis = runComprehensiveAnalysis;
        window.analyzeCreative = analyzeCreative;

        console.log('✅ NewsBreak Creative Intelligence Dashboard loaded successfully');
        console.log('🎯 Features: REAL NewsBreak API integration, No Mock Data, Production ready');
        console.log('⚠️ MOCK DATA DETECTION: Dashboard will alert you if mock data is detected');
    </script>
</body>
</html>: ${type.avgRoas >= 1.5 ? 'var(--success-color)' : 'var(--warning-color)'};">
                                    ${type.avgRoas.toFixed(2)}x ROAS
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                    ${type.count} campaigns
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            typeContainer.innerHTML = typeHTML;
        }

        function analyzeCreativeTypes() {
            const types = [
                {
                    name: 'Financial Content',
                    filter: c => /money|financial|save|cash|earn/i.test(c.headline)
                },
                {
                    name: 'Insurance Related',
                    filter: c => /insurance|coverage|protect/i.test(c.headline)
                },
                {
                    name: 'Question Headlines',
                    filter: c => c.headline.includes('?')
                },
                {
                    name: 'Number Headlines',
                    filter: c => /\d+/.test(c.headline)
                },
                {
                    name: 'Other',
                    filter: c => true
                }
            ];

            return types.map(type => {
                const matching = creativesData.filter(type.filter);
                return {
                    name: type.name,
                    count: matching.length,
                    avgRoas: matching.length > 0 ? matching.reduce((sum, c) => sum + c.roas, 0) / matching.length : 0,
                    avgCtr: matching.length > 0 ? matching.reduce((sum, c) => sum + c.ctr, 0) / matching.length : 0
                };
            }).filter(type => type.count > 0);
        }

        function updateTopHeadlines(topHeadlines = null) {
            const container = document.getElementById('topHeadlines');
            
            if (!creativesData.length) {
                container.innerHTML = '<p>No creative data available.</p>';
                return;
            }

            // Use provided data or calculate locally
            const headlines = topHeadlines || creativesData
                .sort((a, b) => b.roas - a.roas)
                .slice(0, 10);

            const headlinesHTML = `
                <div>
                    <div style="background: #f0f9ff; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                        <h4 style="font-weight: 600; color: var(--primary-color);">🏆 Top Performing Headlines</h4>
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">Ranked by ROAS performance</p>
                    </div>
                    ${headlines.map((headline, index) => `
                        <div style="padding: 1rem; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <span style="font-weight: 600; color: var(--primary-color);">#${index + 1}</span>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.875rem; color: var(--success-color); font-weight: 600;">${headline.roas.toFixed(2)}x ROAS</div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">${(headline.ctr * 100).toFixed(2)}% CTR</div>
                                </div>
                            </div>
                            <div style="font-weight: 500; margin-bottom: 0.5rem;">${headline.headline}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                ${headline.conversions} conversions • $${headline.spend.toFixed(2)} spend
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            container.innerHTML = headlinesHTML;
        }

        function generateCorrelationMatrix() {
            const container = document.getElementById('correlationMatrixContainer');
            
            if (!creativesData.length) {
                container.innerHTML = '<p>No creative data available for correlation analysis.</p>';
                return;
            }

            const correlations = calculateCreativeCorrelations();
            
            const matrixHTML = `
                <div style="padding: 1rem;">
                    <div style="background: #f0f9ff; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                        <h4 style="font-weight: 600; color: var(--primary-color); margin-bottom: 0.5rem;">📊 Performance Correlation Analysis</h4>
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">Statistical analysis of creative traits vs performance metrics</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 0.5rem; font-weight: 600; margin-bottom: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 6px;">
                        <div>Creative Trait</div>
                        <div style="text-align: center;">ROAS Impact</div>
                        <div style="text-align: center;">CTR Impact</div>
                        <div style="text-align: center;">Sample Size</div>
                    </div>
                    
                    ${correlations.map(corr => `
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 0.5rem; align-items: center; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 0.5rem;">
                            <div style="font-weight: 500;">${corr.trait}</div>
                            <div style="text-align: center; font-weight: 600; color: ${corr.roasImpact >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">
                                ${corr.roasImpact >= 0 ? '+' : ''}${(corr.roasImpact * 100).toFixed(1)}%
                            </div>
                            <div style="text-align: center; font-weight: 600; color: ${corr.ctrImpact >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">
                                ${corr.ctrImpact >= 0 ? '+' : ''}${(corr.ctrImpact * 100).toFixed(1)}%
                            </div>
                            <div style="text-align: center; color: var(--text-secondary);">${corr.sampleSize}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = matrixHTML;
        }

        function calculateCreativeCorrelations() {
            const traits = [
                { name: 'Numbers in Headline', test: c => /\d+/.test(c.headline) },
                { name: 'Question Headlines', test: c => c.headline.includes('?') },
                { name: 'Urgency Words', test: c => /\b(now|today|limited|hurry|quick)\b/i.test(c.headline) },
                { name: 'Free Offers', test: c => /\bfree\b/i.test(c.headline) },
                { name: 'Money/Savings', test: c => /\$|save|money|cash|earn/i.test(c.headline) },
                { name: 'Long Headlines (>50 chars)', test: c => c.headline.length > 50 },
                { name: 'High Spend (>$100)', test: c => c.spend > 100 }
            ];

            return traits.map(trait => {
                const withTrait = creativesData.filter(trait.test);
                const withoutTrait = creativesData.filter(c => !trait.test(c));

                if (withTrait.length === 0 || withoutTrait.length === 0) {
                    return {
                        trait: trait.name,
                        roasImpact: 0,
                        ctrImpact: 0,
                        sampleSize: withTrait.length
                    };
                }

                const avgRoasWithTrait = withTrait.reduce((sum, c) => sum + c.roas, 0) / withTrait.length;
                const avgRoasWithoutTrait = withoutTrait.reduce((sum, c) => sum + c.roas, 0) / withoutTrait.length;
                
                const avgCtrWithTrait = withTrait.reduce((sum, c) => sum + c.ctr, 0) / withTrait.length;
                const avgCtrWithoutTrait = withoutTrait.reduce((sum, c) => sum + c.ctr, 0) / withoutTrait.length;

                return {
                    trait: trait.name,
                    roasImpact: avgRoasWithoutTrait > 0 ? (avgRoasWithTrait - avgRoasWithoutTrait) / avgRoasWithoutTrait : 0,
                    ctrImpact: avgCtrWithoutTrait > 0 ? (avgCtrWithTrait - avgCtrWithoutTrait) / avgCtrWithoutTrait : 0,
                    sampleSize: withTrait.length
                };
            }).sort((a, b) => b.roasImpact - a.roasImpact);
        }

        function updateScalingOpportunities() {
            const container = document.getElementById('scalingOpportunities');
            
            if (!creativesData.length) {
                container.innerHTML = '<p>No creative data available for scaling analysis.</p>';
                return;
            }

            const scalingCandidates = creativesData
                .filter(c => c.roas >= 2.0 && c.conversions >= 3 && c.spend < 500)
                .sort((a, b) => b.roas - a.roas)
                .slice(0, 8);

            if (scalingCandidates.length === 0) {
                container.innerHTML = '<p>No immediate scaling opportunities found. Focus on optimizing current campaigns.</p>';
                return;
            }

            const opportunitiesHTML = `
                <div>
                    <div style="background: #f0fdf4; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                        <h4 style="font-weight: 600; color: var(--success-color);">🚀 Scaling Opportunities</h4>
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">${scalingCandidates.length} high-potential campaigns ready for budget increases</p>
                    </div>
                    ${scalingCandidates.map(candidate => `
                        <div style="padding: 1rem; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div style="font-weight: 600; color
