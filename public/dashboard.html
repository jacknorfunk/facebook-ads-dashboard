<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Ads Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background-color 0.2s;
        }
        .sortable-header:hover {
            background-color: #f3f4f6;
        }
        .sort-indicator {
            display: inline-block;
            margin-left: 4px;
            font-size: 12px;
            color: #6b7280;
        }
        .sort-asc::after {
            content: '‚ñ≤';
        }
        .sort-desc::after {
            content: '‚ñº';
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">Facebook Ads Performance</h1>
                        <p class="text-gray-600">Live data from your Facebook advertising campaigns</p>
                    </div>
                    <button id="refreshBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        <span id="refreshIcon">üîÑ</span>
                        Refresh Data
                    </button>
                </div>
            </div>

            <!-- Debug Panel -->
            <div id="debugPanel" class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-6">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-medium text-yellow-800">Debug Information</h3>
                    <button id="hideDebugBtn" class="text-xs text-yellow-600 hover:text-yellow-800">Hide</button>
                </div>
                <div id="debugOutput" class="text-xs text-yellow-700 font-mono max-h-40 overflow-y-auto">
                    Dashboard loaded. Waiting for data...
                </div>
            </div>

            <!-- Controls -->
            <div class="flex flex-wrap gap-4 mb-6">
                <select id="dateRange" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="yesterday">Yesterday</option>
                    <option value="last_7d">Last 7 days</option>
                    <option value="last_30d" selected>Last 30 days</option>
                    <option value="last_90d">Last 90 days</option>
                    <option value="this_month">This month</option>
                    <option value="last_month">Last month</option>
                </select>
            </div>

            <!-- Tabs -->
            <div class="flex space-x-8 mb-6 border-b border-gray-200">
                <button class="tab-btn px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600" data-tab="overview">Overview</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700" data-tab="campaigns">Campaigns</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700" data-tab="creatives">Creative Analysis</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700" data-tab="video-analysis">Video Hook Analysis</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700" data-tab="ai-scripts">AI Script Generator</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700" data-tab="video-intelligence">üé¨ Video Intelligence</button>
            </div>

            <!-- Loading State -->
            <div id="loading" class="text-center py-20">
                <div class="loading inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
                <p class="text-gray-600 mt-4">Loading your Facebook Ads data...</p>
            </div>

            <!-- Error State -->
            <div id="error" class="hidden text-center py-20">
                <div class="text-red-500 text-6xl mb-4">‚ö†Ô∏è</div>
                <h2 class="text-xl font-semibold text-gray-900 mb-2">Connection Error</h2>
                <p class="text-gray-600 mb-4" id="errorMessage"></p>
                <button onclick="loadData()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    Try Again
                </button>
            </div>

            <!-- Overview Tab -->
            <div id="overview-content" class="tab-content active">
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Spend</p>
                                <p class="text-2xl font-bold text-gray-900" id="totalSpend">¬£0</p>
                            </div>
                            <div class="text-blue-500 text-3xl">üí∞</div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Revenue</p>
                                <p class="text-2xl font-bold text-gray-900" id="totalRevenue">¬£0</p>
                            </div>
                            <div class="text-green-500 text-3xl">üìà</div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">ROAS</p>
                                <p class="text-2xl font-bold text-gray-900" id="totalROAS">0.00x</p>
                            </div>
                            <div class="text-purple-500 text-3xl">üéØ</div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Conversions</p>
                                <p class="text-2xl font-bold text-gray-900" id="totalConversions">0</p>
                            </div>
                            <div class="text-orange-500 text-3xl">üëÜ</div>
                        </div>
                    </div>
                </div>

                <!-- Secondary KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <p class="text-sm font-medium text-gray-600">Total Clicks</p>
                        <p class="text-xl font-bold text-gray-900" id="totalClicks">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <p class="text-sm font-medium text-gray-600">CTR</p>
                        <p class="text-xl font-bold text-gray-900" id="averageCTR">0.00%</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <p class="text-sm font-medium text-gray-600">CPC</p>
                        <p class="text-xl font-bold text-gray-900" id="averageCPC">¬£0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <p class="text-sm font-medium text-gray-600">CPM</p>
                        <p class="text-xl font-bold text-gray-900" id="averageCPM">¬£0.00</p>
                    </div>
                </div>
            </div>

            <!-- Campaigns Tab -->
            <div id="campaigns-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Campaign Performance</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Campaign</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-700">Spend</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-700">Revenue</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-700">ROAS</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-700">Conversions</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-700">CTR</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-700">CPC</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-700">Status</th>
                                </tr>
                            </thead>
                            <tbody id="campaignTable">
                                <!-- Campaign rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Creative Analysis Tab -->
            <div id="creatives-content" class="tab-content">
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Creative Performance Analysis</h3>
                    
                    <!-- Creative overview cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 text-center">
                            <p class="text-sm text-gray-600">Total Creatives</p>
                            <p class="text-2xl font-bold text-gray-900" id="totalCreatives">0</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 text-center">
                            <p class="text-sm text-gray-600">Average Score</p>
                            <p class="text-2xl font-bold text-blue-600" id="avgCreativeScore">0</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 text-center">
                            <p class="text-sm text-gray-600">Top Performer</p>
                            <p class="text-xl font-bold text-green-600" id="topPerformer">-</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 text-center">
                            <p class="text-sm text-gray-600">Needs Attention</p>
                            <p class="text-xl font-bold text-red-600" id="needsAttention">-</p>
                        </div>
                    </div>

                    <!-- Creative cards grid -->
                    <div id="creativesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Creative cards will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Video Hook Analysis Tab -->
            <div id="video-analysis-content" class="tab-content">
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Video Hook Analysis</h3>
                    
                    <!-- Video overview cards -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 text-center">
                            <p class="text-sm text-gray-600">Total Videos</p>
                            <p class="text-2xl font-bold text-gray-900" id="totalVideos">0</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 text-center">
                            <p class="text-sm text-gray-600">Avg Hook Rate</p>
                            <p class="text-2xl font-bold text-blue-600" id="avgHookRate">0%</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 text-center">
                            <p class="text-sm text-gray-600">Avg Retention</p>
                            <p class="text-2xl font-bold text-purple-600" id="avgRetention">0%</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 text-center">
                            <p class="text-sm text-gray-600">Avg Completion</p>
                            <p class="text-2xl font-bold text-green-600" id="avgCompletion">0%</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 text-center">
                            <p class="text-sm text-gray-600">Total Spend</p>
                            <p class="text-2xl font-bold text-orange-600" id="videoTotalSpend">¬£0</p>
                        </div>
                    </div>

                    <!-- Video performance table -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full" id="videoAnalysisTable">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="text-left py-4 px-6 font-semibold text-gray-700">Rank</th>
                                        <th class="text-left py-4 px-6 font-semibold text-gray-700">Video</th>
                                        <th class="sortable-header text-right py-4 px-6 font-semibold text-gray-700" data-sort="hook_rate">
                                            Hook Rate<span class="sort-indicator"></span>
                                        </th>
                                        <th class="sortable-header text-right py-4 px-6 font-semibold text-gray-700" data-sort="retention_25pct">
                                            25% Retention<span class="sort-indicator"></span>
                                        </th>
                                        <th class="sortable-header text-right py-4 px-6 font-semibold text-gray-700" data-sort="retention_50pct">
                                            50% Retention<span class="sort-indicator"></span>
                                        </th>
                                        <th class="sortable-header text-right py-4 px-6 font-semibold text-gray-700" data-sort="completion_rate">
                                            Completion<span class="sort-indicator"></span>
                                        </th>
                                        <th class="sortable-header text-right py-4 px-6 font-semibold text-gray-700" data-sort="spend">
                                            Spend<span class="sort-indicator"></span>
                                        </th>
                                        <th class="sortable-header text-right py-4 px-6 font-semibold text-gray-700" data-sort="cpc">
                                            CPC<span class="sort-indicator"></span>
                                        </th>
                                        <th class="sortable-header text-right py-4 px-6 font-semibold text-gray-700" data-sort="conversions">
                                            Conversions<span class="sort-indicator"></span>
                                        </th>
                                        <th class="sortable-header text-right py-4 px-6 font-semibold text-gray-700" data-sort="cpa">
                                            CPA<span class="sort-indicator"></span>
                                        </th>
                                        <th class="text-center py-4 px-6 font-semibold text-gray-700">Grade</th>
                                        <th class="text-center py-4 px-6 font-semibold text-gray-700">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="videoAnalysisTableBody">
                                    <!-- Video rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Script Generator Tab -->
            <div id="ai-scripts-content" class="tab-content">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-lg mb-6">
                    <h2 class="text-2xl font-bold mb-2">ü§ñ AI Script Generator</h2>
                    <p class="text-blue-100">Generate optimized video scripts based on your creative performance data</p>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Generate Script for Creative</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <select id="scriptCreativeSelect" class="px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="">Select a creative...</option>
                        </select>
                        <select id="scriptFocus" class="px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="hook_rate">Hook Rate Focus</option>
                            <option value="retention">Retention Focus</option>
                            <option value="completion">Completion Focus</option>
                            <option value="overall">Balanced Improvement</option>
                        </select>
                        <button id="generateScriptBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300" disabled>
                            ü§ñ Generate Scripts
                        </button>
                    </div>
                    <div id="scriptResults" class="space-y-4">
                        <!-- Script results will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Video Intelligence Tab -->
            <div id="video-intelligence-content" class="tab-content">
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 rounded-lg mb-6">
                    <h2 class="text-2xl font-bold mb-2">üé¨ Video Intelligence Analysis</h2>
                    <p class="text-indigo-100">Deep frame-by-frame analysis with audio transcription and visual scene detection</p>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Analyze Video Content</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <select id="intelligenceCreativeSelect" class="px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="">Select a video creative...</option>
                        </select>
                        <select id="analysisType" class="px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="full">Full Analysis</option>
                            <option value="audio_only">Audio Transcription Only</option>
                            <option value="visual_only">Visual Analysis Only</option>
                            <option value="frame_by_frame">Frame-by-Frame Deep Dive</option>
                        </select>
                        <button id="analyzeVideoBtn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-300" disabled>
                            üé¨ Analyze Video
                        </button>
                    </div>
                    <div id="videoAnalysisProgress" class="hidden">
                        <div class="flex items-center gap-2 text-indigo-600 mb-2">
                            <div class="loading inline-block w-4 h-4 border-2 border-indigo-600 border-t-transparent rounded-full"></div>
                            <span id="analysisStatusText">Downloading and analyzing video...</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="analysisProgressBar" class="bg-indigo-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div id="videoIntelligenceResults" class="space-y-6">
                    <!-- Results will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://facebook-ads-dashboard-git-main-jacks-projects-e0e84f4f.vercel.app';
        
        let accountData = null;
        let campaigns = [];
        let creatives = [];
        let currentSort = { column: null, direction: 'asc' };

        // Debug logging
        function debugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const debugOutput = document.getElementById('debugOutput');
            debugOutput.innerHTML += `${timestamp}: ${message}<br>`;
            debugOutput.scrollTop = debugOutput.scrollHeight;
            console.log(`${timestamp}: ${message}`);
        }

        // Hide debug panel
        document.getElementById('hideDebugBtn').addEventListener('click', () => {
            document.getElementById('debugPanel').style.display = 'none';
        });

        async function fetchAccountData(dateRange) {
            debugLog('Fetching overview data...');
            const response = await fetch(`${API_BASE}/api/overview?date_preset=${dateRange}`);
            debugLog(`Overview response status: ${response.status}`);
            
            if (!response.ok) throw new Error('Failed to fetch account data');
            
            const data = await response.json();
            debugLog('Overview data received successfully');
            return data;
        }

        async function fetchCampaigns(dateRange) {
            debugLog('Fetching campaigns data...');
            const response = await fetch(`${API_BASE}/api/campaigns?date_preset=${dateRange}`);
            debugLog(`Campaigns response status: ${response.status}`);
            
            if (!response.ok) throw new Error('Failed to fetch campaigns');
            
            const data = await response.json();
            debugLog(`Campaigns data received: ${data.length} campaigns`);
            return data;
        }

        async function fetchCreatives(dateRange) {
            debugLog('Fetching creatives data...');
            const response = await fetch(`${API_BASE}/api/creatives?date_preset=${dateRange}`);
            debugLog(`Creatives response status: ${response.status}`);
            
            if (!response.ok) throw new Error('Failed to fetch creatives');
            
            const data = await response.json();
            debugLog(`Creatives data received: ${data.length} creatives`);
            return data;
        }

        function updateOverviewUI() {
            if (!accountData) return;

            debugLog('Updating overview UI...');
            debugLog(`Raw overview data received: ${JSON.stringify(accountData).substring(0, 100)}...`);
            
            // Use flexible field names
            const spend = accountData.totalSpend || accountData.spend || 0;
            const revenue = accountData.totalRevenue || accountData.revenue || 0;
            const conversions = accountData.totalConversions || accountData.conversions || accountData.leadConversions || 0;
            const clicks = accountData.totalClicks || accountData.clicks || 0;
            const impressions = accountData.totalImpressions || accountData.impressions || 0;
            const ctr = accountData.averageCTR || accountData.ctr || 0;
            const cpc = accountData.averageCPC || accountData.cpc || 0;
            const cpm = accountData.averageCPM || accountData.cpm || 0;
            const roas = accountData.totalROAS || accountData.roas || 0;

            debugLog(`Processed metrics - Spend: ¬£${spend}, Revenue: ¬£${revenue}, Clicks: ${clicks}, Impressions: ${impressions}`);

            document.getElementById('totalSpend').textContent = `¬£${spend.toFixed(2)}`;
            document.getElementById('totalRevenue').textContent = `¬£${revenue.toFixed(2)}`;
            document.getElementById('totalROAS').textContent = `${roas.toFixed(2)}x`;
            document.getElementById('totalConversions').textContent = conversions.toLocaleString();
            document.getElementById('totalClicks').textContent = clicks.toLocaleString();
            document.getElementById('averageCTR').textContent = `${ctr.toFixed(2)}%`;
            document.getElementById('averageCPC').textContent = `¬£${cpc.toFixed(2)}`;
            document.getElementById('averageCPM').textContent = `¬£${cpm.toFixed(2)}`;

            debugLog(`Updated overview UI with spend: ¬£${spend.toFixed(2)}, revenue: ¬£${revenue.toFixed(2)}, ROAS: ${roas.toFixed(2)}x`);
        }

        function updateCampaignsUI() {
            const campaignTable = document.getElementById('campaignTable');
            campaignTable.innerHTML = '';

            campaigns.forEach(campaign => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100 hover:bg-gray-50';

                const statusColor = campaign.status === 'winning' ? 'bg-green-50 text-green-800' :
                                  campaign.status === 'losing' ? 'bg-red-50 text-red-800' :
                                  'bg-yellow-50 text-yellow-800';

                row.innerHTML = `
                    <td class="py-4 px-4 font-medium text-gray-900">${campaign.name.length > 40 ? campaign.name.substring(0, 40) + '...' : campaign.name}</td>
                    <td class="py-4 px-4 text-right text-gray-900">¬£${campaign.spend.toFixed(2)}</td>
                    <td class="py-4 px-4 text-right text-gray-900">¬£${campaign.revenue.toFixed(2)}</td>
                    <td class="py-4 px-4 text-right font-medium text-gray-900">${campaign.roas.toFixed(2)}x</td>
                    <td class="py-4 px-4 text-right text-gray-900">${campaign.conversions}</td>
                    <td class="py-4 px-4 text-right text-gray-900">${campaign.ctr.toFixed(2)}%</td>
                    <td class="py-4 px-4 text-right text-gray-900">¬£${campaign.cpc.toFixed(2)}</td>
                    <td class="py-4 px-4 text-center">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusColor}">
                            ${campaign.status}
                        </span>
                    </td>
                `;

                campaignTable.appendChild(row);
            });
        }

        function updateCreativesUI() {
            const creativesGrid = document.getElementById('creativesGrid');
            creativesGrid.innerHTML = '';

            // Update overview stats
            const totalCreatives = creatives.length;
            const avgScore = totalCreatives > 0 ? creatives.reduce((sum, c) => sum + c.performance_score, 0) / totalCreatives : 0;
            const topPerformer = creatives.length > 0 ? creatives.reduce((best, current) => current.performance_score > best.performance_score ? current : best) : null;
            const needsAttention = creatives.filter(c => c.performance_score < 40).length;

            document.getElementById('totalCreatives').textContent = totalCreatives;
            document.getElementById('avgCreativeScore').textContent = avgScore.toFixed(0);
            document.getElementById('topPerformer').textContent = topPerformer ? `${topPerformer.performance_score}/100` : '-';
            document.getElementById('needsAttention').textContent = needsAttention;

            // Create creative cards
            creatives.forEach(creative => {
                const scoreColor = creative.performance_score >= 80 ? 'bg-green-100 text-green-800' :
                                 creative.performance_score >= 60 ? 'bg-yellow-100 text-yellow-800' :
                                 'bg-red-100 text-red-800';

                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow';
                
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 text-sm mb-1">${creative.name.substring(0, 40)}${creative.name.length > 40 ? '...' : ''}</h4>
                            <p class="text-xs text-gray-500">${creative.creative_type.toUpperCase()} ‚Ä¢ ${creative.status}</p>
                        </div>
                        <div class="text-right">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${scoreColor}">
                                ${creative.performance_score}/100
                            </span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="text-center p-2 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-600">Spend</p>
                            <p class="font-semibold text-gray-900">¬£${creative.spend.toFixed(2)}</p>
                        </div>
                        <div class="text-center p-2 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-600">CTR</p>
                            <p class="font-semibold text-gray-900">${creative.ctr.toFixed(2)}%</p>
                        </div>
                        <div class="text-center p-2 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-600">CPC</p>
                            <p class="font-semibold text-gray-900">¬£${creative.cpc.toFixed(2)}</p>
                        </div>
                        <div class="text-center p-2 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-600">Hook Rate</p>
                            <p class="font-semibold text-gray-900">${creative.hook_rate.toFixed(1)}%</p>
                        </div>
                    </div>

                    <div class="space-y-2">
                        ${creative.insights.slice(0, 2).map(insight => `
                            <div class="flex items-start gap-2">
                                <span class="text-xs ${insight.type === 'success' ? 'text-green-500' : insight.type === 'warning' ? 'text-yellow-500' : 'text-red-500'}">
                                    ${insight.type === 'success' ? '‚úÖ' : insight.type === 'warning' ? '‚ö†Ô∏è' : '‚ùå'}
                                </span>
                                <p class="text-xs text-gray-600 leading-relaxed">${insight.message}</p>
                            </div>
                        `).join('')}
                    </div>
                `;

                creativesGrid.appendChild(card);
            });

            // Update dropdowns
            updateCreativeDropdowns();
        }

        function updateVideoAnalysisUI() {
            const videoCreatives = creatives.filter(c => c.creative_type === 'video');
            
            // Update overview stats
            const totalVideos = videoCreatives.length;
            const avgHookRate = totalVideos > 0 ? videoCreatives.reduce((sum, c) => sum + c.hook_rate, 0) / totalVideos : 0;
            const avgRetention = totalVideos > 0 ? videoCreatives.reduce((sum, c) => sum + (c.hook_rate * 0.8), 0) / totalVideos : 0; // Simulated
            const avgCompletion = totalVideos > 0 ? videoCreatives.reduce((sum, c) => sum + c.completion_rate, 0) / totalVideos : 0;
            const totalSpend = videoCreatives.reduce((sum, c) => sum + c.spend, 0);

            document.getElementById('totalVideos').textContent = totalVideos;
            document.getElementById('avgHookRate').textContent = `${avgHookRate.toFixed(1)}%`;
            document.getElementById('avgRetention').textContent = `${avgRetention.toFixed(1)}%`;
            document.getElementById('avgCompletion').textContent = `${avgCompletion.toFixed(1)}%`;
            document.getElementById('videoTotalSpend').textContent = `¬£${totalSpend.toFixed(2)}`;

            // Update table
            updateVideoTable(videoCreatives);
        }

        function updateVideoTable(videoCreatives) {
            const tableBody = document.getElementById('videoAnalysisTableBody');
            tableBody.innerHTML = '';

            // Add video data with enhanced metrics - now properly handling lead conversions
            const enhancedVideos = videoCreatives.map((creative, index) => {
                // Try to get lead conversions first, then fallback to regular conversions
                const leadConversions = creative.leadConversions || 0;
                const regularConversions = creative.conversions || 0;
                const totalConversions = leadConversions > 0 ? leadConversions : regularConversions;
                
                return {
                    ...creative,
                    rank: index + 1,
                    hook_rate: creative.hook_rate || (creative.ctr * 8.5), // Estimate hook rate from CTR
                    retention_25pct: Math.min(100, (creative.hook_rate || creative.ctr * 8.5) * 0.8), // Simulated
                    retention_50pct: Math.min(100, (creative.hook_rate || creative.ctr * 8.5) * 0.6), // Simulated
                    completion_rate: creative.completion_rate || Math.min(100, (creative.hook_rate || creative.ctr * 8.5) * 0.4), // Simulated
                    conversions: totalConversions,
                    cpa: totalConversions > 0 ? creative.spend / totalConversions : 0
                };
            });

            // Sort videos by current sort criteria
            if (currentSort.column) {
                enhancedVideos.sort((a, b) => {
                    let aVal = a[currentSort.column];
                    let bVal = b[currentSort.column];
                    
                    if (typeof aVal === 'string') {
                        aVal = aVal.toLowerCase();
                        bVal = bVal.toLowerCase();
                    }
                    
                    if (currentSort.direction === 'asc') {
                        return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                    } else {
                        return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                    }
                });
            }

            enhancedVideos.forEach((video, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100 hover:bg-gray-50';

                const grade = video.hook_rate >= 15 ? 'A' : video.hook_rate >= 10 ? 'B' : video.hook_rate >= 5 ? 'C' : 'D';
                const gradeColor = grade === 'A' ? 'bg-green-100 text-green-800' :
                                 grade === 'B' ? 'bg-blue-100 text-blue-800' :
                                 grade === 'C' ? 'bg-yellow-100 text-yellow-800' :
                                 'bg-red-100 text-red-800';

                row.innerHTML = `
                    <td class="py-4 px-6 text-center">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full ${index < 3 ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-600'} text-sm font-bold">
                            ${index + 1}
                        </span>
                    </td>
                    <td class="py-4 px-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-gray-200 rounded-lg mr-3 flex items-center justify-center">
                                <span class="text-xs text-gray-500">üé¨</span>
                            </div>
                            <div>
                                <p class="font-medium text-gray-900 text-sm">${video.name.substring(0, 30)}${video.name.length > 30 ? '...' : ''}</p>
                                <p class="text-xs text-gray-500">Video #${video.id.slice(-4)}</p>
                            </div>
                        </div>
                    </td>
                    <td class="py-4 px-6 text-right">
                        <span class="font-semibold ${video.hook_rate >= 10 ? 'text-green-600' : video.hook_rate >= 5 ? 'text-yellow-600' : 'text-red-600'}">
                            ${video.hook_rate.toFixed(1)}%
                        </span>
                    </td>
                    <td class="py-4 px-6 text-right">
                        <span class="text-gray-900">${video.retention_25pct.toFixed(1)}%</span>
                    </td>
                    <td class="py-4 px-6 text-right">
                        <span class="text-gray-900">${video.retention_50pct.toFixed(1)}%</span>
                    </td>
                    <td class="py-4 px-6 text-right">
                        <span class="text-gray-900">${video.completion_rate.toFixed(1)}%</span>
                    </td>
                    <td class="py-4 px-6 text-right">
                        <span class="font-medium text-gray-900">¬£${video.spend.toFixed(2)}</span>
                    </td>
                    <td class="py-4 px-6 text-right">
                        <span class="text-gray-900">¬£${video.cpc.toFixed(2)}</span>
                    </td>
                    <td class="py-4 px-6 text-right">
                        <span class="font-medium ${video.conversions > 0 ? 'text-green-600' : 'text-gray-500'}">${video.conversions}</span>
                    </td>
                    <td class="py-4 px-6 text-right">
                        <span class="text-gray-900">${video.cpa > 0 ? '¬£' + video.cpa.toFixed(2) : '-'}</span>
                    </td>
                    <td class="py-4 px-6 text-center">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${gradeColor}">
                            ${grade}
                        </span>
                    </td>
                    <td class="py-4 px-6 text-center">
                        <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="analyzeVideo('${video.id}')">
                            Analyze
                        </button>
                    </td>
                `;

                tableBody.appendChild(row);
            });
        }

        function sortVideoTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'desc'; // Default to descending for most metrics
            }

            // Update sort indicators
            document.querySelectorAll('.sortable-header').forEach(header => {
                const indicator = header.querySelector('.sort-indicator');
                indicator.className = 'sort-indicator';
                
                if (header.dataset.sort === column) {
                    indicator.className += currentSort.direction === 'asc' ? ' sort-asc' : ' sort-desc';
                }
            });

            // Re-render table
            const videoCreatives = creatives.filter(c => c.creative_type === 'video');
            updateVideoTable(videoCreatives);
        }

        function updateCreativeDropdowns() {
            const scriptSelect = document.getElementById('scriptCreativeSelect');
            const intelligenceSelect = document.getElementById('intelligenceCreativeSelect');
            
            scriptSelect.innerHTML = '<option value="">Select a creative...</option>';
            intelligenceSelect.innerHTML = '<option value="">Select a video creative...</option>';

            creatives.forEach(creative => {
                const scriptOption = document.createElement('option');
                scriptOption.value = creative.id;
                scriptOption.textContent = creative.name.substring(0, 50) + (creative.name.length > 50 ? '...' : '');
                scriptSelect.appendChild(scriptOption);

                if (creative.creative_type === 'video') {
                    const intelligenceOption = document.createElement('option');
                    intelligenceOption.value = creative.id;
                    intelligenceOption.textContent = creative.name.substring(0, 50) + (creative.name.length > 50 ? '...' : '');
                    intelligenceSelect.appendChild(intelligenceOption);
                }
            });

            // Enable buttons if creatives are available
            document.getElementById('generateScriptBtn').disabled = creatives.length === 0;
            document.getElementById('analyzeVideoBtn').disabled = creatives.filter(c => c.creative_type === 'video').length === 0;
        }

        async function loadData() {
            const dateRange = document.getElementById('dateRange').value;
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const content = document.querySelectorAll('.tab-content');
            const refreshIcon = document.getElementById('refreshIcon');

            debugLog('Starting data load...');

            loading.classList.remove('hidden');
            error.classList.add('hidden');
            refreshIcon.style.animation = 'spin 1s linear infinite';

            try {
                accountData = await fetchAccountData(dateRange);
                campaigns = await fetchCampaigns(dateRange);
                creatives = await fetchCreatives(dateRange);

                updateOverviewUI();
                updateCampaignsUI();
                updateCreativesUI();
                updateVideoAnalysisUI();

                loading.classList.add('hidden');
                debugLog('Data load completed successfully');

            } catch (err) {
                loading.classList.add('hidden');
                error.classList.remove('hidden');
                document.getElementById('errorMessage').textContent = err.message;
                debugLog(`Error loading data: ${err.message}`);
            } finally {
                refreshIcon.style.animation = '';
            }
        }

        function analyzeVideo(videoId) {
            debugLog(`Analyzing video: ${videoId}`);
            // Switch to video intelligence tab
            showTab('video-intelligence');
            // Select the video in the dropdown
            document.getElementById('intelligenceCreativeSelect').value = videoId;
            // Enable the analyze button
            document.getElementById('analyzeVideoBtn').disabled = false;
        }

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                btn.classList.add('text-gray-500', 'hover:text-gray-700');
            });

            // Show selected tab content
            document.getElementById(`${tabName}-content`).classList.add('active');

            // Add active class to selected tab button
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('text-gray-500', 'hover:text-gray-700');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('text-blue-600', 'border-b-2', 'border-blue-600');

            // Load specific data for certain tabs
            if (tabName === 'video-intelligence' && creatives.length > 0) {
                loadVideoIntelligence();
            }
        }

        function loadVideoIntelligence() {
            debugLog('Loading Video Intelligence...');
            const videoCreatives = creatives.filter(c => c.creative_type === 'video');
            debugLog(`Video Intelligence loaded with ${videoCreatives.length} video creatives available`);
        }

        // Event listeners
        document.getElementById('refreshBtn').addEventListener('click', loadData);
        document.getElementById('dateRange').addEventListener('change', loadData);

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                showTab(btn.dataset.tab);
            });
        });

        // Sortable table headers
        document.querySelectorAll('.sortable-header').forEach(header => {
            header.addEventListener('click', () => {
                sortVideoTable(header.dataset.sort);
            });
        });

        // Creative selection handlers
        document.getElementById('scriptCreativeSelect').addEventListener('change', function() {
            document.getElementById('generateScriptBtn').disabled = !this.value;
        });

        document.getElementById('intelligenceCreativeSelect').addEventListener('change', function() {
            document.getElementById('analyzeVideoBtn').disabled = !this.value;
        });

        // Initialize page
        debugLog('Page loaded, starting data fetch...');
        loadData();
    </script>
</body>
</html>
