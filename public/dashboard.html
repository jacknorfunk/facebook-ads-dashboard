<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Ads Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .grade-A { @apply bg-green-100 text-green-800 border-green-200; }
        .grade-B { @apply bg-blue-100 text-blue-800 border-blue-200; }
        .grade-C { @apply bg-yellow-100 text-yellow-800 border-yellow-200; }
        .grade-D { @apply bg-red-100 text-red-800 border-red-200; }
        .performance-high { @apply bg-green-50 border-l-4 border-green-400; }
        .performance-medium { @apply bg-yellow-50 border-l-4 border-yellow-400; }
        .performance-low { @apply bg-red-50 border-l-4 border-red-400; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">Facebook Ads Performance</h1>
                        <p class="text-gray-600">Live data from your Facebook advertising campaigns</p>
                    </div>
                    <button id="refreshBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        <span id="refreshIcon">üîÑ</span>
                        Refresh Data
                    </button>
                </div>
            </div>

            <!-- Debug Info -->
            <div id="debugInfo" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 hidden">
                <h3 class="font-semibold text-yellow-800 mb-2">Debug Information</h3>
                <div id="debugContent" class="text-sm text-yellow-700"></div>
            </div>

            <!-- Tabs -->
            <div class="flex space-x-8 mb-6">
                <button class="tab-btn px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600" data-tab="overview">Overview</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700" data-tab="campaigns">Campaigns</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700" data-tab="creatives">Creative Analysis</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700" data-tab="video-analysis">Video Hook Analysis</button>
            </div>

            <!-- Controls -->
            <div class="flex flex-wrap gap-4 mb-6">
                <select id="dateRange" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="yesterday">Yesterday</option>
                    <option value="last_7d">Last 7 days</option>
                    <option value="last_30d" selected>Last 30 days</option>
                    <option value="last_90d">Last 90 days</option>
                </select>
            </div>

            <!-- Loading State -->
            <div id="loading" class="text-center py-20">
                <div class="loading inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
                <p class="text-gray-600 mt-4">Loading your Facebook Ads data...</p>
            </div>

            <!-- Error State -->
            <div id="error" class="hidden text-center py-20">
                <div class="text-red-500 text-6xl mb-4">‚ö†Ô∏è</div>
                <h2 class="text-xl font-semibold text-gray-900 mb-2">Connection Error</h2>
                <p class="text-gray-600 mb-4" id="errorMessage"></p>
                <button onclick="loadData()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Try Again</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview-content" class="tab-content">
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Spend</p>
                                <p class="text-2xl font-bold text-gray-900" id="totalSpend">¬£0</p>
                            </div>
                            <div class="text-blue-500 text-3xl">üí∞</div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Revenue</p>
                                <p class="text-2xl font-bold text-gray-900" id="totalRevenue">¬£0</p>
                            </div>
                            <div class="text-green-500 text-3xl">üìà</div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">ROAS</p>
                                <p class="text-2xl font-bold text-gray-900" id="totalROAS">0.00x</p>
                            </div>
                            <div class="text-purple-500 text-3xl">üéØ</div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Conversions</p>
                                <p class="text-2xl font-bold text-gray-900" id="totalConversions">0</p>
                            </div>
                            <div class="text-orange-500 text-3xl">üéØ</div>
                        </div>
                    </div>
                </div>

                <!-- Secondary KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <p class="text-sm font-medium text-gray-600">Total Clicks</p>
                        <p class="text-xl font-bold text-gray-900" id="totalClicks">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <p class="text-sm font-medium text-gray-600">CTR</p>
                        <p class="text-xl font-bold text-gray-900" id="averageCTR">0.00%</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <p class="text-sm font-medium text-gray-600">CPC</p>
                        <p class="text-xl font-bold text-gray-900" id="averageCPC">¬£0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <p class="text-sm font-medium text-gray-600">CPM</p>
                        <p class="text-xl font-bold text-gray-900" id="averageCPM">¬£0.00</p>
                    </div>
                </div>

                <!-- Insights Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center gap-2 mb-4">
                            <span class="text-green-500 text-xl">‚úÖ</span>
                            <h3 class="text-lg font-semibold text-gray-900">What's Working</h3>
                        </div>
                        <div id="whatsWorking" class="space-y-3">
                            <p class="text-gray-500">Set up conversion tracking to see winning campaigns!</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center gap-2 mb-4">
                            <span class="text-red-500 text-xl">‚ö†Ô∏è</span>
                            <h3 class="text-lg font-semibold text-gray-900">Needs Improvement</h3>
                        </div>
                        <div id="needsImprovement" class="space-y-3">
                            <p class="text-gray-500">Loading recommendations...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Campaigns Tab -->
            <div id="campaigns-content" class="tab-content hidden">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Campaign Performance Analysis</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Campaign</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-700">Spend</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-700">Revenue</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-700">ROAS</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-700">Conversions</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-700">CTR</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-700">CPC</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-700">Status</th>
                                </tr>
                            </thead>
                            <tbody id="campaignTable">
                                <!-- Campaign rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Creative Analysis Tab -->
            <div id="creatives-content" class="tab-content hidden">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Creative Performance Analysis</h3>
                    <div id="creativesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Creative cards will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Video Hook Analysis Tab -->
            <div id="video-analysis-content" class="tab-content hidden">
                <div class="text-center py-20">
                    <div class="text-gray-400 text-6xl mb-4">üé¨</div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">Video Hook Analysis</h3>
                    <p class="text-gray-600">Click on the Video Hook Analysis tab after data loads to see detailed video analysis.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://facebook-ads-dashboard-git-main-jacks-projects-e0e84f4f.vercel.app';
        let accountData = null;
        let campaigns = [];
        let creatives = [];

        // Debug function
        function showDebug(message) {
            console.log('DEBUG:', message);
            const debugInfo = document.getElementById('debugInfo');
            const debugContent = document.getElementById('debugContent');
            debugContent.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
            debugInfo.classList.remove('hidden');
        }

        // Tab Management
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tabName = e.target.dataset.tab;
                
                showDebug(`Switching to tab: ${tabName}`);
                
                // Update button styles
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.className = 'tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700';
                });
                e.target.className = 'tab-btn px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600';
                
                // Show/hide content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`${tabName}-content`).classList.remove('hidden');
            });
        });

        async function fetchAccountData(dateRange) {
            showDebug(`Fetching account data for ${dateRange}`);
            const url = `${API_BASE}/api/overview?date_preset=${dateRange}`;
            showDebug(`Account URL: ${url}`);
            
            const response = await fetch(url);
            showDebug(`Account response status: ${response.status}`);
            
            if (!response.ok) {
                const errorText = await response.text();
                showDebug(`Account error: ${errorText}`);
                throw new Error(`Failed to fetch account data: ${response.status} - ${errorText}`);
            }
            
            const data = await response.json();
            showDebug(`Account data received: ${JSON.stringify(data).substring(0, 200)}...`);
            return data;
        }

        async function fetchCampaigns(dateRange) {
            showDebug(`Fetching campaigns for ${dateRange}`);
            const url = `${API_BASE}/api/campaigns?date_preset=${dateRange}`;
            showDebug(`Campaigns URL: ${url}`);
            
            const response = await fetch(url);
            showDebug(`Campaigns response status: ${response.status}`);
            
            if (!response.ok) {
                const errorText = await response.text();
                showDebug(`Campaigns error: ${errorText}`);
                throw new Error(`Failed to fetch campaigns: ${response.status} - ${errorText}`);
            }
            
            const data = await response.json();
            showDebug(`Campaigns data received: ${data.length} campaigns`);
            return data;
        }

        async function fetchCreatives(dateRange) {
            showDebug(`Fetching creatives for ${dateRange}`);
            const url = `${API_BASE}/api/creatives?date_preset=${dateRange}`;
            showDebug(`Creatives URL: ${url}`);
            
            const response = await fetch(url);
            showDebug(`Creatives response status: ${response.status}`);
            
            if (!response.ok) {
                const errorText = await response.text();
                showDebug(`Creatives error: ${errorText}`);
                throw new Error(`Failed to fetch creatives: ${response.status} - ${errorText}`);
            }
            
            const data = await response.json();
            showDebug(`Creatives data received: ${data.length} creatives`);
            return data;
        }

        function updateOverviewUI() {
            showDebug('Updating overview UI');
            
            if (!accountData) {
                showDebug('No account data available');
                return;
            }

            try {
                // Update KPIs with safe fallbacks
                const totalSpend = accountData.totalSpend || 0;
                const totalRevenue = accountData.totalRevenue || 0;
                const totalROAS = accountData.totalROAS || 0;
                const totalConversions = accountData.totalConversions || 0;
                const totalClicks = accountData.totalClicks || 0;
                const averageCTR = accountData.averageCTR || 0;
                const averageCPC = accountData.averageCPC || 0;
                const averageCPM = accountData.averageCPM || 0;

                document.getElementById('totalSpend').textContent = `¬£${totalSpend.toLocaleString()}`;
                document.getElementById('totalRevenue').textContent = `¬£${totalRevenue.toLocaleString()}`;
                document.getElementById('totalROAS').textContent = `${totalROAS.toFixed(2)}x`;
                document.getElementById('totalConversions').textContent = totalConversions.toLocaleString();
                document.getElementById('totalClicks').textContent = totalClicks.toLocaleString();
                document.getElementById('averageCTR').textContent = `${averageCTR.toFixed(2)}%`;
                document.getElementById('averageCPC').textContent = `¬£${averageCPC.toFixed(2)}`;
                document.getElementById('averageCPM').textContent = `¬£${averageCPM.toFixed(2)}`;

                showDebug(`Updated UI with spend: ¬£${totalSpend}, revenue: ¬£${totalRevenue}`);

                // Update insights
                const winningCampaigns = campaigns.filter(c => c.status === 'winning');
                const losingCampaigns = campaigns.filter(c => c.status === 'losing');

                const whatsWorking = document.getElementById('whatsWorking');
                const needsImprovement = document.getElementById('needsImprovement');

                if (winningCampaigns.length === 0) {
                    whatsWorking.innerHTML = '<p class="text-gray-500">Set up conversion tracking to see winning campaigns!</p>';
                } else {
                    whatsWorking.innerHTML = winningCampaigns.map(campaign => `
                        <div class="p-3 bg-green-50 rounded-lg">
                            <p class="text-sm font-medium text-green-800">${campaign.name}</p>
                            <p class="text-xs text-green-600">${campaign.roas.toFixed(2)}x ROAS - Strong performer! Consider scaling up budget.</p>
                        </div>
                    `).join('');
                }

                if (losingCampaigns.length === 0) {
                    needsImprovement.innerHTML = '<p class="text-gray-500">All campaigns performing well!</p>';
                } else {
                    needsImprovement.innerHTML = losingCampaigns.map(campaign => `
                        <div class="p-3 bg-red-50 rounded-lg">
                            <p class="text-sm font-medium text-red-800">${campaign.name}</p>
                            <p class="text-xs text-red-600">${campaign.roas.toFixed(2)}x ROAS - ${campaign.roas < 1 ? 'Losing money! Consider pausing or setting up conversion tracking.' : 'Below target, review targeting and creatives.'}</p>
                        </div>
                    `).join('');
                }

                showDebug('Overview UI updated successfully');
            } catch (error) {
                showDebug(`Error updating overview UI: ${error.message}`);
            }
        }

        function updateCampaignsUI() {
            showDebug('Updating campaigns UI');
            const campaignTable = document.getElementById('campaignTable');
            campaignTable.innerHTML = '';

            campaigns.forEach((campaign, index) => {
                try {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-100';
                    
                    const statusColor = campaign.status === 'winning' ? 'bg-green-50 text-green-800' :
                                       campaign.status === 'losing' ? 'bg-red-50 text-red-800' :
                                       'bg-yellow-50 text-yellow-800';

                    row.innerHTML = `
                        <td class="py-3 px-4 font-medium text-gray-900">${campaign.name.length > 40 ? campaign.name.substring(0, 40) + '...' : campaign.name}</td>
                        <td class="py-3 px-4 text-right text-gray-900">¬£${campaign.spend.toLocaleString()}</td>
                        <td class="py-3 px-4 text-right text-gray-900">¬£${campaign.revenue.toLocaleString()}</td>
                        <td class="py-3 px-4 text-right font-medium text-gray-900">${campaign.roas.toFixed(2)}x</td>
                        <td class="py-3 px-4 text-right text-gray-900">${campaign.conversions}</td>
                        <td class="py-3 px-4 text-right text-gray-900">${campaign.ctr.toFixed(2)}%</td>
                        <td class="py-3 px-4 text-right text-gray-900">¬£${campaign.cpc.toFixed(2)}</td>
                        <td class="py-3 px-4 text-center">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusColor}">
                                ${campaign.status}
                            </span>
                        </td>
                    `;
                    campaignTable.appendChild(row);
                } catch (error) {
                    showDebug(`Error creating campaign row ${index}: ${error.message}`);
                }
            });

            showDebug(`Campaigns UI updated with ${campaigns.length} campaigns`);
        }

        function updateCreativesUI() {
            showDebug('Updating creatives UI');
            const creativesGrid = document.getElementById('creativesGrid');
            creativesGrid.innerHTML = '';

            creatives.forEach((creative, index) => {
                try {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow-sm border border-gray-200';
                    
                    const performanceColor = creative.performance_score >= 70 ? 'text-green-600' :
                                           creative.performance_score >= 40 ? 'text-yellow-600' : 'text-red-600';

                    card.innerHTML = `
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-900 mb-1">${creative.name.substring(0, 30)}...</h4>
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800">
                                    ${creative.creative_type}
                                </span>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold ${performanceColor}">${creative.performance_score}/100</div>
                                <div class="text-xs text-gray-500">Performance Score</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <div class="text-gray-600">CTR</div>
                                <div class="font-medium">${creative.ctr.toFixed(2)}%</div>
                            </div>
                            <div>
                                <div class="text-gray-600">CPC</div>
                                <div class="font-medium">¬£${creative.cpc.toFixed(2)}</div>
                            </div>
                            <div>
                                <div class="text-gray-600">Hook Rate</div>
                                <div class="font-medium">${creative.hook_rate.toFixed(1)}%</div>
                            </div>
                            <div>
                                <div class="text-gray-600">Spend</div>
                                <div class="font-medium">¬£${creative.spend.toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                    creativesGrid.appendChild(card);
                } catch (error) {
                    showDebug(`Error creating creative card ${index}: ${error.message}`);
                }
            });

            showDebug(`Creatives UI updated with ${creatives.length} creatives`);
        }

        async function loadData() {
            const dateRange = document.getElementById('dateRange').value;
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const refreshIcon = document.getElementById('refreshIcon');

            showDebug(`Starting data load for ${dateRange}`);

            loading.classList.remove('hidden');
            error.classList.add('hidden');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

            refreshIcon.style.animation = 'spin 1s linear infinite';

            try {
                showDebug('Fetching account data...');
                accountData = await fetchAccountData(dateRange);
                
                showDebug('Fetching campaigns...');
                campaigns = await fetchCampaigns(dateRange);
                
                showDebug('Fetching creatives...');
                creatives = await fetchCreatives(dateRange);

                showDebug('Updating UI...');
                updateOverviewUI();
                updateCampaignsUI();
                updateCreativesUI();

                loading.classList.add('hidden');
                document.getElementById('overview-content').classList.remove('hidden');

                showDebug('Data load completed successfully');
            } catch (err) {
                showDebug(`Data load failed: ${err.message}`);
                loading.classList.add('hidden');
                error.classList.remove('hidden');
                document.getElementById('errorMessage').textContent = err.message;
            } finally {
                refreshIcon.style.animation = '';
            }
        }

        // Event listeners
        document.getElementById('refreshBtn').addEventListener('click', () => {
            showDebug('Refresh button clicked');
            loadData();
        });
        
        document.getElementById('dateRange').addEventListener('change', () => {
            showDebug('Date range changed');
            loadData();
        });

        // Load data on page load
        showDebug('Page loaded, starting initial data load');
        loadData();
    </script>
</body>
</html>
