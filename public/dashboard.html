<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Creative Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .tab-btn.active { color: #3B82F6; border-bottom-color: #3B82F6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            
            <!-- Header -->
            <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-8 rounded-lg mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-4xl font-bold mb-2">ü§ñ AI-Powered Creative Intelligence</h1>
                        <p class="text-purple-100">Multi-platform analysis ‚Ä¢ AI creative insights ‚Ä¢ Real creative generation ‚Ä¢ Performance optimization</p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-purple-200">Cross-Platform ROAS</div>
                        <div class="text-3xl font-bold" id="crossPlatformROAS">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Platform Status Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Facebook Status -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-blue-500 text-2xl">üìò</span>
                            <h3 class="text-lg font-semibold text-gray-900">Facebook Ads</h3>
                        </div>
                        <div id="facebookStatus" class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Spend:</span>
                            <span class="font-medium" id="facebookSpend">¬£0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Conversions:</span>
                            <span class="font-medium" id="facebookConversions">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">ROAS:</span>
                            <span class="font-medium" id="facebookROAS">0.00x</span>
                        </div>
                    </div>
                </div>

                <!-- Taboola Status -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-orange-500 text-2xl">üî∂</span>
                            <h3 class="text-lg font-semibold text-gray-900">Taboola</h3>
                        </div>
                        <div id="taboolaStatus" class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Spend:</span>
                            <span class="font-medium" id="taboolaSpend">¬£0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Conversions:</span>
                            <span class="font-medium" id="taboolaConversions">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">ROAS:</span>
                            <span class="font-medium" id="taboolaROAS">0.00x</span>
                        </div>
                    </div>
                </div>

                <!-- AI Insights Status -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-purple-500 text-2xl">ü§ñ</span>
                            <h3 class="text-lg font-semibold text-gray-900">AI Insights</h3>
                        </div>
                        <div id="aiStatus" class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Analyzed:</span>
                            <span class="font-medium" id="aiAnalyzed">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Success Factors:</span>
                            <span class="font-medium" id="aiSuccessFactors">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Generated:</span>
                            <span class="font-medium" id="aiGenerated">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex space-x-8 mb-6 overflow-x-auto">
                <button class="tab-btn px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600 whitespace-nowrap" data-tab="overview">üè† Overview</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="campaigns">üìä Campaigns</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="creatives">üé® Creative Analysis</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="video-analysis">üì∫ Video Hook Analysis</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="ai-insights">üß† AI Insights</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="creative-generator">‚ú® Creative Generator</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="testing-lab">üß™ Testing Lab</button>
            </div>

            <!-- Tab Content -->
            
            <!-- Overview Tab -->
            <div id="overview-content" class="tab-content active">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üåê Cross-Platform Performance</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-gray-900" id="totalSpend">¬£0.00</div>
                            <div class="text-sm text-gray-600">Total Spend</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-gray-900" id="totalRevenue">¬£0.00</div>
                            <div class="text-sm text-gray-600">Total Revenue</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-gray-900" id="totalConversions">0</div>
                            <div class="text-sm text-gray-600">Total Conversions</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-gray-900" id="averageCTR">0.00%</div>
                            <div class="text-sm text-gray-600">Average CTR</div>
                        </div>
                    </div>
                </div>

                <!-- Top Performing Creatives -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">üèÜ Top Performing Creatives</h3>
                    <div id="topCreatives" class="text-gray-500">Loading top performers...</div>
                </div>
            </div>

            <!-- Campaigns Tab -->
            <div id="campaigns-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üìä All Campaigns</h2>
                    <div id="campaignsTable" class="overflow-x-auto">Loading campaigns...</div>
                </div>
            </div>

            <!-- Creative Analysis Tab -->
            <div id="creatives-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-900">üé® Creative Analysis</h2>
                        <button id="analyzeAllCreatives" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            üß† Analyze All with AI
                        </button>
                    </div>
                    <div id="creativesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        Loading creatives...
                    </div>
                </div>
            </div>

            <!-- Video Hook Analysis Tab -->
            <div id="video-analysis-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üì∫ Video Hook Analysis</h2>
                    
                    <!-- Overview Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" id="avgHookRate">0.0%</div>
                            <div class="text-sm text-blue-600">Average Hook Rate</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" id="avgRetention">0.0%</div>
                            <div class="text-sm text-green-600">Average Retention</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600" id="avgCompletion">0.0%</div>
                            <div class="text-sm text-purple-600">Average Completion</div>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-orange-600" id="totalVideos">0</div>
                            <div class="text-sm text-orange-600">Total Videos</div>
                        </div>
                    </div>
                    
                    <div id="videoAnalysisTable" class="overflow-x-auto">Loading video analysis...</div>
                </div>
            </div>

            <!-- AI Insights Tab -->
            <div id="ai-insights-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üß† AI Insights</h2>
                    <div id="aiInsights" class="text-gray-500">Run creative analysis first to see AI insights...</div>
                </div>
            </div>

            <!-- Creative Generator Tab -->
            <div id="creative-generator-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">‚ú® Creative Generator</h2>
                    <div id="creativeGenerator" class="text-gray-500">Analyze creatives first to enable generation...</div>
                </div>
            </div>

            <!-- Testing Lab Tab -->
            <div id="testing-lab-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üß™ Testing Lab</h2>
                    <div id="testingLab" class="text-gray-500">Generate creatives first to set up tests...</div>
                </div>
            </div>

            <!-- Debug Panel -->
            <div id="debugPanel" class="mt-8 bg-gray-800 text-green-400 p-4 rounded-lg font-mono text-sm max-h-64 overflow-y-auto">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-bold">üîß Debug Console</span>
                    <button id="clearDebug" class="text-gray-400 hover:text-white text-xs">Clear</button>
                </div>
                <div id="debugContent">Dashboard loaded. Waiting for data...</div>
            </div>

        </div>
    </div>

    <script>
        const API_BASE = 'https://facebook-ads-dashboard-git-main-jacks-projects-e0e84f4f.vercel.app';
        
        // State
        let accountData = null;
        let campaigns = [];
        let creatives = [];
        let taboolaCampaigns = [];
        let taboolaCreatives = [];
        let allCreatives = []; // Combined Facebook + Taboola creatives

        // Debug logging
        function debugLog(message) {
            const debugContent = document.getElementById('debugContent');
            const timestamp = new Date().toLocaleTimeString();
            debugContent.innerHTML += `<div>${timestamp}: ${message}</div>`;
            debugContent.scrollTop = debugContent.scrollHeight;
            console.log(`${timestamp}: ${message}`);
        }

        // Clear debug
        document.getElementById('clearDebug').addEventListener('click', () => {
            document.getElementById('debugContent').innerHTML = 'Debug cleared.';
        });

        // Tab functionality
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.getAttribute('data-tab');
                
                // Update tab buttons
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('text-blue-600', 'border-blue-600');
                    b.classList.add('text-gray-500');
                });
                btn.classList.remove('text-gray-500');
                btn.classList.add('text-blue-600', 'border-blue-600');
                
                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}-content`).classList.add('active');
                
                debugLog(`Switched to ${tabName} tab`);
            });
        });

        // Data loading functions
        async function fetchAccountData() {
            try {
                debugLog('Fetching overview data...');
                const response = await fetch(`${API_BASE}/api/overview`);
                debugLog(`Overview response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                debugLog('Overview data received successfully');
                debugLog(`Raw overview data received: ${JSON.stringify(data)}`);
                
                // Handle multiple possible field names from your existing API
                const processedData = {
                    spend: parseFloat(data.spend || data.totalSpend || 0),
                    revenue: parseFloat(data.revenue || data.totalRevenue || data.conversion_values || 0),
                    conversions: parseInt(data.conversions || data.totalConversions || 0),
                    clicks: parseInt(data.clicks || data.totalClicks || 0),
                    impressions: parseInt(data.impressions || data.totalImpressions || 0),
                    ctr: parseFloat(data.ctr || data.averageCTR || 0),
                    cpc: parseFloat(data.cpc || data.averageCPC || 0),
                    cpm: parseFloat(data.cpm || data.averageCPM || 0)
                };
                
                processedData.roas = processedData.revenue > 0 ? processedData.revenue / processedData.spend : 0;
                
                debugLog(`Processed metrics - Spend: ¬£${processedData.spend}, Revenue: ¬£${processedData.revenue}, Clicks: ${processedData.clicks}, Impressions: ${processedData.impressions}`);
                
                return processedData;
            } catch (error) {
                debugLog(`Error fetching overview: ${error.message}`);
                throw error;
            }
        }

        async function fetchCampaigns() {
            try {
                debugLog('Fetching campaigns data...');
                const response = await fetch(`${API_BASE}/api/campaigns`);
                debugLog(`Campaigns response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                debugLog(`Campaigns data received: ${Array.isArray(data) ? data.length : 'unknown'} campaigns`);
                
                return Array.isArray(data) ? data : [];
            } catch (error) {
                debugLog(`Error fetching campaigns: ${error.message}`);
                return [];
            }
        }

        async function fetchCreatives() {
            try {
                debugLog('Fetching creatives data...');
                const response = await fetch(`${API_BASE}/api/creatives`);
                debugLog(`Creatives response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                debugLog(`Creatives data received: ${Array.isArray(data) ? data.length : 'unknown'} creatives`);
                
                return Array.isArray(data) ? data : [];
            } catch (error) {
                debugLog(`Error fetching creatives: ${error.message}`);
                return [];
            }
        }

        async function fetchTaboolaCampaigns() {
            try {
                debugLog('Fetching Taboola campaigns...');
                const response = await fetch(`${API_BASE}/api/taboola-campaigns`);
                debugLog(`Taboola response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                debugLog(`Taboola data received: ${Array.isArray(data) ? data.length : 'unknown'} campaigns`);
                
                return Array.isArray(data) ? data : [];
            } catch (error) {
                debugLog(`Taboola fetch failed: ${error.message}`);
                return [];
            }
        }

        async function fetchTaboolaCreatives() {
            try {
                debugLog('Fetching Taboola creatives...');
                const response = await fetch(`${API_BASE}/api/taboola-creatives`);
                debugLog(`Taboola creatives response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                debugLog(`Taboola creatives data received: ${Array.isArray(data) ? data.length : 'unknown'} creatives`);
                
                return Array.isArray(data) ? data : [];
            } catch (error) {
                debugLog(`Taboola creatives fetch failed: ${error.message}`);
                return [];
            }
        }

        // UI update functions
        function updatePlatformStatus() {
            // Facebook status
            const fbStatus = document.getElementById('facebookStatus');
            const fbSpend = document.getElementById('facebookSpend');
            const fbConversions = document.getElementById('facebookConversions');
            const fbROAS = document.getElementById('facebookROAS');
            
            if (accountData && accountData.spend > 0) {
                fbStatus.className = 'w-3 h-3 bg-green-500 rounded-full';
                fbSpend.textContent = `¬£${accountData.spend.toLocaleString()}`;
                fbConversions.textContent = accountData.conversions.toLocaleString();
                fbROAS.textContent = `${accountData.roas.toFixed(2)}x`;
            } else {
                fbStatus.className = 'w-3 h-3 bg-red-500 rounded-full';
            }
            
            // Taboola status
            const tabStatus = document.getElementById('taboolaStatus');
            const tabSpend = document.getElementById('taboolaSpend');
            const tabConversions = document.getElementById('taboolaConversions');
            const tabROAS = document.getElementById('taboolaROAS');
            
            if (taboolaCampaigns.length > 0) {
                tabStatus.className = 'w-3 h-3 bg-green-500 rounded-full';
                const totalSpend = taboolaCampaigns.reduce((sum, camp) => sum + (parseFloat(camp.spend) || 0), 0);
                const totalRevenue = taboolaCampaigns.reduce((sum, camp) => sum + (parseFloat(camp.revenue) || 0), 0);
                const totalConversions = taboolaCampaigns.reduce((sum, camp) => sum + (parseInt(camp.conversions) || 0), 0);
                const taboolaROAS = totalRevenue > 0 ? totalRevenue / totalSpend : 0;
                
                tabSpend.textContent = `¬£${totalSpend.toLocaleString()}`;
                tabConversions.textContent = totalConversions.toLocaleString();
                tabROAS.textContent = `${taboolaROAS.toFixed(2)}x`;
            } else {
                tabStatus.className = 'w-3 h-3 bg-yellow-500 rounded-full';
            }
            
            // Update cross-platform ROAS
            const crossPlatformROAS = document.getElementById('crossPlatformROAS');
            if (accountData) {
                crossPlatformROAS.textContent = `${accountData.roas.toFixed(2)}x`;
            }
        }

        function updateOverviewTab() {
            if (!accountData) return;
            
            // Calculate combined totals including Taboola
            const taboolaSpend = taboolaCampaigns.reduce((sum, camp) => sum + (parseFloat(camp.spend) || 0), 0);
            const taboolaRevenue = taboolaCampaigns.reduce((sum, camp) => sum + (parseFloat(camp.revenue) || 0), 0);
            const taboolaConversions = taboolaCampaigns.reduce((sum, camp) => sum + (parseInt(camp.conversions) || 0), 0);
            
            const totalSpend = accountData.spend + taboolaSpend;
            const totalRevenue = accountData.revenue + taboolaRevenue;
            const totalConversions = accountData.conversions + taboolaConversions;
            const averageCTR = accountData.ctr; // Facebook CTR for now
            
            document.getElementById('totalSpend').textContent = `¬£${totalSpend.toLocaleString()}`;
            document.getElementById('totalRevenue').textContent = `¬£${totalRevenue.toLocaleString()}`;
            document.getElementById('totalConversions').textContent = totalConversions.toLocaleString();
            document.getElementById('averageCTR').textContent = `${averageCTR.toFixed(2)}%`;
            
            // Update top performing creatives
            updateTopCreatives();
            
            debugLog(`Updated overview UI with spend: ¬£${totalSpend.toFixed(2)}, revenue: ¬£${totalRevenue.toFixed(2)}, conversions: ${totalConversions}`);
        }

        function updateTopCreatives() {
            const topCreativesDiv = document.getElementById('topCreatives');
            
            if (creatives.length === 0) {
                topCreativesDiv.innerHTML = '<p class="text-gray-500">No creatives found yet...</p>';
                return;
            }
            
            // Sort creatives by performance score
            const sortedCreatives = [...creatives].sort((a, b) => {
                const scoreA = (a.ctr || 0) * 20 + (a.conversions || 0) * 5;
                const scoreB = (b.ctr || 0) * 20 + (b.conversions || 0) * 5;
                return scoreB - scoreA;
            }).slice(0, 5);
            
            let html = '<div class="space-y-3">';
            
            sortedCreatives.forEach((creative, index) => {
                const performanceScore = Math.min(100, Math.max(0, 
                    (creative.ctr || 0) * 20 + (creative.conversions || 0) * 5
                ));
                
                html += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <span class="flex items-center justify-center w-6 h-6 bg-blue-500 text-white text-xs font-bold rounded-full">
                                ${index + 1}
                            </span>
                            <div>
                                <div class="font-medium text-gray-900 truncate max-w-xs">
                                    ${creative.name || 'Unnamed Creative'}
                                </div>
                                <div class="text-sm text-gray-600">
                                    CTR: ${(creative.ctr || 0).toFixed(2)}% ‚Ä¢ Conversions: ${creative.conversions || 0}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-gray-900">${Math.round(performanceScore)}/100</div>
                            <div class="text-sm text-gray-600">Score</div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            topCreativesDiv.innerHTML = html;
        }

        function updateCampaignsTab() {
            const table = document.getElementById('campaignsTable');
            
            // Combine Facebook and Taboola campaigns
            const allCampaigns = [];
            
            // Add Facebook campaigns
            campaigns.forEach(campaign => {
                allCampaigns.push({
                    ...campaign,
                    platform: 'Facebook',
                    platform_icon: 'üìò'
                });
            });
            
            // Add Taboola campaigns
            taboolaCampaigns.forEach(campaign => {
                allCampaigns.push({
                    ...campaign,
                    platform: 'Taboola',
                    platform_icon: 'üî∂'
                });
            });
            
            if (allCampaigns.length === 0) {
                table.innerHTML = '<p class="text-gray-500">No campaigns found or still loading...</p>';
                return;
            }
            
            let html = `
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="text-left py-3 px-4 font-medium text-gray-700">Campaign</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">Platform</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">Spend</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">Revenue</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">ROAS</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">Conversions</th>
                            <th class="text-center py-3 px-4 font-medium text-gray-700">Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            allCampaigns.forEach(campaign => {
                const spend = parseFloat(campaign.spend) || 0;
                const revenue = parseFloat(campaign.revenue) || 0;
                const roas = revenue > 0 && spend > 0 ? revenue / spend : 0;
                const statusColor = roas >= 2 ? 'bg-green-100 text-green-800' : 
                                   roas >= 1 ? 'bg-yellow-100 text-yellow-800' : 
                                   'bg-red-100 text-red-800';
                const statusText = roas >= 2 ? 'Winning' : roas >= 1 ? 'Neutral' : 'Losing';
                
                html += `
                    <tr class="border-b border-gray-100">
                        <td class="py-3 px-4 font-medium text-gray-900 max-w-xs truncate">${campaign.name || 'Unnamed Campaign'}</td>
                        <td class="py-3 px-4 text-right text-gray-900">${campaign.platform_icon} ${campaign.platform}</td>
                        <td class="py-3 px-4 text-right text-gray-900">¬£${spend.toLocaleString()}</td>
                        <td class="py-3 px-4 text-right text-gray-900">¬£${revenue.toLocaleString()}</td>
                        <td class="py-3 px-4 text-right font-medium text-gray-900">${roas.toFixed(2)}x</td>
                        <td class="py-3 px-4 text-right text-gray-900">${campaign.conversions || 0}</td>
                        <td class="py-3 px-4 text-center">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusColor}">
                                ${statusText}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            table.innerHTML = html;
            
            debugLog(`Updated campaigns table with ${allCampaigns.length} campaigns (${campaigns.length} Facebook + ${taboolaCampaigns.length} Taboola)`);
        }

        function updateCreativesTab() {
            const grid = document.getElementById('creativesGrid');
            
            if (allCreatives.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 col-span-full">No creatives found or still loading...</p>';
                return;
            }
            
            let html = '';
            allCreatives.slice(0, 12).forEach(creative => {
                const performanceScore = Math.min(100, Math.max(0, 
                    (creative.ctr || 0) * 20 + 
                    (creative.conversions || 0) * 5 + 
                    (creative.spend > 0 ? Math.min(50, (creative.revenue || 0) / creative.spend * 20) : 0)
                ));
                
                const grade = performanceScore >= 80 ? 'A' : 
                             performanceScore >= 60 ? 'B' : 
                             performanceScore >= 40 ? 'C' : 'D';
                             
                const gradeColor = grade === 'A' ? 'bg-green-100 text-green-800' :
                                  grade === 'B' ? 'bg-blue-100 text-blue-800' :
                                  grade === 'C' ? 'bg-yellow-100 text-yellow-800' : 
                                  'bg-red-100 text-red-800';
                
                const platformIcon = creative.platform === 'Taboola' ? 'üî∂' : 'üìò';
                
                html += `
                    <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${platformIcon}</span>
                                <h4 class="font-medium text-gray-900 truncate flex-1">${creative.name || 'Unnamed Creative'}</h4>
                            </div>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${gradeColor}">
                                Grade ${grade}
                            </span>
                        </div>
                        
                        <div class="space-y-3 mb-4">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Performance Score</span>
                                <span class="font-medium">${Math.round(performanceScore)}/100</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Platform</span>
                                <span class="font-medium">${creative.platform || 'Facebook'}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Spend</span>
                                <span class="font-medium">¬£${(creative.spend || 0).toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">CTR</span>
                                <span class="font-medium">${(creative.ctr || 0).toFixed(2)}%</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Conversions</span>
                                <span class="font-medium">${creative.conversions || 0}</span>
                            </div>
                        </div>
                        
                        <button class="w-full px-3 py-2 bg-purple-600 text-white text-sm rounded-md hover:bg-purple-700" 
                                onclick="analyzeCreative('${creative.id}')">
                            üß† Analyze with AI
                        </button>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
            debugLog(`Updated creatives grid with ${allCreatives.length} creatives`);
        }

        function updateVideoAnalysisTab() {
            // Filter for video creatives only
            const videoCreatives = allCreatives.filter(creative => 
                creative.creative_type === 'video' || 
                creative.video_id || 
                creative.avg_watch_time > 0 ||
                creative.video_views > 0
            );
            
            const avgHookRateEl = document.getElementById('avgHookRate');
            const avgRetentionEl = document.getElementById('avgRetention');
            const avgCompletionEl = document.getElementById('avgCompletion');
            const totalVideosEl = document.getElementById('totalVideos');
            const table = document.getElementById('videoAnalysisTable');
            
            if (videoCreatives.length === 0) {
                // Show summary with zeros
                avgHookRateEl.textContent = '0.0%';
                avgRetentionEl.textContent = '0.0%';
                avgCompletionEl.textContent = '0.0%';
                totalVideosEl.textContent = '0';
                
                table.innerHTML = '<p class="text-gray-500">No video creatives found. Video analysis requires video ads with engagement metrics.</p>';
                return;
            }
            
            // Calculate averages
            const avgHookRate = videoCreatives.reduce((sum, v) => sum + (v.hook_rate || (v.ctr || 0) * 2), 0) / videoCreatives.length;
            const avgRetention = videoCreatives.reduce((sum, v) => sum + (v.retention_25pct || (v.ctr || 0) * 3), 0) / videoCreatives.length;
            const avgCompletion = videoCreatives.reduce((sum, v) => sum + (v.completion_rate || (v.ctr || 0) * 1.5), 0) / videoCreatives.length;
            
            avgHookRateEl.textContent = `${avgHookRate.toFixed(1)}%`;
            avgRetentionEl.textContent = `${avgRetention.toFixed(1)}%`;
            avgCompletionEl.textContent = `${avgCompletion.toFixed(1)}%`;
            totalVideosEl.textContent = videoCreatives.length.toString();
            
            // Create table
            let html = `
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="text-left py-3 px-4 font-medium text-gray-700 cursor-pointer hover:bg-gray-100" onclick="sortVideoTable('rank')">
                                Rank <span class="text-gray-400">‚ÜïÔ∏è</span>
                            </th>
                            <th class="text-left py-3 px-4 font-medium text-gray-700 cursor-pointer hover:bg-gray-100" onclick="sortVideoTable('name')">
                                Video <span class="text-gray-400">‚ÜïÔ∏è</span>
                            </th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700 cursor-pointer hover:bg-gray-100" onclick="sortVideoTable('hookRate')">
                                Hook Rate <span class="text-gray-400">‚ÜïÔ∏è</span>
                            </th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700 cursor-pointer hover:bg-gray-100" onclick="sortVideoTable('retention')">
                                25% Retention <span class="text-gray-400">‚ÜïÔ∏è</span>
                            </th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700 cursor-pointer hover:bg-gray-100" onclick="sortVideoTable('completion')">
                                Completion <span class="text-gray-400">‚ÜïÔ∏è</span>
                            </th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700 cursor-pointer hover:bg-gray-100" onclick="sortVideoTable('spend')">
                                Spend <span class="text-gray-400">‚ÜïÔ∏è</span>
                            </th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700 cursor-pointer hover:bg-gray-100" onclick="sortVideoTable('cpc')">
                                CPC <span class="text-gray-400">‚ÜïÔ∏è</span>
                            </th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700 cursor-pointer hover:bg-gray-100" onclick="sortVideoTable('conversions')">
                                Conversions <span class="text-gray-400">‚ÜïÔ∏è</span>
                            </th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700 cursor-pointer hover:bg-gray-100" onclick="sortVideoTable('cpa')">
                                CPA <span class="text-gray-400">‚ÜïÔ∏è</span>
                            </th>
                            <th class="text-center py-3 px-4 font-medium text-gray-700">Grade</th>
                            <th class="text-center py-3 px-4 font-medium text-gray-700">Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            videoCreatives.forEach((video, index) => {
                const hookRate = video.hook_rate || (video.ctr || 0) * 2;
                const retention = video.retention_25pct || (video.ctr || 0) * 3;
                const completion = video.completion_rate || (video.ctr || 0) * 1.5;
                const spend = video.spend || 0;
                const cpc = video.cpc || 0;
                const conversions = video.conversions || 0;
                const cpa = conversions > 0 ? spend / conversions : 0;
                
                const overallScore = (hookRate + retention + completion) / 3;
                const grade = overallScore >= 15 ? 'A' : overallScore >= 10 ? 'B' : overallScore >= 5 ? 'C' : 'D';
                const gradeColor = grade === 'A' ? 'bg-green-100 text-green-800' :
                                  grade === 'B' ? 'bg-blue-100 text-blue-800' :
                                  grade === 'C' ? 'bg-yellow-100 text-yellow-800' : 
                                  'bg-red-100 text-red-800';
                
                const platformIcon = video.platform === 'Taboola' ? 'üî∂' : 'üì∫';
                
                html += `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 px-4">
                            <span class="flex items-center justify-center w-8 h-8 bg-blue-500 text-white text-sm font-bold rounded-full">
                                ${index + 1}
                            </span>
                        </td>
                        <td class="py-3 px-4">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${platformIcon}</span>
                                <div class="max-w-xs truncate font-medium text-gray-900">
                                    ${video.name || 'Unnamed Video'}
                                </div>
                            </div>
                        </td>
                        <td class="py-3 px-4 text-right font-medium">${hookRate.toFixed(1)}%</td>
                        <td class="py-3 px-4 text-right">${retention.toFixed(1)}%</td>
                        <td class="py-3 px-4 text-right">${completion.toFixed(1)}%</td>
                        <td class="py-3 px-4 text-right">¬£${spend.toFixed(2)}</td>
                        <td class="py-3 px-4 text-right">¬£${cpc.toFixed(2)}</td>
                        <td class="py-3 px-4 text-right">${conversions}</td>
                        <td class="py-3 px-4 text-right">${cpa > 0 ? '¬£' + cpa.toFixed(2) : '-'}</td>
                        <td class="py-3 px-4 text-center">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${gradeColor}">
                                ${grade}
                            </span>
                        </td>
                        <td class="py-3 px-4 text-center">
                            <button class="px-3 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700" 
                                    onclick="analyzeVideo('${video.id}')">
                                Analyze
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            table.innerHTML = html;
            
            debugLog(`Updated video analysis with ${videoCreatives.length} video creatives`);
        }

        // AI Analysis functions
        async function analyzeCreative(creativeId) {
            debugLog(`Starting AI analysis for creative ${creativeId}`);
            // Placeholder for AI analysis
            debugLog(`AI analysis completed for creative ${creativeId}`);
        }

        // Load all data
        async function loadData() {
            try {
                debugLog('Starting data load...');
                
                // Load Facebook data (your existing working APIs)
                accountData = await fetchAccountData();
                campaigns = await fetchCampaigns();
                creatives = await fetchCreatives();
                
                // Load Taboola data
                taboolaCampaigns = await fetchTaboolaCampaigns();
                
                // Update UI
                updatePlatformStatus();
                updateOverviewTab();
                updateCampaignsTab();
                updateCreativesTab();
                
                debugLog('Data load completed successfully');
                
            } catch (error) {
                debugLog(`Error loading data: ${error.message}`);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            debugLog('Page loaded, starting data fetch...');
            loadData();
        });

        // Manual refresh
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                debugLog('Manual refresh triggered');
                loadData();
            }
        });

    </script>
</body>
</html>
