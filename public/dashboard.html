<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Creative Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .tab-btn.active { color: #3B82F6; border-bottom-color: #3B82F6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            
            <!-- Header -->
            <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-8 rounded-lg mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-4xl font-bold mb-2">ü§ñ AI-Powered Creative Intelligence</h1>
                        <p class="text-purple-100">Multi-platform analysis ‚Ä¢ AI creative insights ‚Ä¢ Real creative generation ‚Ä¢ Performance optimization</p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-purple-200">Cross-Platform ROAS</div>
                        <div class="text-3xl font-bold" id="crossPlatformROAS">0.00x</div>
                    </div>
                </div>
            </div>

            <!-- Platform Status Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Facebook Status -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-blue-500 text-2xl">üìò</span>
                            <h3 class="text-lg font-semibold text-gray-900">Facebook Ads</h3>
                        </div>
                        <div id="facebookStatus" class="w-3 h-3 bg-green-500 rounded-full"></div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Spend:</span>
                            <span class="font-medium" id="facebookSpend">¬£0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Conversions:</span>
                            <span class="font-medium" id="facebookConversions">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">ROAS:</span>
                            <span class="font-medium" id="facebookROAS">0.00x</span>
                        </div>
                    </div>
                </div>

                <!-- Taboola Status -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-orange-500 text-2xl">üî∂</span>
                            <h3 class="text-lg font-semibold text-gray-900">Taboola</h3>
                        </div>
                        <div id="taboolaStatus" class="w-3 h-3 bg-green-500 rounded-full"></div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Spend:</span>
                            <span class="font-medium" id="taboolaSpend">¬£0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Conversions:</span>
                            <span class="font-medium" id="taboolaConversions">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">ROAS:</span>
                            <span class="font-medium" id="taboolaROAS">0.00x</span>
                        </div>
                    </div>
                </div>

                <!-- AI Insights Status -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-purple-500 text-2xl">ü§ñ</span>
                            <h3 class="text-lg font-semibold text-gray-900">AI Insights</h3>
                        </div>
                        <div id="aiStatus" class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Analyzed:</span>
                            <span class="font-medium" id="aiAnalyzed">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Success Factors:</span>
                            <span class="font-medium" id="aiSuccessFactors">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Generated:</span>
                            <span class="font-medium" id="aiGenerated">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex space-x-8 mb-6 overflow-x-auto">
                <button class="tab-btn px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600 whitespace-nowrap active" data-tab="overview">üè† Overview</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="campaigns">üìä Campaigns</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="creatives">üé® Creative Analysis</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="video-analysis">üì∫ Video Hook Analysis</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="ai-insights">üß† AI Insights</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="creative-generator">‚ú® Creative Generator</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="testing-lab">üß™ Testing Lab</button>
            </div>

            <!-- Tab Content -->
            
            <!-- Overview Tab -->
            <div id="overview-content" class="tab-content active">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üåê Cross-Platform Performance</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-gray-900" id="totalSpend">¬£0.00</div>
                            <div class="text-sm text-gray-600">Total Spend</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-gray-900" id="totalRevenue">¬£0.00</div>
                            <div class="text-sm text-gray-600">Total Revenue</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-gray-900" id="totalConversions">0</div>
                            <div class="text-sm text-gray-600">Total Conversions</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-gray-900" id="averageCTR">0.00%</div>
                            <div class="text-sm text-gray-600">Average CTR</div>
                        </div>
                    </div>
                </div>

                <!-- Top Performing Creatives -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">üèÜ Top Performing Creatives</h3>
                    <div id="topCreatives" class="text-gray-500">Loading top performers...</div>
                </div>
            </div>

            <!-- Campaigns Tab -->
            <div id="campaigns-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üìä All Campaigns</h2>
                    <div id="campaignsTable" class="overflow-x-auto">Loading campaigns...</div>
                </div>
            </div>

            <!-- Creative Analysis Tab -->
            <div id="creatives-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-900">üé® Creative Analysis</h2>
                        <div class="flex gap-2">
                            <button id="analyzeAllCreatives" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                üß† Analyze All with AI
                            </button>
                        </div>
                    </div>
                    <div id="creativesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        Loading creatives...
                    </div>
                </div>
            </div>

            <!-- Video Hook Analysis Tab -->
            <div id="video-analysis-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üì∫ Video Hook Analysis</h2>
                    
                    <!-- Overview Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" id="avgHookRate">0.0%</div>
                            <div class="text-sm text-blue-600">Average Hook Rate</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" id="avgRetention">0.0%</div>
                            <div class="text-sm text-green-600">Average Retention</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600" id="avgCompletion">0.0%</div>
                            <div class="text-sm text-purple-600">Average Completion</div>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-orange-600" id="totalVideos">0</div>
                            <div class="text-sm text-orange-600">Total Videos</div>
                        </div>
                    </div>
                    
                    <div id="videoAnalysisTable" class="overflow-x-auto">Loading video analysis...</div>
                </div>
            </div>

            <!-- AI Insights Tab -->
            <div id="ai-insights-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üß† AI Insights</h2>
                    <div id="aiInsights" class="text-gray-500">Run creative analysis first to see AI insights...</div>
                </div>
            </div>

            <!-- Creative Generator Tab -->
            <div id="creative-generator-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">‚ú® Creative Generator</h2>
                    
                    <!-- Generation Controls -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Base Creative:</label>
                                <select id="baseCreativeSelect" class="w-full px-3 py-2 border border-gray-300 rounded">
                                    <option value="">Select top performer...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Generation Type:</label>
                                <select id="generationType" class="w-full px-3 py-2 border border-gray-300 rounded">
                                    <option value="variation">Create Variations</option>
                                    <option value="style_transfer">Style Transfer</option>
                                    <option value="concept_remix">Concept Remix</option>
                                    <option value="platform_adaptation">Platform Adaptation</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Target Platform:</label>
                                <select id="targetPlatform" class="w-full px-3 py-2 border border-gray-300 rounded">
                                    <option value="facebook">Facebook</option>
                                    <option value="taboola">Taboola</option>
                                    <option value="both">Both</option>
                                </select>
                            </div>
                        </div>
                        <button id="generateCreatives" class="mt-4 px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            üöÄ Generate with AI
                        </button>
                    </div>

                    <div id="generatedCreatives" class="text-gray-500">Select a base creative and configure generation options...</div>
                </div>
            </div>

            <!-- Testing Lab Tab -->
            <div id="testing-lab-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üß™ Testing Lab</h2>
                    <div id="testingLab" class="text-gray-500">Generate creatives first to set up tests...</div>
                </div>
            </div>

            <!-- Debug Panel -->
            <div id="debugPanel" class="mt-8 bg-gray-800 text-green-400 p-4 rounded-lg font-mono text-sm max-h-64 overflow-y-auto">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-bold">üîß Debug Console</span>
                    <button id="clearDebug" class="text-gray-400 hover:text-white text-xs">Clear</button>
                </div>
                <div id="debugContent">Dashboard loaded. Waiting for data...</div>
            </div>

        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        
        // State
        let accountData = null;
        let campaigns = [];
        let creatives = [];
        let taboolaCampaigns = [];
        let taboolaCreatives = [];
        let allCreatives = [];

        // Debug logging
        function debugLog(message) {
            const debugContent = document.getElementById('debugContent');
            const timestamp = new Date().toLocaleTimeString();
            debugContent.innerHTML += `<div>${timestamp}: ${message}</div>`;
            debugContent.scrollTop = debugContent.scrollHeight;
            console.log(`${timestamp}: ${message}`);
        }

        // Clear debug
        document.getElementById('clearDebug').addEventListener('click', () => {
            document.getElementById('debugContent').innerHTML = 'Debug cleared.';
        });

        // Tab functionality
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.getAttribute('data-tab');
                
                // Update tab buttons
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('text-blue-600', 'border-blue-600', 'active');
                    b.classList.add('text-gray-500');
                });
                btn.classList.remove('text-gray-500');
                btn.classList.add('text-blue-600', 'border-blue-600', 'active');
                
                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}-content`).classList.add('active');
                
                debugLog(`Switched to ${tabName} tab`);
            });
        });

        // Data loading functions using YOUR existing working APIs
        async function fetchAccountData() {
            try {
                debugLog('üìä Calculating overview from campaigns and creatives...');
                
                // Since you don't have facebook-overview, let's calculate from campaigns
                const campaignsData = await fetchCampaigns();
                const creativesData = await fetchCreatives();
                
                // Calculate totals from campaigns
                const totalSpend = campaignsData.reduce((sum, camp) => sum + (parseFloat(camp.spend) || 0), 0);
                const totalRevenue = campaignsData.reduce((sum, camp) => sum + (parseFloat(camp.revenue) || 0), 0);
                const totalConversions = campaignsData.reduce((sum, camp) => sum + (parseInt(camp.conversions) || 0), 0);
                const totalClicks = creativesData.reduce((sum, creative) => sum + (parseInt(creative.clicks) || 0), 0);
                const totalImpressions = creativesData.reduce((sum, creative) => sum + (parseInt(creative.impressions) || 0), 0);
                
                const averageCTR = creativesData.length > 0 ? 
                    creativesData.reduce((sum, creative) => sum + (parseFloat(creative.ctr) || 0), 0) / creativesData.length : 0;
                const averageCPC = creativesData.length > 0 ? 
                    creativesData.reduce((sum, creative) => sum + (parseFloat(creative.cpc) || 0), 0) / creativesData.length : 0;
                const totalROAS = totalSpend > 0 ? totalRevenue / totalSpend : 0;
                
                debugLog(`‚úÖ Overview calculated: ¬£${totalSpend} spend, ${totalConversions} conversions`);
                
                return {
                    totalSpend,
                    totalRevenue,
                    totalConversions,
                    totalClicks,
                    totalImpressions,
                    averageCTR,
                    averageCPC,
                    totalROAS
                };
            } catch (error) {
                debugLog(`‚ùå Error calculating overview: ${error.message}`);
                return {
                    totalSpend: 0,
                    totalRevenue: 0,
                    totalConversions: 0,
                    totalClicks: 0,
                    totalImpressions: 0,
                    averageCTR: 0,
                    averageCPC: 0,
                    totalROAS: 0
                };
            }
        }

        async function fetchCampaigns() {
            try {
                debugLog('üéØ Fetching campaigns data...');
                const response = await fetch(`${API_BASE}/api/campaigns`);
                debugLog(`Campaigns response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const campaignsArray = Array.isArray(data) ? data : [];
                debugLog(`‚úÖ Campaigns data received: ${campaignsArray.length} campaigns`);
                
                return campaignsArray;
            } catch (error) {
                debugLog(`‚ùå Error fetching campaigns: ${error.message}`);
                return [];
            }
        }

        async function fetchCreatives() {
            try {
                debugLog('üé® Fetching creatives data...');
                const response = await fetch(`${API_BASE}/api/creatives`);
                debugLog(`Creatives response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                debugLog(`‚úÖ Creatives data received: ${data.length} creatives`);
                
                return data;
            } catch (error) {
                debugLog(`‚ùå Error fetching creatives: ${error.message}`);
                return [];
            }
        }

        async function fetchTaboolaCampaigns() {
            try {
                debugLog('üî∂ Fetching Taboola campaigns...');
                const response = await fetch(`${API_BASE}/api/taboola-campaigns`);
                debugLog(`Taboola campaigns response status: ${response.status}`);
                
                if (!response.ok) {
                    debugLog(`‚ö†Ô∏è Taboola campaigns API returned ${response.status}, continuing without Taboola campaigns...`);
                    return [];
                }
                
                const data = await response.json();
                const campaignsArray = Array.isArray(data) ? data : (data.results || []);
                debugLog(`‚úÖ Taboola campaigns data received: ${campaignsArray.length} campaigns`);
                
                return campaignsArray;
            } catch (error) {
                debugLog(`‚ùå Taboola campaigns fetch failed: ${error.message}`);
                return [];
            }
        }

        async function fetchTaboolaCreatives() {
            try {
                debugLog('üî∂ Fetching Taboola creatives...');
                const response = await fetch(`${API_BASE}/api/taboola-creatives`);
                debugLog(`Taboola creatives response status: ${response.status}`);
                
                if (!response.ok) {
                    debugLog(`‚ö†Ô∏è Taboola creatives API returned ${response.status}, continuing without Taboola creatives...`);
                    return [];
                }
                
                const data = await response.json();
                const creativesArray = Array.isArray(data) ? data : (data.results || []);
                debugLog(`‚úÖ Taboola creatives data received: ${creativesArray.length} creatives`);
                
                return creativesArray;
            } catch (error) {
                debugLog(`‚ùå Taboola creatives fetch failed: ${error.message}`);
                return [];
            }
        }

        // UI update functions
        function updatePlatformStatus() {
            // Facebook status
            if (accountData && accountData.totalSpend > 0) {
                document.getElementById('facebookStatus').className = 'w-3 h-3 bg-green-500 rounded-full';
                document.getElementById('facebookSpend').textContent = `¬£${accountData.totalSpend.toLocaleString()}`;
                document.getElementById('facebookConversions').textContent = accountData.totalConversions.toLocaleString();
                document.getElementById('facebookROAS').textContent = `${accountData.totalROAS.toFixed(2)}x`;
            } else {
                document.getElementById('facebookStatus').className = 'w-3 h-3 bg-red-500 rounded-full';
            }
            
            // Taboola status
            if (taboolaCampaigns.length > 0) {
                document.getElementById('taboolaStatus').className = 'w-3 h-3 bg-green-500 rounded-full';
                const totalSpend = taboolaCampaigns.reduce((sum, camp) => sum + (parseFloat(camp.spent) || 0), 0);
                const totalConversions = taboolaCampaigns.reduce((sum, camp) => sum + (parseInt(camp.conversions_value) || 0), 0);
                const taboolaROAS = totalSpend > 0 ? totalConversions / totalSpend : 0;
                
                document.getElementById('taboolaSpend').textContent = `¬£${totalSpend.toLocaleString()}`;
                document.getElementById('taboolaConversions').textContent = totalConversions.toLocaleString();
                document.getElementById('taboolaROAS').textContent = `${taboolaROAS.toFixed(2)}x`;
            } else {
                document.getElementById('taboolaStatus').className = 'w-3 h-3 bg-yellow-500 rounded-full';
            }
            
            // Update cross-platform ROAS
            if (accountData) {
                document.getElementById('crossPlatformROAS').textContent = `${accountData.totalROAS.toFixed(2)}x`;
            }
        }

        function updateOverviewTab() {
            if (!accountData) return;
            
            // Calculate combined totals
            const taboolaSpend = taboolaCampaigns.reduce((sum, camp) => sum + (parseFloat(camp.spent) || 0), 0);
            const taboolaRevenue = taboolaCampaigns.reduce((sum, camp) => sum + (parseFloat(camp.conversions_value) || 0), 0);
            const taboolaConversions = taboolaCampaigns.reduce((sum, camp) => sum + (parseInt(camp.conversions) || 0), 0);
            
            const totalSpend = accountData.totalSpend + taboolaSpend;
            const totalRevenue = accountData.totalRevenue + taboolaRevenue;
            const totalConversions = accountData.totalConversions + taboolaConversions;
            const averageCTR = accountData.averageCTR;
            
            document.getElementById('totalSpend').textContent = `¬£${totalSpend.toLocaleString()}`;
            document.getElementById('totalRevenue').textContent = `¬£${totalRevenue.toLocaleString()}`;
            document.getElementById('totalConversions').textContent = totalConversions.toLocaleString();
            document.getElementById('averageCTR').textContent = `${averageCTR.toFixed(2)}%`;
            
            updateTopCreatives();
            
            debugLog(`‚úÖ Updated overview UI with spend: ¬£${totalSpend.toFixed(2)}, revenue: ¬£${totalRevenue.toFixed(2)}, ROAS: ${accountData.totalROAS.toFixed(2)}x`);
        }

        function combineCreatives() {
            allCreatives = [];
            
            // Add Facebook creatives
            creatives.forEach(creative => {
                allCreatives.push({
                    ...creative,
                    platform: 'Facebook',
                    source: 'facebook'
                });
            });
            
            // Add Taboola creatives
            taboolaCreatives.forEach(creative => {
                allCreatives.push({
                    ...creative,
                    platform: 'Taboola',
                    source: 'taboola'
                });
            });
            
            debugLog(`üìä Combined creatives: ${allCreatives.length} total (${creatives.length} Facebook + ${taboolaCreatives.length} Taboola)`);
        }

        function updateTopCreatives() {
            const topCreativesDiv = document.getElementById('topCreatives');
            
            if (allCreatives.length === 0) {
                topCreativesDiv.innerHTML = '<p class="text-gray-500">No creatives found yet...</p>';
                return;
            }
            
            // Sort creatives by performance score
            const sortedCreatives = [...allCreatives].sort((a, b) => {
                return (b.performance_score || 0) - (a.performance_score || 0);
            }).slice(0, 5);
            
            let html = '<div class="space-y-3">';
            
            sortedCreatives.forEach((creative, index) => {
                const platformIcon = creative.platform === 'Taboola' ? 'üî∂' : 'üìò';
                const performanceScore = creative.performance_score || 0;
                
                html += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <span class="flex items-center justify-center w-6 h-6 bg-blue-500 text-white text-xs font-bold rounded-full">
                                ${index + 1}
                            </span>
                            <span class="text-lg">${platformIcon}</span>
                            <div>
                                <div class="font-medium text-gray-900 truncate max-w-xs">
                                    ${creative.name || 'Unnamed Creative'}
                                </div>
                                <div class="text-sm text-gray-600">
                                    CTR: ${(creative.ctr || 0).toFixed(2)}% ‚Ä¢ Conversions: ${creative.conversions || 0}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-gray-900">${Math.round(performanceScore)}/100</div>
                            <div class="text-sm text-gray-600">Score</div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            topCreativesDiv.innerHTML = html;
        }

        function updateCampaignsTab() {
            const table = document.getElementById('campaignsTable');
            
            // Combine Facebook and Taboola campaigns
            const allCampaigns = [];
            
            // Add Facebook campaigns
            campaigns.forEach(campaign => {
                allCampaigns.push({
                    ...campaign,
                    platform: 'Facebook',
                    platform_icon: 'üìò'
                });
            });
            
            // Add Taboola campaigns
            taboolaCampaigns.forEach(campaign => {
                allCampaigns.push({
                    ...campaign,
                    platform: 'Taboola',
                    platform_icon: 'üî∂'
                });
            });
            
            if (allCampaigns.length === 0) {
                table.innerHTML = '<p class="text-gray-500">No campaigns found or still loading...</p>';
                return;
            }
            
            let html = `
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="text-left py-3 px-4 font-medium text-gray-700">Campaign</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">Platform</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">Spend</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">Conversions</th>
                            <th class="text-center py-3 px-4 font-medium text-gray-700">Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            allCampaigns.forEach(campaign => {
                const spend = parseFloat(campaign.spend || campaign.spent || 0);
                const conversions = parseInt(campaign.conversions || 0);
                const status = campaign.status || 'ACTIVE';
                const statusColor = status === 'ACTIVE' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
                
                html += `
                    <tr class="border-b border-gray-100">
                        <td class="py-3 px-4 font-medium text-gray-900 max-w-xs truncate">${campaign.name || 'Unnamed Campaign'}</td>
                        <td class="py-3 px-4 text-right text-gray-900">${campaign.platform_icon} ${campaign.platform}</td>
                        <td class="py-3 px-4 text-right text-gray-900">¬£${spend.toLocaleString()}</td>
                        <td class="py-3 px-4 text-right text-gray-900">${conversions}</td>
                        <td class="py-3 px-4 text-center">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusColor}">
                                ${status}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            table.innerHTML = html;
            
            debugLog(`‚úÖ Updated campaigns table with ${allCampaigns.length} campaigns`);
        }

        function updateCreativesTab() {
            const grid = document.getElementById('creativesGrid');
            
            if (allCreatives.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <p class="text-gray-500 mb-4">No creatives found or still loading...</p>
                        <button onclick="loadData()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            üîÑ Retry Loading Creatives
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            allCreatives.slice(0, 12).forEach(creative => {
                const performanceScore = creative.performance_score || 0;
                const grade = performanceScore >= 80 ? 'A' : 
                             performanceScore >= 60 ? 'B' : 
                             performanceScore >= 40 ? 'C' : 'D';
                             
                const gradeColor = grade === 'A' ? 'bg-green-100 text-green-800' :
                                  grade === 'B' ? 'bg-blue-100 text-blue-800' :
                                  grade === 'C' ? 'bg-yellow-100 text-yellow-800' : 
                                  'bg-red-100 text-red-800';
                
                const platformIcon = creative.platform === 'Taboola' ? 'üî∂' : 'üìò';
                
                html += `
                    <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${platformIcon}</span>
                                <h4 class="font-medium text-gray-900 truncate flex-1">${creative.name || 'Unnamed Creative'}</h4>
                            </div>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${gradeColor}">
                                Grade ${grade}
                            </span>
                        </div>
                        
                        ${creative.image_url ? `
                            <div class="mb-4">
                                <img src="${creative.image_url}" 
                                     alt="Creative preview" 
                                     class="w-full h-32 object-cover rounded-lg"
                                     onerror="this.style.display='none'">
                            </div>
                        ` : ''}
                        
                        <div class="space-y-3 mb-4">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Performance Score</span>
                                <span class="font-medium">${Math.round(performanceScore)}/100</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Platform</span>
                                <span class="font-medium">${creative.platform || 'Facebook'}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Spend</span>
                                <span class="font-medium">¬£${(creative.spend || 0).toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">CTR</span>
                                <span class="font-medium">${(creative.ctr || 0).toFixed(2)}%</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Conversions</span>
                                <span class="font-medium">${creative.conversions || 0}</span>
                            </div>
                        </div>
                        
                        <button class="w-full px-3 py-2 bg-purple-600 text-white text-sm rounded-md hover:bg-purple-700" 
                                onclick="analyzeCreative('${creative.id}')">
                            üß† Analyze with AI
                        </button>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
            debugLog(`‚úÖ Updated creatives grid with ${Math.min(12, allCreatives.length)} creatives displayed`);
        }

        function updateVideoAnalysisTab() {
            // Filter for video creatives only
            const videoCreatives = allCreatives.filter(creative => 
                creative.creative_type === 'video'
            );
            
            const avgHookRateEl = document.getElementById('avgHookRate');
            const avgRetentionEl = document.getElementById('avgRetention');
            const avgCompletionEl = document.getElementById('avgCompletion');
            const totalVideosEl = document.getElementById('totalVideos');
            const table = document.getElementById('videoAnalysisTable');
            
            totalVideosEl.textContent = videoCreatives.length.toString();
            
            if (videoCreatives.length === 0) {
                avgHookRateEl.textContent = '0.0%';
                avgRetentionEl.textContent = '0.0%';
                avgCompletionEl.textContent = '0.0%';
                
                table.innerHTML = '<p class="text-gray-500">No video creatives found. Video analysis requires video ads with engagement metrics.</p>';
                return;
            }
            
            // Calculate averages
            const avgHookRate = videoCreatives.reduce((sum, v) => sum + (v.hook_rate || 0), 0) / videoCreatives.length;
            const avgRetention = videoCreatives.reduce((sum, v) => sum + (v.retention_25pct || 0), 0) / videoCreatives.length;
            const avgCompletion = videoCreatives.reduce((sum, v) => sum + (v.completion_rate || 0), 0) / videoCreatives.length;
            
            avgHookRateEl.textContent = `${avgHookRate.toFixed(1)}%`;
            avgRetentionEl.textContent = `${avgRetention.toFixed(1)}%`;
            avgCompletionEl.textContent = `${avgCompletion.toFixed(1)}%`;
            
            // Create video analysis table
            let html = `
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="text-left py-3 px-4 font-medium text-gray-700">Video</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">Hook Rate</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">Completion</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">Spend</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">Conversions</th>
                            <th class="text-center py-3 px-4 font-medium text-gray-700">Grade</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            videoCreatives.forEach((video) => {
                const hookRate = video.hook_rate || 0;
                const completion = video.completion_rate || 0;
                const spend = video.spend || 0;
                const conversions = video.conversions || 0;
                const performanceScore = video.performance_score || 0;
                
                const grade = performanceScore >= 80 ? 'A' : 
                             performanceScore >= 60 ? 'B' : 
                             performanceScore >= 40 ? 'C' : 'D';
                const gradeColor = grade === 'A' ? 'bg-green-100 text-green-800' :
                                  grade === 'B' ? 'bg-blue-100 text-blue-800' :
                                  grade === 'C' ? 'bg-yellow-100 text-yellow-800' : 
                                  'bg-red-100 text-red-800';
                
                const platformIcon = video.platform === 'Taboola' ? 'üî∂' : 'üì∫';
                
                html += `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 px-4">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${platformIcon}</span>
                                <div class="max-w-xs truncate font-medium text-gray-900">
                                    ${video.name || 'Unnamed Video'}
                                </div>
                            </div>
                        </td>
                        <td class="py-3 px-4 text-right font-medium">${hookRate.toFixed(1)}%</td>
                        <td class="py-3 px-4 text-right">${completion.toFixed(1)}%</td>
                        <td class="py-3 px-4 text-right">¬£${spend.toFixed(2)}</td>
                        <td class="py-3 px-4 text-right">${conversions}</td>
                        <td class="py-3 px-4 text-center">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${gradeColor}">
                                ${grade}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            table.innerHTML = html;
            
            debugLog(`‚úÖ Updated video analysis with ${videoCreatives.length} video creatives`);
        }

        function updateCreativeGenerator() {
            if (allCreatives.length === 0) return;
            
            // Populate base creative selector with top performers
            const baseSelect = document.getElementById('baseCreativeSelect');
            const topCreatives = [...allCreatives]
                .sort((a, b) => (b.performance_score || 0) - (a.performance_score || 0))
                .slice(0, 10);
            
            baseSelect.innerHTML = '<option value="">Select top performer...</option>';
            topCreatives.forEach(creative => {
                const performanceScore = Math.round(creative.performance_score || 0);
                baseSelect.innerHTML += `
                    <option value="${creative.id}">
                        ${creative.name || 'Unnamed Creative'} (Score: ${performanceScore})
                    </option>
                `;
            });
            
            debugLog(`‚úÖ Updated creative generator with ${topCreatives.length} top performers`);
        }

        // Creative Generator functionality
        document.getElementById('generateCreatives').addEventListener('click', async function() {
            const baseCreative = document.getElementById('baseCreativeSelect').value;
            const generationType = document.getElementById('generationType').value;
            const targetPlatform = document.getElementById('targetPlatform').value;
            
            if (!baseCreative) {
                alert('Please select a base creative first');
                return;
            }
            
            debugLog(`üöÄ Starting creative generation: Base=${baseCreative}, Type=${generationType}, Platform=${targetPlatform}`);
            
            this.textContent = '‚è≥ Generating...';
            this.disabled = true;
            
            try {
                const response = await fetch(`${API_BASE}/api/real-creative-generator`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        base_creative_id: baseCreative,
                        generation_type: generationType,
                        target_platform: targetPlatform,
                        success_factors: [
                            { factor: 'Eye-catching visuals', category: 'visual', impact_score: 0.8 },
                            { factor: 'Strong emotional hook', category: 'psychological', impact_score: 0.7 },
                            { factor: 'Clear value proposition', category: 'textual', impact_score: 0.9 }
                        ],
                        creative_format: 'image'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    debugLog(`‚úÖ Generation completed: ${result.generated_count} creatives`);
                    displayGeneratedCreatives(result.creatives || []);
                    
                    // Update AI generated counter
                    document.getElementById('aiGenerated').textContent = result.generated_count || 0;
                } else {
                    throw new Error(`API error: ${response.status}`);
                }
                
            } catch (error) {
                debugLog(`‚ùå Generation error: ${error.message}`);
                alert(`Generation failed: ${error.message}`);
            } finally {
                this.textContent = 'üöÄ Generate with AI';
                this.disabled = false;
            }
        });

        function displayGeneratedCreatives(creatives) {
            const container = document.getElementById('generatedCreatives');
            
            if (!creatives || creatives.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 p-8">No creatives generated. Check the debug console for details.</div>';
                return;
            }

            let html = '<h3 class="text-lg font-semibold text-gray-800 mb-4">üé® Generated Creatives</h3>';
            
            creatives.forEach((creative, index) => {
                const confidence = Math.round((creative.performance_prediction?.confidence || 0.75) * 100);
                
                html += `
                    <div class="border-2 border-green-500 bg-green-50 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="font-semibold text-gray-800">${creative.name || `Generated Creative ${index + 1}`}</h4>
                                <div class="text-sm text-gray-600 mt-1">
                                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">
                                        Generated with ${creative.generation_method || 'AI'}
                                    </span>
                                    <span class="ml-2">Target: ${creative.target_platform}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-600">Confidence</div>
                                <div class="text-lg font-bold text-green-600">${confidence}%</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">Generated Content:</h5>
                                ${renderCreativeContent(creative.content)}
                            </div>
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">Performance Prediction:</h5>
                                <div class="space-y-1 text-sm">
                                    <div>Expected CTR: <span class="font-medium">${creative.performance_prediction?.expected_ctr_range || '1.5-2.5%'}</span></div>
                                    <div>Performance: <span class="font-medium capitalize">${creative.performance_prediction?.expected_performance || 'medium'}</span></div>
                                    <div>Budget: <span class="font-medium">${creative.testing_strategy?.recommended_budget || '¬£25-50'}</span></div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 flex space-x-2">
                            <button class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
                                üöÄ Launch Test
                            </button>
                            <button class="bg-gray-200 text-gray-800 px-4 py-2 rounded text-sm hover:bg-gray-300">
                                üì• Download
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            debugLog(`‚úÖ Displayed ${creatives.length} generated creatives`);
        }

        function renderCreativeContent(content) {
            if (!content) return '<div class="text-gray-500">No content generated</div>';
            
            if (content.type === 'generated_image') {
                return `
                    <div class="space-y-2">
                        <img src="${content.image_url}" alt="Generated creative" class="w-full max-w-sm rounded-lg border">
                        <a href="${content.download_url}" target="_blank" class="inline-block text-blue-600 text-sm">üì• Download Image</a>
                    </div>
                `;
            } else if (content.type === 'creative_concept') {
                return `
                    <div class="bg-gray-50 p-3 rounded text-sm">
                        <strong>Creative Concept:</strong><br>
                        ${content.concept ? content.concept.substring(0, 200) + '...' : 'Concept generated'}
                    </div>
                `;
            } else if (content.type === 'detailed_brief') {
                return `
                    <div class="bg-blue-50 p-3 rounded text-sm">
                        <strong>${content.title}</strong><br>
                        ${content.concept}<br>
                        <div class="mt-2 text-xs text-gray-600">
                            Style: ${content.visual_direction?.recommended_style || 'Professional'}
                        </div>
                    </div>
                `;
            }
            
            return '<div class="text-gray-500">Content type not recognized</div>';
        }

        // AI Analysis functions
        async function analyzeCreative(creativeId) {
            debugLog(`üß† Starting AI analysis for creative ${creativeId}`);
            
            const creative = allCreatives.find(c => c.id === creativeId);
            if (!creative) {
                debugLog(`‚ùå Creative ${creativeId} not found`);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/ai-creative-analyzer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        creative_id: creativeId,
                        creative_data: creative,
                        performance_data: {
                            ctr: creative.ctr,
                            spend: creative.spend,
                            conversions: creative.conversions,
                            impressions: creative.impressions
                        }
                    })
                });
                
                if (response.ok) {
                    const analysis = await response.json();
                    debugLog(`‚úÖ AI analysis completed for creative ${creativeId} with confidence: ${analysis.confidence_score}%`);
                    updateAIInsights(analysis);
                } else {
                    debugLog(`‚ùå AI analysis failed for creative ${creativeId}: ${response.status}`);
                }
            } catch (error) {
                debugLog(`‚ùå AI analysis error for creative ${creativeId}: ${error.message}`);
            }
        }

        function updateAIInsights(analysis) {
            const aiInsights = document.getElementById('aiInsights');
            
            let html = '<div class="space-y-6">';
            
            if (analysis.success_factors && analysis.success_factors.length > 0) {
                html += '<div class="bg-green-50 p-4 rounded-lg">';
                html += '<h3 class="font-semibold text-green-800 mb-3">üéØ Success Factors</h3>';
                html += '<div class="space-y-2">';
                analysis.success_factors.forEach(factor => {
                    html += `
                        <div class="flex justify-between items-center">
                            <span class="text-green-700">${factor.factor}</span>
                            <span class="font-medium text-green-800">${Math.round(factor.impact_score * 100)}% Impact</span>
                        </div>
                    `;
                });
                html += '</div></div>';
            }
            
            if (analysis.recommendations && analysis.recommendations.length > 0) {
                html += '<div class="bg-purple-50 p-4 rounded-lg">';
                html += '<h3 class="font-semibold text-purple-800 mb-3">üí° AI Recommendations</h3>';
                html += '<div class="space-y-2">';
                analysis.recommendations.forEach(rec => {
                    html += `<div class="text-purple-700">‚Ä¢ ${rec.message}</div>`;
                });
                html += '</div></div>';
            }
            
            html += '</div>';
            aiInsights.innerHTML = html;
            
            // Update AI status
            const aiAnalyzed = document.getElementById('aiAnalyzed');
            const aiSuccessFactors = document.getElementById('aiSuccessFactors');
            const currentAnalyzed = parseInt(aiAnalyzed.textContent) || 0;
            aiAnalyzed.textContent = currentAnalyzed + 1;
            aiSuccessFactors.textContent = analysis.success_factors?.length || 0;
        }

        // Load all data
        async function loadData() {
            try {
                debugLog('üîÑ Starting data load...');
                
                // Load Facebook data
                accountData = await fetchAccountData();
                campaigns = await fetchCampaigns();
                creatives = await fetchCreatives();
                
                // Load Taboola data
                taboolaCampaigns = await fetchTaboolaCampaigns();
                taboolaCreatives = await fetchTaboolaCreatives();
                
                // Combine all creatives
                combineCreatives();
                
                // Update UI
                updatePlatformStatus();
                updateOverviewTab();
                updateCampaignsTab();
                updateCreativesTab();
                updateCreativeGenerator();
                updateVideoAnalysisTab();
                
                debugLog('‚úÖ Data load completed successfully');
                
            } catch (error) {
                debugLog(`‚ùå Error loading data: ${error.message}`);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            debugLog('üì± Page loaded, starting data fetch...');
            loadData();
        });

    </script>
</body>
</html>
