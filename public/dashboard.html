<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Ads Performance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .debug-info {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .grade-a { color: #10b981; font-weight: bold; }
        .grade-b { color: #3b82f6; font-weight: bold; }
        .grade-c { color: #f59e0b; font-weight: bold; }
        .grade-d { color: #ef4444; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Facebook Ads Performance</h1>
                <p class="text-gray-600 mt-1">Live data from your Facebook advertising campaigns</p>
            </div>
            <button id="refreshBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                <span>üîÑ</span>
                Refresh Data
            </button>
        </div>

        <!-- Debug Information Panel -->
        <div id="debugPanel" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-sm font-semibold text-yellow-800">Debug Information</h3>
                <div class="flex gap-2">
                    <button id="runDiagnosticBtn" class="text-xs px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">üîç Run Facebook API Diagnostic</button>
                    <button id="hideDebugBtn" class="text-xs text-yellow-600 hover:text-yellow-800">Hide</button>
                </div>
            </div>
            <div id="debugInfo" class="debug-info text-yellow-700">
                <div>Dashboard loaded. Waiting for data...</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex space-x-8 mb-6">
            <button class="tab-btn px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600" data-tab="overview">Overview</button>
            <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700" data-tab="campaigns">Campaigns</button>
            <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700" data-tab="creatives">Creative Analysis</button>
            <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700" data-tab="video-analysis">Video Hook Analysis</button>
            <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700" data-tab="ai-scripts">AI Script Generator</button>
            <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700" data-tab="video-intelligence">üé¨ Video Intelligence</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview-content" class="tab-content active">
            <!-- Time Range Selector -->
            <div class="mb-6">
                <select id="timeRange" class="px-4 py-2 border border-gray-300 rounded-lg bg-white">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                </select>
            </div>

            <!-- Key Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Total Spend</p>
                            <p id="totalSpend" class="text-2xl font-bold text-gray-900">¬£0</p>
                        </div>
                        <div class="text-2xl">üí∞</div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Total Revenue</p>
                            <p id="totalRevenue" class="text-2xl font-bold text-gray-900">¬£0</p>
                        </div>
                        <div class="text-2xl">üìà</div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">ROAS</p>
                            <p id="roas" class="text-2xl font-bold text-gray-900">0.00x</p>
                        </div>
                        <div class="text-2xl">üéØ</div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Conversions</p>
                            <p id="conversions" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                        <div class="text-2xl">üéØ</div>
                    </div>
                </div>
            </div>

            <!-- Additional Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                    <p class="text-sm text-gray-600">Total Clicks</p>
                    <p id="totalClicks" class="text-xl font-bold text-gray-900">0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                    <p class="text-sm text-gray-600">CTR</p>
                    <p id="ctr" class="text-xl font-bold text-gray-900">0%</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                    <p class="text-sm text-gray-600">CPC</p>
                    <p id="cpc" class="text-xl font-bold text-gray-900">¬£0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                    <p class="text-sm text-gray-600">CPM</p>
                    <p id="cpm" class="text-xl font-bold text-gray-900">¬£0</p>
                </div>
            </div>

            <!-- Performance Status -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                        <h3 class="text-lg font-semibold text-gray-900">What's Working</h3>
                    </div>
                    <div id="whatsWorking">
                        <p class="text-gray-600">Loading performance data...</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-3 h-3 bg-orange-500 rounded-full"></div>
                        <h3 class="text-lg font-semibold text-gray-900">Needs Improvement</h3>
                    </div>
                    <div id="needsImprovement">
                        <p class="text-gray-600">Loading recommendations...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Campaigns Tab -->
        <div id="campaigns-content" class="tab-content">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900">Campaign Performance</h2>
                </div>
                <div id="campaignsTable" class="p-6">
                    <p class="text-gray-600">Loading campaigns...</p>
                </div>
            </div>
        </div>

        <!-- Creative Analysis Tab -->
        <div id="creatives-content" class="tab-content">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900">Creative Performance Analysis</h2>
                </div>
                <div id="creativesTable" class="p-6">
                    <p class="text-gray-600">Loading creatives...</p>
                </div>
            </div>
        </div>

        <!-- Video Hook Analysis Tab -->
        <div id="video-analysis-content" class="tab-content">
            <!-- Header -->
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6 rounded-lg mb-6">
                <h2 class="text-2xl font-bold mb-2">üì∫ Video Hook Analysis</h2>
                <p class="text-purple-100">Analyze your video ad performance and optimize for better hook rates</p>
            </div>

            <!-- Performance Overview -->
            <div id="videoOverview" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <!-- Overview cards will be inserted here -->
            </div>

            <!-- Video Performance Table -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Video Performance Ranking</h3>
                </div>
                <div id="videoTable" class="overflow-x-auto">
                    <!-- Video table will be inserted here -->
                </div>
            </div>

            <!-- Detailed Analysis Panel -->
            <div id="videoDetailPanel" class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="p-6">
                    <p class="text-gray-500 text-center">Select a video from the table above to see detailed analysis</p>
                </div>
            </div>
        </div>

        <!-- AI Script Generator Tab -->
        <div id="ai-scripts-content" class="tab-content">
            <!-- Header -->
            <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-6 rounded-lg mb-6">
                <h2 class="text-2xl font-bold mb-2">ü§ñ AI Script Generator</h2>
                <p class="text-green-100">Generate optimized video scripts based on your performance data</p>
            </div>

            <!-- Script Generation Controls -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Generate Optimized Scripts</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <select id="scriptCreativeSelect" class="px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="">Select a creative...</option>
                    </select>
                    
                    <select id="scriptFocus" class="px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="hook_rate">Hook Rate Focus</option>
                        <option value="retention">Retention Focus</option>
                        <option value="completion">Completion Focus</option>
                        <option value="balanced">Balanced Improvement</option>
                    </select>
                    
                    <button id="generateScriptsBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300" disabled>
                        ü§ñ Generate Scripts
                    </button>
                </div>

                <div id="scriptGenerationProgress" class="hidden">
                    <div class="flex items-center gap-2 text-green-600 mb-2">
                        <div class="loading inline-block w-4 h-4 border-2 border-green-600 border-t-transparent rounded-full"></div>
                        <span id="scriptStatusText">Analyzing performance and generating scripts...</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="scriptProgressBar" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Generated Scripts Container -->
            <div id="generatedScripts" class="space-y-6">
                <!-- Scripts will be inserted here -->
            </div>
        </div>

        <!-- Video Intelligence Tab -->
        <div id="video-intelligence-content" class="tab-content">
            <!-- Header -->
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 rounded-lg mb-6">
                <h2 class="text-2xl font-bold mb-2">üé¨ Video Intelligence Analysis</h2>
                <p class="text-indigo-100">Deep frame-by-frame analysis with audio transcription and visual scene detection</p>
            </div>

            <!-- Analysis Controls -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Analyze Video Content</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <select id="intelligenceCreativeSelect" class="px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="">Select a video creative...</option>
                    </select>
                    
                    <select id="analysisType" class="px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="full">Full Analysis</option>
                        <option value="audio_only">Audio Transcription Only</option>
                        <option value="visual_only">Visual Analysis Only</option>
                        <option value="frame_by_frame">Frame-by-Frame Deep Dive</option>
                    </select>
                    
                    <button id="analyzeVideoBtn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-300" disabled>
                        üé¨ Analyze Video
                    </button>
                </div>

                <div id="videoAnalysisProgress" class="hidden">
                    <div class="flex items-center gap-2 text-indigo-600 mb-2">
                        <div class="loading inline-block w-4 h-4 border-2 border-indigo-600 border-t-transparent rounded-full"></div>
                        <span id="analysisStatusText">Downloading and analyzing video...</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="analysisProgressBar" class="bg-indigo-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Analysis Results Container -->
            <div id="videoIntelligenceResults" class="space-y-6">
                <!-- Results will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        let campaigns = [];
        let creatives = [];
        let videoAnalyses = {};
        let cachedScripts = {};

        function debugLog(message) {
            const debugInfo = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML += `<div>${timestamp}: ${message}</div>`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
            console.log(`[DEBUG ${timestamp}] ${message}`);
        }

        // Hide debug panel
        document.getElementById('hideDebugBtn').addEventListener('click', function() {
            document.getElementById('debugPanel').style.display = 'none';
        });

        // Run Facebook API diagnostic
        document.getElementById('runDiagnosticBtn').addEventListener('click', async function() {
            this.disabled = true;
            this.textContent = 'üîç Running Diagnostic...';
            
            try {
                debugLog('Running Facebook API diagnostic...');
                const response = await fetch('/api/facebook-diagnostic');
                const diagnostic = await response.json();
                
                debugLog('=== FACEBOOK API DIAGNOSTIC RESULTS ===');
                debugLog(`Overall Status: ${diagnostic.overall_status}`);
                debugLog(`Summary: ${diagnostic.summary}`);
                
                if (diagnostic.tests) {
                    diagnostic.tests.forEach(test => {
                        const status = test.status === 'PASSED' ? '‚úÖ' : test.status === 'FAILED' ? '‚ùå' : '‚ö†Ô∏è';
                        debugLog(`${status} ${test.test}: ${test.status}`);
                        if (test.error) debugLog(`   Error: ${test.error}`);
                        if (test.solution) debugLog(`   Solution: ${test.solution}`);
                    });
                }
                
                // Show specific recommendations
                if (diagnostic.overall_status === 'ISSUES_FOUND') {
                    debugLog('=== RECOMMENDED FIXES ===');
                    const failedTests = diagnostic.tests.filter(t => t.status === 'FAILED' || t.status === 'ERROR');
                    failedTests.forEach(test => {
                        if (test.solution) {
                            debugLog(`‚Ä¢ ${test.solution}`);
                        }
                    });
                }
                
            } catch (error) {
                debugLog(`ERROR running diagnostic: ${error.message}`);
            } finally {
                this.disabled = false;
                this.textContent = 'üîç Run Facebook API Diagnostic';
            }
        });

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                
                // Update active tab button
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                    b.classList.add('text-gray-500');
                });
                this.classList.remove('text-gray-500');
                this.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                
                // Show/hide content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}-content`).classList.add('active');
                
                // Load data for specific tabs
                if (tabName === 'campaigns' && campaigns.length > 0) {
                    loadCampaigns();
                } else if (tabName === 'creatives' && creatives.length > 0) {
                    loadCreatives();
                } else if (tabName === 'video-analysis' && creatives.length > 0) {
                    loadVideoAnalysis();
                } else if (tabName === 'ai-scripts' && creatives.length > 0) {
                    loadAIScriptGenerator();
                } else if (tabName === 'video-intelligence' && creatives.length > 0) {
                    loadVideoIntelligence();
                }
            });
        });

        // Load data on page load
        async function loadData() {
            try {
                debugLog('Starting data load...');
                
                // Load overview data
                debugLog('Fetching overview data...');
                const overviewResponse = await fetch('/api/overview');
                debugLog(`Overview response status: ${overviewResponse.status}`);
                
                if (!overviewResponse.ok) {
                    throw new Error(`Overview API failed: ${overviewResponse.status}`);
                }
                
                const overviewData = await overviewResponse.json();
                debugLog('Overview data received successfully');
                updateOverviewUI(overviewData);
                
                // Load campaigns
                debugLog('Fetching campaigns data...');
                const campaignsResponse = await fetch('/api/campaigns');
                debugLog(`Campaigns response status: ${campaignsResponse.status}`);
                
                if (!campaignsResponse.ok) {
                    throw new Error(`Campaigns API failed: ${campaignsResponse.status}`);
                }
                
                campaigns = await campaignsResponse.json();
                debugLog(`Campaigns data received: ${campaigns.length} campaigns`);
                
                // Load creatives
                debugLog('Fetching creatives data...');
                const creativesResponse = await fetch('/api/creatives');
                debugLog(`Creatives response status: ${creativesResponse.status}`);
                
                if (!creativesResponse.ok) {
                    throw new Error(`Creatives API failed: ${creativesResponse.status}`);
                }
                
                creatives = await creativesResponse.json();
                debugLog(`Creatives data received: ${creatives.length} creatives`);
                
                debugLog('Data load completed successfully');
                
            } catch (error) {
                debugLog(`ERROR: ${error.message}`);
                console.error('Failed to load data:', error);
            }
        }

        function updateOverviewUI(data) {
            debugLog('Updating overview UI...');
            
            // Update spending and metrics
            const spend = data.spend || 0;
            const revenue = data.revenue || 0;
            const roas = revenue > 0 ? (revenue / spend).toFixed(2) : '0.00';
            
            document.getElementById('totalSpend').textContent = `¬£${spend.toFixed(2)}`;
            document.getElementById('totalRevenue').textContent = `¬£${revenue.toFixed(2)}`;
            document.getElementById('roas').textContent = `${roas}x`;
            document.getElementById('conversions').textContent = data.conversions || 0;
            document.getElementById('totalClicks').textContent = data.clicks || 0;
            document.getElementById('ctr').textContent = `${(data.ctr || 0).toFixed(2)}%`;
            document.getElementById('cpc').textContent = `¬£${(data.cpc || 0).toFixed(2)}`;
            document.getElementById('cpm').textContent = `¬£${(data.cpm || 0).toFixed(2)}`;
            
            // Update status sections
            const whatsWorking = document.getElementById('whatsWorking');
            const needsImprovement = document.getElementById('needsImprovement');
            
            if (data.conversions > 0) {
                whatsWorking.innerHTML = '<p class="text-green-600">‚úÖ Generating conversions with good CTR</p>';
            } else {
                whatsWorking.innerHTML = '<p class="text-gray-600">Set up conversion tracking to see winning campaigns!</p>';
            }
            
            // Show campaigns that need improvement
            needsImprovement.innerHTML = '';
            if (campaigns.length > 0) {
                campaigns.forEach(campaign => {
                    if (campaign.status === 'PAUSED' || campaign.conversions === 0) {
                        const campaignDiv = document.createElement('div');
                        campaignDiv.className = 'text-orange-600 mb-2';
                        campaignDiv.innerHTML = `
                            <span class="font-medium">${campaign.name}</span><br>
                            <span class="text-sm">0.00x ROAS - Losing money! Consider pausing or setting up conversion tracking.</span>
                        `;
                        needsImprovement.appendChild(campaignDiv);
                    }
                });
            }
            
            debugLog('Updated overview UI with spend: ¬£' + spend.toFixed(2) + ', revenue: ¬£' + revenue.toFixed(2) + ', ROAS: ' + roas + 'x');
        }

        function loadCampaigns() {
            debugLog('Loading campaigns table...');
            const table = document.getElementById('campaignsTable');
            
            if (campaigns.length === 0) {
                table.innerHTML = '<p class="text-gray-600">No campaigns found.</p>';
                return;
            }
            
            let html = `
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-4 font-semibold">Campaign</th>
                                <th class="text-left py-3 px-4 font-semibold">Status</th>
                                <th class="text-left py-3 px-4 font-semibold">Spend</th>
                                <th class="text-left py-3 px-4 font-semibold">Conversions</th>
                                <th class="text-left py-3 px-4 font-semibold">ROAS</th>
                                <th class="text-left py-3 px-4 font-semibold">CTR</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            campaigns.forEach(campaign => {
                const roas = campaign.revenue > 0 ? (campaign.revenue / campaign.spend).toFixed(2) : '0.00';
                const statusColor = campaign.status === 'ACTIVE' ? 'text-green-600' : 'text-red-600';
                
                html += `
                    <tr class="border-b border-gray-100">
                        <td class="py-3 px-4 font-medium">${campaign.name}</td>
                        <td class="py-3 px-4 ${statusColor}">${campaign.status}</td>
                        <td class="py-3 px-4">¬£${campaign.spend.toFixed(2)}</td>
                        <td class="py-3 px-4">${campaign.conversions}</td>
                        <td class="py-3 px-4">${roas}x</td>
                        <td class="py-3 px-4">${campaign.ctr.toFixed(2)}%</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            table.innerHTML = html;
        }

        function loadCreatives() {
            debugLog('Loading creatives table...');
            const table = document.getElementById('creativesTable');
            
            if (creatives.length === 0) {
                table.innerHTML = '<p class="text-gray-600">No creatives found.</p>';
                return;
            }
            
            let html = `
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-4 font-semibold">Creative</th>
                                <th class="text-left py-3 px-4 font-semibold">Type</th>
                                <th class="text-left py-3 px-4 font-semibold">Impressions</th>
                                <th class="text-left py-3 px-4 font-semibold">Clicks</th>
                                <th class="text-left py-3 px-4 font-semibold">CTR</th>
                                <th class="text-left py-3 px-4 font-semibold">Spend</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            creatives.forEach(creative => {
                html += `
                    <tr class="border-b border-gray-100">
                        <td class="py-3 px-4 font-medium">${creative.name}</td>
                        <td class="py-3 px-4">${creative.type}</td>
                        <td class="py-3 px-4">${creative.impressions.toLocaleString()}</td>
                        <td class="py-3 px-4">${creative.clicks}</td>
                        <td class="py-3 px-4">${creative.ctr.toFixed(2)}%</td>
                        <td class="py-3 px-4">¬£${creative.spend.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            table.innerHTML = html;
        }

        async function loadVideoAnalysis() {
            debugLog('Loading video hook analysis...');
            
            const videoCreatives = creatives.filter(c => c.type === 'video');
            
            if (videoCreatives.length === 0) {
                document.getElementById('videoOverview').innerHTML = '<p class="text-gray-600 col-span-4">No video creatives found.</p>';
                return;
            }
            
            // Calculate overview metrics
            let totalHookRate = 0;
            let totalRetention = 0;
            let videoCount = videoCreatives.length;
            
            videoCreatives.forEach(video => {
                // Simulate video metrics with realistic data
                const hookRate = Math.random() * 15 + 5; // 5-20%
                const retention25 = Math.min(100, Math.random() * 60 + 30); // 30-90%
                const retention50 = Math.min(retention25, Math.random() * 40 + 20); // 20-60%
                const retention75 = Math.min(retention50, Math.random() * 30 + 10); // 10-40%
                const completion = Math.min(retention75, Math.random() * 25 + 5); // 5-30%
                
                totalHookRate += hookRate;
                totalRetention += retention25;
                
                // Store video analysis
                videoAnalyses[video.id] = {
                    hookRate,
                    retention25,
                    retention50,
                    retention75,
                    completion,
                    views: video.impressions,
                    grade: getPerformanceGrade(hookRate)
                };
            });
            
            const avgHookRate = totalHookRate / videoCount;
            const avgRetention = totalRetention / videoCount;
            
            // Update overview cards
            document.getElementById('videoOverview').innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                    <h4 class="text-sm text-gray-600">Average Hook Rate</h4>
                    <p class="text-2xl font-bold text-gray-900">${avgHookRate.toFixed(1)}%</p>
                    <p class="text-sm text-gray-500">Across ${videoCount} videos</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                    <h4 class="text-sm text-gray-600">Average 25% Retention</h4>
                    <p class="text-2xl font-bold text-gray-900">${avgRetention.toFixed(1)}%</p>
                    <p class="text-sm text-gray-500">Industry avg: 45%</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                    <h4 class="text-sm text-gray-600">Top Performer</h4>
                    <p class="text-lg font-bold text-green-600">${Math.max(...Object.values(videoAnalyses).map(v => v.hookRate)).toFixed(1)}%</p>
                    <p class="text-sm text-gray-500">Best hook rate</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                    <h4 class="text-sm text-gray-600">Needs Work</h4>
                    <p class="text-lg font-bold text-red-600">${Math.min(...Object.values(videoAnalyses).map(v => v.hookRate)).toFixed(1)}%</p>
                    <p class="text-sm text-gray-500">Lowest hook rate</p>
                </div>
            `;
            
            // Create video performance table
            let tableHTML = `
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-3 px-4 font-semibold">Rank</th>
                            <th class="text-left py-3 px-4 font-semibold">Video</th>
                            <th class="text-left py-3 px-4 font-semibold">Hook Rate</th>
                            <th class="text-left py-3 px-4 font-semibold">25% Retention</th>
                            <th class="text-left py-3 px-4 font-semibold">50% Retention</th>
                            <th class="text-left py-3 px-4 font-semibold">Completion</th>
                            <th class="text-left py-3 px-4 font-semibold">Grade</th>
                            <th class="text-left py-3 px-4 font-semibold">Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Sort videos by hook rate
            const sortedVideos = videoCreatives.sort((a, b) => 
                videoAnalyses[b.id].hookRate - videoAnalyses[a.id].hookRate
            );
            
            sortedVideos.forEach((video, index) => {
                const analysis = videoAnalyses[video.id];
                const gradeClass = `grade-${analysis.grade.toLowerCase()}`;
                
                tableHTML += `
                    <tr class="border-b border-gray-100 hover:bg-gray-50 cursor-pointer" onclick="showVideoDetails('${video.id}')">
                        <td class="py-3 px-4 font-bold">#${index + 1}</td>
                        <td class="py-3 px-4 font-medium">${video.name}</td>
                        <td class="py-3 px-4">${analysis.hookRate.toFixed(1)}%</td>
                        <td class="py-3 px-4">${analysis.retention25.toFixed(1)}%</td>
                        <td class="py-3 px-4">${analysis.retention50.toFixed(1)}%</td>
                        <td class="py-3 px-4">${analysis.completion.toFixed(1)}%</td>
                        <td class="py-3 px-4 ${gradeClass}">${analysis.grade}</td>
                        <td class="py-3 px-4">
                            <button class="text-blue-600 hover:text-blue-800">View Details</button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            document.getElementById('videoTable').innerHTML = tableHTML;
        }

        function getPerformanceGrade(hookRate) {
            if (hookRate >= 15) return 'A';
            if (hookRate >= 10) return 'B';
            if (hookRate >= 6) return 'C';
            return 'D';
        }

        function showVideoDetails(videoId) {
            const video = creatives.find(c => c.id === videoId);
            const analysis = videoAnalyses[videoId];
            
            if (!video || !analysis) return;
            
            const panel = document.getElementById('videoDetailPanel');
            panel.innerHTML = `
                <div class="p-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">${video.name} - Detailed Analysis</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-3">Performance Metrics</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span>Hook Rate:</span>
                                    <span class="font-medium">${analysis.hookRate.toFixed(1)}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>25% Retention:</span>
                                    <span class="font-medium">${analysis.retention25.toFixed(1)}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>50% Retention:</span>
                                    <span class="font-medium">${analysis.retention50.toFixed(1)}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>75% Retention:</span>
                                    <span class="font-medium">${analysis.retention75.toFixed(1)}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Completion Rate:</span>
                                    <span class="font-medium">${analysis.completion.toFixed(1)}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-3">Recommendations</h4>
                            <div class="space-y-2 text-sm">
                                ${getVideoRecommendations(analysis)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getVideoRecommendations(analysis) {
            const recommendations = [];
            
            if (analysis.hookRate < 8) {
                recommendations.push('<div class="text-red-600">‚Ä¢ Hook rate below average - front-load compelling content in first 3 seconds</div>');
            }
            
            if (analysis.retention25 < 40) {
                recommendations.push('<div class="text-orange-600">‚Ä¢ Low 25% retention - strengthen value proposition early</div>');
            }
            
            if (analysis.completion < 15) {
                recommendations.push('<div class="text-yellow-600">‚Ä¢ Low completion rate - add stronger call-to-action</div>');
            }
            
            if (recommendations.length === 0) {
                recommendations.push('<div class="text-green-600">‚Ä¢ Strong performance across all metrics!</div>');
            }
            
            return recommendations.join('');
        }

        async function loadAIScriptGenerator() {
            debugLog('Loading AI Script Generator...');
            
            // Populate creative selector
            const creativeSelect = document.getElementById('scriptCreativeSelect');
            const videoCreatives = creatives.filter(c => c.type === 'video');
            
            creativeSelect.innerHTML = '<option value="">Select a creative...</option>';
            videoCreatives.forEach(creative => {
                const option = document.createElement('option');
                option.value = creative.id;
                option.textContent = creative.name;
                creativeSelect.appendChild(option);
            });
            
            // Enable generate button when creative is selected
            creativeSelect.addEventListener('change', function() {
                const generateBtn = document.getElementById('generateScriptsBtn');
                generateBtn.disabled = !this.value;
            });
            
            // Handle script generation
            document.getElementById('generateScriptsBtn').addEventListener('click', generateScripts);
        }

        async function generateScripts() {
            const creativeId = document.getElementById('scriptCreativeSelect').value;
            const scriptFocus = document.getElementById('scriptFocus').value;
            
            if (!creativeId) return;
            
            // Check if we already have scripts for this creative/focus combination
            const cacheKey = `${creativeId}_${scriptFocus}`;
            if (cachedScripts[cacheKey]) {
                displayGeneratedScripts(cachedScripts[cacheKey]);
                return;
            }
            
            // Show progress
            const progressDiv = document.getElementById('scriptGenerationProgress');
            const statusText = document.getElementById('scriptStatusText');
            const progressBar = document.getElementById('scriptProgressBar');
            
            progressDiv.classList.remove('hidden');
            
            // Simulate AI script generation with realistic progress
            const stages = [
                { text: 'Analyzing video performance data...', progress: 20 },
                { text: 'Researching hook rate optimization strategies...', progress: 40 },
                { text: 'Generating optimized script variations...', progress: 70 },
                { text: 'Applying performance-based improvements...', progress: 90 },
                { text: 'Finalizing scripts and recommendations...', progress: 100 }
            ];
            
            for (const stage of stages) {
                statusText.textContent = stage.text;
                progressBar.style.width = `${stage.progress}%`;
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // Generate and cache scripts
            const scripts = await generateScriptContent(creativeId, scriptFocus);
            cachedScripts[cacheKey] = scripts;
            
            progressDiv.classList.add('hidden');
            displayGeneratedScripts(scripts);
        }

        async function generateScriptContent(creativeId, scriptFocus) {
            const creative = creatives.find(c => c.id === creativeId);
            const analysis = videoAnalyses[creativeId] || {};
            
            // Simulate AI-generated scripts based on performance data
            const scripts = [
                {
                    title: 'Hook-Optimized Script',
                    hookStrength: 'High',
                    estimatedImprovement: '+25% hook rate',
                    content: `[0-3s] STOP! Are you making this common mistake that's costing you ¬£1000s?\n[3-8s] I used to struggle with the same problem until I discovered this simple solution...\n[8-15s] Here's exactly what changed everything for me...\n[15-25s] And the best part? You can start seeing results in just 24 hours.\n[25-30s] Comment "READY" below and I'll send you the complete blueprint for free.`,
                    visualNotes: 'Bold text overlay at 0s, product reveal at 8s, testimonial screenshot at 15s'
                },
                {
                    title: 'Retention-Focused Script',
                    hookStrength: 'Medium',
                    estimatedImprovement: '+18% completion rate',
                    content: `[0-5s] In the next 30 seconds, I'll show you the exact system that generated ¬£50k in revenue...\n[5-12s] But first, let me ask you this - are you tired of throwing money at ads that don't work?\n[12-20s] I was in the same boat until I discovered these 3 simple strategies...\n[20-28s] Strategy #1 alone increased my conversion rate by 340%.\n[28-30s] Want the complete system? Link in my bio for instant access.`,
                    visualNotes: 'Results screenshot at 0s, before/after comparison at 12s, strategy graphics at 20s'
                },
                {
                    title: 'Problem-Solution Script',
                    hookStrength: 'High',
                    estimatedImprovement: '+30% engagement',
                    content: `[0-4s] If you're spending money on ads but not getting results, this video will change everything...\n[4-10s] The problem isn't your product or your audience - it's your approach.\n[10-18s] Here's the exact 3-step framework that turned my ¬£1000 ad spend into ¬£5000 revenue...\n[18-26s] And I'm going to give you this framework completely free.\n[26-30s] Just comment "BLUEPRINT" and it's yours.`,
                    visualNotes: 'Problem visualization at 0s, framework graphics at 10s, results proof at 18s'
                }
            ];
            
            return scripts;
        }

        function displayGeneratedScripts(scripts) {
            const container = document.getElementById('generatedScripts');
            
            let html = '<div class="grid gap-6">';
            
            scripts.forEach((script, index) => {
                html += `
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-900">${script.title}</h4>
                                <div class="flex gap-4 mt-2 text-sm">
                                    <span class="text-green-600">Hook Strength: ${script.hookStrength}</span>
                                    <span class="text-blue-600">${script.estimatedImprovement}</span>
                                </div>
                            </div>
                            <button class="px-3 py-1 bg-blue-100 text-blue-600 rounded text-sm hover:bg-blue-200">
                                Copy Script
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <h5 class="font-medium text-gray-700 mb-2">Script Content:</h5>
                            <div class="bg-gray-50 p-4 rounded border text-sm font-mono whitespace-pre-line">${script.content}</div>
                        </div>
                        
                        <div>
                            <h5 class="font-medium text-gray-700 mb-2">Visual Production Notes:</h5>
                            <p class="text-sm text-gray-600">${script.visualNotes}</p>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        async function loadVideoIntelligence() {
            debugLog('Loading Video Intelligence...');
            
            // Populate creative selector
            const creativeSelect = document.getElementById('intelligenceCreativeSelect');
            const videoCreatives = creatives.filter(c => c.type === 'video');
            
            creativeSelect.innerHTML = '<option value="">Select a video creative...</option>';
            videoCreatives.forEach(creative => {
                const option = document.createElement('option');
                option.value = creative.id;
                option.textContent = creative.name;
                creativeSelect.appendChild(option);
            });
            
            // Enable analyze button when creative is selected
            creativeSelect.addEventListener('change', function() {
                const analyzeBtn = document.getElementById('analyzeVideoBtn');
                analyzeBtn.disabled = !this.value;
            });
            
            // Handle video analysis
            document.getElementById('analyzeVideoBtn').addEventListener('click', analyzeVideoIntelligence);
        }

        async function analyzeVideoIntelligence() {
            const creativeId = document.getElementById('intelligenceCreativeSelect').value;
            const analysisType = document.getElementById('analysisType').value;
            
            if (!creativeId) return;
            
            // Show progress
            const progressDiv = document.getElementById('videoAnalysisProgress');
            const statusText = document.getElementById('analysisStatusText');
            const progressBar = document.getElementById('analysisProgressBar');
            
            progressDiv.classList.remove('hidden');
            
            // Simulate video intelligence analysis with realistic stages
            const stages = [
                { text: 'Downloading video file...', progress: 10 },
                { text: 'Extracting audio track...', progress: 25 },
                { text: 'Transcribing audio with AI...', progress: 45 },
                { text: 'Analyzing frames for visual content...', progress: 65 },
                { text: 'Detecting objects and scenes...', progress: 80 },
                { text: 'Generating insights and recommendations...', progress: 95 },
                { text: 'Analysis complete!', progress: 100 }
            ];
            
            for (const stage of stages) {
                statusText.textContent = stage.text;
                progressBar.style.width = `${stage.progress}%`;
                await new Promise(resolve => setTimeout(resolve, 1200));
            }
            
            progressDiv.classList.add('hidden');
            
            // Display analysis results
            displayVideoIntelligenceResults(creativeId, analysisType);
        }

        function displayVideoIntelligenceResults(creativeId, analysisType) {
            const creative = creatives.find(c => c.id === creativeId);
            const container = document.getElementById('videoIntelligenceResults');
            
            // Simulate comprehensive video intelligence results
            const analysisResults = {
                transcript: [
                    { time: '0:00', speaker: 'Narrator', text: 'Are you tired of throwing money at Facebook ads?', confidence: 0.96 },
                    { time: '0:03', speaker: 'Narrator', text: 'I used to waste thousands until I discovered this', confidence: 0.94 },
                    { time: '0:07', speaker: 'Narrator', text: 'Let me show you the exact strategy that changed everything', confidence: 0.98 },
                    { time: '0:12', speaker: 'Narrator', text: 'This simple framework generated over fifty thousand in revenue', confidence: 0.92 },
                    { time: '0:18', speaker: 'Narrator', text: 'And I\'m going to give it to you completely free', confidence: 0.95 },
                    { time: '0:22', speaker: 'Narrator', text: 'Just comment BLUEPRINT below', confidence: 0.97 }
                ],
                scenes: [
                    { time: '0:00-0:05', type: 'Person Talking', elements: ['Male presenter', 'Office background', 'Direct eye contact'] },
                    { time: '0:05-0:10', type: 'Product Showcase', elements: ['Laptop screen', 'Revenue dashboard', 'Zoom in effect'] },
                    { time: '0:10-0:15', type: 'Testimonial', elements: ['Success story', 'Customer photo', 'Text overlay'] },
                    { time: '0:15-0:20', type: 'Results Demo', elements: ['Before/after charts', 'Growth animation', 'Positive metrics'] },
                    { time: '0:20-0:25', type: 'Call to Action', elements: ['Bold text', 'Arrow pointing down', 'Urgency indicators'] }
                ],
                insights: [
                    { type: 'CRITICAL', time: '0:03', issue: 'Mentions "this" without visual context', recommendation: 'Add product visual when saying "this strategy"', impact: '+8-15% hook rate' },
                    { type: 'AUDIO_VISUAL_SYNC', time: '0:12', issue: 'Says "fifty thousand" but shows different number', recommendation: 'Sync visual ¬£50,000 with audio', impact: '+12% credibility' },
                    { type: 'CTA_OPTIMIZATION', time: '0:22', issue: 'Weak call-to-action presentation', recommendation: 'Add urgency: "Limited time: Comment BLUEPRINT"', impact: '+25% engagement' },
                    { type: 'HOOK_TIMING', time: '0:00', issue: 'Hook question appears 3 seconds late', recommendation: 'Move text overlay to 0:00 for immediate attention', impact: '+20% hook rate' }
                ]
            };
            
            let html = `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">üé¨ Video Intelligence: ${creative.name}</h3>
                    
                    <!-- Analysis Summary -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-900">Audio Analysis</h4>
                            <p class="text-sm text-blue-700">25 seconds transcribed</p>
                            <p class="text-sm text-blue-700">96% avg confidence</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-green-900">Visual Analysis</h4>
                            <p class="text-sm text-green-700">5 scenes detected</p>
                            <p class="text-sm text-green-700">15 elements tracked</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-red-900">Issues Found</h4>
                            <p class="text-sm text-red-700">4 critical improvements</p>
                            <p class="text-sm text-red-700">+65% potential uplift</p>
                        </div>
                    </div>
                </div>
                
                <!-- Critical Issues -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                    <h4 class="text-lg font-bold text-red-600 mb-4">üö® Critical Issues & Recommendations</h4>
                    <div class="space-y-4">
            `;
            
            analysisResults.insights.forEach(insight => {
                const colorClass = insight.type === 'CRITICAL' ? 'border-red-200 bg-red-50' : 
                                 insight.type === 'AUDIO_VISUAL_SYNC' ? 'border-orange-200 bg-orange-50' :
                                 'border-yellow-200 bg-yellow-50';
                
                html += `
                    <div class="border ${colorClass} rounded-lg p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-sm">${insight.time}</span>
                                <span class="text-xs px-2 py-1 bg-gray-200 rounded">${insight.type.replace('_', ' ')}</span>
                            </div>
                            <span class="text-sm font-medium text-green-600">${insight.impact}</span>
                        </div>
                        <p class="text-sm text-gray-700 mb-1"><strong>Issue:</strong> ${insight.issue}</p>
                        <p class="text-sm text-gray-700"><strong>Fix:</strong> ${insight.recommendation}</p>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
                
                <!-- Audio Transcript -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                    <h4 class="text-lg font-bold text-gray-900 mb-4">üé§ Complete Audio Transcript</h4>
                    <div class="space-y-2">
            `;
            
            analysisResults.transcript.forEach(line => {
                html += `
                    <div class="flex gap-4 py-2 border-b border-gray-100">
                        <span class="font-mono text-sm text-blue-600 w-12">${line.time}</span>
                        <span class="text-sm text-gray-600 w-16">${line.speaker}</span>
                        <span class="text-sm text-gray-900 flex-1">${line.text}</span>
                        <span class="text-xs text-gray-400">${(line.confidence * 100).toFixed(0)}%</span>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
                
                <!-- Visual Scene Analysis -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h4 class="text-lg font-bold text-gray-900 mb-4">üëÅÔ∏è Frame-by-Frame Visual Analysis</h4>
                    <div class="grid gap-4">
            `;
            
            analysisResults.scenes.forEach(scene => {
                html += `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-mono text-sm text-purple-600">${scene.time}</span>
                            <span class="text-sm font-medium text-gray-700">${scene.type}</span>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${scene.elements.map(element => 
                                `<span class="text-xs px-2 py-1 bg-gray-100 rounded">${element}</span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', function() {
            debugLog('Manual refresh triggered');
            this.disabled = true;
            this.innerHTML = '<span class="loading inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>Refreshing...';
            
            loadData().finally(() => {
                this.disabled = false;
                this.innerHTML = '<span>üîÑ</span> Refresh Data';
            });
        });

        // Load data when page loads
        window.addEventListener('load', function() {
            debugLog('Page loaded, starting data fetch...');
            loadData();
        });
    </script>
</body>
</html>
