<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Creative Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .tab-btn.active { color: #3B82F6; border-bottom-color: #3B82F6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .filter-active { background-color: #3B82F6; color: white; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            
            <!-- Header -->
            <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-8 rounded-lg mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-4xl font-bold mb-2">ü§ñ AI-Powered Creative Intelligence</h1>
                        <p class="text-purple-100">Multi-platform analysis ‚Ä¢ AI creative insights ‚Ä¢ Real creative generation ‚Ä¢ Performance optimization</p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-purple-200">Cross-Platform ROAS</div>
                        <div class="text-3xl font-bold" id="crossPlatformROAS">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Platform Status Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Facebook Status -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-blue-500 text-2xl">üìò</span>
                            <h3 class="text-lg font-semibold text-gray-900">Facebook Ads</h3>
                        </div>
                        <div id="facebookStatus" class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Spend:</span>
                            <span class="font-medium" id="facebookSpend">¬£0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Conversions:</span>
                            <span class="font-medium" id="facebookConversions">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Creatives:</span>
                            <span class="font-medium" id="facebookCreativeCount">0</span>
                        </div>
                    </div>
                </div>

                <!-- Taboola Status -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-orange-500 text-2xl">üî∂</span>
                            <h3 class="text-lg font-semibold text-gray-900">Taboola</h3>
                        </div>
                        <div id="taboolaStatus" class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Spend:</span>
                            <span class="font-medium" id="taboolaSpend">¬£0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Conversions:</span>
                            <span class="font-medium" id="taboolaConversions">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Creatives:</span>
                            <span class="font-medium" id="taboolaCreativeCount">0</span>
                        </div>
                    </div>
                </div>

                <!-- AI Insights Status -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-purple-500 text-2xl">ü§ñ</span>
                            <h3 class="text-lg font-semibold text-gray-900">AI Insights</h3>
                        </div>
                        <div id="aiStatus" class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Analyzed:</span>
                            <span class="font-medium" id="aiAnalyzed">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Success Factors:</span>
                            <span class="font-medium" id="aiSuccessFactors">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Generated:</span>
                            <span class="font-medium" id="aiGenerated">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex space-x-8 mb-6 overflow-x-auto">
                <button class="tab-btn px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600 whitespace-nowrap" data-tab="overview">üè† Overview</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="campaigns">üìä Campaigns</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="creatives">üé® Creative Analysis</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="video-analysis">üì∫ Video Hook Analysis</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="ai-insights">üß† AI Insights</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="creative-generator">‚ú® Creative Generator</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="testing-lab">üß™ Testing Lab</button>
            </div>

            <!-- Tab Content -->
            
            <!-- Overview Tab -->
            <div id="overview-content" class="tab-content active">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üåê Cross-Platform Performance</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-gray-900" id="totalSpend">¬£0.00</div>
                            <div class="text-sm text-gray-600">Total Spend</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-gray-900" id="totalRevenue">¬£0.00</div>
                            <div class="text-sm text-gray-600">Total Revenue</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-gray-900" id="totalConversions">0</div>
                            <div class="text-sm text-gray-600">Total Conversions</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-gray-900" id="averageCTR">0.00%</div>
                            <div class="text-sm text-gray-600">Average CTR</div>
                        </div>
                    </div>
                </div>

                <!-- Top Performing Creatives -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">üèÜ Top Performing Creatives</h3>
                    <div id="topCreatives" class="text-gray-500">Loading top performers...</div>
                </div>
            </div>

            <!-- Campaigns Tab -->
            <div id="campaigns-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üìä All Campaigns</h2>
                    <div id="campaignsTable" class="overflow-x-auto">Loading campaigns...</div>
                </div>
            </div>

            <!-- Creative Analysis Tab -->
            <div id="creatives-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold text-gray-900">üé® Creative Analysis</h2>
                        <div class="flex items-center gap-3">
                            <span class="text-sm text-gray-600" id="creativesCount">0 creatives</span>
                            <button id="analyzeAllCreatives" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                üß† Analyze All with AI
                            </button>
                        </div>
                    </div>

                    <!-- Smart Filters & Controls -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <!-- Platform Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Platform</label>
                                <div class="flex gap-2">
                                    <button class="filter-btn px-3 py-2 text-xs border rounded filter-active" data-filter="platform" data-value="all">All</button>
                                    <button class="filter-btn px-3 py-2 text-xs border rounded" data-filter="platform" data-value="Facebook">üìò FB</button>
                                    <button class="filter-btn px-3 py-2 text-xs border rounded" data-filter="platform" data-value="Taboola">üî∂ Tab</button>
                                </div>
                            </div>

                            <!-- Performance Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Performance</label>
                                <div class="flex gap-2">
                                    <button class="filter-btn px-3 py-2 text-xs border rounded filter-active" data-filter="performance" data-value="all">All</button>
                                    <button class="filter-btn px-3 py-2 text-xs border rounded" data-filter="performance" data-value="winners">üèÜ Winners</button>
                                    <button class="filter-btn px-3 py-2 text-xs border rounded" data-filter="performance" data-value="losers">‚ö†Ô∏è Losers</button>
                                </div>
                            </div>

                            <!-- Type Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Creative Type</label>
                                <div class="flex gap-2">
                                    <button class="filter-btn px-3 py-2 text-xs border rounded filter-active" data-filter="type" data-value="all">All</button>
                                    <button class="filter-btn px-3 py-2 text-xs border rounded" data-filter="type" data-value="video">üìπ Video</button>
                                    <button class="filter-btn px-3 py-2 text-xs border rounded" data-filter="type" data-value="image">üñºÔ∏è Image</button>
                                </div>
                            </div>

                            <!-- Sort & Limit -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Display</label>
                                <div class="flex gap-2">
                                    <select id="sortBy" class="px-2 py-1 text-xs border rounded">
                                        <option value="performance_score">Performance</option>
                                        <option value="ctr">CTR</option>
                                        <option value="conversions">Conversions</option>
                                        <option value="spend">Spend</option>
                                    </select>
                                    <select id="limitTo" class="px-2 py-1 text-xs border rounded">
                                        <option value="12">Top 12</option>
                                        <option value="24">Top 24</option>
                                        <option value="50">Top 50</option>
                                        <option value="all">All</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="flex items-center gap-4">
                            <button id="clearFilters" class="px-3 py-1 text-xs text-gray-600 hover:text-gray-800">üîÑ Clear Filters</button>
                            <button id="bulkAnalyze" class="px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">üß† Analyze Filtered</button>
                            <button id="exportData" class="px-3 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600">üìä Export Data</button>
                        </div>
                    </div>

                    <!-- Creatives Grid -->
                    <div id="creativesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        Loading creatives...
                    </div>

                    <!-- Load More Button -->
                    <div id="loadMoreContainer" class="text-center mt-6 hidden">
                        <button id="loadMoreBtn" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            Load More Creatives
                        </button>
                    </div>
                </div>
            </div>

            <!-- Video Hook Analysis Tab -->
            <div id="video-analysis-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üì∫ Video Hook Analysis</h2>
                    
                    <!-- Overview Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" id="avgHookRate">0.0%</div>
                            <div class="text-sm text-blue-600">Average Hook Rate</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" id="avgRetention">0.0%</div>
                            <div class="text-sm text-green-600">Average Retention</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600" id="avgCompletion">0.0%</div>
                            <div class="text-sm text-purple-600">Average Completion</div>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-orange-600" id="totalVideos">0</div>
                            <div class="text-sm text-orange-600">Total Videos</div>
                        </div>
                    </div>
                    
                    <div id="videoAnalysisTable" class="overflow-x-auto">Loading video analysis...</div>
                </div>
            </div>

            <!-- AI Insights Tab -->
            <div id="ai-insights-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üß† AI Insights</h2>
                    <div id="aiInsights" class="text-gray-500">Run creative analysis first to see AI insights...</div>
                </div>
            </div>

            <!-- Creative Generator Tab -->
            <div id="creative-generator-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">‚ú® Creative Generator</h2>
                    
                    <!-- Generator Controls -->
                    <div class="mb-6 p-4 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg">
                        <h3 class="text-lg font-semibold mb-4">üöÄ AI Creative Generation</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Base Creative</label>
                                <select id="baseCreativeSelect" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Select a high-performing creative...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Generation Type</label>
                                <select id="generationType" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="variation">Similar Variations</option>
                                    <option value="style_transfer">Style Transfer</option>
                                    <option value="concept_remix">Concept Remix</option>
                                    <option value="platform_adapt">Platform Adaptation</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Target Platform</label>
                                <select id="targetPlatform" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="facebook">Facebook</option>
                                    <option value="taboola">Taboola</option>
                                    <option value="both">Both Platforms</option>
                                </select>
                            </div>
                        </div>
                        <button id="generateCreatives" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 disabled:bg-gray-300" disabled>
                            üé® Generate AI Creatives
                        </button>
                    </div>

                    <!-- Generated Creatives Display -->
                    <div id="generatedCreatives" class="hidden">
                        <h3 class="text-lg font-semibold mb-4">üéØ Generated Creative Variations</h3>
                        <div id="generatedGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Generated creatives will appear here -->
                        </div>
                    </div>

                    <div id="creativeGenerator" class="text-gray-500">Select a high-performing creative above to generate AI variations...</div>
                </div>
            </div>

            <!-- Testing Lab Tab -->
            <div id="testing-lab-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üß™ Testing Lab</h2>
                    <div id="testingLab" class="text-gray-500">Generate creatives first to set up tests...</div>
                </div>
            </div>

            <!-- Debug Panel -->
            <div id="debugPanel" class="mt-8 bg-gray-800 text-green-400 p-4 rounded-lg font-mono text-sm max-h-64 overflow-y-auto">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-bold">üîß Debug Console</span>
                    <div class="flex gap-2">
                        <button id="clearDebug" class="text-gray-400 hover:text-white text-xs">Clear</button>
                        <button id="toggleDebug" class="text-gray-400 hover:text-white text-xs">Hide</button>
                    </div>
                </div>
                <div id="debugContent">Dashboard loaded. Waiting for data...</div>
            </div>

        </div>
    </div>

    <script>
        const API_BASE = 'https://facebook-ads-dashboard-git-main-jacks-projects-e0e84f4f.vercel.app';
        
        // State
        let accountData = null;
        let campaigns = [];
        let creatives = [];
        let taboolaCampaigns = [];
        let taboolaCreatives = [];
        let allCreatives = [];
        let filteredCreatives = [];
        let currentFilters = {
            platform: 'all',
            performance: 'all',
            type: 'all'
        };
        let aiAnalysisResults = [];

        // Debug logging
        function debugLog(message) {
            const debugContent = document.getElementById('debugContent');
            const timestamp = new Date().toLocaleTimeString();
            debugContent.innerHTML += `<div>${timestamp}: ${message}</div>`;
            debugContent.scrollTop = debugContent.scrollHeight;
            console.log(`${timestamp}: ${message}`);
        }

        // Clear debug
        document.getElementById('clearDebug').addEventListener('click', () => {
            document.getElementById('debugContent').innerHTML = 'Debug cleared.';
        });

        // Toggle debug panel
        document.getElementById('toggleDebug').addEventListener('click', () => {
            const panel = document.getElementById('debugPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        });

        // Tab functionality
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.getAttribute('data-tab');
                
                // Update tab buttons
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('text-blue-600', 'border-blue-600');
                    b.classList.add('text-gray-500');
                });
                btn.classList.remove('text-gray-500');
                btn.classList.add('text-blue-600', 'border-blue-600');
                
                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}-content`).classList.add('active');
                
                debugLog(`Switched to ${tabName} tab`);
                
                // Load tab-specific data if needed
                if (tabName === 'video-analysis' && allCreatives.length > 0) {
                    updateVideoAnalysisTab();
                } else if (tabName === 'creative-generator' && allCreatives.length > 0) {
                    updateCreativeGeneratorTab();
                }
            });
        });

        // Filter functionality
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const filterType = btn.getAttribute('data-filter');
                const filterValue = btn.getAttribute('data-value');
                
                // Update filter buttons
                document.querySelectorAll(`[data-filter="${filterType}"]`).forEach(b => {
                    b.classList.remove('filter-active');
                });
                btn.classList.add('filter-active');
                
                // Update filters
                currentFilters[filterType] = filterValue;
                applyFilters();
                
                debugLog(`Applied filter ${filterType}: ${filterValue}`);
            });
        });

        // Clear filters
        document.getElementById('clearFilters').addEventListener('click', () => {
            currentFilters = { platform: 'all', performance: 'all', type: 'all' };
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('filter-active');
                if (btn.getAttribute('data-value') === 'all') {
                    btn.classList.add('filter-active');
                }
            });
            applyFilters();
            debugLog('Cleared all filters');
        });

        // Sort and limit changes
        document.getElementById('sortBy').addEventListener('change', applyFilters);
        document.getElementById('limitTo').addEventListener('change', applyFilters);

        // Apply filters function
        function applyFilters() {
            filteredCreatives = [...allCreatives];
            
            // Platform filter
            if (currentFilters.platform !== 'all') {
                filteredCreatives = filteredCreatives.filter(c => c.platform === currentFilters.platform);
            }
            
            // Performance filter
            if (currentFilters.performance === 'winners') {
                filteredCreatives = filteredCreatives.filter(c => 
                    (c.performance_score >= 70) || (c.ctr >= 2) || (c.conversions > 0)
                );
            } else if (currentFilters.performance === 'losers') {
                filteredCreatives = filteredCreatives.filter(c => 
                    (c.performance_score < 40) && (c.ctr < 1) && (c.conversions === 0)
                );
            }
            
            // Type filter
            if (currentFilters.type !== 'all') {
                filteredCreatives = filteredCreatives.filter(c => 
                    currentFilters.type === 'video' ? c.creative_type === 'video' : c.creative_type !== 'video'
                );
            }
            
            // Sort
            const sortBy = document.getElementById('sortBy').value;
            filteredCreatives.sort((a, b) => {
                const aVal = parseFloat(a[sortBy]) || 0;
                const bVal = parseFloat(b[sortBy]) || 0;
                return bVal - aVal; // Descending order
            });
            
            // Limit
            const limit = document.getElementById('limitTo').value;
            if (limit !== 'all') {
                filteredCreatives = filteredCreatives.slice(0, parseInt(limit));
            }
            
            updateCreativesTab();
        }

        // Data loading functions
        async function fetchAccountData() {
            try {
                debugLog('Fetching overview data...');
                const response = await fetch(`${API_BASE}/api/overview`);
                debugLog(`Overview response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                debugLog('Overview data received successfully');
                
                const processedData = {
                    spend: parseFloat(data.spend || data.totalSpend || 0),
                    revenue: parseFloat(data.revenue || data.totalRevenue || data.conversion_values || 0),
                    conversions: parseInt(data.conversions || data.totalConversions || data.leadConversions || 0),
                    clicks: parseInt(data.clicks || data.totalClicks || 0),
                    impressions: parseInt(data.impressions || data.totalImpressions || 0),
                    ctr: parseFloat(data.ctr || data.averageCTR || 0),
                    cpc: parseFloat(data.cpc || data.averageCPC || 0),
                    cpm: parseFloat(data.cpm || data.averageCPM || 0)
                };
                
                processedData.roas = processedData.revenue > 0 ? processedData.revenue / processedData.spend : 0;
                
                debugLog(`Processed metrics - Spend: ¬£${processedData.spend}, Revenue: ¬£${processedData.revenue}, Conversions: ${processedData.conversions}`);
                
                return processedData;
            } catch (error) {
                debugLog(`Error fetching overview: ${error.message}`);
                throw error;
            }
        }

        async function fetchCampaigns() {
            try {
                debugLog('Fetching campaigns data...');
                const response = await fetch(`${API_BASE}/api/campaigns`);
                debugLog(`Campaigns response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                debugLog(`Campaigns data received: ${Array.isArray(data) ? data.length : 'unknown'} campaigns`);
                
                return Array.isArray(data) ? data : [];
            } catch (error) {
                debugLog(`Error fetching campaigns: ${error.message}`);
                return [];
            }
        }

        async function fetchCreatives() {
            try {
                debugLog('Fetching Facebook creatives data...');
                const response = await fetch(`${API_BASE}/api/creatives`);
                debugLog(`Facebook creatives response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                debugLog(`Facebook creatives data received: ${Array.isArray(data) ? data.length : 'unknown'} creatives`);
                
                const processedCreatives = Array.isArray(data) ? data.map(creative => ({
                    ...creative,
                    platform: 'Facebook'
                })) : [];
                
                return processedCreatives;
            } catch (error) {
                debugLog(`Error fetching Facebook creatives: ${error.message}`);
                return [];
            }
        }

        async function fetchTaboolaCampaigns() {
            try {
                debugLog('Fetching Taboola campaigns...');
                const response = await fetch(`${API_BASE}/api/taboola-campaigns`);
                debugLog(`Taboola campaigns response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                debugLog(`Taboola campaigns data received: ${Array.isArray(data) ? data.length : 'unknown'} campaigns`);
                
                return Array.isArray(data) ? data : [];
            } catch (error) {
                debugLog(`Taboola campaigns fetch failed: ${error.message}`);
                return [];
            }
        }

        async function fetchTaboolaCreatives() {
            try {
                debugLog('Fetching Taboola creatives...');
                const response = await fetch(`${API_BASE}/api/taboola-creatives`);
                debugLog(`Taboola creatives response status: ${response.status}`);
                
                if (!response.ok) {
                    debugLog(`Taboola creatives API returned ${response.status}, skipping...`);
                    return [];
                }
                
                const data = await response.json();
                debugLog(`Taboola creatives data received: ${Array.isArray(data) ? data.length : 'unknown'} creatives`);
                
                const processedCreatives = Array.isArray(data) ? data.map(creative => ({
                    ...creative,
                    platform: 'Taboola'
                })) : [];
                
                debugLog(`Processed Taboola creatives: ${processedCreatives.length} with platform identifiers`);
                
                return processedCreatives;
            } catch (error) {
                debugLog(`Taboola creatives fetch failed: ${error.message}`);
                return [];
            }
        }

        // AI Analysis functions
        async function analyzeCreative(creativeId) {
            debugLog(`Starting AI analysis for creative ${creativeId}`);
            
            try {
                const creative = allCreatives.find(c => c.id === creativeId);
                if (!creative) {
                    debugLog(`Creative ${creativeId} not found`);
                    return;
                }
                
                // Call your enhanced AI analysis API
                const response = await fetch(`${API_BASE}/api/ai-creative-analyzer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        creative_id: creativeId,
                        creative_url: creative.image_url || creative.thumbnail_url,
                        performance_data: {
                            ctr: creative.ctr || 0,
                            spend: creative.spend || 0,
                            conversions: creative.conversions || creative.leadConversions || 0,
                            impressions: creative.impressions || 0
                        },
                        analysis_type: 'full'
                    })
                });
                
                if (response.ok) {
                    const analysis = await response.json();
                    debugLog(`AI analysis completed for creative ${creativeId}. Confidence: ${analysis.confidence_score}%`);
                    
                    // Store analysis results
                    aiAnalysisResults.push(analysis);
                    
                    // Update AI status
                    const aiAnalyzed = document.getElementById('aiAnalyzed');
                    aiAnalyzed.textContent = aiAnalysisResults.length.toString();
                    
                    const aiSuccessFactors = document.getElementById('aiSuccessFactors');
                    const totalFactors = aiAnalysisResults.reduce((sum, result) => sum + result.success_factors.length, 0);
                    aiSuccessFactors.textContent = totalFactors.toString();
                    
                    return analysis;
                } else {
                    debugLog(`AI analysis failed for creative ${creativeId}: ${response.status}`);
                    return null;
                }
                
            } catch (error) {
                debugLog(`Error in AI analysis for creative ${creativeId}: ${error.message}`);
                return null;
            }
        }

        // AI Creative Generation
        async function generateCreativeVariations(baseCreativeId, platform, generationType, targetPlatform) {
            debugLog(`Starting AI creative generation for ${baseCreativeId}`);
            
            try {
                const response = await fetch(`${API_BASE}/api/ai-creative-generator`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        base_creative_id: baseCreativeId,
                        platform: platform,
                        generation_type: generationType,
                        target_platform: targetPlatform
                    })
                });
                
                if (response.ok) {
                    const generation = await response.json();
                    debugLog(`AI generation completed. Generated ${generation.generated_creatives.length} variations`);
                    
                    // Update AI status
                    const aiGenerated = document.getElementById('aiGenerated');
                    aiGenerated.textContent = (parseInt(aiGenerated.textContent) + generation.generated_creatives.length).toString();
                    
                    return generation;
                } else {
                    debugLog(`AI generation failed: ${response.status}`);
                    return null;
                }
                
            } catch (error) {
                debugLog(`Error in AI generation: ${error.message}`);
                return null;
            }
        }

        // UI update functions
        function updatePlatformStatus() {
            // Facebook status
            const fbStatus = document.getElementById('facebookStatus');
            const fbSpend = document.getElementById('facebookSpend');
            const fbConversions = document.getElementById('facebookConversions');
            const fbCreativeCount = document.getElementById('facebookCreativeCount');
            
            if (accountData && accountData.spend > 0) {
                fbStatus.className = 'w-3 h-3 bg-green-500 rounded-full';
                fbSpend.textContent = `¬£${accountData.spend.toLocaleString()}`;
                fbConversions.textContent = accountData.conversions.toLocaleString();
                fbCreativeCount.textContent = creatives.length.toString();
            } else {
                fbStatus.className = 'w-3 h-3 bg-red-500 rounded-full';
            }
            
            // Taboola status
            const tabStatus = document.getElementById('taboolaStatus');
            const tabSpend = document.getElementById('taboolaSpend');
            const tabConversions = document.getElementById('taboolaConversions');
            const tabCreativeCount = document.getElementById('taboolaCreativeCount');
            
            if (taboolaCampaigns.length > 0) {
                tabStatus.className = 'w-3 h-3 bg-green-500 rounded-full';
                const totalSpend = taboolaCampaigns.reduce((sum, camp) => sum + (parseFloat(camp.spend) || 0), 0);
                const totalConversions = taboolaCampaigns.reduce((sum, camp) => sum + (parseInt(camp.conversions) || 0), 0);
                
                tabSpend.textContent = `¬£${totalSpend.toLocaleString()}`;
                tabConversions.textContent = totalConversions.toLocaleString();
                tabCreativeCount.textContent = taboolaCreatives.length.toString();
            } else {
                tabStatus.className = 'w-3 h-3 bg-yellow-500 rounded-full';
            }
            
            // AI status
            const aiStatus = document.getElementById('aiStatus');
            if (allCreatives.length > 0) {
                aiStatus.className = 'w-3 h-3 bg-green-500 rounded-full';
            } else {
                aiStatus.className = 'w-3 h-3 bg-yellow-400 rounded-full';
            }
            
            // Update cross-platform ROAS
            const crossPlatformROAS = document.getElementById('crossPlatformROAS');
            if (accountData) {
                const taboolaRevenue = taboolaCampaigns.reduce((sum, camp) => sum + (parseFloat(camp.revenue) || 0), 0);
                const taboolaSpend = taboolaCampaigns.reduce((sum, camp) => sum + (parseFloat(camp.spend) || 0), 0);
                const totalRevenue = accountData.revenue + taboolaRevenue;
                const totalSpend = accountData.spend + taboolaSpend;
                const combinedROAS = totalRevenue > 0 ? totalRevenue / totalSpend : 0;
                crossPlatformROAS.textContent = `${combinedROAS.toFixed(2)}x`;
            }
        }

        function updateOverviewTab() {
            if (!accountData) return;
            
            const taboolaSpend = taboolaCampaigns.reduce((sum, camp) => sum + (parseFloat(camp.spend) || 0), 0);
            const taboolaRevenue = taboolaCampaigns.reduce((sum, camp) => sum + (parseFloat(camp.revenue) || 0), 0);
            const taboolaConversions = taboolaCampaigns.reduce((sum, camp) => sum + (parseInt(camp.conversions) || 0), 0);
            
            const totalSpend = accountData.spend + taboolaSpend;
            const totalRevenue = accountData.revenue + taboolaRevenue;
            const totalConversions = accountData.conversions + taboolaConversions;
            const averageCTR = accountData.ctr;
            
            document.getElementById('totalSpend').textContent = `¬£${totalSpend.toLocaleString()}`;
            document.getElementById('totalRevenue').textContent = `¬£${totalRevenue.toLocaleString()}`;
            document.getElementById('totalConversions').textContent = totalConversions.toLocaleString();
            document.getElementById('averageCTR').textContent = `${averageCTR.toFixed(2)}%`;
            
            updateTopCreatives();
            debugLog(`Updated overview UI with spend: ¬£${totalSpend.toFixed(2)}, revenue: ¬£${totalRevenue.toFixed(2)}, conversions: ${totalConversions}`);
        }

        function updateTopCreatives() {
            const topCreativesDiv = document.getElementById('topCreatives');
            
            if (allCreatives.length === 0) {
                topCreativesDiv.innerHTML = '<p class="text-gray-500">No creatives found yet...</p>';
                return;
            }
            
            const sortedCreatives = [...allCreatives].sort((a, b) => {
                const scoreA = (a.performance_score || 0) + (a.ctr || 0) * 10 + (a.conversions || a.leadConversions || 0) * 5;
                const scoreB = (b.performance_score || 0) + (b.ctr || 0) * 10 + (b.conversions || b.leadConversions || 0) * 5;
                return scoreB - scoreA;
            }).slice(0, 5);
            
            let html = '<div class="space-y-3">';
            
            sortedCreatives.forEach((creative, index) => {
                const performanceScore = creative.performance_score || Math.min(100, Math.max(0, 
                    (creative.ctr || 0) * 20 + (creative.conversions || creative.leadConversions || 0) * 5
                ));
                
                const platformIcon = creative.platform === 'Taboola' ? 'üî∂' : 'üìò';
                
                html += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <span class="flex items-center justify-center w-6 h-6 bg-blue-500 text-white text-xs font-bold rounded-full">
                                ${index + 1}
                            </span>
                            <div>
                                <div class="font-medium text-gray-900 truncate max-w-xs">
                                    ${platformIcon} ${creative.name || 'Unnamed Creative'}
                                </div>
                                <div class="text-sm text-gray-600">
                                    CTR: ${(creative.ctr || 0).toFixed(2)}% ‚Ä¢ Conversions: ${creative.conversions || creative.leadConversions || 0}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-gray-900">${Math.round(performanceScore)}/100</div>
                            <div class="text-sm text-gray-600">Score</div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            topCreativesDiv.innerHTML = html;
        }

        function updateCampaignsTab() {
            const table = document.getElementById('campaignsTable');
            
            const allCampaigns = [];
            
            campaigns.forEach(campaign => {
                allCampaigns.push({
                    ...campaign,
                    platform: 'Facebook',
                    platform_icon: 'üìò'
                });
            });
            
            taboolaCampaigns.forEach(campaign => {
                allCampaigns.push({
                    ...campaign,
                    platform: 'Taboola',
                    platform_icon: 'üî∂'
                });
            });
            
            if (allCampaigns.length === 0) {
                table.innerHTML = '<p class="text-gray-500">No campaigns found or still loading...</p>';
                return;
            }
            
            let html = `
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="text-left py-3 px-4 font-medium text-gray-700">Campaign</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">Platform</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">Spend</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">Revenue</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">ROAS</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">Conversions</th>
                            <th class="text-center py-3 px-4 font-medium text-gray-700">Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            allCampaigns.forEach(campaign => {
                const spend = parseFloat(campaign.spend) || 0;
                const revenue = parseFloat(campaign.revenue) || 0;
                const roas = revenue > 0 && spend > 0 ? revenue / spend : 0;
                const statusColor = roas >= 2 ? 'bg-green-100 text-green-800' : 
                                   roas >= 1 ? 'bg-yellow-100 text-yellow-800' : 
                                   'bg-red-100 text-red-800';
                const statusText = roas >= 2 ? 'Winning' : roas >= 1 ? 'Neutral' : 'Losing';
                
                html += `
                    <tr class="border-b border-gray-100">
                        <td class="py-3 px-4 font-medium text-gray-900 max-w-xs truncate">${campaign.name || 'Unnamed Campaign'}</td>
                        <td class="py-3 px-4 text-right text-gray-900">${campaign.platform_icon} ${campaign.platform}</td>
                        <td class="py-3 px-4 text-right text-gray-900">¬£${spend.toLocaleString()}</td>
                        <td class="py-3 px-4 text-right text-gray-900">¬£${revenue.toLocaleString()}</td>
                        <td class="py-3 px-4 text-right font-medium text-gray-900">${roas.toFixed(2)}x</td>
                        <td class="py-3 px-4 text-right text-gray-900">${campaign.conversions || 0}</td>
