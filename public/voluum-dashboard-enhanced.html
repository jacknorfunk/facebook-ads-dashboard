<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Voluum Performance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        .roas-high { background-color: #dcfce7; color: #166534; }
        .roas-medium { background-color: #fef3c7; color: #92400e; }
        .roas-low { background-color: #fecaca; color: #991b1b; }
        .cpa-high { background-color: #fecaca; color: #991b1b; }
        .cvr-low { background-color: #fecaca; color: #991b1b; }
        
        /* Softer alert styling - less aggressive red */
        .alert-flag { 
            background-color: #fef7f7; 
            border-left: 3px solid #f87171; 
        }
        .alert-flag-multiple { 
            background-color: #fee2e2; 
            border-left: 4px solid #dc2626; 
        }
        
        .sparkline { width: 60px; height: 20px; }
        .pinned-campaign { background-color: #fffbeb; border-left: 4px solid #f59e0b; }
        .campaign-row:hover { background-color: #f9fafb; cursor: pointer; }
        .expanded-row { background-color: #f3f4f6; }
        .dark-mode { background-color: #111827; color: #f9fafb; }
        .dark-mode .bg-white { background-color: #1f2937; }
        .dark-mode .bg-gray-50 { background-color: #374151; }
        .dark-mode .text-gray-900 { color: #f9fafb; }
        .dark-mode .text-gray-500 { color: #9ca3af; }
        .dark-mode .border-gray-200 { border-color: #374151; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 20px; border-radius: 8px; width: 95%; max-width: 1400px; max-height: 85vh; overflow-y: auto; }
        .toast { position: fixed; top: 20px; right: 20px; z-index: 1001; padding: 12px 20px; border-radius: 6px; color: white; opacity: 0; transition: opacity 0.3s; }
        .toast.show { opacity: 1; }
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        
        /* Fullscreen responsive fixes */
        .main-container { 
            padding: 1rem;
            max-width: 100%;
            overflow-x: auto;
        }
        
        /* Trending indicators */
        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }
        .trend-neutral { color: #6b7280; }
        
        /* Offer rows styling */
        .offer-row {
            background-color: #f9fafb;
            border-left: 4px solid #e5e7eb;
        }
        .offer-row:hover {
            background-color: #f3f4f6;
        }
        
        /* Better table overflow handling */
        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            min-width: 1200px;
        }
        
        /* Loading states */
        .skeleton {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="main-container mx-auto">
        <!-- Header Section -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Voluum Performance Tracker</h1>
                    <p class="text-gray-600 mt-1">Real-time campaign and offer analytics</p>
                </div>
                <div class="flex space-x-4">
                    <button onclick="toggleDarkMode()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg">
                        <i class="fas fa-moon"></i> Dark Mode
                    </button>
                    <button onclick="exportData()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                </div>
            </div>

            <!-- Date Range Filters -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
                    <select id="dateRange" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="last_7_days" selected>Last 7 Days</option>
                        <option value="last_14_days">Last 14 Days</option>
                        <option value="last_30_days">Last 30 Days</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                
                <!-- Custom Date Inputs (hidden by default) -->
                <div id="customDateFrom" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
                    <input type="date" id="fromDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                
                <div id="customDateTo" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
                    <input type="date" id="toDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
            </div>

            <!-- Advanced Filters -->
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                    <input type="text" id="searchCampaign" placeholder="Campaign name..." 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Traffic Source</label>
                    <select id="trafficSourceFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="all">All Sources</option>
                        <option value="newsbreak">NewsBreak</option>
                        <option value="taboola">Taboola</option>
                        <option value="facebook">Facebook</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">OS Filter</label>
                    <select id="osFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="all">All OS</option>
                        <option value="android">Android</option>
                        <option value="ios">iOS</option>
                        <option value="windows">Windows</option>
                        <option value="macos">macOS</option>
                        <option value="unknown">Unknown</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Performance</label>
                    <select id="performanceFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="all">All Campaigns</option>
                        <option value="profitable">Profitable (ROAS > 1)</option>
                        <option value="breakeven">Break Even (0.8-1.2)</option>
                        <option value="unprofitable">Unprofitable (ROAS < 0.8)</option>
                        <option value="high_spend">High Spend (>$500)</option>
                        <option value="alerts">Has Alerts</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Min Spend</label>
                    <input type="number" id="minSpendFilter" placeholder="Min $" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                    <select id="sortFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="spend">Highest Spend</option>
                        <option value="revenue">Highest Revenue</option>
                        <option value="profit">Highest Profit</option>
                        <option value="roas">Highest ROAS</option>
                        <option value="conversions">Most Conversions</option>
                        <option value="cvr">Highest CVR</option>
                        <option value="aov">Highest AOV</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Stats Summary -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-sm p-4">
                <div class="text-sm text-gray-600">Total Campaigns</div>
                <div class="text-2xl font-bold text-gray-900" id="totalCampaigns">0</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-4">
                <div class="text-sm text-gray-600">Total Spend</div>
                <div class="text-2xl font-bold text-gray-900" id="totalSpend">$0</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-4">
                <div class="text-sm text-gray-600">Total Revenue</div>
                <div class="text-2xl font-bold text-gray-900" id="totalRevenue">$0</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-4">
                <div class="text-sm text-gray-600">Overall ROAS</div>
                <div class="text-2xl font-bold text-gray-900" id="overallRoas">0.00</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-4">
                <div class="text-sm text-gray-600">Profit/Loss</div>
                <div class="text-2xl font-bold" id="totalProfit">$0</div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
            <div id="statusBar" class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-green-400 rounded-full mr-2"></div>
                    <span class="text-sm text-gray-700">Ready to load campaigns</span>
                </div>
                <button onclick="loadData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
            </div>
        </div>

        <!-- Main Table -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Campaign</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenue</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Spend</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Profit</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ROAS</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ROAS (7D)</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ROAS (14D)</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ROAS (30D)</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CPA</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CVR</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visits</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conv</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AOV</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">EPC</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alerts</th>
                        </tr>
                    </thead>
                    <tbody id="campaignTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="17" class="px-6 py-12 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                                <div>Loading campaign data from Voluum API...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="toast"></div>

    <script>
        // Global variables
        let allCampaigns = [];
        let filteredCampaigns = [];
        let pinnedCampaigns = new Set();
        let isDarkMode = false;
        let expandedCampaigns = new Set();
        let currentDateRange = { from: null, to: null };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadData();
            setupDarkMode();
            setupDatePickers();
        });

        function setupEventListeners() {
            // Date and filter changes
            document.getElementById('dateRange').addEventListener('change', handleDateRangeChange);
            document.getElementById('fromDate').addEventListener('change', handleCustomDateChange);
            document.getElementById('toDate').addEventListener('change', handleCustomDateChange);
            document.getElementById('searchCampaign').addEventListener('input', applyFilters);
            document.getElementById('trafficSourceFilter').addEventListener('change', applyFilters);
            document.getElementById('osFilter').addEventListener('change', applyFilters);
            document.getElementById('performanceFilter').addEventListener('change', applyFilters);
            document.getElementById('minSpendFilter').addEventListener('input', applyFilters);
            document.getElementById('sortFilter').addEventListener('change', applyFilters);
        }

        function setupDatePickers() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            document.getElementById('toDate').value = today.toISOString().split('T')[0];
            document.getElementById('fromDate').value = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        }

        function handleDateRangeChange() {
            const dateRange = document.getElementById('dateRange').value;
            const customFromEl = document.getElementById('customDateFrom');
            const customToEl = document.getElementById('customDateTo');
            
            if (dateRange === 'custom') {
                customFromEl.classList.remove('hidden');
                customToEl.classList.remove('hidden');
            } else {
                customFromEl.classList.add('hidden');
                customToEl.classList.add('hidden');
                loadData();
            }
        }

        function handleCustomDateChange() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            
            if (fromDate && toDate) {
                loadData();
            }
        }

        async function loadData() {
            updateStatus('loading', 'Loading campaign data...');
            
            try {
                let url = '/api/voluum/campaigns';
                const dateRange = document.getElementById('dateRange').value;
                const osFilter = document.getElementById('osFilter').value;
                
                // Build query parameters
                const params = new URLSearchParams();
                
                if (dateRange === 'custom') {
                    const fromDate = document.getElementById('fromDate').value;
                    const toDate = document.getElementById('toDate').value;
                    if (fromDate && toDate) {
                        // Store the current date range
                        currentDateRange.from = fromDate;
                        currentDateRange.to = toDate;
                        params.append('from', fromDate);
                        params.append('to', toDate);
                    }
                } else {
                    // Store the range type for offer loading
                    currentDateRange.from = null;
                    currentDateRange.to = null;
                    currentDateRange.range = dateRange;
                    params.append('range', dateRange);
                }
                
                if (osFilter && osFilter !== 'all') {
                    params.append('os', osFilter);
                }
                
                url += '?' + params.toString();
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.campaigns) {
                    allCampaigns = processCampaignData(data.campaigns);
                    
                    // Clear offer data when reloading campaigns
                    allCampaigns.forEach(campaign => {
                        campaign.offers = null;
                    });
                    expandedCampaigns.clear();
                    
                    applyFilters();
                    updateStats();
                    updateStatus('success', `Loaded ${allCampaigns.length} campaigns`);
                } else {
                    showErrorState(data.error || 'Failed to load campaigns');
                    updateStatus('error', data.error || 'Failed to load campaigns');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showErrorState(error.message);
                updateStatus('error', 'Failed to connect to API');
            }
        }

        function processCampaignData(campaigns) {
            return campaigns.map(campaign => {
                // Detect traffic source
                let trafficSource = 'other';
                if (campaign.name.toLowerCase().includes('newsbreak') || campaign.name.toLowerCase().includes('nb')) {
                    trafficSource = 'newsbreak';
                } else if (campaign.name.toLowerCase().includes('taboola') || campaign.name.toLowerCase().includes('tab')) {
                    trafficSource = 'taboola';
                } else if (campaign.name.toLowerCase().includes('facebook') || campaign.name.toLowerCase().includes('fb')) {
                    trafficSource = 'facebook';
                }
                
                // Calculate metrics
                const roas = campaign.cost > 0 ? campaign.revenue / campaign.cost : 0;
                const cpa = campaign.conversions > 0 ? campaign.cost / campaign.conversions : 0;
                const cvr = campaign.visits > 0 ? (campaign.conversions / campaign.visits) * 100 : 0;
                const aov = campaign.conversions > 0 ? campaign.revenue / campaign.conversions : 0;
                const epc = campaign.visits > 0 ? campaign.revenue / campaign.visits : 0;
                const profit = campaign.revenue - campaign.cost;
                
                // Generate alerts
                const alerts = [];
                if (roas < 0.5 && campaign.cost > 100) alerts.push('Low ROAS');
                if (cpa > 50) alerts.push('High CPA');
                if (cvr < 0.5 && campaign.visits > 100) alerts.push('Low CVR');
                if (campaign.cost > 1000 && roas < 1) alerts.push('High spend, unprofitable');
                
                return {
                    ...campaign,
                    trafficSource,
                    roas,
                    currentRoas: roas,
                    cpa,
                    cvr,
                    aov,
                    epc,
                    profit,
                    alerts,
                    isPinned: pinnedCampaigns.has(campaign.id),
                    offers: null // Will be loaded on demand
                };
            });
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchCampaign').value.toLowerCase();
            const trafficSource = document.getElementById('trafficSourceFilter').value;
            const osFilter = document.getElementById('osFilter').value;
            const performanceFilter = document.getElementById('performanceFilter').value;
            const minSpend = parseFloat(document.getElementById('minSpendFilter').value) || 0;
            
            filteredCampaigns = allCampaigns.filter(campaign => {
                // Search filter
                if (searchTerm && !campaign.name.toLowerCase().includes(searchTerm)) return false;
                
                // Traffic source filter
                if (trafficSource !== 'all' && campaign.trafficSource !== trafficSource) return false;
                
                // OS filter (handled by API, but also filter locally if needed)
                if (osFilter !== 'all') {
                    const campaignOS = detectOS(campaign.name);
                    if (campaignOS !== osFilter && osFilter !== 'unknown') return false;
                }
                
                // Performance filter
                if (performanceFilter === 'profitable' && campaign.roas <= 1) return false;
                if (performanceFilter === 'breakeven' && (campaign.roas < 0.8 || campaign.roas > 1.2)) return false;
                if (performanceFilter === 'unprofitable' && campaign.roas >= 0.8) return false;
                if (performanceFilter === 'high_spend' && campaign.cost < 500) return false;
                if (performanceFilter === 'alerts' && campaign.alerts.length === 0) return false;
                
                // Min spend filter
                if (campaign.cost < minSpend) return false;
                
                return true;
            });
            
            sortCampaigns();
            updateFilterCounts();
        }

        function detectOS(campaignName) {
            const name = campaignName.toLowerCase();
            if (name.includes('android') || name.includes('and')) return 'android';
            if (name.includes('ios') || name.includes('iphone') || name.includes('ipad')) return 'ios';
            if (name.includes('windows') || name.includes('win')) return 'windows';
            if (name.includes('macos') || name.includes('mac')) return 'macos';
            return 'unknown';
        }

        function sortCampaigns() {
            const sortBy = document.getElementById('sortFilter').value;
            
            // First sort by pinned status
            filteredCampaigns.sort((a, b) => {
                if (a.isPinned && !b.isPinned) return -1;
                if (!a.isPinned && b.isPinned) return 1;
                
                // Then sort by selected criteria
                switch (sortBy) {
                    case 'spend': return (b.cost || 0) - (a.cost || 0);
                    case 'revenue': return (b.revenue || 0) - (a.revenue || 0);
                    case 'profit': return (b.profit || 0) - (a.profit || 0);
                    case 'roas': return (b.roas || 0) - (a.roas || 0);
                    case 'epc': return (b.epc || 0) - (a.epc || 0);
                    case 'cvr': return (b.cvr || 0) - (a.cvr || 0);
                    case 'aov': return (b.aov || 0) - (a.aov || 0);
                    case 'conversions': return (b.conversions || 0) - (a.conversions || 0);
                    default: return 0;
                }
            });
            
            renderCampaigns();
        }

        async function toggleCampaignExpansion(campaignId) {
            const campaign = allCampaigns.find(c => c.id === campaignId);
            if (!campaign) return;

            if (expandedCampaigns.has(campaignId)) {
                // Collapse
                expandedCampaigns.delete(campaignId);
                renderCampaigns();
            } else {
                // Expand and load offers
                expandedCampaigns.add(campaignId);
                
                // Load offers if not already loaded
                if (!campaign.offers) {
                    try {
                        showToast('Loading offer data...', 'success');
                        
                        // Build URL with proper date parameters
                        const params = new URLSearchParams();
                        params.append('campaignId', campaignId);
                        
                        // Use the same date range as the main dashboard
                        if (currentDateRange.from && currentDateRange.to) {
                            params.append('from', currentDateRange.from);
                            params.append('to', currentDateRange.to);
                        } else if (currentDateRange.range) {
                            params.append('range', currentDateRange.range);
                        } else {
                            params.append('range', document.getElementById('dateRange').value);
                        }
                        
                        const response = await fetch(`/api/voluum/offers?${params.toString()}`);
                        const data = await response.json();
                        
                        if (data.success && data.offers) {
                            campaign.offers = data.offers;
                            showToast(`Loaded ${data.offers.length} offers for ${campaign.name}`, 'success');
                        } else {
                            campaign.offers = [];
                            showToast('No offer data available for this campaign', 'error');
                        }
                    } catch (error) {
                        console.error('Error loading offers:', error);
                        campaign.offers = [];
                        showToast('Failed to load offer data: ' + error.message, 'error');
                    }
                }
                
                renderCampaigns();
            }
        }

        function togglePin(campaignId) {
            if (pinnedCampaigns.has(campaignId)) {
                pinnedCampaigns.delete(campaignId);
            } else {
                pinnedCampaigns.add(campaignId);
            }
            
            // Update campaign data
            allCampaigns.forEach(campaign => {
                if (campaign.id === campaignId) {
                    campaign.isPinned = pinnedCampaigns.has(campaignId);
                }
            });
            
            applyFilters();
            showToast(pinnedCampaigns.has(campaignId) ? 'Campaign pinned' : 'Campaign unpinned', 'success');
        }

        function updateStats() {
            const totalCampaigns = filteredCampaigns.length;
            const totalSpend = filteredCampaigns.reduce((sum, c) => sum + (c.cost || 0), 0);
            const totalRevenue = filteredCampaigns.reduce((sum, c) => sum + (c.revenue || 0), 0);
            const totalProfit = totalRevenue - totalSpend;
            const overallRoas = totalSpend > 0 ? totalRevenue / totalSpend : 0;
            
            document.getElementById('totalCampaigns').textContent = totalCampaigns;
            document.getElementById('totalSpend').textContent = `$${totalSpend.toFixed(2)}`;
            document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('totalProfit').textContent = `$${totalProfit.toFixed(2)}`;
            document.getElementById('totalProfit').className = `text-2xl font-bold ${totalProfit >= 0 ? 'text-green-600' : 'text-red-600'}`;
            document.getElementById('overallRoas').textContent = overallRoas.toFixed(2);
        }

        function updateFilterCounts() {
            // Update filter counts in dropdown options if needed
        }

        function renderCampaigns() {
            const tbody = document.getElementById('campaignTableBody');
            
            if (filteredCampaigns.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="17" class="px-6 py-12 text-center text-gray-500">
                            <i class="fas fa-info-circle text-4xl mb-4"></i>
                            <div class="text-lg font-medium text-gray-700 mb-2">No campaigns match your filters</div>
                            <div class="text-sm">Try adjusting your search criteria or date range.</div>
                            <button onclick="clearFilters()" class="mt-4 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                                Clear Filters
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            filteredCampaigns.forEach(campaign => {
                html += renderCampaignRow(campaign);
                if (expandedCampaigns.has(campaign.id) && campaign.offers && campaign.offers.length > 0) {
                    html += renderOfferRows(campaign);
                }
            });
            tbody.innerHTML = html;
        }

        function renderCampaignRow(campaign) {
            const roasClass = campaign.currentRoas >= 2.0 ? 'roas-high' : 
                             campaign.currentRoas >= 1.0 ? 'roas-medium' : 'roas-low';
            const cpaClass = campaign.cpa > 25 ? 'cpa-high' : '';
            const cvrClass = campaign.cvr < 1.0 ? 'cvr-low' : '';
            
            // Softer alert styling
            const alertClass = campaign.alerts.length > 2 ? 'alert-flag-multiple' : 
                              campaign.alerts.length > 0 ? 'alert-flag' : '';
            const pinnedClass = campaign.isPinned ? 'pinned-campaign' : '';
            const expandedClass = expandedCampaigns.has(campaign.id) ? 'expanded-row' : '';
            
            const expandIcon = expandedCampaigns.has(campaign.id) ? 'fa-chevron-down' : 'fa-chevron-right';
            
            // Helper function to render trend indicators
            function renderTrend(change, value) {
                const trendClass = change > 5 ? 'trend-up' : change < -5 ? 'trend-down' : 'trend-neutral';
                const icon = change > 5 ? 'fa-arrow-up' : change < -5 ? 'fa-arrow-down' : 'fa-minus';
                return `
                    <span class="${trendClass}">
                        ${value.toFixed(2)} <i class="fas ${icon} text-xs"></i>
                    </span>
                `;
            }
            
            // Calculate ROAS trends (mock data for now - should come from API)
            const roas7d = campaign.roas * (0.9 + Math.random() * 0.2);
            const roas14d = campaign.roas * (0.85 + Math.random() * 0.3);
            const roas30d = campaign.roas * (0.8 + Math.random() * 0.4);
            
            const change7d = ((campaign.roas - roas7d) / roas7d) * 100;
            const change14d = ((campaign.roas - roas14d) / roas14d) * 100;
            const change30d = ((campaign.roas - roas30d) / roas30d) * 100;
            
            return `
                <tr class="campaign-row ${alertClass} ${pinnedClass} ${expandedClass}">
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="flex space-x-2">
                            <button onclick="toggleCampaignExpansion('${campaign.id}')" 
                                class="text-gray-600 hover:text-purple-600" title="Expand/Collapse">
                                <i class="fas ${expandIcon}"></i>
                            </button>
                            <button onclick="togglePin('${campaign.id}')" 
                                class="text-gray-600 hover:text-yellow-500" title="Pin/Unpin">
                                <i class="fas ${campaign.isPinned ? 'fa-star' : 'fa-star'} ${campaign.isPinned ? 'text-yellow-500' : ''}"></i>
                            </button>
                        </div>
                    </td>
                    <td class="px-4 py-4">
                        <div class="text-sm font-medium text-gray-900">${campaign.name}</div>
                        <div class="text-xs text-gray-500">ID: ${campaign.id}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">
                            ${campaign.trafficSource}
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap font-medium">$${(campaign.revenue || 0).toFixed(2)}</td>
                    <td class="px-4 py-4 whitespace-nowrap font-medium">$${(campaign.cost || 0).toFixed(2)}</td>
                    <td class="px-4 py-4 whitespace-nowrap font-medium ${campaign.profit >= 0 ? 'text-green-600' : 'text-red-600'}">
                        $${campaign.profit.toFixed(2)}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded ${roasClass}">
                            ${campaign.roas.toFixed(2)}x
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">${renderTrend(change7d, roas7d)}</td>
                    <td class="px-4 py-4 whitespace-nowrap">${renderTrend(change14d, roas14d)}</td>
                    <td class="px-4 py-4 whitespace-nowrap">${renderTrend(change30d, roas30d)}</td>
                    <td class="px-4 py-4 whitespace-nowrap ${cpaClass}">$${campaign.cpa.toFixed(2)}</td>
                    <td class="px-4 py-4 whitespace-nowrap ${cvrClass}">${campaign.cvr.toFixed(2)}%</td>
                    <td class="px-4 py-4 whitespace-nowrap">${(campaign.visits || 0).toLocaleString()}</td>
                    <td class="px-4 py-4 whitespace-nowrap">${(campaign.conversions || 0).toLocaleString()}</td>
                    <td class="px-4 py-4 whitespace-nowrap">$${campaign.aov.toFixed(2)}</td>
                    <td class="px-4 py-4 whitespace-nowrap">$${campaign.epc.toFixed(2)}</td>
                    <td class="px-4 py-4">
                        ${campaign.alerts.length > 0 ? `
                            <div class="flex flex-wrap gap-1">
                                ${campaign.alerts.map(alert => `
                                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">
                                        ${alert}
                                    </span>
                                `).join('')}
                            </div>
                        ` : '<span class="text-gray-400">-</span>'}
                    </td>
                </tr>
            `;
        }

        function renderOfferRows(campaign) {
            if (!campaign.offers || campaign.offers.length === 0) {
                return `
                    <tr class="offer-row">
                        <td colspan="17" class="px-8 py-4 text-center text-gray-500">
                            <i class="fas fa-info-circle"></i> No offers with visits in the selected date range
                        </td>
                    </tr>
                `;
            }
            
            let html = '';
            campaign.offers.forEach(offer => {
                html += `
                    <tr class="offer-row">
                        <td class="px-4 py-3"></td>
                        <td class="px-4 py-3 pl-12">
                            <div class="text-sm font-medium text-gray-700">
                                <i class="fas fa-tag text-gray-400 mr-2"></i>${offer.name}
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="text-xs text-gray-500">Offer</span>
                        </td>
                        <td class="px-4 py-3 font-medium">$${(offer.revenue || 0).toFixed(2)}</td>
                        <td class="px-4 py-3 font-medium">$${(offer.spend || 0).toFixed(2)}</td>
                        <td class="px-4 py-3 font-medium ${offer.profit >= 0 ? 'text-green-600' : 'text-red-600'}">
                            $${(offer.profit || 0).toFixed(2)}
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs font-medium rounded ${offer.roas >= 2 ? 'roas-high' : offer.roas >= 1 ? 'roas-medium' : 'roas-low'}">
                                ${(offer.roas || 0).toFixed(2)}x
                            </span>
                        </td>
                        <td class="px-4 py-3 text-gray-400">-</td>
                        <td class="px-4 py-3 text-gray-400">-</td>
                        <td class="px-4 py-3 text-gray-400">-</td>
                        <td class="px-4 py-3">$${(offer.cpa || 0).toFixed(2)}</td>
                        <td class="px-4 py-3">${(offer.cvr || 0).toFixed(2)}%</td>
                        <td class="px-4 py-3">${(offer.visits || 0).toLocaleString()}</td>
                        <td class="px-4 py-3">${(offer.conversions || 0).toLocaleString()}</td>
                        <td class="px-4 py-3">$${(offer.aov || 0).toFixed(2)}</td>
                        <td class="px-4 py-3">$${(offer.epc || 0).toFixed(2)}</td>
                        <td class="px-4 py-3">
                            <span class="text-gray-400">-</span>
                        </td>
                    </tr>
                `;
            });
            
            return html;
        }

        function clearFilters() {
            document.getElementById('searchCampaign').value = '';
            document.getElementById('trafficSourceFilter').value = 'all';
            document.getElementById('osFilter').value = 'all';
            document.getElementById('performanceFilter').value = 'all';
            document.getElementById('minSpendFilter').value = '';
            document.getElementById('sortFilter').value = 'spend';
            applyFilters();
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode');
        }

        function exportData() {
            if (filteredCampaigns.length === 0) {
                showToast('No data to export', 'error');
                return;
            }
            
            let csv = 'Campaign,Source,Revenue,Spend,Profit,ROAS,CPA,CVR,Visits,Conversions,AOV,EPC,Alerts\n';
            
            filteredCampaigns.forEach(campaign => {
                csv += `"${campaign.name}",${campaign.trafficSource},${campaign.revenue},${campaign.cost},${campaign.profit},${campaign.roas},${campaign.cpa},${campaign.cvr},${campaign.visits},${campaign.conversions},${campaign.aov},${campaign.epc},"${campaign.alerts.join(', ')}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `voluum-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            showToast('Data exported successfully', 'success');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function updateStatus(status, message) {
            const statusBar = document.getElementById('statusBar');
            const statusEl = statusBar.querySelector('div');
            
            const iconClasses = {
                loading: 'w-3 h-3 bg-yellow-400 rounded-full mr-2 animate-pulse',
                success: 'w-3 h-3 bg-green-400 rounded-full mr-2',
                error: 'w-3 h-3 bg-red-400 rounded-full mr-2'
            };
            
            statusEl.innerHTML = `
                <div class="${iconClasses[status]}"></div>
                <span class="text-sm text-gray-700">${message}</span>
            `;
        }

        function showErrorState(error) {
            const tbody = document.getElementById('campaignTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="17" class="px-6 py-12 text-center text-gray-500">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                        <div class="text-lg font-medium text-gray-700 mb-2">Failed to Load Data</div>
                        <div class="text-sm text-red-600 mb-2">${error}</div>
                        <div class="text-sm text-gray-600 mb-4">
                            Please check your API credentials and try again.
                        </div>
                        <button onclick="loadData()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                            <i class="fas fa-sync-alt"></i> Retry
                        </button>
                    </td>
                </tr>
            `;
        }
    </script>
</body>
</html>
