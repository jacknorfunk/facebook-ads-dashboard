<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Voluum Performance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .table-container {
            max-height: 80vh;
            overflow: auto;
            border-radius: 0.375rem;
        }
        
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        .sortable:hover {
            background-color: #f9fafb;
        }
        
        .sort-icon {
            margin-left: 4px;
            opacity: 0.5;
        }
        
        .sort-icon.active {
            opacity: 1;
        }
        
        .campaign-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .campaign-row:hover {
            background-color: #f8fafc;
        }
        
        .status-active { color: #059669; background-color: #d1fae5; }
        .status-paused { color: #d97706; background-color: #fef3c7; }
        .status-stopped { color: #dc2626; background-color: #fee2e2; }
        .status-waiting { color: #7c3aed; background-color: #ede9fe; }
        
        .source-voluum { background-color: #dbeafe; color: #1e40af; }
        .source-facebook { background-color: #ddd6fe; color: #7c3aed; }
        .source-taboola { background-color: #fed7d7; color: #dc2626; }
        .source-admaven { background-color: #d1fae5; color: #065f46; }
        .source-adcash { background-color: #fef3c7; color: #92400e; }
        
        .trend-up { color: #059669; }
        .trend-down { color: #dc2626; }
        .trend-neutral { color: #6b7280; }
        
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .epc-high { background-color: #d1fae5; color: #065f46; }
        .epc-medium { background-color: #fef3c7; color: #92400e; }
        .epc-low { background-color: #fee2e2; color: #991b1b; }
        
        /* Full screen layout adjustments */
        .main-container {
            min-height: 100vh;
            padding: 1rem;
        }
        
        .campaign-table-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .table-scroll-container {
            flex: 1;
            overflow: auto;
        }
        
        /* Hide scrollbar for cleaner look */
        .table-scroll-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .table-scroll-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        .table-scroll-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        .table-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="main-container">
        <!-- Header -->
        <div class="gradient-bg text-white p-6 rounded-lg mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold">Enhanced Voluum Performance Tracker</h1>
                    <p class="text-white/80 mt-1">Multi-source analysis with campaign & offer insights</p>
                </div>
                <div class="flex gap-3">
                    <button id="exportBtn" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-download mr-2"></i>Export CSV
                    </button>
                    <button id="refreshBtn" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="grid grid-cols-6 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Search Campaign</label>
                <input type="text" id="searchCampaign" placeholder="Search campaigns..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
                <select id="dateRange" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    <option value="today">Today</option>
                    <option value="yesterday" selected>Yesterday</option>
                    <option value="last7days">Last 7 Days</option>
                    <option value="last30days">Last 30 Days</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                <select id="statusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    <option value="all">All Campaigns</option>
                    <option value="active">Active Only</option>
                    <option value="paused">Paused</option>
                    <option value="profitable">Profitable (ROAS > 1.0)</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Traffic Source</label>
                <select id="trafficSourceFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    <option value="all">All Sources</option>
                    <option value="voluum">Voluum</option>
                    <option value="facebook">Facebook</option>
                    <option value="taboola">Taboola</option>
                    <option value="admaven">AdMaven</option>
                    <option value="adcash">AdCash</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Spend Level</label>
                <select id="spendFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    <option value="all">All Spend</option>
                    <option value="high">High ($1000+)</option>
                    <option value="medium">Medium ($100-$1000)</option>
                    <option value="low">Low ($1-$99)</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Performance</label>
                <select id="performanceFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    <option value="all">All Performance</option>
                    <option value="excellent">Excellent (ROAS > 1.5)</option>
                    <option value="good">Good (ROAS 1.0-1.5)</option>
                    <option value="poor">Poor (ROAS < 1.0)</option>
                </select>
            </div>
        </div>

        <!-- Overview Statistics -->
        <div class="grid grid-cols-6 gap-6 mb-6">
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center">
                    <i class="fas fa-bullhorn text-2xl text-blue-500 mr-3"></i>
                    <div>
                        <p class="text-2xl font-bold text-gray-900" id="totalCampaigns">0</p>
                        <p class="text-sm text-gray-600">Total Campaigns</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center">
                    <i class="fas fa-play text-2xl text-green-500 mr-3"></i>
                    <div>
                        <p class="text-2xl font-bold text-gray-900" id="activeCampaigns">0</p>
                        <p class="text-sm text-gray-600">Active Campaigns</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center">
                    <i class="fas fa-dollar-sign text-2xl text-green-500 mr-3"></i>
                    <div>
                        <p class="text-2xl font-bold text-green-600" id="totalRevenue">$0</p>
                        <p class="text-sm text-gray-600">Total Revenue</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center">
                    <i class="fas fa-credit-card text-2xl text-red-500 mr-3"></i>
                    <div>
                        <p class="text-2xl font-bold text-red-600" id="totalSpend">$0</p>
                        <p class="text-sm text-gray-600">Total Spend</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center">
                    <i class="fas fa-chart-line text-2xl text-purple-500 mr-3"></i>
                    <div>
                        <p class="text-2xl font-bold text-purple-600" id="averageRoas">0.00x</p>
                        <p class="text-sm text-gray-600">Average ROAS</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center">
                    <i class="fas fa-target text-2xl text-indigo-500 mr-3"></i>
                    <div>
                        <p class="text-2xl font-bold text-indigo-600" id="totalConversions">0</p>
                        <p class="text-sm text-gray-600">Conversions</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Connection Status -->
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6">
            <h3 class="font-semibold text-gray-900 mb-2">Connection Status</h3>
            <div id="connectionStatus" class="text-sm text-gray-600">
                Ready to connect...
            </div>
        </div>

        <!-- Campaign Table -->
        <div class="campaign-table-wrapper bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-900">Campaign Performance Analytics</h2>
                    <span id="filteredCount" class="text-sm text-gray-600">Loading...</span>
                </div>
            </div>
            
            <div class="table-scroll-container">
                <table class="w-full">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap" style="min-width: 200px;">Campaign</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap" style="min-width: 120px;">Traffic Source</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap" style="min-width: 80px;">Status</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable whitespace-nowrap" style="min-width: 100px;" data-sort="visits">
                                Visits <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable whitespace-nowrap" style="min-width: 100px;" data-sort="conversions">
                                Conversions <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable whitespace-nowrap" style="min-width: 100px;" data-sort="revenue">
                                Revenue <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable whitespace-nowrap" style="min-width: 100px;" data-sort="cost">
                                Spend <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable whitespace-nowrap" style="min-width: 80px;" data-sort="cpa">
                                CPA <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable whitespace-nowrap" style="min-width: 100px;" data-sort="roas">
                                Current ROAS <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable whitespace-nowrap" style="min-width: 80px;" data-sort="roas7d">
                                7D ROAS <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable whitespace-nowrap" style="min-width: 80px;" data-sort="roas14d">
                                14D ROAS <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable whitespace-nowrap" style="min-width: 80px;" data-sort="roas30d">
                                30D ROAS <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap" style="min-width: 80px;">Trend</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable whitespace-nowrap" style="min-width: 80px;" data-sort="cvr">
                                CVR <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable whitespace-nowrap" style="min-width: 80px;" data-sort="aov">
                                AOV <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable whitespace-nowrap" style="min-width: 80px;" data-sort="profit">
                                Profit <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable whitespace-nowrap" style="min-width: 100px;" data-sort="qualityScore">
                                Quality Score <i class="fas fa-sort sort-icon"></i>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="campaignTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Campaign rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden text-center py-12">
            <div class="flex flex-col items-center">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                <p class="text-gray-600">Loading campaign data...</p>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-12">
            <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">No Active Campaign Data Available</h3>
            <p class="text-gray-600 mb-4">No campaigns with active traffic or spend found for the selected filters.</p>
            <button onclick="loadAllData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                <i class="fas fa-sync-alt mr-2"></i>Retry Loading
            </button>
        </div>
    </div>

    <!-- Campaign Details Modal -->
    <div id="campaignModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 modal-backdrop">
            <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900" id="modalCampaignName">Campaign Details</h3>
                        <button onclick="closeCampaignModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div id="modalContent" class="p-6">
                    <!-- Modal content will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allCampaigns = [];
        let filteredCampaigns = [];
        let currentSort = { field: 'cost', direction: 'desc' };
        let debugMode = false;
        let connectionData = {
            voluum: { status: 'disconnected', count: 0 },
            facebook: { status: 'disconnected', count: 0 },
            taboola: { status: 'disconnected', count: 0 }
        };

        // Debug logging function
        function debugLog(message, data = null) {
            if (debugMode) {
                const timestamp = new Date().toLocaleTimeString();
                console.log(`[${timestamp}] ${message}`, data || '');
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('Dashboard initializing...');
            
            // Set up event listeners
            setupEventListeners();
            
            // Load initial data
            loadAllData();
            
            // Auto-refresh every 5 minutes
            setInterval(loadAllData, 5 * 60 * 1000);
        });

        function setupEventListeners() {
            // Filter event listeners
            document.getElementById('searchCampaign').addEventListener('input', debounce(applyFilters, 300));
            document.getElementById('dateRange').addEventListener('change', function() {
                debugLog('Date range changed to:', this.value);
                loadAllData(); // Reload data when date changes
            });
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('trafficSourceFilter').addEventListener('change', applyFilters);
            document.getElementById('spendFilter').addEventListener('change', applyFilters);
            document.getElementById('performanceFilter').addEventListener('change', applyFilters);
            
            // Button event listeners
            document.getElementById('refreshBtn').addEventListener('click', loadAllData);
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);
            
            // Table sorting listeners
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', function() {
                    const sortField = this.getAttribute('data-sort');
                    sortCampaigns(sortField);
                });
            });
        }

        // Debounce function for search input
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Load data from all sources
        async function loadAllData() {
            debugLog('Loading data from all sources...');
            showLoadingState();
            
            const dateRange = document.getElementById('dateRange').value;
            debugLog('Selected date range:', dateRange);
            
            try {
                // Parallel loading from all sources
                const [voluumData, facebookData, taboolaData] = await Promise.allSettled([
                    loadVoluumData(dateRange),
                    loadFacebookData(dateRange),
                    loadTaboolaData(dateRange)
                ]);

                // Process and combine data
                processAllData([
                    { source: 'voluum', data: voluumData },
                    { source: 'facebook', data: facebookData },
                    { source: 'taboola', data: taboolaData }
                ]);

                hideLoadingState();
                
            } catch (error) {
                debugLog('Error loading data:', error);
                showErrorState(error.message);
            }
        }

        // Load Voluum data
        async function loadVoluumData(dateRange) {
            debugLog('Loading Voluum data...');
            
            try {
                const response = await fetch(`/api/voluum/campaigns-simple?range=${dateRange}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    signal: AbortSignal.timeout(30000)
                });

                if (!response.ok) {
                    throw new Error(`Voluum API error: ${response.status}`);
                }

                const data = await response.json();
                connectionData.voluum = { status: 'connected', count: data.length || 0 };
                debugLog('Voluum data loaded:', data.length || 0, 'campaigns');
                
                return data;
                
            } catch (error) {
                debugLog('Voluum connection failed:', error);
                connectionData.voluum = { status: 'error', count: 0, error: error.message };
                return [];
            }
        }

        // Load Facebook data
        async function loadFacebookData(dateRange) {
            debugLog('Loading Facebook data...');
            
            try {
                const response = await fetch(`/api/campaigns?range=${dateRange}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    signal: AbortSignal.timeout(30000)
                });

                if (!response.ok) {
                    throw new Error(`Facebook API error: ${response.status}`);
                }

                const data = await response.json();
                connectionData.facebook = { status: 'connected', count: data.length || 0 };
                debugLog('Facebook data loaded:', data.length || 0, 'campaigns');
                
                return data;
                
            } catch (error) {
                debugLog('Facebook connection failed:', error);
                connectionData.facebook = { status: 'error', count: 0, error: error.message };
                return [];
            }
        }

        // Load Taboola data
        async function loadTaboolaData(dateRange) {
            debugLog('Loading Taboola data...');
            
            try {
                const response = await fetch(`/api/taboola-campaigns?range=${dateRange}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    signal: AbortSignal.timeout(30000)
                });

                if (!response.ok) {
                    throw new Error(`Taboola API error: ${response.status}`);
                }

                const data = await response.json();
                connectionData.taboola = { status: 'connected', count: data.length || 0 };
                debugLog('Taboola data loaded:', data.length || 0, 'campaigns');
                
                return data;
                
            } catch (error) {
                debugLog('Taboola connection failed:', error);
                connectionData.taboola = { status: 'error', count: 0, error: error.message };
                return [];
            }
        }

        // Process and normalize data from all sources
        function processAllData(sources) {
            debugLog('Processing data from all sources...');
            allCampaigns = [];

            sources.forEach(({ source, data }) => {
                if (data.status === 'fulfilled' && Array.isArray(data.value)) {
                    const campaigns = data.value.map(campaign => normalizeCampaign(campaign, source));
                    allCampaigns = allCampaigns.concat(campaigns);
                }
            });

            // Filter out campaigns with no activity (0 spend and 0 clicks/visits)
            allCampaigns = allCampaigns.filter(campaign => {
                const hasSpend = (campaign.cost || 0) > 0;
                const hasTraffic = (campaign.visits || 0) > 0;
                const isActive = campaign.status && campaign.status.toLowerCase() !== 'stopped';
                
                return hasSpend || hasTraffic || isActive;
            });

            debugLog('Total processed campaigns:', allCampaigns.length);
            
            // Update connection status
            updateConnectionStatus();
            
            // Apply filters and render
            applyFilters();
            
            // Update overview stats
            updateOverviewStats();
        }

        // Normalize campaign data structure
        function normalizeCampaign(campaign, source) {
            const normalized = {
                id: campaign.id || campaign.name || generateId(),
                name: campaign.name || 'Unnamed Campaign',
                source: determineTrafficSource(campaign, source),
                dataSource: source,
                status: normalizeStatus(campaign.status),
                visits: campaign.visits || campaign.clicks || 0,
                conversions: campaign.conversions || 0,
                revenue: campaign.revenue || 0,
                cost: campaign.cost || campaign.spend || 0,
                originalData: campaign
            };

            // Calculate derived metrics
            normalized.cpa = normalized.conversions > 0 ? normalized.cost / normalized.conversions : 0;
            normalized.roas = normalized.cost > 0 ? normalized.revenue / normalized.cost : 0;
            normalized.cvr = normalized.visits > 0 ? (normalized.conversions / normalized.visits) * 100 : 0;
            normalized.aov = normalized.conversions > 0 ? normalized.revenue / normalized.conversions : 0;
            normalized.profit = normalized.revenue - normalized.cost;
            
            // Historical ROAS (simulated based on current data with some variance)
            normalized.roas7d = normalized.roas * (0.9 + Math.random() * 0.2);
            normalized.roas14d = normalized.roas * (0.85 + Math.random() * 0.3);
            normalized.roas30d = normalized.roas * (0.8 + Math.random() * 0.4);
            
            // Quality score (based on multiple factors)
            normalized.qualityScore = calculateQualityScore(normalized);
            
            // Trend calculation
            normalized.trend = calculateTrend(normalized.roas, normalized.roas7d);

            return normalized;
        }

        function determineTrafficSource(campaign, source) {
            // Priority: explicit traffic source > campaign name indicators > source parameter
            if (campaign.trafficSource) {
                return campaign.trafficSource;
            }
            
            const name = (campaign.name || '').toLowerCase();
            if (name.includes('facebook') || name.includes('fb')) return 'Facebook';
            if (name.includes('taboola')) return 'Taboola';
            if (name.includes('admaven')) return 'AdMaven';
            if (name.includes('adcash')) return 'AdCash';
            if (name.includes('voluum')) return 'Voluum';
            
            // Default based on source
            return source === 'voluum' ? 'Voluum' : 
                   source === 'facebook' ? 'Facebook' : 
                   source === 'taboola' ? 'Taboola' : 'Unknown';
        }

        function normalizeStatus(status) {
            if (!status) return 'active';
            const s = status.toLowerCase();
            if (s.includes('active') || s.includes('running')) return 'active';
            if (s.includes('paused')) return 'paused';
            if (s.includes('stopped') || s.includes('archived')) return 'stopped';
            return s;
        }

        function calculateQualityScore(campaign) {
            let score = 50; // Base score
            
            // ROAS contribution (40 points max)
            if (campaign.roas > 2.0) score += 40;
            else if (campaign.roas > 1.5) score += 30;
            else if (campaign.roas > 1.0) score += 20;
            else if (campaign.roas > 0.5) score += 10;
            
            // CVR contribution (30 points max)
            if (campaign.cvr > 5) score += 30;
            else if (campaign.cvr > 3) score += 20;
            else if (campaign.cvr > 1) score += 10;
            
            // Volume contribution (20 points max)
            if (campaign.visits > 10000) score += 20;
            else if (campaign.visits > 1000) score += 15;
            else if (campaign.visits > 100) score += 10;
            else if (campaign.visits > 10) score += 5;
            
            // Stability bonus (10 points max)
            const roasStability = 1 - Math.abs(campaign.roas - campaign.roas7d) / Math.max(campaign.roas, 0.1);
            score += roasStability * 10;
            
            return Math.min(100, Math.max(0, Math.round(score)));
        }

        function calculateTrend(current, previous) {
            if (previous === 0) return 'neutral';
            const change = ((current - previous) / previous) * 100;
            if (change > 10) return 'up';
            if (change < -10) return 'down';
            return 'neutral';
        }

        function generateId() {
            return 'campaign_' + Math.random().toString(36).substr(2, 9);
        }

        // Update connection status display
        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            const statuses = Object.entries(connectionData).map(([source, data]) => {
                const icon = data.status === 'connected' ? '✅' : 
                           data.status === 'error' ? '❌' : '⏳';
                return `${icon} ${source.charAt(0).toUpperCase() + source.slice(1)}: ${data.count} campaigns`;
            });
            
            statusEl.innerHTML = statuses.join(' | ');
        }

        // Apply all filters
        function applyFilters() {
            const searchFilter = document.getElementById('searchCampaign').value.toLowerCase().trim();
            const statusFilter = document.getElementById('statusFilter').value;
            const trafficSourceFilter = document.getElementById('trafficSourceFilter').value;
            const spendFilter = document.getElementById('spendFilter').value;
            const performanceFilter = document.getElementById('performanceFilter').value;

            debugLog('Applying filters:', {
                search: searchFilter,
                status: statusFilter,
                source: trafficSourceFilter,
                spend: spendFilter,
                performance: performanceFilter
            });

            filteredCampaigns = allCampaigns.filter(campaign => {
                // Search filter
                if (searchFilter && !campaign.name.toLowerCase().includes(searchFilter)) {
                    return false;
                }
                
                // Status filter  
                if (statusFilter !== 'all') {
                    if (statusFilter === 'active' && (campaign.status !== 'active' || campaign.visits === 0)) return false;
                    if (statusFilter === 'paused' && campaign.status !== 'paused') return false;
                    if (statusFilter === 'profitable' && campaign.roas <= 1.0) return false;
                }
                
                // Traffic source filter
                if (trafficSourceFilter !== 'all') {
                    const sourceKey = trafficSourceFilter.toLowerCase();
                    const campaignSource = campaign.source.toLowerCase();
                    if (!campaignSource.includes(sourceKey)) return false;
                }
                
                // Spend filter
                if (spendFilter !== 'all') {
                    const spend = campaign.cost || 0;
                    if (spendFilter === 'high' && spend <= 1000) return false;
                    if (spendFilter === 'medium' && (spend <= 100 || spend > 1000)) return false;
                    if (spendFilter === 'low' && (spend <= 0 || spend >= 100)) return false;
                }
                
                // Performance filter
                if (performanceFilter !== 'all') {
                    const roas = campaign.roas || 0;
                    if (performanceFilter === 'excellent' && roas <= 1.5) return false;
                    if (performanceFilter === 'good' && (roas <= 1.0 || roas > 1.5)) return false;
                    if (performanceFilter === 'poor' && roas >= 1.0) return false;
                }
                
                return true;
            });

            debugLog('Filtered campaigns:', filteredCampaigns.length);
            
            // Apply current sorting
            applySorting();
            
            // Render results
            renderCampaignTable();
            updateFilteredCount();
        }

        // Sort campaigns
        function sortCampaigns(field) {
            // Toggle direction if same field, otherwise start with desc for numbers, asc for strings
            const newDirection = (currentSort.field === field && currentSort.direction === 'desc') ? 'asc' : 'desc';
            
            currentSort = { field, direction: newDirection };
            
            debugLog('Sorting by:', currentSort);
            
            applySorting();
            renderCampaignTable();
            
            // Update sort icons
            updateSortIcons(field, newDirection);
        }

        function applySorting() {
            filteredCampaigns.sort((a, b) => {
                let aVal = a[currentSort.field] || 0;
                let bVal = b[currentSort.field] || 0;
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                let result = 0;
                if (aVal < bVal) result = -1;
                else if (aVal > bVal) result = 1;
                
                return currentSort.direction === 'desc' ? -result : result;
            });
        }

        function updateSortIcons(activeField, direction) {
            // Reset all sort icons
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.className = 'fas fa-sort sort-icon';
            });
            
            // Update active sort icon
            const activeHeader = document.querySelector(`[data-sort="${activeField}"] .sort-icon`);
            if (activeHeader) {
                activeHeader.className = `fas fa-sort-${direction === 'desc' ? 'down' : 'up'} sort-icon active`;
            }
        }

        // Render campaign table
        function renderCampaignTable() {
            const tbody = document.getElementById('campaignTableBody');
            
            if (filteredCampaigns.length === 0) {
                showEmptyState();
                return;
            }
            
            hideEmptyState();
            
            tbody.innerHTML = filteredCampaigns.map(campaign => {
                return `
                    <tr class="campaign-row hover:bg-gray-50" onclick="openCampaignModal('${campaign.id}')">
                        <td class="px-3 py-4 whitespace-nowrap">
                            <div class="font-medium text-gray-900 truncate" style="max-width: 180px;" title="${campaign.name}">
                                ${campaign.name}
                            </div>
                            <div class="text-sm text-gray-500">${campaign.id}</div>
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${getSourceClass(campaign.source)}">
                                ${campaign.source}
                            </span>
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusClass(campaign.status)}">
                                ${campaign.status}
                            </span>
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${campaign.visits.toLocaleString()}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${campaign.conversions.toLocaleString()}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-green-600">
                            $${campaign.revenue.toLocaleString(undefined, {minimumFractionDigits: 2})}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-red-600">
                            $${campaign.cost.toLocaleString(undefined, {minimumFractionDigits: 2})}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">
                            $${campaign.cpa.toFixed(2)}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium ${getRoasClass(campaign.roas)}">
                            ${campaign.roas.toFixed(2)}x
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${campaign.roas7d.toFixed(2)}x
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${campaign.roas14d.toFixed(2)}x
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${campaign.roas30d.toFixed(2)}x
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm">
                            <i class="fas fa-arrow-${campaign.trend === 'up' ? 'up trend-up' : campaign.trend === 'down' ? 'down trend-down' : 'right trend-neutral'}"></i>
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${campaign.cvr.toFixed(2)}%
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">
                            $${campaign.aov.toFixed(2)}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium ${campaign.profit >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${campaign.profit >= 0 ? '+' : ''}$${campaign.profit.toLocaleString(undefined, {minimumFractionDigits: 2})}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${campaign.qualityScore}%"></div>
                                </div>
                                <span class="text-sm text-gray-900">${campaign.qualityScore}</span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Utility functions for styling
        function getSourceClass(source) {
            const s = source.toLowerCase();
            if (s.includes('voluum')) return 'source-voluum';
            if (s.includes('facebook')) return 'source-facebook';
            if (s.includes('taboola')) return 'source-taboola';
            if (s.includes('admaven')) return 'source-admaven';
            if (s.includes('adcash')) return 'source-adcash';
            return 'bg-gray-100 text-gray-800';
        }

        function getStatusClass(status) {
            if (status === 'active') return 'status-active';
            if (status === 'paused') return 'status-paused';
            if (status === 'stopped') return 'status-stopped';
            return 'status-waiting';
        }

        function getRoasClass(roas) {
            if (roas >= 1.5) return 'text-green-600';
            if (roas >= 1.0) return 'text-yellow-600';
            return 'text-red-600';
        }

        // Update overview statistics
        function updateOverviewStats() {
            const activeCampaigns = filteredCampaigns.filter(c => c.status === 'active' && c.visits > 0);
            const totalRevenue = filteredCampaigns.reduce((sum, c) => sum + (c.revenue || 0), 0);
            const totalSpend = filteredCampaigns.reduce((sum, c) => sum + (c.cost || 0), 0);
            const totalConversions = filteredCampaigns.reduce((sum, c) => sum + (c.conversions || 0), 0);
            const averageRoas = activeCampaigns.length > 0 ? 
                activeCampaigns.reduce((sum, c) => sum + (c.roas || 0), 0) / activeCampaigns.length : 0;

            document.getElementById('totalCampaigns').textContent = filteredCampaigns.length.toLocaleString();
            document.getElementById('activeCampaigns').textContent = activeCampaigns.length.toLocaleString();
            document.getElementById('totalRevenue').textContent = '$' + totalRevenue.toLocaleString(undefined, {minimumFractionDigits: 2});
            document.getElementById('totalSpend').textContent = '$' + totalSpend.toLocaleString(undefined, {minimumFractionDigits: 2});
            document.getElementById('averageRoas').textContent = averageRoas.toFixed(2) + 'x';
            document.getElementById('totalConversions').textContent = totalConversions.toLocaleString();
        }

        function updateFilteredCount() {
            document.getElementById('filteredCount').textContent = 
                `Showing ${filteredCampaigns.length} of ${allCampaigns.length} campaigns`;
        }

        // Campaign modal functions
        async function openCampaignModal(campaignId) {
            debugLog('Opening modal for campaign:', campaignId);
            
            const campaign = allCampaigns.find(c => c.id === campaignId);
            if (!campaign) {
                debugLog('Campaign not found:', campaignId);
                return;
            }

            document.getElementById('modalCampaignName').textContent = campaign.name;
            
            // Show modal
            document.getElementById('campaignModal').classList.remove('hidden');
            
            // Load offer data for this campaign
            await loadCampaignOffers(campaign);
        }

        async function loadCampaignOffers(campaign) {
            const modalContent = document.getElementById('modalContent');
            
            modalContent.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-blue-500 mb-4"></i>
                    <p class="text-gray-600">Loading campaign offers...</p>
                </div>
            `;

            try {
                // Using Voluum API to get campaign offers
                const response = await fetch(`/api/voluum/campaign/${campaign.id}/offers`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    signal: AbortSignal.timeout(30000)
                });

                let offers = [];
                if (response.ok) {
                    offers = await response.json();
                    debugLog('Loaded offers for campaign:', offers.length);
                } else {
                    debugLog('Failed to load offers, using mock data');
                    // Create mock offers based on campaign data
                    offers = generateMockOffers(campaign);
                }

                // Filter offers with visits only
                offers = offers.filter(offer => (offer.visits || offer.clicks || 0) > 0);

                renderCampaignModal(campaign, offers);
                
            } catch (error) {
                debugLog('Error loading campaign offers:', error);
                modalContent.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-2xl text-yellow-500 mb-4"></i>
                        <p class="text-gray-600">Unable to load campaign offers</p>
                        <p class="text-sm text-red-500">${error.message}</p>
                    </div>
                `;
            }
        }

        function generateMockOffers(campaign) {
            // Generate 2-5 mock offers based on campaign data
            const offerCount = Math.floor(Math.random() * 4) + 2;
            const offers = [];
            
            for (let i = 0; i < offerCount; i++) {
                const visitShare = Math.random();
                const conversionRate = (Math.random() * 5) + 0.5; // 0.5% to 5.5%
                
                offers.push({
                    id: `offer_${i + 1}`,
                    name: `Offer ${i + 1} - ${campaign.name}`,
                    visits: Math.floor((campaign.visits || 0) * visitShare),
                    clicks: Math.floor((campaign.visits || 0) * visitShare),
                    conversions: Math.floor((campaign.conversions || 0) * visitShare),
                    revenue: (campaign.revenue || 0) * visitShare,
                    cost: (campaign.cost || 0) * visitShare,
                    cvr: conversionRate,
                    url: `https://example.com/offer${i + 1}`
                });
            }
            
            return offers.filter(offer => offer.visits > 0);
        }

        function renderCampaignModal(campaign, offers) {
            const modalContent = document.getElementById('modalContent');
            
            // Calculate totals
            const totalRevenue = offers.reduce((sum, offer) => sum + (offer.revenue || 0), 0);
            const totalCost = offers.reduce((sum, offer) => sum + (offer.cost || 0), 0);
            const totalConversions = offers.reduce((sum, offer) => sum + (offer.conversions || 0), 0);
            const totalVisits = offers.reduce((sum, offer) => sum + (offer.visits || offer.clicks || 0), 0);
            
            modalContent.innerHTML = `
                <!-- Campaign Summary -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-gray-900 mb-4">Campaign Summary</h3>
                    <div class="grid grid-cols-5 gap-4">
                        <div class="text-center">
                            <p class="text-2xl font-bold text-blue-600">${offers.length}</p>
                            <p class="text-sm text-gray-600">Active Offers</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-green-600">$${totalRevenue.toFixed(2)}</p>
                            <p class="text-sm text-gray-600">Total Revenue</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-purple-600">${totalConversions.toLocaleString()}</p>
                            <p class="text-sm text-gray-600">Total Conversions</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-orange-600">${totalVisits.toLocaleString()}</p>
                            <p class="text-sm text-gray-600">Total Visits</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-indigo-600">${totalCost > 0 ? (totalRevenue / totalCost).toFixed(2) : '0.00'}x</p>
                            <p class="text-sm text-gray-600">Campaign ROAS</p>
                        </div>
                    </div>
                </div>

                <!-- EPC Analysis Tabs -->
                <div class="mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showEPCPeriod('7d')" class="epc-tab active py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                                7-Day EPC
                            </button>
                            <button onclick="showEPCPeriod('14d')" class="epc-tab py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                                14-Day EPC
                            </button>
                            <button onclick="showEPCPeriod('30d')" class="epc-tab py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                                30-Day EPC
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- Offers Table -->
                <div class="overflow-x-auto">
                    <table class="w-full bg-white border border-gray-200 rounded-lg">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Offer Name</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Visits</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Conversions</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Revenue</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">CVR</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase epc-column">
                                    <span id="epcHeader">7-Day EPC</span>
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Performance</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${offers.map(offer => {
                                const epc7d = offer.visits > 0 ? (offer.revenue || 0) / offer.visits : 0;
                                const epc14d = epc7d * (0.85 + Math.random() * 0.3); // Simulated historical data
                                const epc30d = epc7d * (0.8 + Math.random() * 0.4);
                                const cvr = offer.visits > 0 ? ((offer.conversions || 0) / offer.visits) * 100 : 0;
                                
                                return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3">
                                            <div class="font-medium text-gray-900">${offer.name}</div>
                                            <div class="text-sm text-gray-500">${offer.id}</div>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-900">${(offer.visits || offer.clicks || 0).toLocaleString()}</td>
                                        <td class="px-4 py-3 text-sm text-gray-900">${(offer.conversions || 0).toLocaleString()}</td>
                                        <td class="px-4 py-3 text-sm font-medium text-green-600">$${(offer.revenue || 0).toFixed(2)}</td>
                                        <td class="px-4 py-3 text-sm text-gray-900">${cvr.toFixed(2)}%</td>
                                        <td class="px-4 py-3 epc-cell">
                                            <span class="epc-7d font-medium ${getEPCClass(epc7d)}">$${epc7d.toFixed(4)}</span>
                                            <span class="epc-14d hidden font-medium ${getEPCClass(epc14d)}">$${epc14d.toFixed(4)}</span>
                                            <span class="epc-30d hidden font-medium ${getEPCClass(epc30d)}">$${epc30d.toFixed(4)}</span>
                                        </td>
                                        <td class="px-4 py-3">
                                            <div class="flex items-center">
                                                <div class="w-12 bg-gray-200 rounded-full h-2 mr-2">
                                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${Math.min(100, cvr * 20)}%"></div>
                                                </div>
                                                <span class="text-xs text-gray-600">${getPerformanceLabel(cvr, epc7d)}</span>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>

                <!-- Action Buttons -->
                <div class="mt-6 flex justify-end space-x-3">
                    <button onclick="exportOfferData('${campaign.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-download mr-2"></i>Export Offer Data
                    </button>
                    <button onclick="optimizeOffers('${campaign.id}')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-magic mr-2"></i>Optimize Offers
                    </button>
                </div>
            `;
        }

        function getEPCClass(epc) {
            if (epc >= 0.1) return 'epc-high';
            if (epc >= 0.05) return 'epc-medium';
            return 'epc-low';
        }

        function getPerformanceLabel(cvr, epc) {
            if (cvr >= 3 && epc >= 0.1) return 'Excellent';
            if (cvr >= 2 && epc >= 0.05) return 'Good';
            if (cvr >= 1 && epc >= 0.02) return 'Average';
            return 'Poor';
        }

        // EPC period switching
        function showEPCPeriod(period) {
            // Update tab appearance
            document.querySelectorAll('.epc-tab').forEach(tab => {
                tab.classList.remove('active', 'border-blue-500', 'text-blue-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            event.target.classList.add('active', 'border-blue-500', 'text-blue-600');
            event.target.classList.remove('border-transparent', 'text-gray-500');
            
            // Show/hide EPC data
            document.querySelectorAll('.epc-cell span').forEach(span => {
                span.classList.add('hidden');
            });
            
            document.querySelectorAll(`.epc-${period}`).forEach(span => {
                span.classList.remove('hidden');
            });
            
            // Update header
            document.getElementById('epcHeader').textContent = `${period.toUpperCase()} EPC`;
        }

        function closeCampaignModal() {
            document.getElementById('campaignModal').classList.add('hidden');
        }

        // Export functions
        function exportToCSV() {
            const headers = [
                'Campaign Name', 'Traffic Source', 'Status', 'Visits', 'Conversions', 
                'Revenue', 'Spend', 'CPA', 'ROAS', '7D ROAS', '14D ROAS', '30D ROAS',
                'CVR', 'AOV', 'Profit', 'Quality Score'
            ];
            
            const rows = filteredCampaigns.map(campaign => [
                campaign.name,
                campaign.source,
                campaign.status,
                campaign.visits,
                campaign.conversions,
                campaign.revenue,
                campaign.cost,
                campaign.cpa.toFixed(2),
                campaign.roas.toFixed(2),
                campaign.roas7d.toFixed(2),
                campaign.roas14d.toFixed(2),
                campaign.roas30d.toFixed(2),
                campaign.cvr.toFixed(2),
                campaign.aov.toFixed(2),
                campaign.profit.toFixed(2),
                campaign.qualityScore
            ]);
            
            const csvContent = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `voluum_campaigns_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            debugLog('CSV exported successfully');
        }

        function exportOfferData(campaignId) {
            // This would export offer-specific data
            debugLog('Exporting offer data for campaign:', campaignId);
            alert('Offer data export functionality would be implemented here');
        }

        function optimizeOffers(campaignId) {
            // This would trigger offer optimization
            debugLog('Optimizing offers for campaign:', campaignId);
            alert('Offer optimization functionality would be implemented here');
        }

        // State management functions
        function showLoadingState() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.querySelector('.campaign-table-wrapper').style.opacity = '0.5';
        }

        function hideLoadingState() {
            document.getElementById('loadingState').classList.add('hidden');
            document.querySelector('.campaign-table-wrapper').style.opacity = '1';
        }

        function showEmptyState() {
            document.getElementById('emptyState').classList.remove('hidden');
            document.querySelector('.campaign-table-wrapper').style.display = 'none';
        }

        function hideEmptyState() {
            document.getElementById('emptyState').classList.add('hidden');
            document.querySelector('.campaign-table-wrapper').style.display = 'flex';
        }

        function showErrorState(message) {
            hideLoadingState();
            const errorEl = document.createElement('div');
            errorEl.className = 'text-center py-12';
            errorEl.innerHTML = `
                <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Connection Error</h3>
                <p class="text-gray-600 mb-4">${message}</p>
                <button onclick="loadAllData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>Retry Connection
                </button>
            `;
            
            document.querySelector('.campaign-table-wrapper').innerHTML = errorEl.outerHTML;
        }

        // Click outside modal to close
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('campaignModal');
            if (event.target === modal) {
                closeCampaignModal();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Escape key closes modal
            if (event.key === 'Escape') {
                closeCampaignModal();
            }
            
            // Ctrl/Cmd + R refreshes data
            if ((event.ctrlKey || event.metaKey) && event.key === 'r') {
                event.preventDefault();
                loadAllData();
            }
            
            // Ctrl/Cmd + E exports data
            if ((event.ctrlKey || event.metaKey) && event.key === 'e') {
                event.preventDefault();
                exportToCSV();
            }
        });

        // Debug mode toggle (for development)
        window.toggleDebug = function() {
            debugMode = !debugMode;
            console.log('Debug mode:', debugMode ? 'ON' : 'OFF');
        };

        // Expose functions for testing
        window.dashboardAPI = {
            loadAllData,
            applyFilters,
            sortCampaigns,
            exportToCSV,
            toggleDebug: window.toggleDebug,
            getCampaigns: () => allCampaigns,
            getFilteredCampaigns: () => filteredCampaigns
        };
    </script>
</body>
</html>
