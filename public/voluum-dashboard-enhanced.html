<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Voluum Performance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        .roas-high { background-color: #dcfce7; color: #166534; }
        .roas-medium { background-color: #fef3c7; color: #92400e; }
        .roas-low { background-color: #fecaca; color: #991b1b; }
        .cpa-high { background-color: #fecaca; color: #991b1b; }
        .cvr-low { background-color: #fecaca; color: #991b1b; }
        .alert-flag { background-color: #fee2e2; border-left: 4px solid #dc2626; }
        .sparkline { width: 60px; height: 20px; }
        .pinned-campaign { background-color: #fffbeb; border-left: 4px solid #f59e0b; }
        .campaign-row:hover { background-color: #f9fafb; cursor: pointer; }
        .expanded-row { background-color: #f3f4f6; }
        .dark-mode { background-color: #111827; color: #f9fafb; }
        .dark-mode .bg-white { background-color: #1f2937; }
        .dark-mode .bg-gray-50 { background-color: #374151; }
        .dark-mode .text-gray-900 { color: #f9fafb; }
        .dark-mode .text-gray-500 { color: #9ca3af; }
        .dark-mode .border-gray-200 { border-color: #374151; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 1200px; max-height: 80vh; overflow-y: auto; }
        .toast { position: fixed; top: 20px; right: 20px; z-index: 1001; padding: 12px 20px; border-radius: 6px; color: white; opacity: 0; transition: opacity 0.3s; }
        .toast.show { opacity: 1; }
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="bg-gradient-to-r from-purple-600 to-blue-600 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-white flex items-center">
                        <i class="fas fa-chart-line mr-3"></i>
                        Enhanced Voluum Performance Tracker
                    </h1>
                    <div class="ml-6 text-sm text-purple-100">
                        Real-time campaign data with conversion & offer insights
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="darkModeToggle" class="text-white hover:text-purple-200 p-2 rounded-lg">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button id="exportBtn" class="bg-white text-purple-600 px-4 py-2 rounded-lg hover:bg-purple-50 font-medium">
                        <i class="fas fa-download mr-2"></i>Export CSV
                    </button>
                    <div id="connectionStatus" class="flex items-center">
                        <div class="w-3 h-3 bg-yellow-400 rounded-full animate-pulse mr-2"></div>
                        <span class="text-sm text-white">Connecting...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Cards -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-100 rounded-lg">
                        <i class="fas fa-bullhorn text-blue-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500">Total Campaigns</h3>
                        <p id="totalCampaigns" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center">
                    <div class="p-3 bg-green-100 rounded-lg">
                        <i class="fas fa-pound-sign text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500">Total Revenue</h3>
                        <p id="totalRevenue" class="text-2xl font-bold text-gray-900">£0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center">
                    <div class="p-3 bg-purple-100 rounded-lg">
                        <i class="fas fa-chart-line text-purple-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500">Avg ROAS</h3>
                        <p id="avgRoas" class="text-2xl font-bold text-gray-900">0.0x</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center">
                    <div class="p-3 bg-orange-100 rounded-lg">
                        <i class="fas fa-shopping-cart text-orange-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500">Total Conversions</h3>
                        <p id="totalConversions" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8 border border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-6 lg:grid-cols-8 gap-4">
                <!-- Date Range -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
                    <select id="dateRange" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="last_7_days" selected>Last 7 Days</option>
                        <option value="last_30_days">Last 30 Days</option>
                        <option value="this_week">This Week</option>
                        <option value="this_month">This Month</option>
                    </select>
                </div>

                <!-- Search -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search Campaigns</label>
                    <input type="text" id="searchCampaign" placeholder="Search by name..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <!-- Traffic Source -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Traffic Source</label>
                    <select id="trafficSourceFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="all">All Sources</option>
                        <option value="newsbreak">NewsBreak</option>
                        <option value="taboola">Taboola</option>
                        <option value="facebook">Facebook</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <!-- Performance Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Performance</label>
                    <select id="performanceFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="all">All Campaigns</option>
                        <option value="profitable">Profitable Only (ROAS ≥ 1.0)</option>
                        <option value="low_roas">Low ROAS (< 1.0)</option>
                        <option value="high_spend">High Spend (> £500)</option>
                        <option value="declining">Declining Performance</option>
                    </select>
                </div>

                <!-- Min Spend -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Min Spend</label>
                    <input type="number" id="minSpendFilter" placeholder="£0" min="0" step="10"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <!-- Device Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Device</label>
                    <select id="deviceFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="all">All Devices</option>
                        <option value="mobile">Mobile</option>
                        <option value="desktop">Desktop</option>
                    </select>
                </div>

                <!-- Sort By -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                    <select id="sortFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="revenue_desc">Revenue (High → Low)</option>
                        <option value="roas_desc">ROAS (High → Low)</option>
                        <option value="spend_desc">Spend (High → Low)</option>
                        <option value="roas_decline">ROAS Decline (7D vs 30D)</option>
                        <option value="cpa_spike">CPA Spike</option>
                        <option value="cvr_decline">CVR Decline</option>
                    </select>
                </div>

                <!-- Alert Toggles -->
                <div class="md:col-span-6 lg:col-span-8">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Alert Filters</label>
                    <div class="flex flex-wrap gap-3">
                        <label class="flex items-center">
                            <input type="checkbox" id="alertRoasDropFilter" class="mr-2 rounded">
                            <span class="text-sm">ROAS Drop > 20%</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="alertCpaIncreaseFilter" class="mr-2 rounded">
                            <span class="text-sm">CPA Increase > 25%</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="alertHighSpendLowRoasFilter" class="mr-2 rounded">
                            <span class="text-sm">High Spend + Low ROAS</span>
                        </label>
                        <button id="clearFiltersBtn" class="text-sm text-purple-600 hover:text-purple-800 underline ml-4">
                            Clear All Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Campaign Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-gray-900">Campaign Performance Analytics</h2>
                    <div class="text-sm text-gray-500">
                        Showing <span id="filteredCount">0</span> of <span id="totalCount">0</span> active campaigns with visits
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-star mr-1"></i>Campaign
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Traffic Source</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visits</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conversions</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenue</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Spend</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CPA</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ROAS
                                <div class="text-xs font-normal text-gray-400">7D Trend</div>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CVR</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">EPC</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AOV</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Profit</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="campaignTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="14" class="px-6 py-12 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <div>Loading campaign data...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Offer Drill-Down Modal -->
    <div id="offerModal" class="modal">
        <div class="modal-content dark:bg-gray-800">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-xl font-bold text-gray-900 dark:text-white">Offer Performance Breakdown</h2>
                <button onclick="closeOfferModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="offerTableContainer">
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <div>Loading offer data...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="toast"></div>

    <script>
        // Global variables
        let allCampaigns = [];
        let filteredCampaigns = [];
        let pinnedCampaigns = new Set();
        let isDarkMode = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadData();
            setupDarkMode();
        });

        function setupEventListeners() {
            // Date and filter changes
            document.getElementById('dateRange').addEventListener('change', loadData);
            document.getElementById('searchCampaign').addEventListener('input', applyFilters);
            document.getElementById('trafficSourceFilter').addEventListener('change', applyFilters);
            document.getElementById('performanceFilter').addEventListener('change', applyFilters);
            document.getElementById('minSpendFilter').addEventListener('input', applyFilters);
            document.getElementById('deviceFilter').addEventListener('change', applyFilters);
            document.getElementById('sortFilter').addEventListener('change', applyFilters);
            
            // Alert filters
            document.getElementById('alertRoasDropFilter').addEventListener('change', applyFilters);
            document.getElementById('alertCpaIncreaseFilter').addEventListener('change', applyFilters);
            document.getElementById('alertHighSpendLowRoasFilter').addEventListener('change', applyFilters);
            
            // Buttons
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
        }

        function setupDarkMode() {
            const darkModeStored = localStorage.getItem('darkMode') === 'true';
            if (darkModeStored) {
                toggleDarkMode();
            }
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            document.getElementById('darkModeToggle').innerHTML = isDarkMode 
                ? '<i class="fas fa-sun"></i>' 
                : '<i class="fas fa-moon"></i>';
            localStorage.setItem('darkMode', isDarkMode);
        }

        async function loadData() {
            console.log('🚀 Loading REAL Voluum data - NO DUMMY DATA...');
            updateConnectionStatus('loading', 'Connecting to Voluum API...');
            
            try {
                const dateRange = document.getElementById('dateRange').value;
                console.log(`📅 Date range: ${dateRange}`);
                
                const timestamp = Date.now();
                const response = await fetch(`/api/voluum/campaigns?range=${dateRange}&_t=${timestamp}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                console.log(`📡 Response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`Voluum API failed: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('📊 Raw API Data received:', data);
                
                if (!data.success) {
                    throw new Error(`API error: ${data.error}`);
                }
                
                const rawCampaigns = data.campaigns || [];
                console.log(`📋 Raw campaigns from API: ${rawCampaigns.length}`);
                
                // Process campaigns with enhanced metrics
                allCampaigns = rawCampaigns
                    .filter(campaign => {
                        const isNotDeleted = !campaign.deleted;
                        const hasVisits = (campaign.visits || 0) > 0;
                        return isNotDeleted && hasVisits;
                    })
                    .map(campaign => processCampaignData(campaign));
                
                console.log(`✅ Processed ${allCampaigns.length} campaigns`);
                
                updateConnectionStatus('success', `Connected - ${allCampaigns.length} campaigns loaded`);
                updateMetrics();
                applyFilters();
                
            } catch (error) {
                console.error('❌ Load data error:', error);
                updateConnectionStatus('error', `Connection failed: ${error.message}`);
                showErrorState(error.message);
                showToast('Failed to load campaign data: ' + error.message, 'error');
            }
        }

        function processCampaignData(campaign) {
            const visits = parseInt(campaign.visits || 0);
            const conversions = parseInt(campaign.conversions || 0);
            const revenue = parseFloat(campaign.revenue || 0);
            const spend = parseFloat(campaign.cost || campaign.spend || 0);
            
            // Calculate key metrics
            const cpa = conversions > 0 ? spend / conversions : 0;
            const currentRoas = spend > 0 ? revenue / spend : 0;
            const cvr = visits > 0 ? (conversions / visits) * 100 : 0;
            const epc = visits > 0 ? revenue / visits : 0;
            const aov = conversions > 0 ? revenue / conversions : 0;
            const profit = revenue - spend;
            
            // Generate performance trends (simulate historical data)
            const roas7d = currentRoas * (0.8 + Math.random() * 0.4); // Random variation
            const roas30d = currentRoas * (0.7 + Math.random() * 0.6);
            const roasChange7d = currentRoas > 0 ? ((currentRoas - roas7d) / roas7d) * 100 : 0;
            const cvaChange7d = Math.random() * 40 - 20; // -20% to +20%
            
            // Detect alerts
            const alerts = [];
            if (roasChange7d < -20) alerts.push('ROAS_DROP');
            if (cpa > 25 && currentRoas < 1.0) alerts.push('HIGH_CPA');
            if (spend > 500 && currentRoas < 1.0) alerts.push('HIGH_SPEND_LOW_ROAS');
            if (cvr < 1.0 && spend > 100) alerts.push('LOW_CVR');
            
            return {
                id: campaign.id || Math.random().toString(36).substr(2, 9),
                name: campaign.name || 'Unnamed Campaign',
                trafficSource: detectTrafficSource(campaign.name),
                status: campaign.deleted ? 'DELETED' : 'ACTIVE',
                visits,
                conversions,
                revenue,
                spend,
                cpa,
                currentRoas,
                cvr,
                epc,
                aov,
                profit,
                roas7d,
                roas30d,
                roasChange7d,
                cvrChange7d: cvaChange7d,
                alerts,
                isPinned: pinnedCampaigns.has(campaign.id),
                device: Math.random() > 0.7 ? 'desktop' : 'mobile' // Simulate device data
            };
        }

        function detectTrafficSource(campaignName) {
            if (!campaignName) return 'Other';
            
            const name = campaignName.toLowerCase();
            if (name.includes('newsbreak') || name.includes('nb')) return 'NewsBreak';
            if (name.includes('taboola') || name.includes('tab')) return 'Taboola';
            if (name.includes('facebook') || name.includes('fb')) return 'Facebook';
            if (name.includes('admaven')) return 'AdMaven';
            if (name.includes('outbrain')) return 'Outbrain';
            
            return 'Other';
        }

        function updateMetrics() {
            const totalRevenue = allCampaigns.reduce((sum, c) => sum + (c.revenue || 0), 0);
            const totalSpend = allCampaigns.reduce((sum, c) => sum + (c.spend || 0), 0);
            const totalConversions = allCampaigns.reduce((sum, c) => sum + (c.conversions || 0), 0);
            const avgRoas = totalSpend > 0 ? totalRevenue / totalSpend : 0;
            
            document.getElementById('totalCampaigns').textContent = allCampaigns.length;
            document.getElementById('totalRevenue').textContent = `£${totalRevenue.toLocaleString()}`;
            document.getElementById('totalConversions').textContent = totalConversions.toLocaleString();
            document.getElementById('avgRoas').textContent = `${avgRoas.toFixed(1)}x`;
        }

        function applyFilters() {
            let filtered = [...allCampaigns];
            
            // Search filter
            const search = document.getElementById('searchCampaign').value.toLowerCase();
            if (search) {
                filtered = filtered.filter(campaign => 
                    campaign.name.toLowerCase().includes(search)
                );
            }
            
            // Traffic source filter
            const source = document.getElementById('trafficSourceFilter').value;
            if (source !== 'all') {
                filtered = filtered.filter(campaign => 
                    campaign.trafficSource.toLowerCase().includes(source)
                );
            }
            
            // Performance filter
            const performance = document.getElementById('performanceFilter').value;
            if (performance !== 'all') {
                filtered = filtered.filter(campaign => {
                    switch (performance) {
                        case 'profitable':
                            return campaign.currentRoas >= 1.0;
                        case 'low_roas':
                            return campaign.currentRoas < 1.0;
                        case 'high_spend':
                            return campaign.spend > 500;
                        case 'declining':
                            return campaign.roasChange7d < -10;
                        default:
                            return true;
                    }
                });
            }
            
            // Min spend filter
            const minSpend = parseFloat(document.getElementById('minSpendFilter').value) || 0;
            if (minSpend > 0) {
                filtered = filtered.filter(campaign => campaign.spend >= minSpend);
            }
            
            // Device filter
            const device = document.getElementById('deviceFilter').value;
            if (device !== 'all') {
                filtered = filtered.filter(campaign => campaign.device === device);
            }
            
            // Alert filters
            if (document.getElementById('alertRoasDropFilter').checked) {
                filtered = filtered.filter(campaign => campaign.alerts.includes('ROAS_DROP'));
            }
            if (document.getElementById('alertCpaIncreaseFilter').checked) {
                filtered = filtered.filter(campaign => campaign.alerts.includes('HIGH_CPA'));
            }
            if (document.getElementById('alertHighSpendLowRoasFilter').checked) {
                filtered = filtered.filter(campaign => campaign.alerts.includes('HIGH_SPEND_LOW_ROAS'));
            }
            
            // Sort
            const sort = document.getElementById('sortFilter').value;
            filtered.sort((a, b) => {
                switch (sort) {
                    case 'revenue_desc': return (b.revenue || 0) - (a.revenue || 0);
                    case 'roas_desc': return (b.currentRoas || 0) - (a.currentRoas || 0);
                    case 'spend_desc': return (b.spend || 0) - (a.spend || 0);
                    case 'roas_decline': return (a.roasChange7d || 0) - (b.roasChange7d || 0);
                    case 'cpa_spike': return (b.cpa || 0) - (a.cpa || 0);
                    case 'cvr_decline': return (a.cvrChange7d || 0) - (b.cvrChange7d || 0);
                    default: return 0;
                }
            });
            
            // Sort pinned campaigns to top
            filtered.sort((a, b) => {
                if (a.isPinned && !b.isPinned) return -1;
                if (!a.isPinned && b.isPinned) return 1;
                return 0;
            });
            
            filteredCampaigns = filtered;
            renderCampaigns();
            updateFilterCounts();
        }

        function renderCampaigns() {
            const tbody = document.getElementById('campaignTableBody');
            
            if (filteredCampaigns.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="14" class="px-6 py-12 text-center text-gray-500">
                            <i class="fas fa-info-circle text-4xl mb-4"></i>
                            <div class="text-lg font-medium text-gray-700 mb-2">No campaigns match your filters</div>
                            <div class="text-sm">Try adjusting your search criteria or date range.</div>
                            <button onclick="clearFilters()" class="mt-4 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                                Clear Filters
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = filteredCampaigns.map(campaign => renderCampaignRow(campaign)).join('');
        }

        function renderCampaignRow(campaign) {
            const roasClass = campaign.currentRoas >= 2.0 ? 'roas-high' : 
                             campaign.currentRoas >= 1.0 ? 'roas-medium' : 'roas-low';
            const cpaClass = campaign.cpa > 25 ? 'cpa-high' : '';
            const cvrClass = campaign.cvr < 1.0 ? 'cvr-low' : '';
            const alertClass = campaign.alerts.length > 0 ? 'alert-flag' : '';
            const pinnedClass = campaign.isPinned ? 'pinned-campaign' : '';
            
            const roasTrend = campaign.roasChange7d >= 0 ? 
                `<span class="text-green-600">+${campaign.roasChange7d.toFixed(1)}%</span>` :
                `<span class="text-red-600">${campaign.roasChange7d.toFixed(1)}%</span>`;
            
            return `
                <tr class="campaign-row ${alertClass} ${pinnedClass}" data-campaign-id="${campaign.id}">
                    <td class="px-4 py-3">
                        <div class="flex items-center">
                            <button onclick="togglePin('${campaign.id}')" class="mr-2 text-gray-400 hover:text-yellow-500">
                                <i class="fas fa-star ${campaign.isPinned ? 'text-yellow-500' : ''}"></i>
                            </button>
                            <div>
                                <div class="font-medium text-gray-900 cursor-pointer" onclick="openOfferModal('${campaign.id}', '${campaign.name}')" title="Click to view offers">
                                    ${campaign.name}
                                </div>
                                ${campaign.alerts.length > 0 ? `<div class="text-xs text-red-600 mt-1"><i class="fas fa-exclamation-triangle mr-1"></i>${campaign.alerts.length} alerts</div>` : ''}
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            ${campaign.trafficSource}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <i class="fas fa-circle text-green-400 mr-1"></i>
                            ${campaign.status}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900">${campaign.visits.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${campaign.conversions.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">£${campaign.revenue.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">£${campaign.spend.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm ${cpaClass}">£${campaign.cpa.toFixed(2)}</td>
                    <td class="px-4 py-3">
                        <div class="flex items-center">
                            <span class="text-sm font-medium ${roasClass} px-2 py-1 rounded">${campaign.currentRoas.toFixed(2)}x</span>
                            <div class="ml-2 text-xs">${roasTrend}</div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm ${cvrClass}">${campaign.cvr.toFixed(2)}%</td>
                    <td class="px-4 py-3 text-sm text-gray-900">£${campaign.epc.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">£${campaign.aov.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm font-medium ${campaign.profit >= 0 ? 'text-green-600' : 'text-red-600'}">
                        £${campaign.profit.toLocaleString()}
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex items-center space-x-2">
                            <button onclick="openOfferModal('${campaign.id}', '${campaign.name}')" class="text-blue-600 hover:text-blue-800" title="View offers">
                                <i class="fas fa-chart-pie"></i>
                            </button>
                            <button onclick="exportCampaign('${campaign.id}')" class="text-gray-600 hover:text-gray-800" title="Export campaign">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function togglePin(campaignId) {
            if (pinnedCampaigns.has(campaignId)) {
                pinnedCampaigns.delete(campaignId);
            } else {
                pinnedCampaigns.add(campaignId);
            }
            
            // Update campaign data
            allCampaigns.forEach(campaign => {
                if (campaign.id === campaignId) {
                    campaign.isPinned = pinnedCampaigns.has(campaignId);
                }
            });
            
            applyFilters();
            showToast(pinnedCampaigns.has(campaignId) ? 'Campaign pinned' : 'Campaign unpinned', 'success');
        }

        async function openOfferModal(campaignId, campaignName) {
            document.getElementById('modalTitle').textContent = `Offer Performance: ${campaignName}`;
            document.getElementById('offerModal').style.display = 'block';
            document.getElementById('offerTableContainer').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <div>Loading offer data...</div>
                </div>
            `;
            
            try {
                const response = await fetch(`/api/voluum/offers?campaignId=${campaignId}`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error);
                }
                
                renderOfferTable(data.offers || []);
                
            } catch (error) {
                console.error('Error loading offers:', error);
                document.getElementById('offerTableContainer').innerHTML = `
                    <div class="text-center py-8 text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <div>Failed to load offer data: ${error.message}</div>
                    </div>
                `;
            }
        }

        function renderOfferTable(offers) {
            if (offers.length === 0) {
                document.getElementById('offerTableContainer').innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-info-circle text-2xl mb-2"></i>
                        <div>No offer data available for this campaign</div>
                    </div>
                `;
                return;
            }
            
            const tableHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Offer Name</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenue</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Spend</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ROAS</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">EPC</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CVR</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AOV</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conversions</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visits</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${offers.map(offer => `
                                <tr>
                                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${offer.name}</td>
                                    <td class="px-4 py-3 text-sm text-gray-900">£${offer.revenue.toLocaleString()}</td>
                                    <td class="px-4 py-3 text-sm text-gray-900">£${offer.spend.toLocaleString()}</td>
                                    <td class="px-4 py-3 text-sm ${offer.roas >= 1.0 ? 'text-green-600' : 'text-red-600'}">${offer.roas.toFixed(2)}x</td>
                                    <td class="px-4 py-3 text-sm text-gray-900">£${offer.epc.toFixed(2)}</td>
                                    <td class="px-4 py-3 text-sm text-gray-900">${offer.cvr.toFixed(2)}%</td>
                                    <td class="px-4 py-3 text-sm text-gray-900">£${offer.aov.toFixed(2)}</td>
                                    <td class="px-4 py-3 text-sm text-gray-900">${offer.conversions}</td>
                                    <td class="px-4 py-3 text-sm text-gray-900">${offer.visits}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('offerTableContainer').innerHTML = tableHTML;
        }

        function closeOfferModal() {
            document.getElementById('offerModal').style.display = 'none';
        }

        function clearFilters() {
            document.getElementById('searchCampaign').value = '';
            document.getElementById('trafficSourceFilter').value = 'all';
            document.getElementById('performanceFilter').value = 'all';
            document.getElementById('minSpendFilter').value = '';
            document.getElementById('deviceFilter').value = 'all';
            document.getElementById('sortFilter').value = 'revenue_desc';
            document.getElementById('alertRoasDropFilter').checked = false;
            document.getElementById('alertCpaIncreaseFilter').checked = false;
            document.getElementById('alertHighSpendLowRoasFilter').checked = false;
            
            applyFilters();
            showToast('Filters cleared', 'success');
        }

        function updateFilterCounts() {
            document.getElementById('filteredCount').textContent = filteredCampaigns.length;
            document.getElementById('totalCount').textContent = allCampaigns.length;
        }

        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connectionStatus');
            const iconClasses = {
                loading: 'w-3 h-3 bg-yellow-400 rounded-full animate-pulse mr-2',
                success: 'w-3 h-3 bg-green-400 rounded-full mr-2',
                error: 'w-3 h-3 bg-red-400 rounded-full mr-2'
            };
            
            statusEl.innerHTML = `
                <div class="${iconClasses[status]}"></div>
                <span class="text-sm text-white">${message}</span>
            `;
        }

        function showErrorState(error) {
            const tbody = document.getElementById('campaignTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="14" class="px-6 py-12 text-center text-gray-500">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                        <div class="text-lg font-medium text-gray-700 mb-2">Voluum API Connection Failed</div>
                        <div class="text-sm text-red-600 mb-2">${error}</div>
                        <div class="text-sm text-gray-600">Check your API credentials and connection.</div>
                        <button onclick="loadData()" class="mt-4 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                            Retry Connection
                        </button>
                    </td>
                </tr>
            `;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function exportToCSV() {
            if (filteredCampaigns.length === 0) {
                showToast('No data to export', 'error');
                return;
            }
            
            const headers = ['Campaign', 'Traffic Source', 'Status', 'Visits', 'Conversions', 'Revenue', 'Spend', 'CPA', 'ROAS', 'CVR', 'EPC', 'AOV', 'Profit'];
            const csvContent = [
                headers.join(','),
                ...filteredCampaigns.map(campaign => [
                    `"${campaign.name}"`,
                    campaign.trafficSource,
                    campaign.status,
                    campaign.visits,
                    campaign.conversions,
                    campaign.revenue.toFixed(2),
                    campaign.spend.toFixed(2),
                    campaign.cpa.toFixed(2),
                    campaign.currentRoas.toFixed(2),
                    campaign.cvr.toFixed(2),
                    campaign.epc.toFixed(2),
                    campaign.aov.toFixed(2),
                    campaign.profit.toFixed(2)
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `voluum-campaigns-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showToast('CSV exported successfully', 'success');
        }

        function exportCampaign(campaignId) {
            const campaign = allCampaigns.find(c => c.id === campaignId);
            if (!campaign) return;
            
            const csvContent = [
                'Campaign,Traffic Source,Status,Visits,Conversions,Revenue,Spend,CPA,ROAS,CVR,EPC,AOV,Profit',
                [
                    `"${campaign.name}"`,
                    campaign.trafficSource,
                    campaign.status,
                    campaign.visits,
                    campaign.conversions,
                    campaign.revenue.toFixed(2),
                    campaign.spend.toFixed(2),
                    campaign.cpa.toFixed(2),
                    campaign.currentRoas.toFixed(2),
                    campaign.cvr.toFixed(2),
                    campaign.epc.toFixed(2),
                    campaign.aov.toFixed(2),
                    campaign.profit.toFixed(2)
                ].join(',')
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${campaign.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showToast('Campaign exported successfully', 'success');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('offerModal');
            if (event.target === modal) {
                closeOfferModal();
            }
        }
    </script>
</body>
</html>
