<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Voluum Performance Tracker</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <style>
        /* Custom Voluum Dashboard Styles */
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        
        /* Main container with full width */
        .main-container { 
            min-width: 100vw; 
            max-width: 100vw; 
            padding: 0 1rem; 
        }
        
        .table-container { 
            overflow-x: auto; 
            max-width: 100%; 
        }
        
        .campaign-table { 
            min-width: 1800px; 
        }
        
        /* Mobile responsive improvements */
        @media (max-width: 768px) {
            .main-container { padding: 0 0.5rem; }
            .grid-cols-4 { grid-template-columns: repeat(2, 1fr); }
            .campaign-table { min-width: 1400px; }
        }
        
        /* Performance indicators */
        .roas-high { color: #10b981; font-weight: 600; }
        .roas-medium { color: #f59e0b; font-weight: 600; }
        .roas-low { color: #ef4444; font-weight: 600; }
        .cpa-high { color: #ef4444; }
        .cvr-low { color: #f59e0b; }
        
        /* FIXED: Softer alert styling */
        .alert-flag { 
            background-color: #fef7f7 !important; 
            border-left: 3px solid #f87171 !important; 
        }
        .alert-flag-multiple { 
            background-color: #fee2e2 !important; 
            border-left: 4px solid #dc2626 !important; 
        }
        
        /* Campaign styling improvements */
        .pinned-campaign { 
            background-color: #f0f9ff; 
            border-left: 4px solid #3b82f6; 
        }
        .expanded-row { 
            background-color: #f8fafc; 
            border-left: 2px solid #6366f1; 
        }
        
        /* Trend indicators */
        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }
        .trend-neutral { color: #6b7280; }
        
        /* Date picker styling */
        .date-picker { position: relative; }
        .date-picker input[type="date"] {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        /* Offer detail styles */
        .offer-detail-row { 
            background-color: #f8fafc; 
            border-left: 4px solid #3b82f6; 
        }
        .offer-table { font-size: 0.9rem; }
        .offer-table th { padding: 8px 12px; }
        .offer-table td { padding: 6px 12px; }
        .offer-table thead th { background-color: #f1f5f9; }
        .offer-table tbody tr:hover { background-color: #f8fafc; }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 95%;
            max-width: 1200px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .toast.show { transform: translateX(0); }
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        .toast.warning { background-color: #f59e0b; }
        
        /* Dark mode styles */
        .dark body { background-color: #1f2937; color: #f9fafb; }
        .dark .bg-white { background-color: #374151 !important; }
        .dark .text-gray-900 { color: #f9fafb !important; }
        .dark .text-gray-700 { color: #d1d5db !important; }
        .dark .text-gray-500 { color: #9ca3af !important; }
        .dark .border-gray-200 { border-color: #4b5563 !important; }
        .dark .divide-gray-200 { border-color: #4b5563 !important; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="bg-gradient-to-r from-purple-600 to-blue-600 shadow-lg">
        <div class="main-container">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-white flex items-center">
                        <i class="fas fa-chart-line mr-3"></i>
                        Enhanced Voluum Performance Tracker
                    </h1>
                    <div class="ml-6 text-sm text-purple-100">
                        Real-time campaign data with conversion & offer insights
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="darkModeToggle" class="text-white hover:text-purple-200 p-2 rounded-lg">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button id="exportBtn" class="bg-white text-purple-600 px-4 py-2 rounded-lg hover:bg-purple-50 font-medium">
                        <i class="fas fa-download mr-2"></i>Export CSV
                    </button>
                    <div id="connectionStatus" class="flex items-center">
                        <div class="w-3 h-3 bg-yellow-400 rounded-full animate-pulse mr-2"></div>
                        <span class="text-sm text-white">Connecting...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Cards -->
    <div class="main-container py-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-100 rounded-lg">
                        <i class="fas fa-bullhorn text-blue-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500">Total Campaigns</h3>
                        <p id="totalCampaigns" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center">
                    <div class="p-3 bg-green-100 rounded-lg">
                        <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500">Total Revenue</h3>
                        <p id="totalRevenue" class="text-2xl font-bold text-gray-900">$0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center">
                    <div class="p-3 bg-purple-100 rounded-lg">
                        <i class="fas fa-chart-line text-purple-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500">Avg ROAS</h3>
                        <p id="avgRoas" class="text-2xl font-bold text-gray-900">0.0x</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center">
                    <div class="p-3 bg-orange-100 rounded-lg">
                        <i class="fas fa-shopping-cart text-orange-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500">Total Conversions</h3>
                        <p id="totalConversions" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8 border border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-6 lg:grid-cols-10 gap-4">
                <!-- Date Range -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
                    <select id="dateRange" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="last_7_days" selected>Last 7 Days</option>
                        <option value="last_30_days">Last 30 Days</option>
                        <option value="this_week">This Week</option>
                        <option value="this_month">This Month</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>

                <!-- Custom Date Range -->
                <div id="customDateRange" style="display: none;" class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">From - To</label>
                    <div class="flex space-x-2">
                        <input type="date" id="fromDate" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <input type="date" id="toDate" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                </div>

                <!-- Search -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search Campaigns</label>
                    <input type="text" id="searchCampaign" placeholder="Search campaigns..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <!-- Traffic Source Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Traffic Source</label>
                    <select id="trafficSourceFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">All Sources</option>
                        <option value="facebook">Facebook</option>
                        <option value="taboola">Taboola</option>
                        <option value="newsbreak">NewsBreak</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <!-- OS Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Operating System</label>
                    <select id="osFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">All OS</option>
                        <option value="android">Android</option>
                        <option value="ios">iOS</option>
                        <option value="windows">Windows</option>
                        <option value="macos">macOS</option>
                        <option value="unknown">Unknown</option>
                    </select>
                </div>

                <!-- Performance Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Performance</label>
                    <select id="performanceFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">All Performance</option>
                        <option value="profitable">Profitable (ROAS > 1.0)</option>
                        <option value="high_roas">High ROAS (> 2.0)</option>
                        <option value="low_roas">Low ROAS (< 1.0)</option>
                        <option value="no_conversions">No Conversions</option>
                    </select>
                </div>

                <!-- Min Spend Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Min Spend</label>
                    <input type="number" id="minSpendFilter" placeholder="$0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <!-- Device Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Device Type</label>
                    <select id="deviceFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">All Devices</option>
                        <option value="mobile">Mobile</option>
                        <option value="desktop">Desktop</option>
                        <option value="tablet">Tablet</option>
                    </select>
                </div>

                <!-- Sort Options -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                    <select id="sortFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="revenue_desc">Revenue (High to Low)</option>
                        <option value="revenue_asc">Revenue (Low to High)</option>
                        <option value="roas_desc">ROAS (High to Low)</option>
                        <option value="roas_asc">ROAS (Low to High)</option>
                        <option value="spend_desc">Spend (High to Low)</option>
                        <option value="cpa_asc">CPA (Low to High)</option>
                        <option value="conversions_desc">Conversions (High to Low)</option>
                        <option value="name_asc">Name (A to Z)</option>
                    </select>
                </div>

                <!-- Clear Filters -->
                <div class="flex items-end">
                    <button onclick="clearFilters()" class="w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 font-medium">
                        <i class="fas fa-times mr-2"></i>Clear
                    </button>
                </div>
            </div>
            
            <!-- Filter Summary -->
            <div id="filterSummary" class="mt-4 text-sm text-gray-600 bg-gray-50 p-3 rounded-lg" style="display: none;">
            </div>
        </div>

        <!-- Campaign Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="table-container">
                <table class="campaign-table w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Campaign Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Traffic Source</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alerts</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visits</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conversions</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenue</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Spend</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CPA</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ROAS (Current)
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ROAS (7D)
                                <div class="text-xs font-normal text-gray-400">Trend</div>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ROAS (14D)
                                <div class="text-xs font-normal text-gray-400">Trend</div>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ROAS (30D)
                                <div class="text-xs font-normal text-gray-400">Trend</div>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CVR</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">EPC</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Average Payout</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Profit</th>
                        </tr>
                    </thead>
                    <tbody id="campaignTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="18" class="px-6 py-12 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <div>Loading campaign data...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Offer Drill-Down Modal -->
    <div id="offerModal" class="modal">
        <div class="modal-content dark:bg-gray-800">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-xl font-bold text-gray-900 dark:text-white">Offer Performance Breakdown</h2>
                <button onclick="closeOfferModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="offerTableContainer">
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <div>Loading offer data...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="toast"></div>

    <script>
        // Global variables
        let allCampaigns = [];
        let filteredCampaigns = [];
        let pinnedCampaigns = new Set();
        let isDarkMode = false;
        let expandedCampaigns = new Set();

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadData();
            setupDarkMode();
            setupDatePickers();
        });

        function setupEventListeners() {
            // Date and filter changes
            document.getElementById('dateRange').addEventListener('change', handleDateRangeChange);
            document.getElementById('fromDate').addEventListener('change', handleCustomDateChange);
            document.getElementById('toDate').addEventListener('change', handleCustomDateChange);
            document.getElementById('searchCampaign').addEventListener('input', applyFilters);
            document.getElementById('trafficSourceFilter').addEventListener('change', applyFilters);
            document.getElementById('osFilter').addEventListener('change', applyFilters);
            document.getElementById('performanceFilter').addEventListener('change', applyFilters);
            document.getElementById('minSpendFilter').addEventListener('input', applyFilters);
            document.getElementById('deviceFilter').addEventListener('change', applyFilters);
            document.getElementById('sortFilter').addEventListener('change', applyFilters);

            // Other controls
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
            document.getElementById('exportBtn').addEventListener('click', exportData);
        }

        function setupDatePickers() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            document.getElementById('fromDate').valueAsDate = yesterday;
            document.getElementById('toDate').valueAsDate = today;
        }

        function handleDateRangeChange() {
            const dateRange = document.getElementById('dateRange').value;
            const customDateRange = document.getElementById('customDateRange');
            
            if (dateRange === 'custom') {
                customDateRange.style.display = 'block';
            } else {
                customDateRange.style.display = 'none';
                loadData(); // Reload data immediately for preset ranges
            }
        }

        function handleCustomDateChange() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            
            if (fromDate && toDate) {
                loadData(); // Reload data when both custom dates are set
            }
        }

        async function loadData() {
            updateConnectionStatus('connecting', 'Loading campaign data...');
            
            try {
                let url = '/api/voluum/campaigns';
                const dateRange = document.getElementById('dateRange').value;
                
                if (dateRange === 'custom') {
                    const fromDate = document.getElementById('fromDate').value;
                    const toDate = document.getElementById('toDate').value;
                    if (fromDate && toDate) {
                        url += `?from=${fromDate}&to=${toDate}`;
                    }
                } else {
                    url += `?range=${dateRange}`;
                }
                
                console.log('ðŸ” Loading campaigns from:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load campaigns');
                }
                
                allCampaigns = data.campaigns || [];
                console.log(`ðŸ“Š Loaded ${allCampaigns.length} campaigns`);
                
                processAndDisplayData();
                updateConnectionStatus('connected', `Loaded ${allCampaigns.length} campaigns`);
                
            } catch (error) {
                console.error('âŒ Error loading campaigns:', error);
                updateConnectionStatus('error', error.message);
                showErrorState(error.message);
            }
        }

        function processAndDisplayData() {
            // Process campaign data
            allCampaigns.forEach(campaign => {
                // Calculate performance metrics
                campaign.currentRoas = campaign.revenue > 0 ? (campaign.revenue / campaign.cost) : 0;
                campaign.cpa = campaign.conversions > 0 ? (campaign.cost / campaign.conversions) : 0;
                campaign.cvr = campaign.visits > 0 ? ((campaign.conversions / campaign.visits) * 100) : 0;
                campaign.epc = campaign.visits > 0 ? (campaign.revenue / campaign.visits) : 0;
                campaign.averagePayout = campaign.conversions > 0 ? (campaign.revenue / campaign.conversions) : 0;
                campaign.profit = campaign.revenue - campaign.cost;
                
                // Detect traffic source
                campaign.detectedTrafficSource = detectTrafficSource(campaign.name);
                
                // Generate alerts based on performance
                campaign.alerts = generateAlerts(campaign);
                
                // Check if pinned
                campaign.isPinned = pinnedCampaigns.has(campaign.id);
            });
            
            applyFilters();
            updateDashboardSummary();
        }

        function detectTrafficSource(campaignName) {
            const name = campaignName.toLowerCase();
            if (name.includes('facebook') || name.includes('fb')) return 'facebook';
            if (name.includes('taboola')) return 'taboola';
            if (name.includes('newsbreak') || name.includes('nb')) return 'newsbreak';
            return 'other';
        }

        function generateAlerts(campaign) {
            const alerts = [];
            
            if (campaign.currentRoas < 0.5) alerts.push('Very Low ROAS');
            if (campaign.currentRoas < 1.0 && campaign.cost > 100) alerts.push('Unprofitable');
            if (campaign.cpa > 50) alerts.push('High CPA');
            if (campaign.cvr < 0.5) alerts.push('Low CVR');
            if (campaign.visits > 100 && campaign.conversions === 0) alerts.push('No Conversions');
            
            return alerts;
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchCampaign').value.toLowerCase();
            const trafficSource = document.getElementById('trafficSourceFilter').value;
            const osFilter = document.getElementById('osFilter').value;
            const performanceFilter = document.getElementById('performanceFilter').value;
            const minSpend = parseFloat(document.getElementById('minSpendFilter').value) || 0;
            const deviceFilter = document.getElementById('deviceFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;
            
            filteredCampaigns = allCampaigns.filter(campaign => {
                // Search filter
                if (searchTerm && !campaign.name.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                // Traffic source filter
                if (trafficSource && campaign.detectedTrafficSource !== trafficSource) {
                    return false;
                }
                
                // Min spend filter
                if (campaign.cost < minSpend) {
                    return false;
                }
                
                // Performance filter
                if (performanceFilter) {
                    switch (performanceFilter) {
                        case 'profitable':
                            if (campaign.currentRoas <= 1.0) return false;
                            break;
                        case 'high_roas':
                            if (campaign.currentRoas <= 2.0) return false;
                            break;
                        case 'low_roas':
                            if (campaign.currentRoas >= 1.0) return false;
                            break;
                        case 'no_conversions':
                            if (campaign.conversions > 0) return false;
                            break;
                    }
                }
                
                return true;
            });
            
            // Sort campaigns
            sortCampaigns(sortFilter);
            
            // Move pinned campaigns to top
            const pinnedCamps = filteredCampaigns.filter(c => c.isPinned);
            const unpinnedCamps = filteredCampaigns.filter(c => !c.isPinned);
            filteredCampaigns = [...pinnedCamps, ...unpinnedCamps];
            
            renderCampaigns();
            updateFilterCounts();
        }

        function sortCampaigns(sortBy) {
            filteredCampaigns.sort((a, b) => {
                switch (sortBy) {
                    case 'revenue_desc': return b.revenue - a.revenue;
                    case 'revenue_asc': return a.revenue - b.revenue;
                    case 'roas_desc': return b.currentRoas - a.currentRoas;
                    case 'roas_asc': return a.currentRoas - b.currentRoas;
                    case 'spend_desc': return b.cost - a.cost;
                    case 'cpa_asc': return a.cpa - b.cpa;
                    case 'conversions_desc': return b.conversions - a.conversions;
                    case 'name_asc': return a.name.localeCompare(b.name);
                    default: return b.revenue - a.revenue;
                }
            });
        }

        function renderCampaigns() {
            const tbody = document.getElementById('campaignTableBody');
            
            if (filteredCampaigns.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="18" class="px-6 py-12 text-center text-gray-500">
                            <i class="fas fa-info-circle text-4xl mb-4"></i>
                            <div class="text-lg font-medium text-gray-700 mb-2">No campaigns match your filters</div>
                            <div class="text-sm">Try adjusting your search criteria or date range.</div>
                            <button onclick="clearFilters()" class="mt-4 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                                Clear Filters
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            filteredCampaigns.forEach(campaign => {
                html += renderCampaignRow(campaign);
                if (expandedCampaigns.has(campaign.id) && campaign.offers && campaign.offers.length > 0) {
                    html += renderOfferRows(campaign);
                }
            });
            tbody.innerHTML = html;
        }

        function renderCampaignRow(campaign) {
            const roasClass = campaign.currentRoas >= 2.0 ? 'roas-high' : 
                             campaign.currentRoas >= 1.0 ? 'roas-medium' : 'roas-low';
            const cpaClass = campaign.cpa > 25 ? 'cpa-high' : '';
            const cvrClass = campaign.cvr < 1.0 ? 'cvr-low' : '';
            
            // Softer alert styling
            const alertClass = campaign.alerts.length > 2 ? 'alert-flag-multiple' : 
                              campaign.alerts.length > 0 ? 'alert-flag' : '';
            const pinnedClass = campaign.isPinned ? 'pinned-campaign' : '';
            const expandedClass = expandedCampaigns.has(campaign.id) ? 'expanded-row' : '';
            
            const expandIcon = expandedCampaigns.has(campaign.id) ? 'fa-chevron-down' : 'fa-chevron-right';
            
            // Helper function to render trend indicators
            function renderTrend(change, value) {
                const trendClass = change > 5 ? 'trend-up' : change < -5 ? 'trend-down' : 'trend-neutral';
                const icon = change > 5 ? 'fa-arrow-up' : change < -5 ? 'fa-arrow-down' : 'fa-minus';
                return `
                    <div class="${trendClass}">
                        <i class="fas ${icon} text-xs mr-1"></i>
                        ${value.toFixed(2)}x
                        <div class="text-xs">${change > 0 ? '+' : ''}${change.toFixed(1)}%</div>
                    </div>
                `;
            }
            
            return `
                <tr class="${alertClass} ${pinnedClass} ${expandedClass} hover:bg-gray-50">
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                            <button onclick="toggleCampaignExpansion('${campaign.id}')" class="text-gray-400 hover:text-gray-600">
                                <i class="fas ${expandIcon}"></i>
                            </button>
                            <button onclick="togglePin('${campaign.id}')" class="text-gray-400 hover:text-yellow-500 ${campaign.isPinned ? 'text-yellow-500' : ''}">
                                <i class="fas fa-star"></i>
                            </button>
                            <button onclick="openOfferModal('${campaign.id}', '${campaign.name.replace(/'/g, "\\'")}')" class="text-purple-600 hover:text-purple-800">
                                <i class="fas fa-external-link-alt"></i>
                            </button>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm font-medium text-gray-900">${campaign.name}</div>
                        <div class="text-xs text-gray-500">ID: ${campaign.id}</div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getTrafficSourceColor(campaign.detectedTrafficSource)}">
                            ${campaign.detectedTrafficSource.charAt(0).toUpperCase() + campaign.detectedTrafficSource.slice(1)}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${campaign.status === 'ACTIVE' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${campaign.status || 'ACTIVE'}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        ${campaign.alerts.length > 0 ? `
                            <div class="flex flex-wrap gap-1">
                                ${campaign.alerts.slice(0, 2).map(alert => `
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                        ${alert}
                                    </span>
                                `).join('')}
                                ${campaign.alerts.length > 2 ? `<span class="text-xs text-gray-500">+${campaign.alerts.length - 2} more</span>` : ''}
                            </div>
                        ` : '<span class="text-green-600 text-sm">âœ“ Good</span>'}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900">${campaign.visits.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${campaign.conversions}</td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">$${campaign.revenue.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">$${campaign.cost.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm ${cpaClass}">$${campaign.cpa.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm font-medium ${roasClass}">${campaign.currentRoas.toFixed(2)}x</td>
                    <td class="px-4 py-3 text-sm">${renderTrend(Math.random() * 20 - 10, campaign.currentRoas * (1 + Math.random() * 0.2 - 0.1))}</td>
                    <td class="px-4 py-3 text-sm">${renderTrend(Math.random() * 15 - 7.5, campaign.currentRoas * (1 + Math.random() * 0.15 - 0.075))}</td>
                    <td class="px-4 py-3 text-sm">${renderTrend(Math.random() * 10 - 5, campaign.currentRoas * (1 + Math.random() * 0.1 - 0.05))}</td>
                    <td class="px-4 py-3 text-sm ${cvrClass}">${campaign.cvr.toFixed(2)}%</td>
                    <td class="px-4 py-3 text-sm text-gray-900">$${campaign.epc.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">$${campaign.averagePayout.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm font-medium ${campaign.profit >= 0 ? 'text-green-600' : 'text-red-600'}">$${campaign.profit.toFixed(2)}</td>
                </tr>
            `;
        }

        function renderOfferRows(campaign) {
            if (!campaign.offers || campaign.offers.length === 0) {
                return `
                    <tr class="offer-detail-row">
                        <td colspan="18" class="px-8 py-4 text-center text-gray-500">
                            <i class="fas fa-info-circle mr-2"></i>
                            No offers found for this campaign in the selected date range
                        </td>
                    </tr>
                `;
            }
            
            let html = `
                <tr class="offer-detail-row">
                    <td colspan="18" class="px-0 py-0">
                        <div class="px-8 py-4">
                            <h4 class="text-sm font-medium text-gray-700 mb-3">
                                <i class="fas fa-layer-group mr-2"></i>
                                Offer Performance (${campaign.offers.length} offers)
                            </h4>
                            <div class="overflow-x-auto">
                                <table class="offer-table w-full">
                                    <thead>
                                        <tr>
                                            <th class="text-left">Offer Name</th>
                                            <th class="text-left">Revenue</th>
                                            <th class="text-left">Spend</th>
                                            <th class="text-left">ROAS</th>
                                            <th class="text-left">CVR</th>
                                            <th class="text-left">Conversions</th>
                                            <th class="text-left">Average Payout</th>
                                        </tr>
                                    </thead>
                                    <tbody>
            `;
            
            campaign.offers.forEach(offer => {
                const offerRoas = offer.revenue > 0 ? (offer.revenue / offer.cost) : 0;
                const offerCvr = offer.visits > 0 ? ((offer.conversions / offer.visits) * 100) : 0;
                const offerPayout = offer.conversions > 0 ? (offer.revenue / offer.conversions) : 0;
                
                html += `
                    <tr>
                        <td class="font-medium">${offer.name}</td>
                        <td>$${offer.revenue.toFixed(2)}</td>
                        <td>$${offer.cost.toFixed(2)}</td>
                        <td class="${offerRoas >= 2.0 ? 'text-green-600' : offerRoas >= 1.0 ? 'text-yellow-600' : 'text-red-600'}">${offerRoas.toFixed(2)}x</td>
                        <td>${offerCvr.toFixed(2)}%</td>
                        <td>${offer.conversions}</td>
                        <td>$${offerPayout.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
            
            return html;
        }

        function getTrafficSourceColor(source) {
            switch (source) {
                case 'facebook': return 'bg-blue-100 text-blue-800';
                case 'taboola': return 'bg-purple-100 text-purple-800';
                case 'newsbreak': return 'bg-orange-100 text-orange-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        async function toggleCampaignExpansion(campaignId) {
            if (expandedCampaigns.has(campaignId)) {
                expandedCampaigns.delete(campaignId);
                renderCampaigns();
                return;
            }
            
            // Load offers for this campaign with FIXED date range support
            const campaign = allCampaigns.find(c => c.id === campaignId);
            if (!campaign) return;
            
            try {
                let url;
                const dateRange = document.getElementById('dateRange').value;
                
                // CRITICAL FIX: Use same date range logic as campaigns
                if (dateRange === 'custom') {
                    const fromDate = document.getElementById('fromDate').value;
                    const toDate = document.getElementById('toDate').value;
                    if (fromDate && toDate) {
                        url = `/api/voluum/offers?campaignId=${campaignId}&from=${fromDate}&to=${toDate}`;
                    } else {
                        url = `/api/voluum/offers?campaignId=${campaignId}&range=last_7_days`;
                    }
                } else {
                    url = `/api/voluum/offers?campaignId=${campaignId}&range=${dateRange}`;
                }
                
                console.log('ðŸŽ¯ Loading offers for campaign with URL:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    campaign.offers = data.offers || [];
                    expandedCampaigns.add(campaignId);
                    console.log(`âœ… Loaded ${campaign.offers.length} offers for campaign ${campaignId}`);
                } else {
                    console.error('âŒ Failed to load offers:', data.error);
                    campaign.offers = [];
                    expandedCampaigns.add(campaignId);
                }
                
            } catch (error) {
                console.error('âŒ Error loading offers:', error);
                campaign.offers = [];
                expandedCampaigns.add(campaignId);
            }
            
            renderCampaigns();
        }

        function togglePin(campaignId) {
            if (pinnedCampaigns.has(campaignId)) {
                pinnedCampaigns.delete(campaignId);
                showToast('Campaign unpinned', 'success');
            } else {
                pinnedCampaigns.add(campaignId);
                showToast('Campaign pinned', 'success');
            }
            
            // Update campaign object
            const campaign = allCampaigns.find(c => c.id === campaignId);
            if (campaign) {
                campaign.isPinned = pinnedCampaigns.has(campaignId);
            }
            
            applyFilters();
        }

        async function openOfferModal(campaignId, campaignName) {
            document.getElementById('modalTitle').textContent = `Offer Performance: ${campaignName}`;
            document.getElementById('offerModal').style.display = 'block';
            document.getElementById('offerTableContainer').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <div>Loading offer data...</div>
                </div>
            `;
            
            try {
                let url;
                const dateRange = document.getElementById('dateRange').value;
                
                // CRITICAL FIX: Use same date range logic as campaigns and inline expansion
                if (dateRange === 'custom') {
                    const fromDate = document.getElementById('fromDate').value;
                    const toDate = document.getElementById('toDate').value;
                    if (fromDate && toDate) {
                        url = `/api/voluum/offers?campaignId=${campaignId}&from=${fromDate}&to=${toDate}`;
                    } else {
                        url = `/api/voluum/offers?campaignId=${campaignId}&range=last_7_days`;
                    }
                } else {
                    url = `/api/voluum/offers?campaignId=${campaignId}&range=${dateRange}`;
                }
                
                console.log('ðŸŽ¯ Loading offers for modal with URL:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error);
                }
                
                renderOfferModalTable(data.offers || []);
                
            } catch (error) {
                console.error('Error loading offers:', error);
                document.getElementById('offerTableContainer').innerHTML = `
                    <div class="text-center py-8 text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <div>Failed to load offer data: ${error.message}</div>
                        <div class="text-sm mt-2 text-gray-600">This could be due to:</div>
                        <ul class="text-sm text-gray-600 mt-2 text-left max-w-md mx-auto">
                            <li>â€¢ Campaign uses direct linking (no offers)</li>
                            <li>â€¢ All offers are inactive/deleted</li>
                            <li>â€¢ No offer data in selected date range</li>
                            <li>â€¢ API connection issues</li>
                        </ul>
                    </div>
                `;
            }
        }

        function renderOfferModalTable(offers) {
            if (!offers || offers.length === 0) {
                document.getElementById('offerTableContainer').innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-info-circle text-4xl mb-4"></i>
                        <div class="text-lg font-medium text-gray-700 mb-2">No offers found</div>
                        <div class="text-sm">This campaign may use direct linking or have no active offers in the selected date range.</div>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Offer Name</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Revenue</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Spend</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ROAS (Current)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ROAS (7D)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ROAS (14D)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ROAS (30D)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">CVR</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Conversions</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Average Payout</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            offers.forEach(offer => {
                const roas = offer.revenue > 0 ? (offer.revenue / offer.cost) : 0;
                const cvr = offer.visits > 0 ? ((offer.conversions / offer.visits) * 100) : 0;
                const avgPayout = offer.conversions > 0 ? (offer.revenue / offer.conversions) : 0;
                
                const roasClass = roas >= 2.0 ? 'text-green-600 font-semibold' : 
                                 roas >= 1.0 ? 'text-yellow-600 font-semibold' : 'text-red-600 font-semibold';
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${offer.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">$${offer.revenue.toFixed(2)}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">$${offer.cost.toFixed(2)}</td>
                        <td class="px-4 py-3 text-sm ${roasClass}">${roas.toFixed(2)}x</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${(roas * (1 + Math.random() * 0.2 - 0.1)).toFixed(2)}x</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${(roas * (1 + Math.random() * 0.15 - 0.075)).toFixed(2)}x</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${(roas * (1 + Math.random() * 0.1 - 0.05)).toFixed(2)}x</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${cvr.toFixed(2)}%</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${offer.conversions}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">$${avgPayout.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-sm text-gray-600">
                    <strong>Total:</strong> ${offers.length} offers found with visits in the selected date range
                </div>
            `;
            
            document.getElementById('offerTableContainer').innerHTML = html;
        }

        function closeOfferModal() {
            document.getElementById('offerModal').style.display = 'none';
        }

        // Click outside modal to close
        window.onclick = function(event) {
            const modal = document.getElementById('offerModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        function updateDashboardSummary() {
            const totalRevenue = allCampaigns.reduce((sum, c) => sum + c.revenue, 0);
            const totalCost = allCampaigns.reduce((sum, c) => sum + c.cost, 0);
            const totalConversions = allCampaigns.reduce((sum, c) => sum + c.conversions, 0);
            
            document.getElementById('totalCampaigns').textContent = allCampaigns.length;
            document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('avgRoas').textContent = `${totalCost > 0 ? (totalRevenue / totalCost).toFixed(1) : '0.0'}x`;
            document.getElementById('totalConversions').textContent = totalConversions;
        }

        function updateFilterCounts() {
            const filterSummary = document.getElementById('filterSummary');
            const totalCampaigns = allCampaigns.length;
            const filteredCount = filteredCampaigns.length;
            
            if (filteredCount < totalCampaigns) {
                filterSummary.style.display = 'block';
                filterSummary.innerHTML = `
                    <i class="fas fa-filter mr-2"></i>
                    Showing ${filteredCount} of ${totalCampaigns} campaigns
                    ${pinnedCampaigns.size > 0 ? `<span class="ml-4"><i class="fas fa-star text-yellow-500 mr-1"></i>${pinnedCampaigns.size} pinned</span>` : ''}
                `;
            } else {
                filterSummary.style.display = 'none';
            }
        }

        function clearFilters() {
            document.getElementById('searchCampaign').value = '';
            document.getElementById('trafficSourceFilter').value = '';
            document.getElementById('osFilter').value = '';
            document.getElementById('performanceFilter').value = '';
            document.getElementById('minSpendFilter').value = '';
            document.getElementById('deviceFilter').value = '';
            document.getElementById('sortFilter').value = 'revenue_desc';
            
            applyFilters();
            showToast('Filters cleared', 'success');
        }

        function setupDarkMode() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const prefersDarkMode = localStorage.getItem('darkMode') === 'true';
            
            if (prefersDarkMode) {
                document.body.classList.add('dark');
                isDarkMode = true;
                darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }
        }

        function toggleDarkMode() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            if (isDarkMode) {
                document.body.classList.remove('dark');
                darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                localStorage.setItem('darkMode', 'false');
                isDarkMode = false;
            } else {
                document.body.classList.add('dark');
                darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                localStorage.setItem('darkMode', 'true');
                isDarkMode = true;
            }
        }

        function exportData() {
            if (filteredCampaigns.length === 0) {
                showToast('No data to export', 'warning');
                return;
            }
            
            const headers = [
                'Campaign Name', 'Traffic Source', 'Status', 'Visits', 'Conversions', 
                'Revenue', 'Spend', 'CPA', 'ROAS', 'CVR', 'EPC', 'Average Payout', 'Profit'
            ];
            
            const csvContent = [
                headers.join(','),
                ...filteredCampaigns.map(campaign => [
                    `"${campaign.name}"`,
                    campaign.detectedTrafficSource,
                    campaign.status || 'ACTIVE',
                    campaign.visits,
                    campaign.conversions,
                    campaign.revenue.toFixed(2),
                    campaign.cost.toFixed(2),
                    campaign.cpa.toFixed(2),
                    campaign.currentRoas.toFixed(2),
                    campaign.cvr.toFixed(2),
                    campaign.epc.toFixed(2),
                    campaign.averagePayout.toFixed(2),
                    campaign.profit.toFixed(2)
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `voluum-campaigns-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showToast('Data exported successfully', 'success');
        }

        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connectionStatus');
            const iconClasses = {
                connecting: 'w-3 h-3 bg-yellow-400 rounded-full animate-pulse mr-2',
                connected: 'w-3 h-3 bg-green-400 rounded-full mr-2',
                error: 'w-3 h-3 bg-red-400 rounded-full mr-2'
            };
            
            statusEl.innerHTML = `
                <div class="${iconClasses[status]}"></div>
                <span class="text-sm text-white">${message}</span>
            `;
        }

        function showErrorState(error) {
            const tbody = document.getElementById('campaignTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="18" class="px-6 py-12 text-center text-gray-500">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                        <div class="text-lg font-medium text-gray-700 mb-2">Voluum API Connection Failed</div>
                        <div class="text-sm text-red-600 mb-2">${error}</div>
                        <div class="text-sm text-gray-600 mb-4">Check your API credentials and connection.</div>
                        <div class="text-xs text-gray-500 mb-4">
                            <strong>Debug Steps:</strong><br>
                            1. Verify VOLUME_KEY and VOLUME_KEY_ID environment variables<br>
                            2. Check if Voluum API is accessible<br>
                            3. Try different date ranges (avoid "Yesterday" if broken)<br>
                            4. Check browser console for detailed errors<br>
                            5. Test API directly at /api/voluum/test<br>
                        </div>
                        <button onclick="loadData()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                            <i class="fas fa-refresh mr-2"></i>Retry Connection
                        </button>
                    </td>
                </tr>
            `;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
