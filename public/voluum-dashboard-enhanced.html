<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Voluum Performance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .status-up { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .status-down { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .status-stable { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); }
        .status-paused { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .loading-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .trend-positive { color: #10b981; }
        .trend-negative { color: #ef4444; }
        .campaign-row { cursor: pointer; transition: all 0.2s ease; }
        .campaign-row:hover { background-color: #f8fafc; transform: translateY(-1px); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { max-height: 90vh; overflow-y: auto; }
        .table-container { max-height: 600px; overflow-y: auto; }
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { background-color: #f1f5f9; }
        .connection-status { padding: 8px 12px; border-radius: 6px; font-size: 14px; font-weight: 500; }
        .connection-success { background: #d1fae5; color: #065f46; }
        .connection-error { background: #fee2e2; color: #991b1b; }
        .connection-warning { background: #fef3c7; color: #92400e; }
        .connection-loading { background: #e0e7ff; color: #3730a3; }
        .api-status-panel { background: #f8fafc; border: 1px solid #e2e8f0; padding: 16px; border-radius: 8px; margin-bottom: 16px; }
        .debug-panel { background: #1e293b; color: #e2e8f0; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="gradient-bg shadow-lg">
        <div class="max-w-full mx-auto px-4 py-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-white">Enhanced Voluum Performance Tracker</h1>
                    <p class="text-blue-100">Multi-source traffic analysis • Voluum + Facebook + Taboola + Other Sources</p>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="exportBtn" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-all">
                        <i class="fas fa-download mr-2"></i>Export CSV
                    </button>
                    <button id="refreshBtn" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-all">
                        <i class="fas fa-sync mr-2"></i>Refresh
                    </button>
                </div>
            </div>
            
            <!-- API Connection Status Panel -->
            <div class="api-status-panel">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-gray-700 font-semibold">Data Source Status</h3>
                    <button id="toggleDebugBtn" class="text-sm px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">
                        <i class="fas fa-code mr-1"></i>Debug
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                    <div class="flex items-center">
                        <i class="fas fa-circle mr-2 text-gray-400" id="volumeStatus"></i>
                        <span>Voluum API</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-circle mr-2 text-gray-400" id="facebookStatus"></i>
                        <span>Facebook API</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-circle mr-2 text-gray-400" id="taboolaStatus"></i>
                        <span>Taboola API</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-circle mr-2 text-gray-400" id="overallStatus"></i>
                        <span>Overall Status</span>
                    </div>
                </div>
                <div id="connectionMessage" class="mt-2 text-sm text-gray-600"></div>
            </div>
            
            <!-- Debug Panel -->
            <div id="debugPanel" class="debug-panel hidden">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-lg font-semibold">Debug Information</h4>
                    <button id="clearDebugBtn" class="text-xs px-2 py-1 bg-gray-600 rounded hover:bg-gray-500">Clear</button>
                </div>
                <div id="debugLog"></div>
            </div>

            <!-- Filters -->
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mt-4">
                <div>
                    <label class="block text-white text-sm font-medium mb-2">Date Range</label>
                    <select id="dateRangeFilter" class="w-full bg-white bg-opacity-90 border border-gray-300 rounded-lg px-3 py-2 text-gray-900">
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="last_7_days">Last 7 Days</option>
                        <option value="last_14_days">Last 14 Days</option>
                        <option value="last_30_days" selected>Last 30 Days</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-white text-sm font-medium mb-2">Status</label>
                    <select id="statusFilter" class="w-full bg-white bg-opacity-90 border border-gray-300 rounded-lg px-3 py-2 text-gray-900">
                        <option value="all" selected>All Campaigns</option>
                        <option value="active">Active Only</option>
                        <option value="paused">Paused Only</option>
                        <option value="profitable">Profitable (ROAS > 1.0)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-white text-sm font-medium mb-2">Traffic Source</label>
                    <select id="trafficSourceFilter" class="w-full bg-white bg-opacity-90 border border-gray-300 rounded-lg px-3 py-2 text-gray-900">
                        <option value="all">All Sources</option>
                        <option value="voluum">Voluum</option>
                        <option value="facebook">Facebook</option>
                        <option value="taboola">Taboola</option>
                        <option value="newsbreak">NewsBreak</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-white text-sm font-medium mb-2">Spend Level</label>
                    <select id="spendFilter" class="w-full bg-white bg-opacity-90 border border-gray-300 rounded-lg px-3 py-2 text-gray-900">
                        <option value="all">All Spend</option>
                        <option value="high">High (>$1000)</option>
                        <option value="medium">Medium ($100-$1000)</option>
                        <option value="low">Low (<$100)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-white text-sm font-medium mb-2">Performance</label>
                    <select id="performanceFilter" class="w-full bg-white bg-opacity-90 border border-gray-300 rounded-lg px-3 py-2 text-gray-900">
                        <option value="all">All Performance</option>
                        <option value="profitable">Profitable</option>
                        <option value="breakeven">Break-even</option>
                        <option value="losing">Losing</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-white text-sm font-medium mb-2">Sort By</label>
                    <select id="sortFilter" class="w-full bg-white bg-opacity-90 border border-gray-300 rounded-lg px-3 py-2 text-gray-900">
                        <option value="revenue">Revenue (High to Low)</option>
                        <option value="spend">Spend (High to Low)</option>
                        <option value="roas">ROAS (High to Low)</option>
                        <option value="conversions">Conversions (High to Low)</option>
                        <option value="profit">Profit (High to Low)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Overview Stats -->
    <div class="max-w-full mx-auto px-4 py-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-3xl font-bold text-blue-600" id="totalCampaigns">0</p>
                        <p class="text-sm text-gray-600">Total Campaigns</p>
                        <p class="text-xs text-gray-500">Active: <span id="activeCampaigns">0</span></p>
                    </div>
                    <i class="fas fa-chart-line text-blue-600 text-2xl"></i>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-3xl font-bold text-green-600">$<span id="totalRevenue">0</span></p>
                        <p class="text-sm text-gray-600">Total Revenue</p>
                        <p class="text-xs text-gray-500">Multi-source</p>
                    </div>
                    <i class="fas fa-dollar-sign text-green-600 text-2xl"></i>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-3xl font-bold text-red-600">$<span id="totalSpend">0</span></p>
                        <p class="text-sm text-gray-600">Total Spend</p>
                        <p class="text-xs text-gray-500">Multi-source</p>
                    </div>
                    <i class="fas fa-credit-card text-red-600 text-2xl"></i>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-3xl font-bold text-purple-600"><span id="averageRoas">0</span>x</p>
                        <p class="text-sm text-gray-600">Average ROAS</p>
                        <p class="text-xs text-gray-500">Conversions: <span id="totalConversions">0</span></p>
                    </div>
                    <i class="fas fa-chart-pie text-purple-600 text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- Campaign Table -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-900">Campaign Performance Analytics</h2>
                    <div class="flex items-center space-x-4">
                        <input type="text" id="campaignSearchFilter" placeholder="Search campaigns..." 
                               class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span id="filteredCount" class="text-sm text-gray-600">Loading...</span>
                    </div>
                </div>
            </div>
            
            <div class="table-container">
                <table class="w-full">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Campaign</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="visits">Visits</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="conversions">Conversions</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="revenue">Revenue</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="spend">Spend</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="roas">ROAS</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Profit</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="campaignTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Campaign rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden text-center py-12">
            <div class="loading-pulse">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                <p class="text-gray-600">Loading campaign data from multiple sources...</p>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-12">
            <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">No Campaign Data Available</h3>
            <p class="text-gray-600 mb-4">Unable to load campaign data from any connected sources.</p>
            <button onclick="loadAllData()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fas fa-sync mr-2"></i>Try Again
            </button>
        </div>
    </div>

    <script>
        // Global variables
        let allCampaigns = [];
        let filteredCampaigns = [];
        let currentSort = { field: 'revenue', direction: 'desc' };
        let debugLogs = [];
        let dataSourceStatus = {
            voluum: 'disconnected',
            facebook: 'disconnected',
            taboola: 'disconnected'
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadAllData();
        });

        function setupEventListeners() {
            // Filter event listeners
            document.getElementById('dateRangeFilter').addEventListener('change', loadAllData);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('trafficSourceFilter').addEventListener('change', applyFilters);
            document.getElementById('spendFilter').addEventListener('change', applyFilters);
            document.getElementById('performanceFilter').addEventListener('change', applyFilters);
            document.getElementById('sortFilter').addEventListener('change', applySortFromFilter);
            document.getElementById('campaignSearchFilter').addEventListener('input', applyFilters);
            
            // Button event listeners
            document.getElementById('refreshBtn').addEventListener('click', loadAllData);
            document.getElementById('exportBtn').addEventListener('click', exportToCsv);
            document.getElementById('toggleDebugBtn').addEventListener('click', toggleDebugPanel);
            document.getElementById('clearDebugBtn').addEventListener('click', clearDebugLog);
            
            // Sortable headers
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const field = header.dataset.sort;
                    sortCampaigns(field);
                });
            });
        }

        function debugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLogs.push(logEntry);
            
            // Keep only last 100 log entries
            if (debugLogs.length > 100) {
                debugLogs.shift();
            }
            
            // Update debug panel if visible
            const debugPanel = document.getElementById('debugLog');
            if (debugPanel && !document.getElementById('debugPanel').classList.contains('hidden')) {
                debugPanel.innerHTML = debugLogs.join('\n');
                debugPanel.scrollTop = debugPanel.scrollHeight;
            }
            
            console.log(logEntry);
        }

        function toggleDebugPanel() {
            const debugPanel = document.getElementById('debugPanel');
            const debugLog = document.getElementById('debugLog');
            
            debugPanel.classList.toggle('hidden');
            
            if (!debugPanel.classList.contains('hidden')) {
                debugLog.innerHTML = debugLogs.join('\n');
                debugLog.scrollTop = debugLog.scrollHeight;
            }
        }

        function clearDebugLog() {
            debugLogs = [];
            document.getElementById('debugLog').innerHTML = '';
        }

        function updateConnectionStatus(source, status, message = '') {
            dataSourceStatus[source] = status;
            const statusElement = document.getElementById(source + 'Status');
            
            if (statusElement) {
                statusElement.className = 'fas fa-circle mr-2 ' + getStatusColor(status);
            }
            
            // Update overall status
            const overallStatus = calculateOverallStatus();
            const overallElement = document.getElementById('overallStatus');
            if (overallElement) {
                overallElement.className = 'fas fa-circle mr-2 ' + getStatusColor(overallStatus);
            }
            
            // Update connection message
            const messageElement = document.getElementById('connectionMessage');
            if (messageElement && message) {
                messageElement.textContent = message;
                messageElement.className = 'mt-2 text-sm connection-' + status;
            }
        }

        function getStatusColor(status) {
            switch (status) {
                case 'connected': return 'text-green-500';
                case 'warning': return 'text-yellow-500';
                case 'error': return 'text-red-500';
                case 'loading': return 'text-blue-500';
                default: return 'text-gray-400';
            }
        }

        function calculateOverallStatus() {
            const statuses = Object.values(dataSourceStatus);
            if (statuses.includes('connected')) return 'connected';
            if (statuses.includes('warning')) return 'warning';
            if (statuses.includes('error')) return 'error';
            if (statuses.includes('loading')) return 'loading';
            return 'disconnected';
        }

        async function loadAllData() {
            showLoadingState();
            debugLog('🚀 Starting comprehensive data load from all sources...');
            
            const combinedData = {
                campaigns: [],
                overview: {
                    totalCampaigns: 0,
                    activeCampaigns: 0,
                    totalRevenue: 0,
                    totalSpend: 0,
                    averageRoas: 0,
                    totalConversions: 0
                }
            };

            // Load data from all sources in parallel
            const promises = [
                loadVoluumData(),
                loadFacebookData(),
                loadTaboolaData()
            ];

            try {
                const results = await Promise.allSettled(promises);
                
                results.forEach((result, index) => {
                    const source = ['voluum', 'facebook', 'taboola'][index];
                    
                    if (result.status === 'fulfilled' && result.value) {
                        combinedData.campaigns.push(...result.value.campaigns);
                        debugLog(`✅ ${source} data loaded: ${result.value.campaigns.length} campaigns`);
                    } else {
                        debugLog(`❌ ${source} data failed: ${result.reason?.message || 'Unknown error'}`);
                    }
                });

                // Process combined data
                processAllData(combinedData);
                
                const totalCampaigns = combinedData.campaigns.length;
                const connectedSources = Object.values(dataSourceStatus).filter(s => s === 'connected').length;
                
                debugLog(`📊 Final result: ${totalCampaigns} campaigns from ${connectedSources} connected sources`);
                
                if (totalCampaigns === 0) {
                    showEmptyState();
                }
                
            } catch (error) {
                debugLog(`❌ Critical error during data loading: ${error.message}`);
                showEmptyState();
            } finally {
                hideLoadingState();
            }
        }

        async function loadVoluumData() {
            debugLog('📊 Loading Voluum data...');
            updateConnectionStatus('voluum', 'loading', 'Connecting to Voluum API...');
            
            try {
                const dateRange = document.getElementById('dateRangeFilter').value;
                const response = await fetch(`/api/voluum/campaigns-simple?date_range=${dateRange}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success === false) {
                    throw new Error(data.error || 'Voluum API error');
                }
                
                // Process Voluum data using the actual API structure
                const processedData = {
                    campaigns: (data.data?.campaigns || []).map(campaign => ({
                        ...campaign,
                        source: campaign.trafficSource || 'Voluum',
                        dataSource: 'voluum'
                    }))
                };
                
                updateConnectionStatus('voluum', 'connected', `Voluum: ${processedData.campaigns.length} campaigns loaded`);
                debugLog(`✅ Voluum data processed: ${processedData.campaigns.length} campaigns`);
                
                return processedData;
                
            } catch (error) {
                debugLog(`❌ Voluum error: ${error.message}`);
                updateConnectionStatus('voluum', 'error', `Voluum Error: ${error.message}`);
                
                // Return mock data for development
                const mockData = generateMockVoluumData();
                updateConnectionStatus('voluum', 'warning', 'Voluum: Using mock data');
                return mockData;
            }
        }

        async function loadFacebookData() {
            debugLog('📘 Loading Facebook data...');
            updateConnectionStatus('facebook', 'loading', 'Connecting to Facebook API...');
            
            try {
                const response = await fetch('/api/campaigns');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!Array.isArray(data)) {
                    throw new Error('Facebook API returned invalid data format');
                }
                
                // Process Facebook data using the actual API structure
                const processedData = {
                    campaigns: data.map(campaign => ({
                        id: campaign.id,
                        name: campaign.name,
                        visits: campaign.clicks || 0,
                        conversions: campaign.conversions || 0,
                        revenue: campaign.revenue || 0,
                        cost: campaign.spend || 0,
                        roas: campaign.roas || (campaign.spend > 0 ? (campaign.revenue || 0) / campaign.spend : 0),
                        status: campaign.status || 'Active',
                        hasTraffic: true,
                        source: 'Facebook',
                        dataSource: 'facebook'
                    }))
                };
                
                updateConnectionStatus('facebook', 'connected', `Facebook: ${processedData.campaigns.length} campaigns loaded`);
                debugLog(`✅ Facebook data processed: ${processedData.campaigns.length} campaigns`);
                
                return processedData;
                
            } catch (error) {
                debugLog(`❌ Facebook error: ${error.message}`);
                updateConnectionStatus('facebook', 'error', `Facebook Error: ${error.message}`);
                
                // Return mock data for development
                const mockData = generateMockFacebookData();
                updateConnectionStatus('facebook', 'warning', 'Facebook: Using mock data');
                return mockData;
            }
        }

        async function loadTaboolaData() {
            debugLog('📄 Loading Taboola data...');
            updateConnectionStatus('taboola', 'loading', 'Connecting to Taboola API...');
            
            try {
                const response = await fetch('/api/taboola-campaigns');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!Array.isArray(data)) {
                    throw new Error('Taboola API returned invalid data format');
                }
                
                // Process Taboola data using the actual API structure
                const processedData = {
                    campaigns: data.map(campaign => ({
                        id: campaign.id,
                        name: campaign.name,
                        visits: campaign.clicks || 0,
                        conversions: campaign.conversions || 0,
                        revenue: campaign.revenue || 0,
                        cost: campaign.spend || 0,
                        roas: campaign.roas || (campaign.spend > 0 ? (campaign.revenue || 0) / campaign.spend : 0),
                        status: campaign.campaignStatus || 'Active',
                        hasTraffic: true,
                        source: 'Taboola',
                        dataSource: 'taboola'
                    }))
                };
                
                updateConnectionStatus('taboola', 'connected', `Taboola: ${processedData.campaigns.length} campaigns loaded`);
                debugLog(`✅ Taboola data processed: ${processedData.campaigns.length} campaigns`);
                
                return processedData;
                
            } catch (error) {
                debugLog(`❌ Taboola error: ${error.message}`);
                updateConnectionStatus('taboola', 'error', `Taboola Error: ${error.message}`);
                
                // Return mock data for development
                const mockData = generateMockTaboolaData();
                updateConnectionStatus('taboola', 'warning', 'Taboola: Using mock data');
                return mockData;
            }
        }

        function processAllData(combinedData) {
            debugLog('🔄 Processing combined data from all sources...');
            
            // Ensure all campaigns have required fields
            allCampaigns = combinedData.campaigns.map(campaign => ({
                id: campaign.id || campaign.name,
                name: campaign.name || 'Unknown Campaign',
                source: campaign.source || 'Unknown',
                dataSource: campaign.dataSource || 'unknown',
                visits: campaign.visits || 0,
                conversions: campaign.conversions || 0,
                revenue: campaign.revenue || 0,
                cost: campaign.cost || campaign.spend || 0,
                roas: campaign.roas || (campaign.cost > 0 ? campaign.revenue / campaign.cost : 0),
                cpa: campaign.cpa || (campaign.conversions > 0 ? campaign.cost / campaign.conversions : 0),
                cvr: campaign.cvr || (campaign.visits > 0 ? (campaign.conversions / campaign.visits) * 100 : 0),
                profit: campaign.profit || (campaign.revenue - campaign.cost),
                status: campaign.status || 'Active',
                hasTraffic: campaign.hasTraffic !== false
            }));
            
            // Calculate overview stats
            const overview = calculateOverviewStats(allCampaigns);
            updateOverviewStats(overview);
            
            // Apply filters and render
            applyFilters();
            
            debugLog(`✅ Data processing complete: ${allCampaigns.length} total campaigns`);
        }

        function calculateOverviewStats(campaigns) {
            const activeCampaigns = campaigns.filter(c => c.hasTraffic && c.status === 'Active');
            const totalRevenue = campaigns.reduce((sum, c) => sum + (c.revenue || 0), 0);
            const totalSpend = campaigns.reduce((sum, c) => sum + (c.cost || 0), 0);
            const totalConversions = campaigns.reduce((sum, c) => sum + (c.conversions || 0), 0);
            const averageRoas = activeCampaigns.length > 0 ? 
                activeCampaigns.reduce((sum, c) => sum + (c.roas || 0), 0) / activeCampaigns.length : 0;
            
            return {
                totalCampaigns: campaigns.length,
                activeCampaigns: activeCampaigns.length,
                totalRevenue: totalRevenue,
                totalSpend: totalSpend,
                averageRoas: averageRoas,
                totalConversions: totalConversions
            };
        }

        function updateOverviewStats(overview) {
            document.getElementById('totalCampaigns').textContent = overview.totalCampaigns.toLocaleString();
            document.getElementById('activeCampaigns').textContent = overview.activeCampaigns.toLocaleString();
            document.getElementById('totalRevenue').textContent = overview.totalRevenue.toLocaleString();
            document.getElementById('totalSpend').textContent = overview.totalSpend.toLocaleString();
            document.getElementById('averageRoas').textContent = overview.averageRoas.toFixed(2);
            document.getElementById('totalConversions').textContent = overview.totalConversions.toLocaleString();
        }

        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const sourceFilter = document.getElementById('trafficSourceFilter').value;
            const spendFilter = document.getElementById('spendFilter').value;
            const performanceFilter = document.getElementById('performanceFilter').value;
            const searchFilter = document.getElementById('campaignSearchFilter').value.toLowerCase();
            
            filteredCampaigns = allCampaigns.filter(campaign => {
                // Status filter
                if (statusFilter !== 'all') {
                    if (statusFilter === 'active' && campaign.status !== 'Active') return false;
                    if (statusFilter === 'paused' && campaign.status !== 'Paused') return false;
                    if (statusFilter === 'profitable' && campaign.roas <= 1.0) return false;
                }
                
                // Source filter
                if (sourceFilter !== 'all') {
                    if (sourceFilter === 'voluum' && campaign.dataSource !== 'voluum') return false;
                    if (sourceFilter === 'facebook' && campaign.dataSource !== 'facebook') return false;
                    if (sourceFilter === 'taboola' && campaign.dataSource !== 'taboola') return false;
                    if (sourceFilter === 'newsbreak' && !campaign.name.toLowerCase().includes('newsbreak')) return false;
                    if (sourceFilter === 'other' && ['voluum', 'facebook', 'taboola'].includes(campaign.dataSource)) return false;
                }
                
                // Spend filter
                if (spendFilter !== 'all') {
                    const spend = campaign.cost || 0;
                    if (spendFilter === 'high' && spend <= 1000) return false;
                    if (spendFilter === 'medium' && (spend <= 100 || spend > 1000)) return false;
                    if (spendFilter === 'low' && spend >= 100) return false;
                }
                
                // Performance filter
                if (performanceFilter !== 'all') {
                    const roas = campaign.roas || 0;
                    if (performanceFilter === 'profitable' && roas <= 1.0) return false;
                    if (performanceFilter === 'breakeven' && (roas < 0.9 || roas > 1.1)) return false;
                    if (performanceFilter === 'losing' && roas >= 1.0) return false;
                }
                
                // Search filter
                if (searchFilter && !campaign.name.toLowerCase().includes(searchFilter)) return false;
                
                return true;
            });
            
            // Apply current sort
            sortCampaigns(currentSort.field, currentSort.direction);
            
            // Update filtered count
            document.getElementById('filteredCount').textContent = 
                `Showing ${filteredCampaigns.length} of ${allCampaigns.length} campaigns`;
            
            // Render table
            renderCampaignTable();
        }

        function sortCampaigns(field, direction = null) {
            if (direction === null) {
                direction = currentSort.field === field && currentSort.direction === 'desc' ? 'asc' : 'desc';
            }
            
            currentSort = { field, direction };
            
            filteredCampaigns.sort((a, b) => {
                let aVal = a[field] || 0;
                let bVal = b[field] || 0;
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                const result = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                return direction === 'desc' ? -result : result;
            });
            
            renderCampaignTable();
        }

        function applySortFromFilter() {
            const sortValue = document.getElementById('sortFilter').value;
            let field = 'revenue';
            
            switch (sortValue) {
                case 'spend': field = 'cost'; break;
                case 'roas': field = 'roas'; break;
                case 'conversions': field = 'conversions'; break;
                case 'profit': field = 'profit'; break;
                default: field = 'revenue';
            }
            
            sortCampaigns(field, 'desc');
        }

        function renderCampaignTable() {
            const tbody = document.getElementById('campaignTableBody');
            
            if (filteredCampaigns.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="px-6 py-12 text-center text-gray-500">
                            <i class="fas fa-search text-2xl mb-2"></i>
                            <p>No campaigns match your current filters</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = filteredCampaigns.map(campaign => `
                <tr class="campaign-row hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${campaign.name}</div>
                        <div class="text-sm text-gray-500">ID: ${campaign.id}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${campaign.source}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusStyle(campaign.status)}">
                            ${campaign.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${campaign.visits.toLocaleString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${campaign.conversions.toLocaleString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        $${campaign.revenue.toLocaleString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        $${campaign.cost.toLocaleString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${campaign.roas > 1 ? 'text-green-600' : 'text-red-600'}">
                        ${campaign.roas.toFixed(2)}x
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${campaign.profit > 0 ? 'text-green-600' : 'text-red-600'}">
                        $${campaign.profit.toLocaleString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="viewCampaignDetails('${campaign.id}')" class="text-blue-600 hover:text-blue-900">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusStyle(status) {
            switch (status) {
                case 'Active': return 'bg-green-100 text-green-800';
                case 'Paused': return 'bg-yellow-100 text-yellow-800';
                case 'Stopped': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function viewCampaignDetails(campaignId) {
            const campaign = allCampaigns.find(c => c.id === campaignId);
            if (campaign) {
                alert(`Campaign Details:\n\nName: ${campaign.name}\nSource: ${campaign.source}\nRevenue: $${campaign.revenue}\nSpend: $${campaign.cost}\nROAS: ${campaign.roas.toFixed(2)}x\nProfit: $${campaign.profit}`);
            }
        }

        function showLoadingState() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
        }

        function hideLoadingState() {
            document.getElementById('loadingState').classList.add('hidden');
        }

        function showEmptyState() {
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('loadingState').classList.add('hidden');
        }

        function exportToCsv() {
            if (filteredCampaigns.length === 0) {
                alert('No data to export');
                return;
            }
            
            const headers = ['Campaign', 'Source', 'Status', 'Visits', 'Conversions', 'Revenue', 'Spend', 'ROAS', 'Profit'];
            const csvContent = [
                headers.join(','),
                ...filteredCampaigns.map(campaign => [
                    `"${campaign.name}"`,
                    campaign.source,
                    campaign.status,
                    campaign.visits,
                    campaign.conversions,
                    campaign.revenue,
                    campaign.cost,
                    campaign.roas.toFixed(2),
                    campaign.profit.toFixed(2)
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `campaign_data_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Mock data generators for development
        function generateMockVoluumData() {
            const campaigns = [
                {
                    id: 'vol_001',
                    name: 'Voluum Campaign A - NewsBreak',
                    visits: 15000,
                    conversions: 150,
                    revenue: 2250,
                    cost: 1800,
                    status: 'Active',
                    hasTraffic: true
                },
                {
                    id: 'vol_002',
                    name: 'Voluum Campaign B - Taboola',
                    visits: 12000,
                    conversions: 120,
                    revenue: 1920,
                    cost: 1600,
                    status: 'Active',
                    hasTraffic: true
                }
            ];
            
            return { campaigns };
        }

        function generateMockFacebookData() {
            const campaigns = [
                {
                    id: 'fb_001',
                    name: 'Facebook Campaign A - Lead Gen',
                    visits: 8000,
                    conversions: 80,
                    revenue: 1200,
                    cost: 1000,
                    status: 'Active',
                    hasTraffic: true
                },
                {
                    id: 'fb_002',
                    name: 'Facebook Campaign B - Conversions',
                    visits: 6000,
                    conversions: 60,
                    revenue: 900,
                    cost: 800,
                    status: 'Active',
                    hasTraffic: true
                }
            ];
            
            return { campaigns };
        }

        function generateMockTaboolaData() {
            const campaigns = [
                {
                    id: 'tab_001',
                    name: 'Taboola Campaign A - Native',
                    visits: 10000,
                    conversions: 100,
                    revenue: 1500,
                    cost: 1200,
                    status: 'Active',
                    hasTraffic: true
                },
                {
                    id: 'tab_002',
                    name: 'Taboola Campaign B - Display',
                    visits: 7000,
                    conversions: 70,
                    revenue: 1050,
                    cost: 900,
                    status: 'Active',
                    hasTraffic: true
                }
            ];
            
            return { campaigns };
        }
    </script>
</body>
</html>
